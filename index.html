<!DOCTYPE html>
<html lang="id">
<head>

<!-- Charset & Viewport -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Judul -->
  <title>Mutaba'ah Tahfidz Digital</title>

  <!-- Favicon untuk browser -->
  <link rel="icon" href="./icon-192.png" type="image/png" sizes="192x192" />
  <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/tahfizpis/web/refs/heads/main/logo.png" />

  <!-- Open Graph Meta Tags (untuk WhatsApp, FB, Telegram) -->
  <meta property="og:title" content="Portal Mutaba'ah Tahfidz" />
  <meta property="og:description" content="Mudah, simpel, akurat. Sesuai halaman Mushaf Madinah. Dilengkapi laporan otomatis." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://tahfizpis.netlify.app/" />

  <!-- Gunakan gambar 512x512 -->
  <meta property="og:image" content="https://raw.githubusercontent.com/tahfizpis/web/refs/heads/main/logo.png" />
  <meta property="og:image:type" content="image/png" />
  <meta property="og:image:width" content="512" />
  <meta property="og:image:height" content="512" />

  <!-- Warna tema untuk mobile browser -->
  <meta name="theme-color" content="#2563eb" />
	
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    body {
  font-family: Arial, sans-serif;
  margin: 0;
  background: #f4f6f8;
  font-size: 12px; /* ini akan kecilkan semua font */
}

    button.lihat-quran-btn {
  all: unset; /* reset semua style bawaan */
  display: inline-block;
  font-weight: 600;
  font-size: 12px;
  letter-spacing: 0.3px;
  color: #1E88E5;
  padding: 2px 4px;
  cursor: pointer;
  position: relative;
  transition: color 0.00s ease;
}

/* underline animasi halus */
button.lihat-quran-btn::after {
  content: "";
  position: absolute;
  left: 0;
  bottom: -2px;
  width: 0%;
  height: 2px;
  background-color: currentColor;
  transition: width 0.00s ease;
}

button.lihat-quran-btn:hover {
  color: #ffffff;
}

button.lihat-quran-btn:hover::after {
  width: 100%;
}

#santri-table th:first-child,
#santri-table td:first-child {
  position: sticky;
  left: 0;
  background: white;
  z-index: 5;
  border-right: 1px solid #ccc; /* opsional, biar ada garis pembatas */
}

	  /* ----- Sticky header umum (baris judul tetap di atas) ----- */
#santri-table thead th {
  position: sticky;
  top: 0;
  z-index: 3;              /* di atas sel body biasa */
  background: #1e88e5;     /* ulangi background agar tidak transparan */
  color: #fff;
}

/* ----- Sudut kiri atas: header kolom pertama ----- */
#santri-table thead th:first-child {
  position: sticky;
  left: 0;                 /* sudah ada, tambahkan top agar tak ketutup */
  top: 0;
  z-index: 6;              /* paling tinggi agar tidak ketiban apa pun */
  background: #1e88e5;     /* samakan warna header */
}

/* ----- Kolom pertama di body ikut sticky kiri ----- */
#santri-table tbody td:first-child {
  position: sticky;
  left: 0;
  background: #fff;        /* wajib: kalau transparan, akan ‚Äòtembus‚Äô */
  z-index: 5;              /* di bawah th:first-child, di atas sel lain */
  border-right: 1px solid #ccc;
}

    .password-wrapper {
  position: relative;
  width: 100%;
}

.password-wrapper input {
  width: 100%;
  padding-right: 40px; /* ruang untuk icon üëÅ */
  box-sizing: border-box;
}

.toggle-password {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  cursor: pointer;
  user-select: none;
  font-size: 12px;
}

    .password-login-group {
  display: flex;
  align-items: center;
  gap: 8px; /* jarak antara password dan tombol login */
}

.password-login-group button {
  white-space: nowrap; /* biar tulisan "Login" nggak pecah */
}

    #username {
  width: 314px; /* atur lebar sesuai kebutuhan */
  max-width: 100%; /* biar tetap responsif di layar kecil */
  box-sizing: border-box; /* supaya padding ikut hitung lebar */
}


   .modal {
  position: fixed;
  z-index: 999;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.4);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 10px; /* Tambahan: agar konten modal tidak nempel di tepi */
  box-sizing: border-box;
}

.modal-content {
  background: white;
  padding: 20px;
  border-radius: 10px;
  width: 100%;
  max-width: 300px; /* Batasi ukuran maksimum di desktop */
  box-sizing: border-box;
}

/* Responsif tambahan (opsional) */
@media (max-width: 400px) {
  .modal-content {
    padding: 15px;
    font-size: 12px;
  }
}

    .login-actions {
  display: flex;
  justify-content: center;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 15px;
}

@media (max-width: 600px) {
  .login-actions {
    flex-direction: column;
    align-items: stretch;
    gap: 8px;
  }

  .login-actions button {
    width: 100%;
  }
}

.dashboard-header {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}

.dashboard-header-row {
  display: flex;
  flex-direction: row;
  gap: 12px;
  align-items: center;
  flex-wrap: wrap;
  justify-content: center;
}

.dashboard-header label {
  font-size: 12px;
}

.dashboard-header select,
.dashboard-header input[type="date"] {
  padding: 8px;
  font-size: 12px;
  border-radius: 6px;
  border: 1px solid #ccc;
  min-width: 140px;
}

/* üåê Tambahkan ini untuk mobile */
@media (max-width: 600px) {
  .dashboard-header-row {
    flex-direction: column;
    align-items: stretch;
  }

  .dashboard-header label {
    text-align: left;
    width: 100%;
  }
}
    
    .total-all-juz span {
  font-weight: bold;
  background: #e0f2f1;
  border-radius: 4px;
  padding: 1px 4px;
}
    .container {
  max-width: 1400px;
  margin: 0;               /* tidak ada margin sama sekali */
  padding: 0;              /* tidak ada padding sama sekali */
}

	  /* Bedakan login card */
#login-card {
  max-width: 400px;
  margin: 80px auto;   /* naik turun 80px, horizontal auto */
  padding: 20px;
  box-sizing: border-box;
}

/* Atur agar konten login tetap center di layar */
@media (min-height: 600px) {
  #login-card {
    margin-top: 10vh;  /* 10% dari tinggi layar, lebih responsif */
  }
}
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      margin-top: 0px;
    }
    h1, h2 {
      text-align: center;
    }
    form, .dashboard-header {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
      margin-top: 0px;
    }
    input, select, button {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 12px;
    }
    button {
      background: #1e88e5;
      color: white;
      cursor: pointer;
      margin: 2px;
    }
    button:hover {
      background: #1565c0;
    }
    .logout-btn {
      background: #e53935;
    }
    .logout-btn:hover {
      background: #b71c1c;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 12px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #1e88e5;
      color: white;
    }
    .actions {
      text-align: center;
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .password-group {
      display: flex;
      gap: 5px;
      align-items: center;
    }
    .toggle-btn {
      background: #6c757d;
      font-size: 12px;
      padding: 10px 14px;
    }
    .toggle-btn:hover {
      background: #495057;
    }
    
  /* Overlay Loading */
#overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.4);
  z-index: 1000;

  /* DEFAULT: sembunyi (jangan ditimpa lagi) */
  display: none;

  /* centering saat AKTIF (lihat aturan .is-active di bawah) */
  align-items: center;
  justify-content: center;
}

/* TAMPILKAN overlay dengan menambah class .is-active */
#overlay.is-active {
  display: flex;
}

/* kotak putih dengan ukuran bisa diatur */
#overlay span {
  background: #fff;
  width: 68px;                  /* atur lebar kotak */
  height: 68px;                 /* atur tinggi kotak */
  border-radius: 8px;
  color: #333;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);

  display: flex;
  align-items: center;
  justify-content: center;
}

/* GIF dengan ukuran bisa diatur */
#overlay img {
  width: 64px;                  /* atur lebar GIF */
  height: 64px;                 /* atur tinggi GIF */
  object-fit: contain;          /* jaga proporsi GIF */
  display: block;
}

@media (max-width: 768px) {
  .dashboard-header { flex-direction: column; align-items: stretch; }
  table { display: block; overflow-x: auto; white-space: nowrap; }
  .actions { flex-direction: column; }
  .password-group { flex-direction: row; }
}

	  /* Header Login: Logo + Judul sejajar */
.login-header {
  display: flex;
  align-items: center;       /* vertikal tengah */
  justify-content: center;   /* center di dalam card */
  gap: 10px;                 /* jarak antara logo dan teks */
  margin-bottom: 16px;
  flex-wrap: wrap;           /* kalau layar kecil, bisa turun ke bawah */
}

.login-header img {
  height: 7em;             /* ikuti tinggi teks */
  width: auto;
}

.login-header h1 {
  font-size: 1.2rem;         /* ukuran teks, bisa kamu sesuaikan */
  margin: 0;
  text-align: center;
}

	  .judul {
  display: flex;
  flex-direction: column; /* otomatis jadi 2 baris */
  align-items: center;    /* rata tengah */
  margin: 0;
  padding: 0;
  line-height: 1.1;       /* rapatkan antar baris */
}

.judul-atas {
  font-size: 1.2rem;
  font-weight: bold;
  margin: 0;
  padding: 0;
}

.judul-bawah {
  font-size: 1.2rem;
  font-weight: bold;
  margin: 0;
  padding: 0;
}

	  /* === OVERRIDE: samakan mobile dengan desktop untuk area tombol login === */
@media (max-width: 600px) {
  .login-actions {
    display: flex;
    flex-direction: row;   /* jangan kolom */
    flex-wrap: wrap;       /* turun baris kalau sempit */
    justify-content: center;
    gap: 10px;
  }
  .login-actions button {
    width: auto;           /* jangan full width */
    min-width: 150px;      /* biar konsisten seperti desktop */
  }

  /* pastikan input password + tombol Login tetap sejajar */
  .password-login-group {
    flex-direction: row;
    flex-wrap: nowrap;
  }
  .password-wrapper { flex: 1; }   /* input melar, tombol tetap di kanan */
}
  </style>
</head>
<body>
	
<!-- HAPUS inline style="display:flex" agar tidak muncul saat awal load -->
<div id="overlay"><span>
<img src="https://raw.githubusercontent.com/digitalmtq/web/main/gear.gif"></span>
</div>

<div class="container"> 
  <!-- Halaman Login -->
  <div id="login-card" class="card">
    
    <!-- Header Login (Logo + Judul) -->
    <div class="login-header">
    <img src="https://raw.githubusercontent.com/tahfizpis/web/main/SD-IT-removebg-preview.png" alt="Logo Mutaba'ah Tahfizh" />
	<br>
   <h1 class="judul">Mutaba'ah Tahfizh SD-IT PIS Bima</h1>
    </div>

    <!-- Form Login -->
    <form id="login-form">
      <input type="text" id="username" placeholder="Username" required />
      
      <div class="password-group" style="display: flex; align-items: center;">
        <div class="password-wrapper">
          <input type="password" id="password" placeholder="Password" required />
          <span id="toggle-password" class="toggle-password">üëÅ</span>
        </div>
        <button type="submit">Masuk</button>
      </div>

      <div class="login-actions">
        <button type="button" onclick="toggleChangePassword()">Ganti Password</button>
        <button type="button" onclick="munculkanModalDaftarAdmin()">Daftar Admin</button>
        <button type="button" onclick="munculkanValidasiAdmin()">Daftar User Kelas</button>
        <button type="button" onclick="bukaModalTambahKelas()">Tambah Kelas</button>
        <button type="button" onclick="munculkanValidasiAdminNIS()">Daftar User NIS</button>
      </div>
    </form>


	  <!-- Overlay Ganti Password -->
<div id="change-password-overlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:20px; border-radius:8px; width:300px; position:relative;">
    <h3 style="margin-top:0;">Ganti Password</h3>
    <input type="text" id="change-username" placeholder="Username" required style="width:80%; margin-bottom:8px;" />
    <input type="password" id="old-password" placeholder="Password Lama" required style="width:80%; margin-bottom:8px;" />
<input type="password" id="new-password" placeholder="Password Baru" required style="width:80%; margin-bottom:8px;" />

<label style="display:block; margin-bottom:10px;">
  <input type="checkbox" onclick="togglePasswordVisibility()"> Lihat Password
</label>
    <button id="save-password-btn" type="button" onclick="submitPasswordChange()" style="width:90%;">Simpan</button>
    <p id="change-password-msg" style="color:red; margin-top:10px;"></p>
    <button onclick="toggleChangePassword()" style="position:absolute; top:5px; right:10px;">‚úñ</button>
  </div>
</div>

    <p id="login-error" style="color: red; display: none;">Username atau password salah!</p>
    
  </div>
</div>

	<script>
  function toggleChangePassword() {
    const overlay = document.getElementById("change-password-overlay");
    overlay.style.display = overlay.style.display === "flex" ? "none" : "flex";
    document.getElementById("change-password-msg").textContent = "";
  }

  async function submitPasswordChange() {
    const username = document.getElementById("change-username").value.trim();
    const oldPassword = document.getElementById("old-password").value;
    const newPassword = document.getElementById("new-password").value;
    const msgEl = document.getElementById("change-password-msg");
    const saveBtn = document.getElementById("save-password-btn");

    if (!username || !oldPassword || !newPassword) {
      msgEl.textContent = "Semua kolom wajib diisi.";
      return;
    }

    saveBtn.disabled = true;
    saveBtn.textContent = "Menyimpan...";

    try {
      const res = await fetch("/api/changePassword", {
        method: "POST",
        body: JSON.stringify({ username, oldPassword, newPassword })
      });

      const data = await res.json();

      if (res.ok) {
        msgEl.style.color = "green";
        msgEl.textContent = data.message || "Berhasil mengganti password.";
        setTimeout(() => {
          toggleChangePassword(); // tutup overlay
        }, 1000);
      } else {
        msgEl.style.color = "red";
        msgEl.textContent = data.message || "Gagal mengganti password.";
      }
    } catch (err) {
      msgEl.textContent = "Terjadi kesalahan.";
    }

    saveBtn.disabled = false;
    saveBtn.textContent = "Simpan";
  }

    function togglePasswordVisibility() {
    const oldPass = document.getElementById("old-password");
    const newPass = document.getElementById("new-password");

    const type = oldPass.type === "password" ? "text" : "password";
    oldPass.type = type;
    newPass.type = type;
  }
</script>

<!-- Daftar Admin -->
<!-- Modal Validasi Admin -->
<div id="modalAdminDaftar" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>Masukkan Password Admin</h3>
    <label>Password Admin: <input type="password" id="adminPasswordInputDaftar"></label>
    <p id="adminErrorDaftar" style="color:red;"></p>
    <button onclick="cekPasswordAdminDaftar()">Submit</button>
    <button onclick="tutupModal('modalAdminDaftar')">Close</button>
  </div>
</div>

<!-- Modal Form Daftar Admin -->
<div id="modalDaftarAdmin" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>Daftar Admin</h3>

    <label>Username: <input type="text" id="usernameAdmin"></label><br>
    <label>Password: <input type="password" id="passwordAdmin"></label><br>
    <label><input type="checkbox" onclick="toggleLihatPasswordAdmin()"> Lihat Password</label><br><br>

    <button onclick="buatAdminBaru()">Create Admin</button>
    <button onclick="tutupModal('modalDaftarAdmin')">Close</button>

    <p id="daftarAdminError" style="color:red;"></p>
    <p id="daftarAdminSuccess" style="color:green;"></p>
  </div>
</div>

	<script>
function munculkanModalDaftarAdmin() {
  document.getElementById("modalAdminDaftar").style.display = "flex";
}

// Toggle password
function toggleLihatPasswordAdmin() {
  const input = document.getElementById("passwordAdmin");
  input.type = input.type === "password" ? "text" : "password";
}

// Validasi password admin
async function cekPasswordAdminDaftar() {
  const password = document.getElementById("adminPasswordInputDaftar").value.trim();
  const errorEl = document.getElementById("adminErrorDaftar");
  errorEl.textContent = "";

  if (!password) {
    errorEl.textContent = "Password admin wajib diisi.";
    return;
  }

  try {
    const res = await fetch("/api/cek-admin", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ password }),
    });

    const data = await res.json();
    if (!res.ok) {
      errorEl.textContent = data.message || "Password admin salah.";
      return;
    }

    // Sembunyikan modal validasi dan tampilkan modal daftar admin
    tutupModal("modalAdminDaftar");
    document.getElementById("modalDaftarAdmin").style.display = "flex";

  } catch (err) {
    console.error(err);
    errorEl.textContent = "Terjadi kesalahan saat menghubungi server.";
  }
}

// Fungsi membuat admin baru
async function buatAdminBaru() {
  const username = document.getElementById("usernameAdmin").value.trim();
  const password = document.getElementById("passwordAdmin").value;
  const errorEl = document.getElementById("daftarAdminError");
  const successEl = document.getElementById("daftarAdminSuccess");

  errorEl.textContent = "";
  successEl.textContent = "";

  if (!username || !password) {
    errorEl.textContent = "Username dan password wajib diisi.";
    return;
  }

  const konfirmasi = confirm(`Yakin ingin mendaftar admin baru: ${username}?`);
  if (!konfirmasi) return;

  try {
    const res = await fetch("/api/daftar-user", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, password, role: "admin" }),
    });

    const hasil = await res.json();

    if (res.ok) {
      successEl.textContent = "üéâ Pendaftaran berhasil! Silakan login.";
      document.getElementById("usernameAdmin").value = "";
      document.getElementById("passwordAdmin").value = "";
    } else {
      errorEl.textContent = hasil.message || "Gagal mendaftar.";
    }

  } catch (err) {
    console.error(err);
    errorEl.textContent = "Terjadi kesalahan saat menghubungi server.";
  }
}

// Fungsi tutup modal
function tutupModal(id) {
  document.getElementById(id).style.display = "none";
}
</script>



	<!-- Daftar User Kelas -->
<div id="modalAdmin" class="modal"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:9999;">
  <div class="modal-content"
       style="background:#fff; padding:20px; border-radius:8px; width:min(420px,92%);
              max-height:80%; overflow:auto;">
    <h3>Masukkan Password Admin</h3>
    <label>Password Admin: <input type="password" id="adminPasswordInput"></label>
    <p id="adminError" style="color:red;"></p>
    <button onclick="cekPasswordAdmin()">Submit</button>
    <button onclick="tutupModal('modalAdmin')">Close</button>
  </div>
</div>

<!-- Modal Form Daftar Akun -->
<div id="modalDaftar" class="modal"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:9999;">
  <div class="modal-content"
       style="background:#fff; padding:20px; border-radius:8px; width:min(560px,96%);
              max-height:80%; overflow:auto;">
    <h3>Daftar User Kelas</h3>
    <label>Username: <input type="text" id="newUsername"></label><br>
    <label>Password: <input type="password" id="newPassword"></label>
    <br><br>
    <label><input type="checkbox" onclick="toggleLihatPassword()"> Lihat Password</label><br><br>

    <!-- Kontainer daftar kelas (akan diisi <select multiple> oleh ambilDaftarKelas) -->
    <div id="kelasCheckboxContainer">üîÑ Memuat daftar kelas...</div><br>

    <button onclick="buatAkunBaru()">Create Account</button>
    <button onclick="tutupModal('modalDaftar')">Close</button>
    <p id="daftarError" style="color:red;"></p>
    <p id="daftarSuccess" style="color:green;"></p>
  </div>
</div>

<script>
function munculkanValidasiAdmin() {
  document.getElementById("modalAdmin").style.display = "flex";
  document.getElementById("adminPasswordInput").value = "";
  document.getElementById("adminError").textContent = "";
}

// Fungsi untuk cek password admin
async function cekPasswordAdmin() {
  const password = document.getElementById("adminPasswordInput").value;

  if (!password) {
    document.getElementById("adminError").textContent = "Password wajib diisi.";
    return;
  }

  const response = await fetch('/api/cek-admin', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ password })
  });

  const result = await response.json();

  if (response.status === 200) {
    tutupModal("modalAdmin");
    bukaFormDaftar(password); // password disimpan sementara
  } else {
    document.getElementById("adminError").textContent = result.message || "Gagal validasi.";
  }
}

// Buka modal daftar setelah validasi admin sukses
let adminPasswordGlobal = "";
function bukaFormDaftar(adminPass) {
  adminPasswordGlobal = adminPass;
  document.getElementById("modalDaftar").style.display = "flex";
  document.getElementById("daftarError").textContent = "";
  document.getElementById("daftarSuccess").textContent = "";
  ambilDaftarKelas(); // Load daftar kelas
}

// Tutup modal
function tutupModal(id) {
  document.getElementById(id).style.display = "none";
}

// Toggle lihat password
function toggleLihatPassword() {
  const pwField = document.getElementById("newPassword");
  pwField.type = pwField.type === "password" ? "text" : "password";
}

/* ===========================
   REVISI: ambilDaftarKelas()
   =========================== */
async function ambilDaftarKelas() {
  const container = document.getElementById("kelasCheckboxContainer");
  container.innerHTML = '<select id="kelasSelect" multiple size="10" style="width:100%;margin:6px 0;"></select>';
  const sel = document.getElementById("kelasSelect");

  try {
    // Ambil daftar kelas dari API D1
    let list = [];
    const r = await fetch("/api/ambil-kelas");
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    list = await r.json();

    // Validasi isi
    if (!Array.isArray(list) || list.length === 0) {
      sel.outerHTML = "‚ùå Tidak ada kelas di database. Tambahkan dulu lewat menu Tambah Kelas.";
      return;
    }

    // Render opsi sekali saja
    sel.innerHTML = list.map(kelas => `<option value="${kelas}">${kelas}</option>`).join('');
  } catch (err) {
    console.error("Gagal memuat kelas:", err);
    // Ganti select dengan pesan error jika gagal
    if (sel) sel.replaceWith(document.createTextNode("‚ùå Gagal memuat kelas."));
  }
}

/* ===========================
   REVISI: buatAkunBaru() ‚Äî ambil kelas dari <select multiple>
   =========================== */
async function buatAkunBaru() {
  const username = document.getElementById("newUsername").value.trim();
  const password = document.getElementById("newPassword").value.trim();

  // ambil dari <select multiple>
  const kelasChecked = Array.from(document.getElementById('kelasSelect')?.selectedOptions || [])
    .map(o => o.value);

  const errorEl = document.getElementById("daftarError");
  const successEl = document.getElementById("daftarSuccess");

  errorEl.textContent = "";
  successEl.textContent = "";

  if (!username || !password || kelasChecked.length === 0) {
    errorEl.textContent = "Semua kolom dan kelas wajib diisi.";
    return;
  }

  const payload = {
    username,
    password,
    kelas: kelasChecked,
    adminPassword: adminPasswordGlobal
  };

  try {
    const res = await fetch('/api/daftar-khusus', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const result = await res.json();

    if (res.status === 200) {
      successEl.textContent = "üü¢ Akun berhasil dibuat.";
      // Reset form
      document.getElementById("newUsername").value = "";
      document.getElementById("newPassword").value = "";
      // kosongkan pilihan
      const sel = document.getElementById('kelasSelect');
      if (sel) Array.from(sel.options).forEach(o => o.selected = false);
    } else {
      errorEl.textContent = result.message || "‚ùå Gagal membuat akun.";
    }
  } catch (err) {
    console.error("Gagal kirim data:", err);
    errorEl.textContent = "Terjadi kesalahan jaringan.";
  }
}
</script>



<!-- Tambah Kelas (Password) -->
<div id="modalTambahKelasPassword" class="modal"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:9999;">
  <div class="modal-content"
       style="background:#fff; padding:20px; border-radius:8px; width:min(420px,92%);
              max-height:80%; overflow:auto;">
    <h3>Verifikasi Admin</h3>
    <label>Password Admin: <input type="password" id="inputPasswordTambahKelas"></label>
    <p id="statusPasswordTambahKelas" style="color:red;"></p>
    <button onclick="verifikasiAdminTambahKelas()">Submit</button>
    <button onclick="tutupModal('modalTambahKelasPassword')">Close</button>
  </div>
</div>

<!-- Form Tambah Kelas -->
<div id="modalFormTambahKelas" class="modal"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:9999;">
  <div class="modal-content"
       style="background:#fff; padding:20px; border-radius:8px; width:min(560px,96%);
              max-height:80%; overflow:auto;">
    <h3>Tambah Kelas Baru</h3>
    <p>Kelas yang sudah ada:</p>
    <!-- Kontainer akan diganti jadi <select size=10> oleh JS -->
    <ul id="listKelasTersedia"></ul>

    <input type="number" id="inputNomorKelasBaruTambah" placeholder="Contoh: 7" />
    <button onclick="submitTambahKelasBaru()">Buat</button>
    <button onclick="tutupModal('modalFormTambahKelas')">Close</button>
    <p id="statusTambahKelasBaru" style="color:red;"></p>
  </div>
</div>

<script>
let passwordTambahKelas = "";

function bukaModalTambahKelas() {
  document.getElementById("modalTambahKelasPassword").style.display = "flex";
}

function tutupModal(id) {
  document.getElementById(id).style.display = "none";
}

async function verifikasiAdminTambahKelas() {
  const passInput = document.getElementById("inputPasswordTambahKelas").value;
  const status = document.getElementById("statusPasswordTambahKelas");
  status.textContent = "‚è≥ Mengecek...";

  const res = await fetch("/api/cek-admin", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ password: passInput })
  });

  const result = await res.json();
  if (res.ok) {
    passwordTambahKelas = passInput;
    tutupModal("modalTambahKelasPassword");
    tampilkanFormTambahKelasBaru();
  } else {
    status.textContent = result.message || "‚ùå Password salah.";
  }
}

/* ===== REVISI: render listKelasTersedia sebagai <select size=10> (scroll otomatis) ===== */
async function tampilkanFormTambahKelasBaru() {
  const list = document.getElementById("listKelasTersedia");
  const status = document.getElementById("statusTambahKelasBaru");
  document.getElementById("inputNomorKelasBaruTambah").value = "";
  list.innerHTML = "<li>üîÑ Mengambil data kelas...</li>";
  status.textContent = "";

  try {
    const res = await fetch("/api/ambil-kelas");
    const kelas = await res.json();

    // Ganti <ul id="listKelasTersedia"> menjadi <div id="listKelasTersedia"><select ...></select></div>
    list.outerHTML = '<div id="listKelasTersedia"><select id="listKelasTersediaSelect" size="10" style="width:100%;margin:6px 0;"></select></div>';
    const sel = document.getElementById("listKelasTersediaSelect");

    if (Array.isArray(kelas) && kelas.length) {
      sel.innerHTML = kelas.map(nama => `<option>${nama}</option>`).join("");
    } else {
      document.getElementById("listKelasTersedia").innerHTML = "‚ùå Gagal/tidak ada daftar kelas.";
    }

    document.getElementById("modalFormTambahKelas").style.display = "flex";
  } catch (err) {
    // fallback pesan error
    list.innerHTML = "<li>‚ùå Gagal mengambil daftar kelas.</li>";
  }
}

async function submitTambahKelasBaru() {
  const nomor = document.getElementById("inputNomorKelasBaruTambah").value.trim();
  const status = document.getElementById("statusTambahKelasBaru");

  if (!nomor) {
    status.textContent = "‚ùó Nomor kelas harus diisi.";
    return;
  }

  status.textContent = "‚è≥ Mengirim permintaan...";
  const res = await fetch("/api/buat-kelas-baru", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ namaFile: `kelas_${nomor}.json` })
  });

  const result = await res.json();
  if (res.ok) {
    status.style.color = "green";
    status.textContent = "üü¢ Kelas berhasil dibuat.";
    setTimeout(() => tutupModal("modalFormTambahKelas"), 1500);
  } else {
    status.style.color = "red";
    status.textContent = result.message || "‚ùå Gagal membuat kelas.";
  }
}
</script>



<!-- Modal Validasi Admin NIS -->
<div id="modalAdminNIS" class="modal"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:9999;">
  <div class="modal-content"
       style="background:#fff; padding:20px; border-radius:8px; width:min(420px,92%);
              max-height:80%; overflow:auto;">
    <h3>Validasi Admin</h3>
    <label>Password Admin: <input type="password" id="adminPasswordInputNIS"></label>
    <p id="adminErrorNIS" style="color:red;"></p>
    <button onclick="cekPasswordAdminNIS()">Submit</button>
    <button onclick="tutupModal('modalAdminNIS')">Close</button>
  </div>
</div>

<!-- Modal Daftar User NIS -->
<div id="modalDaftarNIS" class="modal"
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:9999;">
  <div class="modal-content"
       style="background:#fff; padding:20px; border-radius:8px; width:min(600px,96%);
              max-height:80%; overflow:auto;">
    <h3>Daftar User NIS</h3>
    <label>Username: <input type="text" id="newUsernameNIS"></label><br>
    <label>Password: <input type="password" id="newPasswordNIS"></label><br>
    <label><input type="checkbox" onclick="toggleLihatPasswordNIS()"> Lihat Password</label><br><br>

    <!-- akan diisi <select multiple> oleh JS -->
    <div id="kelasCheckboxContainerNIS">üîÑ Memuat daftar kelas...</div><br>
    <!-- akan diisi <select multiple> oleh JS -->
    <div id="nisCheckboxContainer">üîÑ Pilih kelas dahulu...</div><br>

    <button onclick="buatUserNIS()">Create User NIS</button>
    <button onclick="tutupModal('modalDaftarNIS')">Close</button>
    <p id="daftarNISError" style="color:red;"></p>
    <p id="daftarNISSuccess" style="color:green;"></p>
  </div>
</div>

<script>
/* =========================
   Helper kecil (tetap)
========================= */
const _norm = v => String(v ?? '').trim().toLowerCase();
const _fetchJson = async (url, opt) => {
  const r = await fetch(url, opt);
  let data = null;
  try { data = await r.json(); } catch {}
  if (!r.ok) throw new Error((data && (data.error || data.message)) || `${r.status} ${r.statusText}`);
  return data;
};

let adminPasswordGlobalNIS = "";
let usedNisSet = new Set(); // diisi dari /api/getUsersNis

// Tampilkan modal validasi admin (tetap)
function munculkanValidasiAdminNIS() {
  document.getElementById("modalAdminNIS").style.display = "flex";
  document.getElementById("adminPasswordInputNIS").value = "";
  document.getElementById("adminErrorNIS").textContent = "";
}

// Cek password admin (tetap)
async function cekPasswordAdminNIS() {
  const password = document.getElementById("adminPasswordInputNIS").value;
  if (!password) { 
    document.getElementById("adminErrorNIS").textContent = "Password wajib diisi."; 
    return; 
  }

  try {
    const res = await fetch('/api/cekAdminWali', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ password })
    });
    const result = await res.json();

    if (res.status === 200) {
      adminPasswordGlobalNIS = password;
      tutupModal("modalAdminNIS");
      bukaFormDaftarNIS();
    } else {
      document.getElementById("adminErrorNIS").textContent = result.message || "Gagal validasi.";
    }
  } catch (e) {
    document.getElementById("adminErrorNIS").textContent = e.message || "Gagal validasi.";
  }
}

// Buka modal daftar NIS (tetap)
async function bukaFormDaftarNIS() {
  document.getElementById("modalDaftarNIS").style.display = "flex";
  document.getElementById("daftarNISError").textContent = "";
  document.getElementById("daftarNISSuccess").textContent = "";
  document.getElementById("kelasCheckboxContainerNIS").innerHTML = "üîÑ Memuat daftar kelas...";
  document.getElementById("nisCheckboxContainer").innerHTML = "üîÑ Pilih kelas dahulu...";

  // Ambil daftar NIS yang SUDAH terdaftar (tetap)
  try {
    const { usedNis = [] } = await _fetchJson('/api/getUsersNis');
    usedNisSet = new Set(usedNis.map(_norm));
  } catch (e) {
    usedNisSet = new Set();
    console.warn('Gagal ambil used NIS:', e);
  }

  // Ambil daftar kelas
  ambilDaftarKelasNIS();
}

// Tutup modal (tetap)
function tutupModal(id) { document.getElementById(id).style.display = "none"; }

// Toggle password (tetap)
function toggleLihatPasswordNIS() {
  const pwField = document.getElementById("newPasswordNIS");
  pwField.type = pwField.type === "password" ? "text" : "password";
}

/* =========================
   REVISI: Ambil daftar kelas ‚Üí <select multiple size=8>
========================= */
async function ambilDaftarKelasNIS() {
  const container = document.getElementById("kelasCheckboxContainerNIS");
  container.innerHTML = '<select id="kelasSelectNIS" multiple size="8" style="width:100%;margin:6px 0;"></select>';
  const sel = document.getElementById("kelasSelectNIS");
  try {
    const res = await fetch("/api/ambil-kelas");
    const kelasList = await res.json();

    if (!Array.isArray(kelasList) || !kelasList.length) {
      container.innerHTML = "‚ùå Gagal/tidak ada kelas.";
      return;
    }
    sel.innerHTML = kelasList.map(kelas => `<option value="${kelas}">${kelas}</option>`).join('');
    sel.addEventListener('change', () => ambilDaftarNIS()); // panggil saat pilihan berubah
  } catch(err) {
    console.error(err);
    container.innerHTML = "‚ùå Gagal memuat kelas.";
  }
}

/* =========================
   REVISI: Ambil daftar NIS ‚Üí <select multiple size=10>
========================= */
async function ambilDaftarNIS(/*kelasDiklik*/) {
  const container = document.getElementById("nisCheckboxContainer");
  container.innerHTML = "üîÑ Memuat NIS...";

  // ambil kelas terpilih dari <select>
  const selK = document.getElementById("kelasSelectNIS");
  const kelasDipilih = selK ? Array.from(selK.selectedOptions).map(o => o.value) : [];

  if (!kelasDipilih.length) {
    container.innerHTML = "üîÑ Pilih kelas dahulu...";
    return;
  }

  try {
    const settled = await Promise.allSettled(
      kelasDipilih.map(k => fetch(`/api/ambil-kelas-nis?kelas=${encodeURIComponent(k)}`).then(r => r.json()))
    );

    const mapByNis = new Map(); // key = norm(nis) -> {nis, nama}
    for (const it of settled) {
      if (it.status !== 'fulfilled' || !Array.isArray(it.value)) continue;
      for (const s of it.value) {
        const nisRaw = s?.nis ?? s?.NIS ?? s?.id ?? '';
        const key = _norm(nisRaw);
        if (!key) continue;
        if (usedNisSet.has(key)) continue; // sembunyikan yang sudah terdaftar
        if (!mapByNis.has(key)) {
          mapByNis.set(key, { nis: String(nisRaw).trim(), nama: String(s?.nama ?? s?.name ?? '').trim() });
        }
      }
    }

    const items = [...mapByNis.values()].sort((a,b) => String(a.nis).localeCompare(String(b.nis), 'id'));

    if (!items.length) {
      container.innerHTML = "Semua NIS telah habis digunakan untuk membuat akun.";
      return;
    }

    container.innerHTML = '<select id="nisSelect" multiple size="10" style="width:100%;margin:6px 0;"></select>';
    document.getElementById('nisSelect').innerHTML =
      items.map(santri => `<option value="${santri.nis}">${santri.nis} - ${santri.nama}</option>`).join('');
  } catch(err) {
    console.error(err);
    container.innerHTML = "‚ùå Gagal memuat NIS.";
  }
}

/* =========================
   REVISI: buatUserNIS() ‚Äî baca dari <select> baru
========================= */
async function buatUserNIS() {
  const username = document.getElementById("newUsernameNIS").value;
  const password = document.getElementById("newPasswordNIS").value;

  // ambil dari <select> (bukan checkbox)
  const kelasSelect = document.getElementById('kelasSelectNIS');
  const nisSelect   = document.getElementById('nisSelect');
  const kelas = kelasSelect ? Array.from(kelasSelect.selectedOptions).map(o => o.value) : [];
  const nis   = nisSelect   ? Array.from(nisSelect.selectedOptions).map(o => o.value)   : [];

  if (!username || !password) { 
    document.getElementById("daftarNISError").textContent = "Username & Password wajib diisi."; 
    return; 
  }
  if (!nis.length) { 
    document.getElementById("daftarNISError").textContent = "Pilih minimal 1 NIS."; 
    return; 
  }

  // Safety kecil: hindari NIS yang sudah used
  const adaDup = nis.some(n => usedNisSet.has(_norm(n)));
  if (adaDup) {
    document.getElementById("daftarNISError").textContent = "Ada NIS yang sudah terdaftar. Muat ulang daftar lalu pilih lagi.";
    return;
  }

  try {
    const res = await fetch('/api/daftarNisWali', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ username, password, kelas, nis, adminPassword: adminPasswordGlobalNIS })
    });
    const result = await res.json();

    if (res.status === 200) {
      document.getElementById("daftarNISSuccess").textContent = result.message || "Berhasil membuat user NIS.";
      document.getElementById("daftarNISError").textContent = "";

      // update usedNisSet + reset pilihan
      nis.forEach(n => usedNisSet.add(_norm(n)));
      if (nisSelect) Array.from(nisSelect.options).forEach(o => o.selected = false);

      // refresh daftar NIS sesuai kelas yang masih terpilih
      ambilDaftarNIS();
    } else {
      document.getElementById("daftarNISError").textContent = result.message || "Gagal membuat user NIS.";
    }
  } catch (err) {
    document.getElementById("daftarNISError").textContent = err.message || "Gagal membuat user NIS.";
  }
}
</script>


  
    <!-- Dashboard -->
    <div id="dashboard-card" class="card" style="display: none;">
      <h1>Mutaba'ah Hafalan Al-Qur'an SD PIS</h1>
      <h2>Ahlan, <span id="namaUser"></span>!</h2>

     
<div class="dashboard-header">
  <div class="dashboard-header-row">
    <select id="kelas"></select>

    <!-- Dua tanggal dibundel agar berdampingan rapat -->
    <span class="date-pair">
      <!-- Pair 1: label nempel ke input -->
      <span class="date-item">
        <label for="tanggal">Dari</label>
        <input type="date" id="tanggal" />
      </span>

      <!-- Pair 2: label nempel ke input -->
      <span class="date-item">
        <label for="tanggal-filter-akhir">‚ü∂ sampai</label>
        <input type="date" id="tanggal-filter-akhir" />
      </span>
    </span>
  </div>
</div>

<style>
  /* Baris kontrol */
  .dashboard-header-row{
    display:flex; flex-direction:row; flex-wrap:wrap;
    align-items:center; justify-content:flex-start;
    gap:.6rem; /* jarak antara <select> dan grup tanggal */
  }

  /* Grup dua tanggal (jangan melar, berdampingan rapat) */
  .date-pair{
    display:flex; align-items:center; flex-wrap:nowrap;
    gap:0;              /* tidak ada gap antar pair, kita atur manual di bawah */
    flex:0 0 auto;
  }

  /* Tiap pair: label nempel ke input, tanpa renggang */
  .date-item{
    display:inline-flex; align-items:center; white-space:nowrap;
    gap:0;              /* NOL: label menempel ke input */
    flex:0 0 auto; justify-content:flex-start; width:auto;
  }
  .date-item label{
    margin:0; line-height:1; display:inline-flex; align-items:center;
  }
  .date-item input{
    margin-left:2px;    /* jarak sangat kecil agar tidak dempet total */
  }

  /* Lebar input tanggal kompak */
  #tanggal, #tanggal-filter-akhir{
    width:16ch; min-width:14ch;
  }

  /* === Mobile (<=600px) === */
  @media (max-width:600px){
    #kelas{ flex:1 1 100%; max-width:100%; } /* select 1 baris penuh */
    .dashboard-header-row{ gap:.5rem; }

    /* jarak ANTAR pair (antara "Dari"‚Ä¶ dan "sampai"‚Ä¶) kecil & konsisten */
    .date-item + .date-item{ margin-left:.35rem; }  /* ~5-6px */

    /* tetap rapat antara label & input */
    .date-item input{ margin-left:2px; }
  }

  /* === Desktop (>=601px): tiga kolom sejajar */
  @media (min-width:601px){
    .dashboard-header-row{ flex-wrap:nowrap; }
    .date-item + .date-item{ margin-left:.5rem; }   /* sedikit lebih lega di desktop */
  }
</style>
		

      <table id="santri-table">
        <thead>
          <tr>
            <th>Nis</th>
            <th>Nama</th>
			<th>Kelas</th>
            <th>Level</th>
            <th>Presensi</th>
			<th>SP</th>
            <th>Setor Dari</th>
            <th>Setor Sampai</th>
			<th>Page</th>
			<th>Total Page</th>
			<th>Juz</th>
            <th>Total Juz</th>
            <th>Nilai</th>
            <th id="totalAllJuzHeader" style="cursor:pointer; text-decoration:underline;">Setting THMS</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button onclick="bukaModalSantri()" style="margin-left:0px;">Tambah Santri</button>
      <button id="btnHapusSantri">Hapus Santri</button>
	  <button id="btnPindahKelas">Pindah Kelas</button>
      
	<div class="actions" 
    style="display:flex; align-items:center; gap:.5rem; flex-direction:row; flex-wrap:nowrap; overflow-x:auto; -webkit-overflow-scrolling:touch;">

  <button id="save-btn">Simpan Data</button>
  <button id="openPdfModal">Unduh Data</button>
  <button id="editBtnIndex" type="button">HTML</button>

<!-- Modal Utama: Rentang Tanggal + Aksi -->
<div id="pdfModalOverlay" style="
  display:none; 
  position:fixed; 
  top:0; left:0; 
  width:100%; height:100%; 
  background:rgba(0,0,0,0.5); 
  z-index:999; 
  justify-content:center; 
  align-items:center;">
  
  <div style="background:#fff; padding:20px; border-radius:8px; min-width:320px; max-width:90%;">
    <h3>Download Rekap Nilai</h3>
    
    <!-- Kontrol Rekap: 3 baris x 2 kolom -->
    <div class="pdf-rekap-controls">
      <!-- Row 1, Col 1: Mulai -->
      <div class="date-item">
        <label for="pdf-start-date">Mulai</label>
        <input type="date" id="pdf-start-date" />
      </div>

      <!-- Row 1, Col 2: s/d -->
      <div class="date-item">
        <label for="pdf-end-date">s/d</label>
        <input type="date" id="pdf-end-date" />
      </div>

      <!-- Toggle Rentang Absensi (opsional) -->
      <div class="date-item" style="align-items:center;">
        <label for="use-absensi-range" style="display:inline-flex; gap:.35rem; align-items:center; font-weight:600;">
          <input type="checkbox" id="use-absensi-range" />
          Rentang Absensi (opsional)
        </label>
      </div>
      <div></div>

      <!-- Absensi Mulai / s.d (muncul jika toggle aktif) -->
      <div class="date-item absensi-range" style="display:none;">
        <label for="absensi-start-date">Mulai</label>
        <input type="date" id="absensi-start-date" disabled />
      </div>
      <div class="date-item absensi-range" style="display:none;">
        <label for="absensi-end-date">s/d</label>
        <input type="date" id="absensi-end-date" disabled />
      </div>

      <!-- Row 2, Col 1: PDF Halaqoh -->
      <button id="download-pdf-rekap" class="rekap-btn">PDF Halaqoh</button>

      <!-- Row 2, Col 2: Excel All Halaqoh -->
      <button id="download-xls-rekap" class="rekap-btn">Excel All Halaqoh</button>

      <!-- Row 3, Col 1: PDF Individual -->
      <button id="download-pdf-santri" class="rekap-btn">PDF Individual</button>

      <!-- Row 3, Col 2: PDF All Halaqoh -->
      <button id="download-pdf-allkelas" class="rekap-btn">PDF All Halaqoh</button>
    </div>

    <!-- Tombol tutup -->
    <div style="text-align:right; margin-top:15px;">
      <button id="closePdfModal">Tutup</button>
    </div>
  </div>
</div>

<!-- CSS khusus modal ini saja -->
<style>
  #pdfModalOverlay .absensi-range input[type="date"]{
    width:12ch; min-width:10ch;
  }
  /* Grid 2 kolom untuk 6 item (3 baris) */
  #pdfModalOverlay .pdf-rekap-controls{
    display:grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap:.6rem .8rem;              /* row-gap, column-gap */
    align-items:center;
    margin-top:.5rem;
  }
  /* Label nempel ke input & kompak */
  #pdfModalOverlay .date-item{
    display:inline-flex; align-items:center; gap:.2rem; white-space:nowrap;
  }
  #pdfModalOverlay .date-item input[type="date"]{
    width:12ch; min-width:10ch;
  }
  /* Tombol melebar mengikuti kolom agar sejajar rapi */
  #pdfModalOverlay .rekap-btn{
    width:100%;
  }
</style>

<!-- Modal Kedua: Pilih Santri (muncul saat klik "PDF per Santri") -->
<div id="santriModalOverlay" style="
  display:none; 
  position:fixed; 
  top:0; left:0; 
  width:100%; height:100%; 
  background:rgba(0,0,0,0.5); 
  z-index:1000; 
  justify-content:center; 
  align-items:center;">
  
  <div style="background:#fff; padding:20px; border-radius:8px; min-width:320px; max-width:90%;">
    <h3>Pilih Santri</h3>

    <div class="pdf-rekap-controls" style="margin-top:.75rem;">
      <label for="pdf-santri-select" style="min-width:260px;">
        <span>Santri</span>
        <select id="pdf-santri-select">
          <option value="">Memuat‚Ä¶</option>
        </select>
      </label>

      <button id="okSantriSelect" class="rekap-btn" style="background:#0ea5e9;">OK</button>
      <button id="cancelSantriSelect" class="rekap-btn" style="background:#6b7280;">Batal</button>
    </div>
  </div>
</div>
<button class="logout-btn" id="logout-btn">Keluar</button>
</div>

<script>
  // -------- Modal Utama --------
  const openPdfModal = document.getElementById("openPdfModal");
  const pdfModalOverlay = document.getElementById("pdfModalOverlay");
  const closePdfModal = document.getElementById("closePdfModal");

  openPdfModal?.addEventListener("click", () => {
    pdfModalOverlay.style.display = "flex";
  });

  closePdfModal?.addEventListener("click", () => {
    pdfModalOverlay.style.display = "none";
  });

  pdfModalOverlay?.addEventListener("click", (e) => {
    if (e.target === pdfModalOverlay) pdfModalOverlay.style.display = "none";
  });

  // -------- Modal Pilih Santri (kedua) --------
  const santriModalOverlay = document.getElementById("santriModalOverlay");
  const okSantriSelect = document.getElementById("okSantriSelect");
  const cancelSantriSelect = document.getElementById("cancelSantriSelect");

  // Buka modal kedua saat klik "PDF per Santri"
  document.getElementById("download-pdf-santri")?.addEventListener("click", async () => {
    santriModalOverlay.style.display = "flex";
    try { if (window._populateSantriSelect) await window._populateSantriSelect(); } catch(e){}
  });

  // OK => generate PDF per santri
  okSantriSelect?.addEventListener("click", async () => {
    try {
      if (window._pdfSantriDownload) {
        await window._pdfSantriDownload(); // validasi & generate
        santriModalOverlay.style.display = "none"; // sukses => tutup
      }
    } catch (e) {
      console.error(e); // gagal => biarkan modal tetap terbuka
    }
  });

  // Batal / klik luar untuk tutup
  cancelSantriSelect?.addEventListener("click", () => {
    santriModalOverlay.style.display = "none";
  });
  santriModalOverlay?.addEventListener("click", (e) => {
    if (e.target === santriModalOverlay) santriModalOverlay.style.display = "none";
  });


  // === Toggle UI "Rentang Absensi" + PERSISTENCE TERPISAH ===
  (function initAbsensiRangeUI(){
    const chk   = document.getElementById('use-absensi-range');
    const sEl   = document.getElementById('absensi-start-date');
    const eEl   = document.getElementById('absensi-end-date');
    const group = document.querySelectorAll('.absensi-range');
    const kelasEl = document.getElementById('kelasSelect');

    if (!sEl || !eEl) return;

    // kunci storage khusus absensi (per kelas)
    const keyFor = () => `raportahfiz.absensiRange.${kelasEl?.value || 'ALL'}`;
    const isISO = v => /^\d{4}-\d{2}-\d{2}$/.test(v);

    // flag untuk mencegah auto-copy setelah hydrate
    let hydrated = false;

    function save(){
      localStorage.setItem(keyFor(), JSON.stringify({
        enabled: !!(chk?.checked),
        start:   sEl.value || null,
        end:     eEl.value || null,
        t: Date.now()
      }));
    }

    function syncUI(){
      const on = !!chk?.checked;
      group.forEach(el => el.style.display = on ? '' : 'none');
      sEl.disabled = !on;
      eEl.disabled = !on;

      // auto-copy dari Periode HANYA bila:
      // - toggle ON
      // - belum pernah hydrate dari storage
      // - kedua field masih kosong
      if (on && !hydrated && !sEl.value && !eEl.value){
        const gs = document.getElementById('pdf-start-date')?.value || '';
        const ge = document.getElementById('pdf-end-date')?.value   || '';
        if (isISO(gs)) sEl.value = gs;
        if (isISO(ge)) eEl.value = ge;
      }
    }

    function load(){
      let obj = {};
      try { obj = JSON.parse(localStorage.getItem(keyFor()) || '{}'); } catch(_){}
      if (typeof obj.enabled === 'boolean' && chk) chk.checked = obj.enabled;
      if (isISO(obj.start)) sEl.value = obj.start;
      if (isISO(obj.end))   eEl.value = obj.end;
      hydrated = true;
      syncUI();
    }

    chk?.addEventListener('change', () => { syncUI(); save(); });
    sEl.addEventListener('change', save);
    eEl.addEventListener('change', save);

    // ganti kelas ‚Üí kunci berubah
    kelasEl?.addEventListener('change', () => { hydrated = false; load(); });

    if (document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', load);
    } else {
      load();
    }

    // debug helper
    window.clearSavedAbsensiRange = function(){
      localStorage.removeItem(keyFor());
      hydrated = false;
      load();
    };
  })();

  // === Ambil range ABSENSI kalau toggle aktif; kalau tidak, pakai global ===
  function getAbsensiRangeOrDefault(){
    const use = document.getElementById('use-absensi-range')?.checked;
    const as  = document.getElementById('absensi-start-date')?.value || '';
    const ae  = document.getElementById('absensi-end-date')?.value   || '';
    if (use && as && ae) return { start: as, end: ae, source: 'absensi' };
    const gs  = document.getElementById('pdf-start-date')?.value || '';
    const ge  = document.getElementById('pdf-end-date')?.value   || '';
    return { start: gs, end: ge, source: 'global' };
  }
  window.getAbsensiRangeOrDefault = getAbsensiRangeOrDefault;

  // === Buat label "Range Absensi" utk header (dipakai PDF) ===
  function buildRangeLabel(startISO, endISO){
    const { start, end, source } = getAbsensiRangeOrDefault();
    const fmt = iso => {
      const m = String(iso||'').match(/^(\d{4})-(\d{2})-(\d{2})$/);
      return m ? `${Number(m[3])}-${Number(m[2])}-${m[1]}` : (iso || '-');
    };
    if (source === 'absensi') return `${fmt(start)} s.d. ${fmt(end)}`;
    return `${fmt(startISO)} s.d. ${fmt(endISO)}`;
  }
  window.buildRangeLabel = buildRangeLabel;
</script>



	<!-- Modal Pindah Kelas -->
<div id="modalPindahKelas" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);align-items:center;justify-content:center;z-index:9999;">
  <!-- [PERUBAHAN] tambahkan max-height & overflow agar isi modal bisa scroll -->
  <div style="background:#fff;padding:16px;border-radius:10px;max-width:520px;width:92%;max-height:80%;overflow:auto;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <h3 style="margin:0;">Pindah Kelas</h3>
      <button id="closePindah" title="Tutup">‚úï</button>
    </div>

    <label><b>Pilih Santri (multi pilih):</b></label>
    <select id="selectSantriPindah" multiple size="8" style="width:100%;margin:6px 0;"></select>

    <div style="margin:8px 0;">
      <label><b>Pilih Kelas Tujuan:</b></label>
      <div id="listKelasTujuan" style="margin-top:6px;"></div>
    </div>
  <div style="display:flex;gap:8px;align-items:center;margin-top:10px;">
      <button id="doPindah" style="padding:8px 16px;">Pindahkan</button>
      <span id="statusPindah" style="font-size:.95rem;"></span>
    </div>
  </div>
</div>


<!-- Modal Overlay -->
<div id="modalHapusSantri" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center;">
  <div style="background:#fff; padding:20px; border-radius:8px; width:400px; max-height:80%; overflow:auto;">
    <h3>Pilih Santri yang Akan Dihapus</h3>
    <ul id="listSantriHapus" style="list-style:none; padding-left:0;"></ul>
    <button id="btnHapusTerpilih">Hapus</button>
    <button id="btnTutupModal">Tutup</button>
  </div>
</div>


<script>
// ==== SEMESTER FLEX ====
const SEMESTER_MAX = 604;

function isValidSemester(v, max = SEMESTER_MAX) {
  const n = Number(String(v).trim());
  return Number.isInteger(n) && n >= 1 && n <= max;
}

function extendSemesterOptions(selectEl, max = SEMESTER_MAX) {
  if (!selectEl) return;
  const existing = new Set([...selectEl.options].map(o => String(o.value)));
  const frag = document.createDocumentFragment();
  for (let i = 1; i <= max; i++) {
    const val = String(i);
    if (!existing.has(val)) {
      const opt = document.createElement("option");
      opt.value = val;
      opt.textContent = val;
      frag.appendChild(opt);
    }
  }
  if (frag.childNodes.length) selectEl.appendChild(frag);
}
</script>

	
<!-- Modal Tambah Santri -->
<div id="modalSantri" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;">
  <div style="background:#fff; width:320px; margin:100px auto; padding:20px; border-radius:10px;">
    <h2>Tambah Santri</h2>

    <label>Nama:</label><br>
    <input type="text" id="inputNama" style="width:90%; margin-bottom:10px;" />

    <label>NIS:</label><br>
    <input type="text" id="inputNis" style="width:90%; margin-bottom:10px;" />

    <label>Semester:</label><br>
    <select id="inputSemester" style="width:90%; margin-bottom:10px;">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
    </select>

    <!-- ‚¨áÔ∏è BARU: Jenjang -->
    <label>Jenjang:</label><br>
    <select id="inputJenjang" style="width:90%; margin-bottom:10px;">
  <option value=""></option>
  <option value="A1">1A</option>
  <option value="A2">1B</option>
  <option value="A3">2A</option>
  <option value="A4">2B</option>
  <option value="A5">3A</option>
  <option value="A6">3B</option>
  <option value="A7">4A</option>
  <option value="A8">4B</option>
  <option value="A9">5A1</option>
  <option value="A10">5A2</option>
  <option value="A11">5B</option>
  <option value="A12">6A1</option>
  <option value="A13">6A2</option>
  <option value="A14">6B</option>
  </select>

    <div style="margin-top:10px; display:flex; justify-content:space-between; gap:8px;">
      <button id="btnSimpanSantri" onclick="simpanSantriBaru()">Simpan</button>
      <button onclick="tutupModal('modalSantri')">‚ùå Batal</button>
    </div>

    <div id="loadingTambahSantri" style="display:none; margin-top:10px; color:blue;">
      ‚è≥ Menyimpan...
    </div>
  </div>
</div>
  
  
  <!-- ======================= OVERLAY LEMBAR PENILAIAN (TANPA PLAYBACK AUDIO) ======================= -->
<div id="overlay-quran" style="display:none; position:fixed; top:0; left:0;
     width:100%; height:100%; background:rgba(0,0,0,0.5);
     z-index:10000; justify-content:center; align-items:center;">
  <div style="background:white; padding:20px; border-radius:8px;
       max-width:800px; max-height:80vh;
       display:flex; flex-direction:column;
       overflow:hidden;">

    <!-- Baris sejajar: toggle kiri, counter kanan -->
    <div class="keterangan-row"
         style="display:flex; align-items:center; justify-content:space-between; gap:12px; direction:ltr; margin-bottom:6px;">
      <button id="toggle-keterangan" class="keterangan-toggle">Lihat Keterangan Warna</button>
      <div id="modal-mark-warna" style="font-weight:bold; font-size:16px;"></div>
    </div>

    <!-- Box keterangan (ditoggle oleh tombol di kiri) -->
    <div id="keterangan-box" class="keterangan-box">
      <p>üü© <b>Hijau</b> = kesalahan ringan (pengurangan <b>0.25</b>)<br>
        Contoh: meninggalkan tajwid seperti <i>Ikhfa, Tebal, Tipis, Hukum Ra, Qalqalah, Ghunnah, Mad Munfashil, Mad Iwad, Shafir, Dhod, Hams, Mim Sakinah</i>, dan lain-lain.</p>
      <p>üü® <b>Kuning</b> = kesalahan menengah (pengurangan <b>0.5</b>)<br>
        Contoh: salah hafalan tapi bisa memperbaiki sendiri, <i>waqof</i> dan <i>ibtida'</i> kurang tepat, dan lain-lain.</p>
      <p>üü• <b>Merah</b> = kesalahan berat (pengurangan <b>1</b>)<br>
        Contoh: kesalahan fatal mengganti huruf, <i>waqof</i> dan <i>ibtida'</i> salah, menambah atau mengurangi mad yang mengubah makna Al-Quran, atau salah hafalan kemudian dibetulkan oleh guru, dan lain-lain.</p>
    </div>

    <!-- Area teks Al-Qur'an -->
<div id="quran-text" style="
  direction:rtl; font-size:30px; line-height:2.2;

  /* kunci justify */
  text-align:justify;
  text-align-last:right;
  text-justify:inter-word;
  white-space:normal;  /* ‚Üê ganti dari pre-wrap */

  flex:1 1 auto; overflow:auto; overscroll-behavior:contain; -webkit-overflow-scrolling:touch; scrollbar-gutter:stable;
"></div>


    <hr>

    <div>
      <span id="modal-nama-santri" style="font-weight:bold; font-size:18px;"></span>
      <span id="nilai-akhir">100</span> ‚Äî <span id="predikat-akhir">MUMTAZ</span>
    </div>

    <!-- Baris aksi nilai + tombol rekam -->
<div class="manual-actions" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
  <input type="number" id="input-nilai-manual" min="0" max="100" step="0.1" style="width:90px;" placeholder="Nilai Manual">
  <button id="btn-beri-nilai">Acc</button>
  <button id="btn-reset-nilai" title="Kosongkan nilai & hapus di server">Reset</button>
  <button id="btn-open-record">Recording</button>
</div>

    <style>
      .keterangan-row{
        display:flex;
        align-items:center;
        gap:12px;
        margin-bottom:6px;
      }
      .keterangan-box {
        display: none;
        background: #f9f9f9;
        border-left: 4px solid #007bff;
        margin-top: 10px;
        padding: 12px;
        border-radius: 6px;
        font-size: 15px;
        line-height: 1.6;
      }
      .keterangan-toggle {
        all: unset;
        display: inline-block;
        font-weight: 600;
        font-size: 15px;
        letter-spacing: 0.3px;
        color: #1E88E5;
        padding: 2px 4px;
        cursor: pointer;
        position: relative;
        transition: color 0s ease;
      }
      .keterangan-toggle:hover {
        color: #ffffff;
        background:#1E88E5;
        border-radius:4px;
      }
      /* Tombol Simpan/Tutup horizontal full width */
      .modal-actions{
        display:flex; flex-direction:row; align-items:stretch; gap:10px; margin-top:12px;
      }
      .modal-actions button{
        flex:1 1 0; width:auto; padding:10px 14px; border:none; border-radius:8px; font-weight:600; cursor:pointer;
      }
      .btn-primary{ background:#1E88E5; color:#fff; }
      .btn-primary:hover{ filter:brightness(1.05); }
      .btn-secondary{ background:#e9ecef; color:#333; }
      .btn-secondary:hover{ filter:brightness(0.98); }
      @media (max-width:380px){ .modal-actions{ flex-wrap:wrap; } .modal-actions button{ flex:1 0 100%; } }
    </style>

    <!-- Tombol Simpan/Tutup -->
    <div class="modal-actions">
      <button id="save-btn-modal" class="btn-primary">Simpan</button>
      <button id="close-overlay" class="btn-secondary">Tutup</button>
    </div>

  </div>
</div>

<!-- ======================= OVERLAY REKAMAN AUDIO (SATU-SATUNYA TEMPAT PLAYBACK) ======================= -->
<div id="overlay-record" style="display:none; position:fixed; top:0; left:0;
  width:100%; height:100%; background:rgba(0,0,0,0.5);
  z-index:10001; justify-content:center; align-items:center;">
  <div style="background:white; padding:20px; border-radius:8px; width:min(720px,95vw); max-height:85vh; display:flex; flex-direction:column; overflow:auto;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
      <div style="font-weight:700; font-size:18px;">Rekam Audio</div>
      <button id="record-close" class="btn-secondary" style="border:none; padding:8px 12px; border-radius:8px; cursor:pointer;">Close</button>
    </div>
    <div style="margin-bottom:6px;">
      <span style="opacity:.7;">Santri:</span> <b id="record-nama-santri">-</b>
    </div>

    <div class="record-controls" style="display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin:6px 0 10px;">
      <button id="record-start" class="rec-btn">Recording</button>
      <button id="record-stop" class="stop-btn" disabled>Stop</button>
      <span id="record-duration">00:00</span>
      <span id="record-spinner" style="display:none; align-items:center;">
        <span class="spinner" style="margin-right:8px;"></span>
        <i style="color:#007bff;">Menyimpan...</i>
      </span>
    </div>

    <!-- Semua rekaman (lama & baru) hanya muncul di sini -->
    <ul id="record-list" style="margin:0; padding-left:18px;"></ul>

    <style>
      .rec-btn{
        background:linear-gradient(135deg,#ff4b5c,#ff0000); color:#fff; font-weight:bold; font-size:12px;
        border:none; border-radius:50px; padding:10px 22px; cursor:pointer; transition:transform .1s, box-shadow .1s;
      }
      .rec-btn:hover{ transform:scale(1.05); box-shadow:0 0 15px rgba(255,0,0,.4); }
      .stop-btn{
        background:linear-gradient(135deg,#555,#333); color:#fff; font-weight:bold; font-size:12px;
        border:none; border-radius:50px; padding:10px 22px; cursor:pointer; transition:transform .1s, box-shadow .1s;
      }
      .stop-btn:hover{ transform:scale(1.05); box-shadow:0 0 10px rgba(0,0,0,.5); }
      .spinner{
        border:4px solid #f3f3f3; border-top:4px solid #007bff; border-radius:50%;
        width:22px; height:22px; animation:spin 1s linear infinite; display:inline-block;
      }
      @keyframes spin{ 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    </style>
  </div>
</div>

<!-- ============ Library encoder MP3 (WAJIB di /js/) ============ -->
<script>window.WEB_AUDIO_WORKER_DIR = '/js/';</script>
<script src="/js/WebAudioRecorder.min.js" defer></script>
<script src="/js/WebAudioRecorderMp3.min.js" defer></script>

<script>
/* ========= STATE UTAMA ========= */
let quranData = {};
let ayahPageMap = {};
let markData = {};
let currentIdSiswa = null;     // id/nis baris aktif
let currentRowEl = null;       // <tr> aktif
const recordListEl   = document.getElementById('record-list'); // hanya di modal rekaman
const WORKER_DIR = window.WEB_AUDIO_WORKER_DIR || '/js/';       // penting untuk worker + .mem

/* ========= UTIL KELAS/TANGGAL ========= */
function getKelasTanggalAktif() {
  const kelas = document.getElementById('kelas')?.value || 'default';
  const tanggal = currentRowEl?.dataset?.tanggal || document.getElementById('tanggal')?.value || 'default';
  return { kelas, tanggal };
}

/* ========= AMBIL MARKS + AUDIO (SERVER) ========= */
async function ambilMarksDariNetlify(id, kelas, tanggal) {
  try {
    const res = await fetch(`/api/getMarksAudio?id=${id}&kelas=${kelas}&tanggal=${tanggal}`);
    if (!res.ok) throw new Error('Gagal ambil marks dari server');
    const data = await res.json();
    return data.marks || {};
  } catch(err) {
    console.error(err);
    return {};
  }
}

/* ========= AUDIO: UTIL MIME ========= */
function getMimeType(filename) {
  const ext = filename.split('.').pop().toLowerCase();
  if (ext === 'mp3') return 'audio/mpeg';
  if (ext === 'ogg') return 'audio/ogg';
  if (ext === 'webm') return 'audio/webm';
  return 'audio/wav';
}

/* ========= RENDER AUDIO HANYA DI MODAL REKAMAN ========= */
function tampilkanAudioDiModalRekam(marks) {
  recordListEl.innerHTML = '';
  if (marks && Array.isArray(marks.audio) && marks.audio.length) {
    for (const filename of marks.audio) {
      const li = document.createElement('li');
      li.innerHTML = `
        <audio controls preload="metadata" style="width:100%;">
          <source src="/api/getAudio?file=${encodeURIComponent(filename)}" type="${getMimeType(filename)}">
          Browser Anda tidak mendukung audio.
        </audio>`;
      recordListEl.appendChild(li);
    }
  }
}

/* ========= STORAGE ========= */
function getStorageKey() {
  const { kelas, tanggal } = getKelasTanggalAktif();
  return `marks_${kelas}_${tanggal}_${currentIdSiswa}`;
}
function simpanKeStorage() {
  if (!currentIdSiswa) return;
  localStorage.setItem(getStorageKey(), JSON.stringify(markData));
}
function ambilDariStorage() {
  if (!currentIdSiswa) return;
  const saved = localStorage.getItem(getStorageKey());
  markData = saved ? JSON.parse(saved) : {};
}

/* ========= HITUNG NILAI ========= */
function hitungNilai() {
  let totalMinus = 0, hijau = 0, kuning = 0, merah = 0, adaMark = false;
  for (let ayat in markData) {
    if (ayat === 'audio') continue; // abaikan daftar audio
    for (let idx in markData[ayat]) {
      const mark = markData[ayat][idx]; if (!mark) continue;
      adaMark = true;
      if (mark === "green") { totalMinus += 0.5; hijau++; }
      else if (mark === "yellow") { totalMinus += 1; kuning++; }
      else if (mark === "red") { totalMinus += 2; merah++; }
    }
  }
  let nilai = adaMark ? Math.max(0, 100 - totalMinus) : 0;
  const predikatMap = [
    { max: 59, text: "ROSIB", huruf: "D" },
    { max: 69, text: "MAQBUL", huruf: "C" },
    { max: 79, text: "JAYYID", huruf: "B" },
    { max: 89, text: "JAYYID JIDDAN", huruf: "A" },
    { max: 100, text: "MUMTAZ PLUS", huruf: "A" }
  ];
  let predikat = "-";
  if (adaMark) {
    const p = predikatMap.find(p => nilai <= p.max);
    const warna = { A: "green", B: "blue", C: "orange", D: "red" };
    predikat = `${p.text} <span style="background-color:${warna[p.huruf]};color:white;padding:0 4px;border-radius:3px;">${p.huruf}</span>`;
  }
  const nilaiEl = document.getElementById("nilai-akhir");
  const predikatEl = document.getElementById("predikat-akhir");
  if (nilaiEl) nilaiEl.innerText = nilai.toFixed(1);
  if (predikatEl) predikatEl.innerHTML = predikat;
  const warnaDiv = document.getElementById("modal-mark-warna");
  if (warnaDiv) warnaDiv.innerHTML = `üü© ${hijau} &nbsp; üü® ${kuning} &nbsp; üü• ${merah}`;
  return { nilai, predikat, hijau, kuning, merah };
}

/* ========= TOMBOL NILAI MANUAL ========= */
document.getElementById("btn-beri-nilai").onclick = function() {
  if (!currentIdSiswa) return alert("Klik 'Lembar Penilaian' dulu.");
  const v = parseFloat(document.getElementById("input-nilai-manual").value);
  if (isNaN(v) || v < 0 || v > 100) return alert("Masukkan Nilai Manual dari 0 sampai 100.");

  let pred = "-";
  if (v <= 59) pred = "ROSIB (D)";
  else if (v <= 69) pred = "MAQBUL (C)";
  else if (v <= 79) pred = "JAYYID (B)";
  else if (v <= 89) pred = "JAYYID JIDDAN (A)";
  else pred = "MUMTAZ PLUS (A)";

  // Nilai manual tidak menghapus audio
  const audioKeep = Array.isArray(markData.audio) ? { audio: [...markData.audio] } : {};
  markData = { ...audioKeep };

  document.getElementById("nilai-akhir").innerText = v.toFixed(1);
  document.getElementById("predikat-akhir").innerText = pred;
  document.getElementById("modal-mark-warna").innerHTML = `üü© 0 &nbsp; üü® 0 &nbsp; üü• 0`;

  updateNilaiDiTabel({ nilai: v, predikat: pred });

  // Matikan flag reset jika sebelumnya diaktifkan
  if (currentRowEl) {
    delete currentRowEl.dataset.resetNilai;
    const cell = [...currentRowEl.cells].find(td => td.querySelector(".lihat-quran-btn"));
    if (cell) delete cell.dataset.resetNilai;
  }
};

/* ========= TOMBOL RESET NILAI ========= */
document.getElementById("btn-reset-nilai").onclick = function () {
  if (!currentIdSiswa) return alert("Klik 'Lembar Penilaian' dulu.");

  // 1) Kosongkan tampilan di overlay
  const nilaiEl = document.getElementById("nilai-akhir");
  const predEl  = document.getElementById("predikat-akhir");
  const warnaEl = document.getElementById("modal-mark-warna");
  const inputManual = document.getElementById("input-nilai-manual");

  if (nilaiEl) nilaiEl.textContent = "";      // benar-benar kosong
  if (predEl)  predEl.innerHTML   = "";       // benar-benar kosong
  if (warnaEl) warnaEl.innerHTML  = "";       // kosongkan counter
  if (inputManual) inputManual.value = "";

  // 2) Bersihkan kolom tabel (hapus .nilai-ringkas, sisakan tombol)
  let row = currentRowEl || [...document.querySelectorAll("table tbody tr")]
    .find(r => String(r.cells[0].innerText.trim()) === String(currentIdSiswa));
  if (row) {
    const cell = [...row.cells].find(td => td.querySelector(".lihat-quran-btn"));
    if (cell) {
      cell.innerHTML = `<button class="lihat-quran-btn">Lembar Penilaian</button>`;
      cell.dataset.resetNilai = "1";
    }
    row.dataset.resetNilai = "1";
  }

  // (opsional) alert('Nilai dikosongkan. Klik "Simpan" untuk menerapkan ke server.');
};

/* ========= UPDATE TABEL ========= */
function updateNilaiDiTabel({ nilai, predikat }) {
  if (!currentIdSiswa) return;
  let row = currentRowEl || [...document.querySelectorAll("table tbody tr")]
    .find(r => String(r.cells[0].innerText.trim()) === String(currentIdSiswa));
  if (!row) return;

  // Jika mode reset aktif ‚Üí jangan tulis nilai ringkas
  if (row.dataset.resetNilai === "1") return;

  const cell = [...row.cells].find(td => td.querySelector(".lihat-quran-btn"));
  if (cell) {
    cell.innerHTML = `
      <div class="nilai-ringkas"><strong>${Number(nilai).toFixed(1)}</strong> ${predikat}</div>
      <button class="lihat-quran-btn">Lembar Penilaian</button>`;
    row.markData = JSON.parse(JSON.stringify(markData));
  }
}

/* ========= BUAT KATA KLIK ========= */
function buatKataKlik(surah, ayat, teks) {
  return teks.split(" ").map((kata, idx) => {
    const span = document.createElement("span");
    span.innerText = kata + " ";
    span.style.cursor = "pointer";
    span.dataset.key = `${surah}:${ayat}`;
    span.dataset.idx = idx;
    span.onclick = () => {
      const warnaSekarang = markData[surah+":"+ayat]?.[idx] || null;
      let warnaBaru = warnaSekarang === null ? "green"
        : warnaSekarang === "green" ? "yellow"
        : warnaSekarang === "yellow" ? "red"
        : null;
      if (!markData[surah+":"+ayat]) markData[surah+":"+ayat] = {};
      if (warnaBaru) markData[surah+":"+ayat][idx] = warnaBaru;
      else delete markData[surah+":"+ayat][idx];
      span.style.backgroundColor = warnaBaru || "";
      const hasil = hitungNilai();
      updateNilaiDiTabel(hasil);
    };
    if (markData[surah+":"+ayat]?.[idx]) span.style.backgroundColor = markData[surah+":"+ayat][idx];
    return span;
  });
}

/* ========= LOAD DATA QURAN ========= */
let dataSiap = Promise.all([
  fetch('https://raw.githubusercontent.com/dickymiswardi/mtq/refs/heads/main/symbol1.json').then(r => r.json()).then(d => { quranData = d; }),
  fetch('https://raw.githubusercontent.com/dickymiswardi/tadabbur/refs/heads/main/ayah_page_map.json').then(r => r.json()).then(d => { ayahPageMap = d; })
]);

/* ========= EVENT CLICK "LEMBAR PENILAIAN" ========= */
const fontLoadedPages = new Set();
document.addEventListener('click', async function (e) {
  if (!e.target.classList.contains('lihat-quran-btn')) return;

  const overlay = document.getElementById('overlay-quran');
  overlay.style.display = 'flex';

  // baris yang diklik
  const row = e.target.closest('tr');
  if (!row) return;                   /* guard */
  currentRowEl = row;
  currentIdSiswa = row.cells[0].innerText.trim();  // STRING

  // tampilkan nama
  const namaSantri = row.cells[1].childNodes[0]?.textContent.trim()
                  || row.cells[1].innerText.replace(/\d{4}-\d{2}-\d{2}/,'').trim();
  const namaSpan = document.getElementById('modal-nama-santri');
  if (namaSpan) namaSpan.innerText = namaSantri;

  // gunakan tanggal per-baris jika ada
  const kelas = document.getElementById('kelas')?.value || 'default';
  const tanggalBaris = row.dataset?.tanggal || document.getElementById('tanggal')?.value || 'default';

  // 1) ambil marks + audio (TAPI TIDAK dirender di overlay ini)
  let serverMarks = await ambilMarksDariNetlify(currentIdSiswa, kelas, tanggalBaris);
  markData = (serverMarks && typeof serverMarks === 'object') ? serverMarks : {};

  // 2) pastikan data Quran siap
  await dataSiap;

  // 3) ambil range
  const surahDari   = parseInt(row.querySelector('.surah-dari').value, 10);
  const ayatDari    = parseInt(row.querySelector('.ayat-dari').value, 10);
  const surahSampai = parseInt(row.querySelector('.surah-sampai').value, 10);
  const ayatSampai  = parseInt(row.querySelector('.ayat-sampai').value, 10);

  // 4) peta halaman -> daftar ayat
  const halamanMap = {};
  for (let s = surahDari; s <= surahSampai; s++) {
    const aStart = (s === surahDari) ? ayatDari : 1;
    const aEnd   = (s === surahSampai) ? ayatSampai : 300;
    for (let a = aStart; a <= aEnd; a++) {
      const key = `${s}:${a}`; const teks = quranData[key]; const page = ayahPageMap[key];
      if (!teks || !page) continue;
      (halamanMap[page] ||= []).push({ surah:s, ayat:a, teks:String(teks).replace(/\|/g,' ') });
    }
  }

  // 5) render ke overlay
  const quranText = document.getElementById('quran-text');
  quranText.innerHTML = '';
  const halamanUrut = Object.keys(halamanMap).map(Number).sort((x,y)=>x-y);
  for (const page of halamanUrut) {
    if (!fontLoadedPages.has(page)) {
      const pageStr = String(page).padStart(3,'0');
      const fontUrl = `https://raw.githubusercontent.com/dickymiswardi/quran/refs/heads/main/fonts/QCF_P${pageStr}.TTF`;
      try {
        const font = new FontFace(`QCF_P${pageStr}`, `url(${fontUrl})`);
        await font.load(); document.fonts.add(font); fontLoadedPages.add(page);
      } catch (err) { console.warn('Gagal load font page', page, err); }
    }
    const pageDiv = document.createElement('div');
    const pageStr = String(page).padStart(3,'0');
    pageDiv.style.fontFamily = `QCF_P${pageStr}, serif`;
    pageDiv.style.fontSize = '30px';
    pageDiv.style.lineHeight = '2.2';
    pageDiv.style.direction = 'rtl';
    pageDiv.style.marginBottom = '20px';
    pageDiv.style.textAlign = 'justify';
    pageDiv.style.setProperty('text-justify','inter-word');
    pageDiv.style.setProperty('text-align-last','right');
    pageDiv.style.whiteSpace = 'normal';

    halamanMap[page].forEach(item => {
      const spans = buatKataKlik(item.surah, item.ayat, item.teks);
      spans.forEach(span => pageDiv.appendChild(span));
      pageDiv.appendChild(document.createTextNode(' '));       // spasi antar-ayat
    });

    quranText.appendChild(pageDiv);
  }

  // 6) nilai
  const adaMarkBerwarna = Object.keys(markData).some(k =>
    k !== 'audio' && markData[k] && typeof markData[k] === 'object' &&
    Object.values(markData[k]).some(v => v === 'green' || v === 'yellow' || v === 'red')
  );
  const hasil = (typeof hitungNilai === 'function') ? hitungNilai() : null;
  if (hasil && adaMarkBerwarna) {
    updateNilaiDiTabel(hasil);
  } else {
    const ringkas = row.querySelector('.nilai-ringkas');
    const nilaiEl = document.getElementById('nilai-akhir');
    const predEl  = document.getElementById('predikat-akhir');
    if (ringkas && nilaiEl && predEl) {
      const strong = ringkas.querySelector('strong');
      const angka = strong ? parseFloat(String(strong.textContent).replace(',', '.')) : NaN;
      if (!Number.isNaN(angka)) nilaiEl.textContent = angka.toFixed(1);
      const sisa = ringkas.textContent.replace(strong?.textContent || '', '').trim();
      predEl.innerHTML = sisa || '';
    } else {
      // tidak ada ringkas dan tidak ada mark ‚Üí kosongkan overlay
      if (nilaiEl) nilaiEl.textContent = '';
      if (predEl)  predEl.innerHTML    = '';
    }
  }
});

/* ========= TOGGLE & TUTUP ========= */
document.getElementById("toggle-keterangan").addEventListener("click", () => {
  const box = document.getElementById("keterangan-box");
  box.style.display = (box.style.display === "block") ? "none" : "block";
});
document.getElementById('close-overlay').addEventListener('click', () => {
  document.getElementById('overlay-quran').style.display = 'none';
});

/* ========= MODAL REKAMAN (BUKA/TUTUP) ========= */
document.getElementById('btn-open-record').addEventListener('click', () => {
  if (!currentIdSiswa) return alert("Buka dulu 'Lembar Penilaian' pada baris santri.");
  const overlay = document.getElementById('overlay-record');
  const namaEl = document.getElementById('record-nama-santri');
  const nama = document.getElementById('modal-nama-santri')?.textContent || '-';
  namaEl.textContent = nama;

  // render rekaman lama di modal rekaman
  tampilkanAudioDiModalRekam(markData);

  overlay.style.display = 'flex';
});
document.getElementById('record-close').addEventListener('click', () => {
  stopRecordingIfNeeded(true);
  document.getElementById('overlay-record').style.display = 'none';
});

/* ========= REKAMAN .MP3 DENGAN WebAudioRecorder ========= */
let audioCtx = null;
let micStream = null;
let sourceNode = null;
let mp3Recorder = null;
let isRecording = false;

const recordStartBtn = document.getElementById('record-start');
const recordStopBtn  = document.getElementById('record-stop');
const recordDurEl    = document.getElementById('record-duration');
const recordSpinEl   = document.getElementById('record-spinner');

let durSec = 0;
let durTimer = null;

function formatTime(sec){ const m = String(Math.floor(sec/60)).padStart(2,'0'); const s = String(sec%60).padStart(2,'0'); return `${m}:${s}`; }

async function ensureMicNodes(){
  if (audioCtx && micStream && sourceNode) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  micStream = await navigator.mediaDevices.getUserMedia({ audio:true });
  sourceNode = audioCtx.createMediaStreamSource(micStream);
}

function stopRecordingIfNeeded(cancelOnly=false){
  try { if (mp3Recorder && isRecording && !cancelOnly) mp3Recorder.finishRecording(); } catch(e){}
  isRecording = false;
  clearInterval(durTimer);
  recordStartBtn.disabled = false;
  recordStopBtn.disabled = true;
}

recordStartBtn.addEventListener('click', async () => {
  try{
    await ensureMicNodes();

    mp3Recorder = new WebAudioRecorder(sourceNode, {
      workerDir: WORKER_DIR,   // ‚Üê pastikan ke /js/
      encoding: 'mp3',
      numChannels: 2,          // ‚Üê MP3 encoder butuh stereo
      onComplete: async function(rec, blob){
        await handleRecordedBlobMP3(blob);
      },
      onError: function(rec, err){ console.error(err); alert('Terjadi kesalahan saat rekam/encode.'); }
    });

    mp3Recorder.setOptions({
      timeLimit: 600,            // 10 menit
      encodeAfterRecord: true,   // encode setelah stop
      mp3: { bitRate: 128 }      // 128 kbps
    });

    mp3Recorder.startRecording();
    isRecording = true;

    durSec = 0; recordDurEl.textContent = '00:00';
    durTimer = setInterval(()=>{ durSec++; recordDurEl.textContent = formatTime(durSec); }, 1000);

    recordStartBtn.disabled = true;
    recordStopBtn.disabled  = false;
  } catch(err){
    console.error(err);
    alert('Tidak bisa mengakses mikrofon.');
  }
});

recordStopBtn.addEventListener('click', () => {
  if (!mp3Recorder || !isRecording) return;
  recordStopBtn.disabled  = true;
  recordStartBtn.disabled = false;
  clearInterval(durTimer);
  try { mp3Recorder.finishRecording(); } catch(e){ console.warn(e); }
  isRecording = false;
});

async function handleRecordedBlobMP3(blob){
  // tampilkan spinner
  recordSpinEl.style.display = 'inline-flex';

  const { kelas, tanggal } = getKelasTanggalAktif();
  const ts = Date.now();
  const safeTanggal = String(tanggal).replace(/[^0-9-]/g,'');
  const filename = `rec_${kelas}_${currentIdSiswa}_${safeTanggal}_${ts}.mp3`;

  // Helper: blob -> dataURL (base64)
  function blobToDataURL(b){
    return new Promise((res, rej) => {
      const r = new FileReader();
      r.onload = () => res(r.result);
      r.onerror = rej;
      r.readAsDataURL(b);
    });
  }

  let uploaded = false;
  try{
    const base64 = await blobToDataURL(blob);

    // 1) Upload audio ke repo
    const up = await fetch('/api/upload-audio', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ fileName: filename, base64 }) // folder default: "audio"
    });
    const upJson = await up.json();
    if (!up.ok || !upJson?.success) throw new Error(upJson?.error || 'Upload audio gagal');
    uploaded = true;

    // 2) Append ke marks.audio
    await fetch('/api/appendAudioToMarks', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ id: currentIdSiswa, ...getKelasTanggalAktif(), filename })
    }).catch(()=>{});
  } catch(e){
    console.warn('Upload/append audio gagal, file disimpan lokal saja.', e);
  }

  // 3) Tampilkan rekaman BARU di modal rekaman (bukan overlay Qur'an)
  const url = uploaded
    ? `/api/getAudio?file=${encodeURIComponent(filename)}`
    : URL.createObjectURL(blob);

  const li = document.createElement('li');
  li.innerHTML = `
    <audio controls preload="metadata" style="width:100%;">
      <source src="${url}" type="audio/mpeg">
      Browser Anda tidak mendukung audio.
    </audio>`;
  recordListEl.appendChild(li);

  // 4) Update struktur data (tanpa merender di overlay Qur'an)
  markData.audio = Array.isArray(markData.audio) ? markData.audio : [];
  if (uploaded) markData.audio.push(filename);

  // selesai
  recordSpinEl.style.display = 'none';
}
</script>


<!-- Overlay Hitung Total All Juz -->
<div id="juzOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
background:rgba(0,0,0,0.5); z-index:999; justify-content:center; align-items:center;">
  <div style="background:white; padding:20px; border-radius:8px; min-width:300px;">
    <h3>Target Hafalan Minimal Semester</h3>
    <!-- Styling bullet yang rapi & minimal -->
    <style>
      #juzOverlay .juz-list{
        margin:8px 0 12px;
        padding-left:1.25rem;        /* jarak marker */
        list-style:disc;
      }
      #juzOverlay .juz-list li{
        margin:4px 0;                /* spasi antar baris */
        line-height:1.55;
      }
      #juzOverlay .juz-list li::marker{
        color:#3b82f6;               /* warna bullet (biru lembut) */
        font-size:1.1em;             /* sedikit lebih besar */
      }
      #juzOverlay .juz-list strong{
        font-variant-numeric:tabular-nums; /* angka rata */
      }
    </style>

    <!-- Bullet list cakep -->
    <ul class="juz-list"><li>Semester 1 Kelas 1: <strong>0,5</strong> Juz</li>
<li>Semester 2 Kelas 1: <strong>1</strong> Juz</li>
<li>Semester 1 Kelas 2: <strong>1,5</strong> Juz</li>
<li>Semester 2 Kelas 2: <strong>2</strong> Juz</li>
<li>Semester 1 Kelas 3: <strong>2,5</strong> Juz</li>
<li>Semester 2 Kelas 3: <strong>3</strong> Juz</li>
<li>Semester 1 Kelas 4: <strong>3,5</strong> Juz</li>
<li>Semester 2 Kelas 4: <strong>4</strong> Juz</li>
<li>Semester 1 Kelas 5: <strong>4,5</strong> Juz</li>
<li>Semester 2 Kelas 5: <strong>5</strong> Juz</li>
<li>Semester 1 Kelas 6: <strong>5,5</strong> Juz</li>
<li>Semester 2 Kelas 6: <strong>6</strong> Juz</li></ul>

    <hr style="border:none; border-top:1px solid #eee; margin:8px 0 12px;">

    <label>Dari: <input type="date" id="rangeDari"></label><br><br>
    <label>Sampai: <input type="date" id="rangeSampai" disabled></label><br><br>
    <button id="btnHitungTotalJuz">Setting Tanggal THMS</button>
    <button onclick="document.getElementById('juzOverlay').style.display='none'">Close</button>
  </div>
</div>

<!-- ===========================
     MODAL: Input Murajaah (3 Sesi + Juz)
     =========================== -->
<div id="murModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:1200; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:16px; border-radius:12px; width:min(980px,95%); max-height:90vh; overflow:auto;">
    <div class="mur-headline" style="display:flex;align-items:baseline;justify-content:space-between;gap:12px;margin:0 0 10px;">
  <h3 style="margin:0 0 10px;">Input Murajaah</h3>
  <div id="murStudentInfo" style="font-weight:600;font-size:14px;white-space:nowrap;">
    <span id="murNama">‚Äî</span><span id="murNis" style="opacity:.75;"></span>
  </div>
</div>

    <style>
      .mur-sesi{border:1px solid #e5e7eb; border-radius:10px; padding:10px; margin-bottom:10px}
      .mur-sesi h4{margin:0 0 8px; font-size:14px}
      .mur-sesi .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
      .mur-sesi .muted{color:#6b7280}
      .mur-sesi .sum{background:#f9fafb; border:1px dashed #e5e7eb; padding:8px; border-radius:8px; margin-top:8px}
      .mur-sesi select{min-width:88px}
      .mur-total-grid{display:grid; grid-template-columns:repeat(4,minmax(0,1fr)); gap:8px; margin-top:10px}
      @media (max-width:680px){ .mur-total-grid{grid-template-columns:repeat(2,minmax(0,1fr));} }
      .mur-chip{font-size:12px; color:#374151}
      .mur-score{width:74px; padding:4px 6px; border:1px solid #e5e7eb; border-radius:6px}
      .mur-badge{display:inline-block; padding:2px 6px; border-radius:999px; font-size:12px; border:1px solid #e5e7eb; background:#fff}
    </style>

    <!-- Sesi 1 -->
    <div class="mur-sesi" id="mur-sesi1" data-idx="1">
      <h4>Murajaah Sesi 1</h4>
      <div class="row">
        <label>Juz
          <select id="mur1-juzFrom"><option value="">‚Äî</option></select>
        </label>
        <label>to
          <select id="mur1-juzTo"><option value="">‚Äî</option></select>
        </label>

        <span class="muted" aria-hidden="true">|</span>

        <label>Page
          <select id="mur1-pageFrom"></select>
        </label>
        <label>to
          <select id="mur1-pageTo"></select>
        </label>

        <span class="muted" aria-hidden="true">|</span>

        <label>Surah
          <select id="mur1-surahFrom"></select>
        </label>
        <label>
          <select id="mur1-ayahFrom"></select>
        </label>
        <span class="muted" aria-hidden="true">‚Üí</span>
        <label>to
          <select id="mur1-surahTo"></select>
        </label>
        <label>
          <select id="mur1-ayahTo"></select>
        </label>

        <span class="muted" aria-hidden="true">|</span>

        <label>Nilai
          <input id="mur1-score" type="number" min="0" max="100" step="1" class="mur-score" placeholder="0-100">
        </label>
        <span class="mur-badge" id="mur1-predikatBadge">‚Äì</span>
      </div>
      <div class="sum">
        <div><b>Total setara Juz (Sesi 1):</b> <span id="mur1-totalJuz" style="font-weight:700">0.00</span> <span class="mur-chip" id="mur1-pagesHint"></span></div>
      </div>
    </div>

    <!-- Sesi 2 -->
    <div class="mur-sesi" id="mur-sesi2" data-idx="2">
      <h4>Murajaah Sesi 2</h4>
      <div class="row">
        <label>Juz
          <select id="mur2-juzFrom"><option value="">‚Äî</option></select>
        </label>
        <label>to
          <select id="mur2-juzTo"><option value="">‚Äî</option></select>
        </label>

        <span class="muted" aria-hidden="true">|</span>

        <label>Page
          <select id="mur2-pageFrom"></select>
        </label>
        <label>to
          <select id="mur2-pageTo"></select>
        </label>

        <span class="muted" aria-hidden="true">|</span>

        <label>Surah
          <select id="mur2-surahFrom"></select>
        </label>
        <label>
          <select id="mur2-ayahFrom"></select>
        </label>
        <span class="muted" aria-hidden="true">‚Üí</span>
        <label>to
          <select id="mur2-surahTo"></select>
        </label>
        <label>
          <select id="mur2-ayahTo"></select>
        </label>

        <span class="muted" aria-hidden="true">|</span>

        <label>Nilai
          <input id="mur2-score" type="number" min="0" max="100" step="1" class="mur-score" placeholder="0-100">
        </label>
        <span class="mur-badge" id="mur2-predikatBadge">‚Äì</span>
      </div>
      <div class="sum">
        <div><b>Total setara Juz (Sesi 2):</b> <span id="mur2-totalJuz" style="font-weight:700">0.00</span> <span class="mur-chip" id="mur2-pagesHint"></span></div>
      </div>
    </div>

    <!-- Sesi 3 -->
    <div class="mur-sesi" id="mur-sesi3" data-idx="3">
      <h4>Murajaah Sesi 3</h4>
      <div class="row">
        <label>Juz
          <select id="mur3-juzFrom"><option value="">‚Äî</option></select>
        </label>
        <label>to
          <select id="mur3-juzTo"><option value="">‚Äî</option></select>
        </label>

        <span class="muted" aria-hidden="true">|</span>

        <label>Page
          <select id="mur3-pageFrom"></select>
        </label>
        <label>to
          <select id="mur3-pageTo"></select>
        </label>

        <span class="muted" aria-hidden="true">|</span>

        <label>Surah
          <select id="mur3-surahFrom"></select>
        </label>
        <label>
          <select id="mur3-ayahFrom"></select>
        </label>
        <span class="muted" aria-hidden="true">‚Üí</span>
        <label>to
          <select id="mur3-surahTo"></select>
        </label>
        <label>
          <select id="mur3-ayahTo"></select>
        </label>

        <span class="muted" aria-hidden="true">|</span>

        <label>Nilai
          <input id="mur3-score" type="number" min="0" max="100" step="1" class="mur-score" placeholder="0-100">
        </label>
        <span class="mur-badge" id="mur3-predikatBadge">‚Äì</span>
      </div>
      <div class="sum">
        <div><b>Total setara Juz (Sesi 3):</b> <span id="mur3-totalJuz" style="font-weight:700">0.00</span> <span class="mur-chip" id="mur3-pagesHint"></span></div>
      </div>
    </div>

    <!-- Rekap total semua sesi -->
    <div class="mur-total-grid">
      <div class="sum"><b>Juz Sesi 1:</b> <span id="mur-t1">0.00</span></div>
      <div class="sum"><b>Juz Sesi 2:</b> <span id="mur-t2">0.00</span></div>
      <div class="sum"><b>Juz Sesi 3:</b> <span id="mur-t3">0.00</span></div>
      <div class="sum"><b>Total 3 Sesi:</b> <span id="mur-totalJuzAll" style="font-weight:700">0.00</span> juz</div>
    </div>

    <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end; align-items:center;">
      <span id="mur-save-status" style="font-size:12px; color:#6b7280; margin-right:auto;"></span>
      <button type="button" id="mur-preview" style="border:1px solid #0ea5e9; color:#0ea5e9; padding:8px 12px; border-radius:8px; background:#ecfeff">Lihat Hasil</button>
      <button type="button" id="mur-save" style="background:#16a34a; color:#fff; border:1px solid #16a34a; padding:8px 12px; border-radius:8px;">Save Data</button>
      <button type="button" id="mur-close">Tutup</button>
    </div>
  </div>
</div>

<!-- ===========================
     Overlay Ringkasan (wajib: 3 sesi)
     =========================== -->
<div id="murPreviewOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:1300; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:18px; border-radius:12px; width:min(620px,94%); box-shadow:0 12px 36px rgba(0,0,0,.18)">
    <h3 style="margin:0 0 10px;">Ringkasan Murajaah (3 Sesi)</h3>
    <div id="murPreviewBody" style="font-size:14px; line-height:1.6"></div>
    <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end">
      <button type="button" onclick="document.getElementById('murPreviewOverlay').style.display='none'">Close</button>
    </div>
  </div>
</div>

<!-- ===========================
     Overlay Total Mur (Range) (tetap)
     =========================== -->
<div id="murRangeOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:1200; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:20px; border-radius:12px; width:min(520px,94%); box-shadow:0 12px 36px rgba(0,0,0,.18)">
    <h3 style="margin:0 0 10px;">Target Hafalan Minimal Semester</h3>

    <style>
      #murRangeOverlay .juz-list{
        margin:8px 0 12px;
        padding-left:1.25rem;
        list-style:disc;
      }
      #murRangeOverlay .juz-list li{ margin:4px 0; line-height:1.55; }
      #murRangeOverlay .juz-list li::marker{ color:#3b82f6; font-size:1.1em; }
      #murRangeOverlay .juz-list strong{ font-variant-numeric:tabular-nums; }
    </style>

    <ul class="juz-list"><li>Semester 1: <strong>8</strong> Juz</li>
<li>Semester 1 Kelas 1: <strong>0,5</strong> Juz</li>
<li>Semester 2 Kelas 1: <strong>1</strong> Juz</li>
<li>Semester 1 Kelas 2: <strong>1,5</strong> Juz</li>
<li>Semester 2 Kelas 2: <strong>2</strong> Juz</li>
<li>Semester 1 Kelas 3: <strong>2,5</strong> Juz</li>
<li>Semester 2 Kelas 3: <strong>3</strong> Juz</li>
<li>Semester 1 Kelas 4: <strong>3,5</strong> Juz</li>
<li>Semester 2 Kelas 4: <strong>4</strong> Juz</li>
<li>Semester 1 Kelas 5: <strong>4,5</strong> Juz</li>
<li>Semester 2 Kelas 5: <strong>5</strong> Juz</li>
<li>Semester 1 Kelas 6: <strong>5,5</strong> Juz</li>
<li>Semester 2 Kelas 6: <strong>6</strong> Juz</li></ul>

    <hr style="border:none; border-top:1px solid #eee; margin:8px 0 12px;">

    <label>Dari: <input type="date" id="murRangeDari"></label><br><br>
    <label>Sampai: <input type="date" id="murRangeSampai"></label><br><br>

    <div id="murRangeStatus" style="font-size:12px; color:#6b7280; margin-bottom:10px;"></div>

    <button id="btnHitungTotalMur" type="button">Setting Tanggal Murajaah</button>
    <button type="button" onclick="document.getElementById('murRangeOverlay').style.display='none'">Close</button>
  </div>
</div>	
  
 <script>
  // === Deklarasi elemen ===
  const loginCard = document.getElementById("login-card");
  const dashboardCard = document.getElementById("dashboard-card");
  const loginForm = document.getElementById("login-form");
  const loginError = document.getElementById("login-error");
  const logoutBtn = document.getElementById("logout-btn");
  const togglePasswordBtn = document.getElementById("toggle-password");
  const passwordInput = document.getElementById("password");
  const overlay = document.getElementById("overlay");
  const kelasSelect = document.getElementById("kelas");
  const tanggalInput = document.getElementById("tanggal");  
  const startDateInput = document.getElementById("start-date");  // üîπ TAMBAHAN
  const endDateInput = document.getElementById("end-date");      // üîπ TAMBAHAN
  const santriTableBody = document.querySelector("#santri-table tbody");
  const saveBtn = document.getElementById("save-btn");
  const downloadBtn = document.getElementById("download-btn");
  const totalAllJuzHeader = document.getElementById("totalAllJuzHeader");
  const namaUserSpan = document.getElementById("namaUser");
  const tanggalFilterAkhir = document.getElementById("tanggal-filter-akhir");
  const KELAS_KEY = "kelasTerakhir";



  let surahList = [];
  let pagesMap = {};

  

  // === Fungsi atur dropdown kelas ===
function aturDropdownKelas(user) {
  const semuaKelas = [  "kelas_012526","kelas_012025"];

  const namaKelasCustom = {  kelas_012526: "Ustadz M. Taqi Lazuardi",
  kelas_012025: "Ahmad Wildan"};

  kelasSelect.innerHTML = "";

  const kelasDiizinkan = user?.kelas?.length ? user.kelas : semuaKelas;

  semuaKelas.forEach(kls => {
    const opt = document.createElement("option");
    opt.value = kls;
    opt.textContent = namaKelasCustom[kls] || kls;
    opt.disabled = !kelasDiizinkan.includes(kls);
    kelasSelect.appendChild(opt);
  });

  // --- pilih nilai ---
  const saved = localStorage.getItem(KELAS_KEY); // ex: "kelas_3"
  const adaSaved = saved && Array.from(kelasSelect.options).some(o => o.value === saved && !o.disabled);
  if (adaSaved) {
    kelasSelect.value = saved;        // pakai pilihan terakhir bila masih diizinkan
  } else {
    const pertamaAktif = Array.from(kelasSelect.options).find(o => !o.disabled);
    if (pertamaAktif) kelasSelect.value = pertamaAktif.value; // fallback
  }
}

  // === Login form ===
  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const username = document.getElementById("username").value;
    const password = passwordInput.value;

    overlay.style.display = "flex";

    try {
      const res = await fetch("/api/getUsers");
      const users = await res.json();
      const user = users.find(u => u.username === username && u.password === password);

      if (user) {
        localStorage.setItem("isLoggedIn", true);
        localStorage.setItem("username", username);
        localStorage.setItem("kelasDiizinkan", JSON.stringify(user.kelas || []));
        namaUserSpan.textContent = username;

        aturDropdownKelas(user);
        showDashboard();
        loadDataSantri(); // langsung load data sesuai kelas terpilih
      } else {
        loginError.style.display = "block";
      }
    } catch (err) {
      loginError.textContent = "Gagal memuat data user!";
      loginError.style.display = "block";
    }

    overlay.style.display = "none";
  });

  // === Load data santri ===
  async function loadDataSantri() {
    const kelas = kelasSelect.value;
    if (!kelas) return; // jaga-jaga

    try {
      const res = await fetch(`/api/getSantri?kelas=${kelas}`);
      if (!res.ok) throw new Error("Gagal memuat data santri");
      const data = await res.json();
      console.log("Data santri:", data);
      // TODO: render ke tabel
    } catch (err) {
      console.error(err);
      alert("Gagal memuat data santri / absensi!");
    }
  }

  // === Saat halaman dibuka ===
  window.addEventListener("DOMContentLoaded", async () => {
    try {
      const resSurah = await fetch("/api/getAyat");
      surahList = await resSurah.json();

      const resPages = await fetch("/api/getPagesMap");
      pagesMap = await resPages.json();
    } catch (err) {
      console.error("Gagal load surah/pagesMap:", err);
    }

    const isLoggedIn = localStorage.getItem("isLoggedIn");
    if (isLoggedIn) {
      const storedKelas = JSON.parse(localStorage.getItem("kelasDiizinkan") || "[]");
      const storedUsername = localStorage.getItem("username") || "";
      namaUserSpan.textContent = storedUsername;

      aturDropdownKelas({ kelas: storedKelas });
      showDashboard();
      loadDataSantri();
    }
  });

  // === Event ganti kelas ===
  kelasSelect.addEventListener("change", () => {
  try { localStorage.setItem(KELAS_KEY, kelasSelect.value); } catch {}
  loadDataSantri();
});

  // === Header total juz click ===
  totalAllJuzHeader.addEventListener("click", bukaOverlayTotalAllJuz);



    

    function showDashboard() {
  loginCard.style.display = "none";
  dashboardCard.style.display = "block";

  const today = new Date().toLocaleDateString('sv-SE'); // YYYY-MM-DD

  // batas maksimal filter akhir
  if (tanggalFilterAkhir) tanggalFilterAkhir.max = today;

  // restore filter akhir
  const savedTanggalAkhirFilter = localStorage.getItem("tanggalFilterAkhirTerakhir") || "";
  if (tanggalFilterAkhir) {
    tanggalFilterAkhir.value = savedTanggalAkhirFilter;
    tanggalFilterAkhir.addEventListener("change", () => {
      localStorage.setItem("tanggalFilterAkhirTerakhir", tanggalFilterAkhir.value);
      loadSantriData();
    });
  }

  // batas tanggal tak boleh ke depan
  if (tanggalInput)   tanggalInput.max = today;
  if (startDateInput) startDateInput.max = today;
  if (endDateInput)   endDateInput.max = today;

  // restore tanggal
  const savedTanggal = localStorage.getItem("tanggalTerakhir");
  const savedEnd     = localStorage.getItem("endDateTerakhir");

  if (tanggalInput) {
    tanggalInput.value = savedTanggal || today;
    tanggalInput.addEventListener("change", () => {
      localStorage.setItem("tanggalTerakhir", tanggalInput.value);
      if (tanggalFilterAkhir) {
        tanggalFilterAkhir.value = "";
        localStorage.removeItem("tanggalFilterAkhirTerakhir");
      }
      loadSantriData();
    });
  }

  if (endDateInput) {
    endDateInput.value = savedEnd || today;
    endDateInput.addEventListener("change", () => {
      localStorage.setItem("endDateTerakhir", endDateInput.value);
      loadSantriData();
    });
  }

  loadSantriData();
}

logoutBtn.addEventListener("click", () => {
  overlay.style.display = "flex";
  setTimeout(() => {
    localStorage.removeItem("isLoggedIn");
    localStorage.removeItem("username");
    loginCard.style.display = "block";
    dashboardCard.style.display = "none";
    overlay.style.display = "none";
  }, 500);
});

<!-- ============ ABSENSI FLEX ‚Äì UTIL & RENDER (global, ringan) ============ -->
(function(){
  // Inject style .abs-mini
  (function ensureAbsMiniStyles(){
    if (document.getElementById('absmini-green-style')) return;
    const st = document.createElement('style');
    st.id = 'absmini-green-style';
    st.textContent = `
      .abs-mini{
        transition: background .2s ease, color .2s ease;
      }
      /* Warna default saat 100% (kompat lama) ‚Äî akan dioverride oleh kelas status */
      .abs-mini.is-complete{
        background:#dcfce7; /* hijau muda */
        color:#065f46;       /* kontras */
        border-radius:6px;
        padding:0 .375rem;
        transition: background .2s ease, color .2s ease;
      }
      /* Warna berdasar status dominan */
      .abs-mini.is-hadir{
        background:#dcfce7; /* green-100 */
        color:#065f46;
        border-radius:6px; padding:0 .375rem;
      }
      .abs-mini.is-izin{
        background:#f3e8ff; /* violet-100 */
        color:#4c1d95;
        border-radius:6px; padding:0 .375rem;
      }
      .abs-mini.is-sakit{
        background:#fef9c3; /* yellow-100 */
        color:#854d0e;
        border-radius:6px; padding:0 .375rem;
      }
      .abs-mini.is-alpha{
        background:#fee2e2; /* red-200 */
        color:#7f1d1d;
        border-radius:6px; padding:0 .375rem;
      }
    `;
    document.head.appendChild(st);
  })();

  // Konfigurasi global yang bisa dioverride sebelum loadSantriData jalan
    window.ABS_FLEX_CFG = window.ABS_FLEX_CFG || {
    statuses: ["hadir","izin","sakit","alpha"],
    perStatus: Number(window.ABS_FLEX_PER_STATUS ?? 1), // ‚úÖ default 2 (Pagi/Sore)
    defaultTarget: 1,                                   // ‚úÖ bawa default ke 2
    maxTarget: 1,                                       // ‚úÖ dukung 1..6 sesi aktif
    labels: null
  };

  // --- Tambahan: helper clone aman & di-expose global ---
  function safeCloneItems(items){
    return Array.isArray(items)
      ? items.map(it => ({ key: String(it.key).toLowerCase(), checked: !!it.checked }))
      : [];
  }
  window.__absflex_safeCloneItems = safeCloneItems;

  // --- Tambahan: tentukan status dominan & expose global ---
  function dominantStatus(items){
    const cnt = {hadir:0, izin:0, sakit:0, alpha:0};
    (items||[]).forEach(it=>{
      if (!it?.checked) return;
      const base = String(it.key||'').toLowerCase().replace(/\d+$/,'');
      if (base in cnt) cnt[base]++;
    });
    // prioritas seri: hadir > izin > sakit > alpha
    let best=null,max=0;
    ["hadir","izin","sakit","alpha"].forEach(k=>{
      if (cnt[k] > max){ max=cnt[k]; best=k; }
    });
    return max>0 ? best : null;
  }
  window.__absmini_dominantStatus = dominantStatus;

  function buildKeys(perStatus = ABS_FLEX_CFG.perStatus){
    const n = Math.max(1, Math.min(6, perStatus|0 || 2));
    const keys = [];
    for (const st of ABS_FLEX_CFG.statuses){
      for (let i=1;i<=n;i++) keys.push(`${st}${i}`);
    }
    return keys;
  }

  function defaultLabel(st, i){
    // Dukungan sesi lengkap + pertahankan perilaku lama untuk perStatus=2 (Pagi/Sore)
    const Title   = st.charAt(0).toUpperCase() + st.slice(1);
    const idx     = i - 1;
    const per     = ABS_FLEX_CFG.perStatus|0;
    if (per === 2){
	const sesi = (idx === 0) ? "Pagi" : "Sore";
	return `${Title} ${sesi}`; // ‚úÖ tidak ulang angka
	}
	if (per > 2){
	return `${Title} Sesi ${i}`; // ‚úÖ Sesi 1..N
	}
	return `${Title} ${i}`;
  }

  function labelFor(st, i){
    const map = ABS_FLEX_CFG.labels;
    if (map && Array.isArray(map[st]) && map[st][i-1]) return map[st][i-1];
    return defaultLabel(st, i);
  }

  function computePercent(items, target){
    const tgt = Math.max(1, Math.min(ABS_FLEX_CFG.maxTarget, target|0 || ABS_FLEX_CFG.defaultTarget));
    const checked = (items||[]).reduce((a,it)=>a+(it.checked?1:0),0);
    return { percent: Math.min(checked, tgt)/tgt*100, checked, target: tgt };
  }

  function clampToTarget(items, target, mode="lifo"){
    const tgt = Math.max(1, Math.min(ABS_FLEX_CFG.maxTarget, target|0 || ABS_FLEX_CFG.defaultTarget));
    const on  = (items||[]).filter(it=>it.checked);
    if (on.length <= tgt) return items;
    const extra = on.length - tgt;
    const order = on.map(it=>it.key);
    const toOff = (mode==="fifo") ? order.slice(0,extra) : order.slice(-extra);
    const offSet = new Set(toOff);
    return items.map(it => offSet.has(it.key) ? {...it, checked:false} : it);
  }

  // Legacy ‚Üí items bernomor
  function legacyToItems(legacy, target=2){
    const st = String((legacy||"").toLowerCase());
    const base = ["hadir","izin","sakit","alpha"].includes(st) ? st : "alpha";
    const perStatus = ABS_FLEX_CFG.perStatus;
    const keys = buildKeys(perStatus);
    const items = keys.map(k => ({key:k, checked:false}));
    let filled = 0;
    for (let i=0;i<items.length && filled<target;i++){
      if (items[i].key.startsWith(base)) { items[i].checked = true; filled++; }
    }
    return items;
  }

  // absensi6 (array status per slot) ‚Üí items bernomor
  function abs6ToItems(absensi6=[], target=6){
    const perStatus = ABS_FLEX_CFG.perStatus;
    const counts = {hadir:0, izin:0, sakit:0, alpha:0};
    const keys = buildKeys(perStatus);
    const items = keys.map(k => ({key:k, checked:false}));
    const n = Math.max(1, Math.min(6, target|0 || 6));
    for (let i=0;i<n;i++){
      const s = String(absensi6[i]||"").toLowerCase();
      if (!["hadir","izin","sakit","alpha"].includes(s)) continue;
      counts[s] = Math.min(perStatus, counts[s]+1);
      const markKey = `${s}${counts[s]}`;
      const it = items.find(x => x.key === markKey);
      if (it) it.checked = true;
    }
    return items;
  }

  // Cari .abs-mini yang se-sel dengan tombol
  function findAbsMiniFromBtn(btn){
    if (!btn) return null;
    const cell = btn.closest('.abs-flex-cell, td, th, .cell, .grid-cell');
    return (cell && cell.querySelector('.abs-mini'))
        || btn.querySelector?.('.abs-mini')
        || btn.parentElement?.querySelector?.('.abs-mini')
        || null;
  }

  // Sinkronkan badge .abs-mini
  function syncAbsMiniFromPercent(percent){
    const btn = window.__absensiLastButton;
    if (!btn) return;
    const mini = findAbsMiniFromBtn(btn);
    if (!mini) return;

    // Toggle indikator complete (kompat lama)
    const complete = (percent >= 100);
    mini.classList.toggle('is-complete', complete);

    // Warna berdasar status dominan dari CELL pemanggil
    const cell = btn.closest('.abs-flex-cell, td, th, .cell, .grid-cell');
    const items = Array.isArray(cell?._absensiItems) ? cell._absensiItems : [];
    const st = dominantStatus(items);

    mini.classList.remove('is-hadir','is-izin','is-sakit','is-alpha');
    if (st) {
      mini.classList.add(`is-${st}`);
    } else {
      // netral
      mini.style.background = '';
      mini.style.color = '';
      mini.style.borderRadius = '';
      mini.style.padding = '';
    }
  }
  window.__absmini_sync = syncAbsMiniFromPercent;

  // Render widget ke target container (dipakai di MODAL)
  window.renderAbsensiFlex = function renderAbsensiFlex(container, { target=ABS_FLEX_CFG.defaultTarget, presetItems=null } = {}){
    const root = (typeof container === "string") ? document.getElementById(container) : container;
    if (!root) throw new Error("Container absensi tidak ditemukan");
    const perStatus = ABS_FLEX_CFG.perStatus;
    const keys = buildKeys(perStatus);

    root.innerHTML = `
      <div class="absflex-head" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:6px;">
        <label style="font-size:12px;color:#6b7280">Sesi aktif:</label>
        <select class="absflex-target" style="padding:2px 6px;border:1px solid #e5e7eb;border-radius:8px;">
          ${Array.from({length:ABS_FLEX_CFG.maxTarget},(_,i)=>`<option value="${i+1}" ${i+1==target?'selected':''}>${i+1}</option>`).join("")}
        </select>
        <span class="absflex-percent" style="border:1px solid #c7d2fe;padding:2px 8px;border-radius:999px;background:#eef2ff;font-weight:600;">0%</span>
      </div>

      <!-- Grid luar: kartu per status (responsif & rapi) -->
      <div class="absflex-grid" style="display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));">
        ${ABS_FLEX_CFG.statuses.map(st => `
          <div style="border:1px solid #e5e7eb;border-radius:10px;padding:8px;background:#fff;">
            <div style="font-weight:700;margin-bottom:6px;text-transform:capitalize;">${st}</div>

            <!-- Grid dalam: checkbox per sesi, rapi sampai 6 sesi -->
            <div style="display:grid;gap:6px;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));">
              ${Array.from({length:perStatus},(_,i)=>`
                <label style="display:flex;align-items:center;gap:8px;padding:4px 6px;border-radius:8px;border:1px solid #f1f5f9;min-height:32px;min-width:0;">
                  <input type="checkbox" data-abskey="${st}${i+1}" style="width:16px;height:16px;">
                  <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;min-width:0;">${labelFor(st, i+1)}</span>
                </label>
              `).join("")}
            </div>
          </div>
        `).join("")}
      </div>
    `;

    const percentEl = root.querySelector(".absflex-percent");
    const targetEl  = root.querySelector(".absflex-target");
    const boxes     = [...root.querySelectorAll('input[type="checkbox"][data-abskey]')];

    // bangun items awal
    let items;
    if (Array.isArray(presetItems)) {
      const presetSet = new Map(presetItems.map(it => [String(it.key).toLowerCase(), !!it.checked]));
      items = keys.map(k => ({ key:k, checked: !!presetSet.get(k) }));
    } else {
      items = keys.map(k => ({ key:k, checked:false }));
    }

    function writeUI(){
      boxes.forEach(b => {
        const k = String(b.dataset.abskey).toLowerCase();
        const it = items.find(x => x.key === k);
        b.checked = !!it?.checked;
      });
    }
    function recolor(p){
      percentEl.style.background = p>=80 ? '#dcfce7' : p>=50 ? '#fff7ed' : '#fee2e2';
      percentEl.style.borderColor= p>=80 ? '#86efac' : p>=50 ? '#fdba74' : '#fca5a5';
    }
    function recalcExpose(){
      const t = Number(targetEl.value)||ABS_FLEX_CFG.defaultTarget;
      const rec = computePercent(items, t);
      percentEl.textContent = `${Math.round(rec.percent)}%`;
      recolor(rec.percent);
      // expose ke container (dipakai untuk sync ke cell pemanggil)
      root._absensiItems   = items.map(it => ({key:it.key, checked:!!it.checked}));
      root._absensiTarget  = rec.target;
      root._absensiChecked = rec.checked;
      root._absensiPercent = Math.round(rec.percent);

      // Sinkronkan badge .abs-mini di sel tombol terkait
      syncAbsMiniFromPercent(Math.round(rec.percent));
    }

    // listeners
    root.addEventListener("change", (e) => {
      if (e.target === targetEl) {
        items = clampToTarget(items, Number(targetEl.value) || ABS_FLEX_CFG.defaultTarget, "lifo");
        writeUI(); recalcExpose();
        return;
      }
      if (e.target.matches('input[type="checkbox"][data-abskey]')) {
        const k = String(e.target.dataset.abskey).toLowerCase();
        const it = items.find(x => x.key === k);
        if (it) it.checked = !!e.target.checked;
        items = clampToTarget(items, Number(targetEl.value) || ABS_FLEX_CFG.defaultTarget, "lifo");
        writeUI(); recalcExpose();
      }
    });

    // init tampilan
    writeUI(); recalcExpose();
    return root;
  };

  // Converter untuk preset dari data lama/baru (dipakai saat render baris)
  window.__makePresetAbsensiItems = function(dataAbsensi){
    if (Array.isArray(dataAbsensi?.absensiItems)){
      const target = Number(dataAbsensi?.absensiTarget) || ABS_FLEX_CFG.defaultTarget;
      return { preset: safeCloneItems(dataAbsensi.absensiItems), target };
    }
    if (Array.isArray(dataAbsensi?.absensi6)){
      const target = Number(dataAbsensi?.absensiActive) || 6;
      const items = abs6ToItems(dataAbsensi.absensi6, target);
      return { preset: safeCloneItems(items), target: Math.max(1, Math.min(6, target)) };
    }
    if (typeof dataAbsensi?.absensi === "string" && dataAbsensi.absensi){
      const items = legacyToItems(dataAbsensi.absensi, ABS_FLEX_CFG.defaultTarget);
      return { preset: safeCloneItems(items), target: ABS_FLEX_CFG.defaultTarget };
    }
    return { preset: null, target: ABS_FLEX_CFG.defaultTarget };
  };

  // expose helper compute (optional)
  window.__absflex_computePercent = computePercent;
})();

<!-- === helper: buat modal overlay Absensi Flex secara dinamis (sekali saja) -->
(function(){
  function ensureAbsensiModal(){
    if (document.getElementById("absensiModalOverlay")) return;
    const overlay = document.createElement("div");
    overlay.id = "absensiModalOverlay";
    overlay.style.cssText = [
      "display:none","position:fixed","inset:0","background:rgba(0,0,0,.5)","z-index:1000",
      "justify-content:center","align-items:center"
    ].join(";");

    overlay.innerHTML = `
      <div class="absensi-modal-card" style="background:#fff; padding:20px; border-radius:12px; min-width:340px; max-width:90%; max-height:90%; overflow:auto;">
        <div style="display:flex;align-items:center;gap:10px;justify-content:space-between;margin-bottom:10px;">
          <h3 style="margin:0;font-size:18px;"><span id="absensiModalTitleName" style="font-weight:600;"></span></h3>
          <button id="absensiModalClose" style="padding:6px 10px;border:1px solid #e5e7eb;border-radius:8px;background:#1E88E5;color:#fff;">Tutup</button>
        </div>
        <div id="absensiModalContent"></div>
      </div>
    `;
    document.body.appendChild(overlay);

    // close handlers
    const closeBtn = overlay.querySelector("#absensiModalClose");
    closeBtn.addEventListener("click", () => overlay.style.display = "none");
    overlay.addEventListener("click", (e) => {
      if (e.target === overlay) overlay.style.display = "none";
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") overlay.style.display = "none";
    });
  }
  window.ensureAbsensiModal = ensureAbsensiModal;
})();

<!-- === listener ringan: set judul modal dari baris (tanpa buka modal / tanpa render) -->
(function(){
  // Ambil teks aman dari sel (support <a>, input/select)
  function cellText(el){
    if (!el) return '';
    const input = el.querySelector('input,select,textarea');
    if (input) return (input.value || input.textContent || '').trim();
    const a = el.querySelector('a');
    if (a) return (a.textContent || a.innerText || '').trim();
    return (el.textContent || el.innerText || '').trim();
  }

  // Peta index kolom berdasarkan THEAD; fallback 0:Nis, 1:Nama
  function headerMapForTable(table){
    const map = { nis: 0, nama: 1 };
    if (!table) return map;
    const ths = table.querySelectorAll('thead th');
    if (!ths.length) return map;
    for (let i=0;i<ths.length;i++){
      const t = (ths[i].textContent || '').trim().toLowerCase();
      if (t === 'nis')  map.nis  = i;
      if (t === 'nama') map.nama = i;
    }
    return map;
  }

  function extractIdentityFromButton(btn){
    const tr = btn.closest('tr');
    const table = tr && tr.closest('table');
    const map = headerMapForTable(table);
    const tds = tr ? tr.querySelectorAll('td') : [];
    const nis  = cellText(tds[map.nis]  || tds[0]);
    const nama = cellText(tds[map.nama] || tds[1]);
    return { nis, nama };
  }

  function setAbsensiModalTitle(nis, nama){
    const span = document.getElementById('absensiModalTitleName');
    if (!span) return;
    const n1 = (nama||'').trim();
    const n2 = (nis||'').trim();
    span.textContent = (n1 && n2) ? `${n1} (${n2})`
                     :  n1 ? n1
                     :  n2 ? `NIS ${n2}`
                     :  '';
  }

  // Ekspor fungsi publik jika ingin dipanggil dari handler lama Anda
  window.__setAbsensiTitleFromBtn = function(btn){
    window.ensureAbsensiModal && window.ensureAbsensiModal();
    // simpan tombol terakhir untuk sinkronisasi .abs-mini
    window.__absensiLastButton = btn;
    const { nis, nama } = extractIdentityFromButton(btn);
    setAbsensiModalTitle(nis, nama);

    // tandai awal jika badge sudah 100%
    const mini = (function(){
      const cell = btn.closest('.abs-flex-cell, td, th, .cell, .grid-cell');
      return (cell && cell.querySelector('.abs-mini')) || null;
    })();
    if (mini){
      const txt = (mini.getAttribute('data-progress') ?? mini.textContent ?? '').trim();
      const num = parseInt(String(txt).replace('%','').trim(), 10);
      mini.classList.toggle('is-complete', Number.isFinite(num) && num === 100);
    }
  };

  // Listener global: hanya set judul; tidak membuka modal & tidak render
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.btn-absensi-flex');
    if (!btn) return;
    window.__setAbsensiTitleFromBtn(btn);
    // Tidak preventDefault / stopPropagation ‚Äî biarkan handler lama berjalan
  }, { passive: true });
})();
<!-- ============ ABSENSI FLEX ‚Äì UTIL & RENDER (global, ringan) ============ -->

// === Load Santri Data ===
async function loadSantriData() {
  const kelas   = kelasSelect.value;
  const tanggal = tanggalInput.value; // tanggal awal (kolom pertama)
  overlay.style.display = "flex";

  // ===== util jenjang (tetap) =====
  const JENJANG_MAX = Number(window.JENJANG_MAX ?? 14);

  const parseJenjang = (v) => {
    const m = /^A(\d+)$/.exec(String(v || "").trim());
    return m ? Number(m[1]) : null;
  };
  const isValidJenjang = (v, max = JENJANG_MAX) => {
    if (!v) return true;
    const n = parseJenjang(v);
    if (!Number.isFinite(n) || n < 1) return false;
    if (!max || max === 0) return true;
    return n <= max;
  };
  const ensureJenjangOptions = (selectEl, max = JENJANG_MAX, currentValue = "") => {
    if (!selectEl) return;
    const existingVals = new Set([...selectEl.options].map(o => String(o.value || "")));
    const frag = document.createDocumentFragment();
    if (![...selectEl.options].some(o => o.value === "")) {
      const empty = document.createElement("option");
      empty.value = "";
      empty.textContent = "";
      frag.appendChild(empty);
    }
    for (let i = 1; i <= max; i++) {
      const v = `A${i}`;
      if (!existingVals.has(v)) {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        frag.appendChild(opt);
      }
    }
    if (frag.childNodes.length) selectEl.appendChild(frag);
    if (currentValue !== undefined && currentValue !== null) {
      selectEl.value = String(currentValue);
    }
  };

  // === cache master
  window.semesterMap   ??= {};
  window.jenjangMap    ??= {};
  window.keteranganMap ??= {};

  // ===== index riwayat tilawah =====
  // __ayatIndex [kelas][nis][surahId] = Set(ayat)
  // __ayatLatest[kelas][nis] = { dari:{surah,ayat,tanggal}, sampai:{...} }
  // __ayatOwner [kelas][nis][surahId][ayat] = "<YYYY-MM-DD>" (tanggal owner = yang paling awal)
  window.__ayatIndex  ??= {};
  window.__ayatLatest ??= {};
  window.__ayatOwner  ??= {};
  const getIndexBucket  = k => (window.__ayatIndex[k]  ??= {});
  const getLatestBucket = k => (window.__ayatLatest[k] ??= {});
  const getOwnerBucket  = k => (window.__ayatOwner[k]  ??= {});

  // Helpers kecil
  const keyId   = v => (v === 0 || v) ? String(v).trim() : "";
  const keyNis  = v => (v === 0 || v) ? String(v).trim() : "";
  const keyName = v => String(v || "").trim().toLowerCase();
  const byIdMap = (arr, pick = x => x) => {
    const m = new Map();
    for (const a of arr || []) { const id = keyId(a?.id); if (id) m.set(id, pick(a)); }
    return m;
  };
  const byNisMap = (arr, pick = x => x) => {
    const m = new Map();
    for (const a of arr || []) { const nis = keyNis(a?.nis); if (nis) m.set(nis, pick(a)); }
    return m;
  };
  const byNameMap = (arr, pick = x => x) => {
    const m = new Map();
    for (const a of arr || []) { const nm = keyName(a?.nama); if (nm && !m.has(nm)) m.set(nm, pick(a)); }
    return m;
  };

  function setButtonsDisabled(disabled) {
    const targets = [
      document.getElementById("save-btn-modal"),
      document.getElementById("save-btn"),
      document.getElementById("mur-save"),
	  document.getElementById("paBtnSave"),
	  document.getElementById("mur1-totalJuz-reset"),
	  document.getElementById("mur2-totalJuz-reset"),
	  document.getElementById("mur3-totalJuz-reset"),
      document.querySelector("button[onclick='bukaModalSantri()']"),
      document.getElementById("btnHapusSantri"),
      document.getElementById("btnPindahKelas"),
      document.getElementById("recordButton"),
      document.getElementById("btn-beri-nilai"),
      document.querySelector("button[onclick='simpanSantriBaru()']"),
      document.getElementById("btnHapusTerpilih"),
      document.getElementById("doPindah"),
    ];
    targets.forEach(btn => {
      if (!btn) return;
      btn.disabled = !!disabled;
      btn.style.opacity = disabled ? "0.5" : "";
      btn.style.cursor  = disabled ? "not-allowed" : "";
      if (disabled) {
        btn.dataset._onclick_bak ??= btn.getAttribute("onclick") || "";
        if (btn.dataset._onclick_bak) btn.removeAttribute("onclick");
      } else {
        if (btn.dataset._onclick_bak) {
          btn.setAttribute("onclick", btn.dataset._onclick_bak);
          delete btn.dataset._onclick_bak;
        }
      }
    });
  }

  // ========== INDEX GLOBAL dari server ==========
  function academicYearRange(today = new Date()) {
    const y = today.getFullYear();
    const start = new Date(today.getMonth() < 6 ? y - 1 : y, 6, 1);  // 1 Jul
    const end   = new Date(start.getFullYear() + 1, 5, 30);          // 30 Jun berikutnya
    const toISO = d => d.toISOString().slice(0,10);
    return { start: toISO(start), end: toISO(end) };
  }
  function resetBucketsForClass(kelasKey) {
    window.__ayatIndex [kelasKey] = {};
    window.__ayatLatest[kelasKey] = {};
    window.__ayatOwner [kelasKey] = {};
  }
  const earlier = (a, b) => String(a||"").localeCompare(String(b||"")) < 0;

  // bangun/merge index + owner (owner = tanggal paling awal)
  function buildAyatIndexFromList(kelasKey, absList) {
    const usedBucket   = getIndexBucket(kelasKey);
    const latestBucket = getLatestBucket(kelasKey);
    const ownerBucket  = getOwnerBucket(kelasKey);

    const ensureOwner = (nis, s, a, tanggal) => {
      ownerBucket[nis] ??= {};
      ownerBucket[nis][s] ??= {};
      const cur = ownerBucket[nis][s][a];
      if (!cur || earlier(tanggal, cur)) ownerBucket[nis][s][a] = String(tanggal||"");
    };

    const pushPoint = (nis, kind, surahAyat, tanggal) => {
      if (!nis || !surahAyat || !/^\d+:\d+$/.test(surahAyat)) return;
      const [sN,aN] = surahAyat.split(":").map(Number);
      const s = String(sN), a = Number(aN);
      usedBucket[nis] ??= {};
      usedBucket[nis][s] ??= new Set();
      usedBucket[nis][s].add(a);

      ensureOwner(nis, s, a, tanggal);

      latestBucket[nis] ??= {};
      const prev = latestBucket[nis][kind];
      if (!prev || String(tanggal).localeCompare(String(prev.tanggal)) > 0) {
        latestBucket[nis][kind] = { surah: s, ayat: a, tanggal: String(tanggal||"") };
      }
    };

    const pushRange = (nis, dariStr, sampaiStr, tanggal) => {
      if (!nis || !dariStr || !sampaiStr) return;
      const m1 = /^(\d+):(\d+)$/.exec(String(dariStr).trim());
      const m2 = /^(\d+):(\d+)$/.exec(String(sampaiStr).trim());
      if (!m1 || !m2) return;

      let sFrom = Number(m1[1]), aFrom = Number(m1[2]);
      let sTo   = Number(m2[1]), aTo   = Number(m2[2]);
      if (sFrom > sTo || (sFrom === sTo && aFrom > aTo)) {
        [sFrom, sTo] = [sTo, sFrom];
        [aFrom, aTo] = [aTo, aFrom];
      }

      usedBucket[nis] ??= {};
      for (let s = sFrom; s <= sTo; s++) {
        const surah = surahList.find(x => Number(x.id) === s);
        if (!surah) continue;
        const totalAy = Number(surah.jumlah_ayat || 0); // ‚úÖ FIX
        const startAy = (s === sFrom) ? aFrom : 1;
        const endAy   = (s === sTo)   ? aTo   : totalAy;

        const keyS = String(s);
        const set = (usedBucket[nis][keyS] ??= new Set());
        for (let a = startAy; a <= endAy; a++) {
          set.add(a);
          ensureOwner(nis, keyS, a, tanggal);
        }
      }
    };

    (absList||[]).forEach(r => {
      const nis = keyNis(r?.nis) || keyId(r?.id) || "";
      const tgl = r?.tanggal || "";
      const dari   = r?.dari   ? String(r.dari)   : "";
      const sampai = r?.sampai ? String(r.sampai) : "";

      if (dari)   pushPoint(nis, 'dari',   dari,   tgl);
      if (sampai) pushPoint(nis, 'sampai', sampai, tgl);
      if (dari && sampai) pushRange(nis, dari, sampai, tgl);
    });
  }

  async function fetchGlobalUsageIndex(kelasKey) {
    const { start, end } = academicYearRange(new Date());
    resetBucketsForClass(kelasKey);
    try {
      const r = await fetch(`/api/getAbsensiRange?kelas=${encodeURIComponent(kelasKey)}&start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}&t=${Date.now()}`, { credentials:'include' });
      const json = await r.json().catch(()=>({}));
      const list = Array.isArray(json) ? json : (json?.list || []);
      buildAyatIndexFromList(kelasKey, list);
    } catch(e) {
      console.warn('Gagal memuat riwayat global, jatuh ke index lokal hari ini.', e);
    }
  }

  // ===== generator opsi SURAH: skip surah "habis" KECUALI ada ayat yang owner-nya = tanggal baris ini
  function makeSurahOptions(kelasKey, nis, kind, selectedId = "", opts = {}) {
    const { ownerDate = "", allowAll = false } = opts;
    const usedMap   = (getIndexBucket(kelasKey)?.[nis])   || {};
    const latestMap = (getLatestBucket(kelasKey)?.[nis]?.[kind]);
    const ownerMap  = (getOwnerBucket(kelasKey)?.[nis])   || {};

    let html = `<option value="">‚Äî Surah ‚Äî</option>`;
    for (const s of surahList) {
      const sid     = String(s.id);
      const usedSet = usedMap[sid] || null;
      const total   = Number(s.jumlah_ayat || 0);

      let isFull = usedSet && total > 0 && usedSet.size >= total;

      // Jika baris ini adalah OWNER dari salah satu ayat di surah tersebut, jangan sembunyikan
      if (isFull && ownerDate && ownerMap[sid]) {
        // ada ayat yg ownernya = ownerDate?
        const hasOwnedHere = [...usedSet].some(a => String(ownerMap[sid][a]) === String(ownerDate));
        if (hasOwnedHere) isFull = false;
      }

      if (!allowAll && isFull && String(selectedId) !== sid) continue;

      const hasAny = !!usedSet && usedSet.size > 0;
      const isLast = latestMap && latestMap.surah === sid;
      const mark   = isLast ? "üü¢ " : (hasAny ? "‚úì " : "");
      const sel    = selectedId && selectedId == sid ? ' selected' : '';
      html += `<option value="${sid}"${sel}>${mark}${s.nama}</option>`;
    }
    return html;
  }
  window.__makeSurahOptions = makeSurahOptions;

  // AYAT dropdown bertanda ‚úì/üü¢ ‚Äî fallback aman bila Tahap 2 belum terpasang
function _fillAyatOptionsMarkedLocal(selectEl, surahId, selectedAyat = "") {
  if (!selectEl) return;
  selectEl.innerHTML = `<option value="">‚Äî Ayat ‚Äî</option>`;
  if (selectedAyat) selectEl.value = String(selectedAyat);
}
// helper: pilih global jika ada, selain itu pakai lokal
function callFillAyatOptions(selectEl, surahId, selectedAyat=""){
  if (typeof window.fillAyatOptionsMarked === "function") {
    window.fillAyatOptionsMarked(selectEl, surahId, selectedAyat);
  } else {
    _fillAyatOptionsMarkedLocal(selectEl, surahId, selectedAyat);
  }
}

  try {
    // MASTER santri
    const resSantri = await fetch(`/api/getSantri?kelas=${encodeURIComponent(kelas)}&t=${Date.now()}`, { credentials:'include' });
    let santriData = await resSantri.json().catch(() => []);
    if (!Array.isArray(santriData)) santriData = [];

    window.semesterMap   = {};
    window.jenjangMap    = {};
    window.keteranganMap = {};

    (santriData || []).forEach(s => {
      const k = (s?.nis != null && s.nis !== "") ? String(s.nis).trim()
              : (s?.id != null ? String(s.id).trim() : "");
      if (!k) return;
      window.semesterMap[k]   = String(s?.semester   ?? "1");
      window.jenjangMap[k]    = String(s?.jenjang    ?? "");
      window.keteranganMap[k] = String(s?.keterangan ?? "");
    });

    const rosterById   = byIdMap(santriData, s => s);
    const rosterByNis  = byNisMap(santriData, s => s);
    const rosterByName = byNameMap(santriData, s => s);

    // Ambil absensi (single / range)
    let absensiRaw = [];
    const endEl = (typeof tanggalFilterAkhir !== 'undefined' && tanggalFilterAkhir) ? tanggalFilterAkhir : window.tanggalFilterAkhir;
    const endFilter = endEl ? endEl.value : "";

    if (endFilter && endFilter !== tanggal) {
      const resAbsensiRange = await fetch(`/api/getAbsensiRange?kelas=${encodeURIComponent(kelas)}&start=${encodeURIComponent(tanggal)}&end=${encodeURIComponent(endFilter)}&t=${Date.now()}`, { credentials:'include' });
      let d = await resAbsensiRange.json().catch(()=>({}));
      absensiRaw = Array.isArray(d) ? d : (d?.list || []);
      if (!Array.isArray(absensiRaw)) absensiRaw = [];
    } else {
      const resAbsensi = await fetch(`/api/getAbsensi?kelas=${encodeURIComponent(kelas)}&tanggal=${encodeURIComponent(tanggal)}&t=${Date.now()}`, { credentials:'include' });
      let d = await resAbsensi.json().catch(()=>({}));
      absensiRaw = Array.isArray(d) ? d : (d?.list || []);
    }

    // Normalisasi absensi
    let absensiData = absensiRaw.map((r) => {
      let id   = keyId(r?.id ?? "");
      let nis  = keyNis(r?.nis ?? "");
      const nm = keyName(r?.nama);

      if (!nis && id && rosterById.get(id)?.nis) nis = keyNis(rosterById.get(id).nis);
      if (!nis && nm && rosterByName.get(nm)?.nis) nis = keyNis(rosterByName.get(nm).nis);

      let nama = r?.nama;
      if (!nama && nis && rosterByNis.get(nis)?.nama) nama = rosterByNis.get(nis).nama;
      if (!nama && id  && rosterById.get(id)?.nama)  nama = rosterById.get(id).nama;

      if (!id && nis && rosterByNis.get(nis)?.id) id = keyId(rosterByNis.get(nis).id);

      const keyMaster   = nis || id || "";
      const semesterFix = window.semesterMap?.[keyMaster]   ?? r.semester;
      const jenjangFix  = window.jenjangMap?.[keyMaster]    ?? r.jenjang;
      const ketFix      = window.keteranganMap?.[keyMaster] ?? r.keterangan;

      return { ...r, id, nis, nama, semester: semesterFix, jenjang: jenjangFix, keterangan: ketFix };
    });

    // Muat INDEX GLOBAL + merge hari ini
    await fetchGlobalUsageIndex(kelas);
    buildAyatIndexFromList(kelas, absensiData);

    // filter akses user (tetap)
    const username = localStorage.getItem("username");
    const users = await fetch(`/api/getUsers?t=${Date.now()}`, {credentials:'include'}).then(r => r.json()).catch(()=>[]);
    const user  = users.find(u => u.username === username);

    if (user) {
      if (user.kelas && user.kelas.length) {
        if (!user.kelas.includes(kelas)) {
          santriData = [];
        } else if (user.nis && user.nis.length) {
          santriData = santriData.filter(s => user.nis.includes(s.nis));
        }
      }
    } else {
      santriData = [];
    }

    const isModeNIS = !!(user && Array.isArray(user.nis) && user.nis.length);
    setButtonsDisabled(isModeNIS);
    setNISDropdownDisabled(isModeNIS);
    setNISRecordDisabled(isModeNIS);
    setNISRekapDisabled(isModeNIS);

    // RENDER
    santriTableBody.innerHTML = "";
    const isRange = !!(endFilter && endFilter !== tanggal);

    let absById, absByNis, absByName, absensiById, absensiByNis, absensiByName;
    if (!isRange) {
      absById   = new Map();
      absByNis  = new Map();
      absByName = new Map();
      for (const a of absensiData) {
        const aid  = keyId(a?.id);
        const anis = keyNis(a?.nis);
        const anm  = keyName(a?.nama);
        if (aid && !absById.has(aid))   absById.set(aid, a);
        if (anis && !absByNis.has(anis)) absByNis.set(anis, a);
        if (anm && !absByName.has(anm))  absByName.set(anm, a);
      }
    } else {
      absensiById   = {};
      absensiByNis  = {};
      absensiByName = {};
      for (const a of absensiData) {
        const aid  = keyId(a?.id);
        const anis = keyNis(a?.nis);
        const anm  = keyName(a?.nama);
        if (aid)  (absensiById[aid]  ||= []).push(a);
        if (anis) (absensiByNis[anis] ||= []).push(a);
        if (anm)  (absensiByName[anm] ||= []).push(a);
      }
      const sorter = arr => arr.sort((x,y) => String(x.tanggal||"").localeCompare(String(y.tanggal||"")));
      Object.values(absensiById).forEach(sorter);
      Object.values(absensiByNis).forEach(sorter);
      Object.values(absensiByName).forEach(sorter);
    }

    function computeLocal(items, target){
      const maxT = Number(window.ABS_FLEX_CFG?.maxTarget ?? 6);
      const tgt = Math.max(1, Math.min(maxT, Number(target)||Number(window.ABS_FLEX_CFG?.defaultTarget||2)));
      const checked = (items||[]).reduce((a,it)=>a+(it?.checked?1:0),0);
      const percent = Math.round((Math.min(checked, tgt)/tgt)*100);
      return { checked, tgt, percent };
    }

    // per santri
    santriData.forEach((santri) => {
      const sid    = keyId(santri.id);
      const snis   = keyNis(santri.nis);
      const snameK = keyName(santri.nama);

      let rowsForSantri;
      if (isRange) {
        const fromNis  = (snis && absensiByNis?.[snis])  ? absensiByNis[snis]  : [];
        const fromId   = (sid  && absensiById?.[sid])    ? absensiById[sid]    : [];
        const fromName = (snameK && absensiByName?.[snameK]) ? absensiByName[snameK] : [];
        const seen = new Set();
        rowsForSantri = [];
        for (const r of [...fromNis, ...fromId, ...fromName]) {
          const k = r.tanggal || "__";
          if (!seen.has(k)) { rowsForSantri.push(r); seen.add(k); }
        }
      } else {
        const hit = (snis && absByNis.get(snis))
                 || (sid  && absById.get(sid))
                 || (snameK && absByName.get(snameK))
                 || null;
        rowsForSantri = [hit || {}];
      }

      if (isRange && rowsForSantri.length === 0) rowsForSantri.push({});

      rowsForSantri.forEach((dataAbsensi) => {
        const row = document.createElement("tr");

        const dariRaw   = (dataAbsensi?.dari   || "").trim();
        const sampaiRaw = (dataAbsensi?.sampai || "").trim();
        const dari   = dariRaw   ? dariRaw.split(":")   : ["",""];
        const sampai = sampaiRaw ? sampaiRaw.split(":") : ["",""];

        const rowDate = (isRange && dataAbsensi?.tanggal) ? dataAbsensi.tanggal : tanggal;
        const subTanggal = isRange && dataAbsensi?.tanggal
          ? `<div style="font-size:12px;opacity:.65">${dataAbsensi.tanggal}</div>` : "";

        const keyMaster = (snis || sid || "");
        const semNow = (window.semesterMap?.[keyMaster])   ?? santri.semester   ?? "1";
        const jenNow = (window.jenjangMap?.[keyMaster])    ?? santri.jenjang    ?? "";
        const ketNow = (window.keteranganMap?.[keyMaster]) ?? santri.keterangan ?? "";

        // SURAH (dengan konteks ownerDate=rowDate)
        const surahOptionsDari   = makeSurahOptions(kelas, snis || sid || "", 'dari',   dari[0]||"",   { ownerDate: rowDate });
        const surahOptionsSampai = makeSurahOptions(kelas, snis || sid || "", 'sampai', sampai[0]||"", { ownerDate: rowDate });

        row.innerHTML = `
          <td class="col-nis">${santri.nis ?? santri.id ?? ""}</td>
          <td class="col-nama">${santri.nama ?? ""}${subTanggal}</td>
          <td>
            <select class="jenjang">
    <option value="A1" ${jenNow === 'A1' ? 'selected' : ''}>1A</option>
    <option value="A2" ${jenNow === 'A2' ? 'selected' : ''}>1B</option>
    <option value="A3" ${jenNow === 'A3' ? 'selected' : ''}>2A</option>
    <option value="A4" ${jenNow === 'A4' ? 'selected' : ''}>2B</option>
    <option value="A5" ${jenNow === 'A5' ? 'selected' : ''}>3A</option>
    <option value="A6" ${jenNow === 'A6' ? 'selected' : ''}>3B</option>
    <option value="A7" ${jenNow === 'A7' ? 'selected' : ''}>4A</option>
    <option value="A8" ${jenNow === 'A8' ? 'selected' : ''}>4B</option>
    <option value="A9" ${jenNow === 'A9' ? 'selected' : ''}>5A1</option>
    <option value="A10" ${jenNow === 'A10' ? 'selected' : ''}>5A2</option>
    <option value="A11" ${jenNow === 'A11' ? 'selected' : ''}>5B</option>
    <option value="A12" ${jenNow === 'A12' ? 'selected' : ''}>6A1</option>
    <option value="A13" ${jenNow === 'A13' ? 'selected' : ''}>6A2</option>
    <option value="A14" ${jenNow === 'A14' ? 'selected' : ''}>6B</option>
  </select>
          </td>
          <td>
            <select class="semester">
    <option value="1" ${String(semNow) === '1' ? 'selected' : ''}>SM1-1</option>
    <option value="2" ${String(semNow) === '2' ? 'selected' : ''}>SM2-1</option>
    <option value="3" ${String(semNow) === '3' ? 'selected' : ''}>SM1-2</option>
    <option value="4" ${String(semNow) === '4' ? 'selected' : ''}>SM2-2</option>
    <option value="5" ${String(semNow) === '5' ? 'selected' : ''}>SM1-3</option>
    <option value="6" ${String(semNow) === '6' ? 'selected' : ''}>SM2-3</option>
    <option value="7" ${String(semNow) === '7' ? 'selected' : ''}>SM1-4</option>
    <option value="8" ${String(semNow) === '8' ? 'selected' : ''}>SM2-4</option>
    <option value="9" ${String(semNow) === '9' ? 'selected' : ''}>SM1-5</option>
    <option value="10" ${String(semNow) === '10' ? 'selected' : ''}>SM2-5</option>
    <option value="11" ${String(semNow) === '11' ? 'selected' : ''}>SM1-6</option>
    <option value="12" ${String(semNow) === '12' ? 'selected' : ''}>SM2-6</option>
  </select>
          </td>

          <!-- ABSENSI FLEX -->
          <td class="abs-flex-cell">
            <div class="abs-mini" style="font-size:12px;opacity:.8;margin-top:4px;"></div>
            <button type="button" class="btn-absensi-flex" style="margin-top:6px; padding:4px 8px;border:1px solid #e5e7eb;border-radius:8px;background:#1E88E5;">Input</button>
          </td>

          <td>
            <select class="keterangan">
    <option value="" ${!ketNow ? 'selected' : ''}></option>
    <option value="SP1" ${ketNow === 'SP1' ? 'selected' : ''}>SP1</option>
    <option value="SP2" ${ketNow === 'SP2' ? 'selected' : ''}>SP2</option>
    <option value="SP3" ${ketNow === 'SP3' ? 'selected' : ''}>SP3</option>
  </select>
          </td>
          <td>
            <select class="surah-dari">${surahOptionsDari}</select>
            <select class="ayat-dari"  data-kind="dari"   data-kelas="${kelas}" data-nis="${snis||sid||''}"><option value="">‚Äî Ayat ‚Äî</option></select>
          </td>
          <td>
            <select class="surah-sampai">${surahOptionsSampai}</select>
            <select class="ayat-sampai" data-kind="sampai" data-kelas="${kelas}" data-nis="${snis||sid||''}"><option value="">‚Äî Ayat ‚Äî</option></select>
          </td>
          <td class="halaman-terbaca">${dataAbsensi?.halaman ?? '-'}</td>
          <td class="total-halaman">${dataAbsensi?.totalHalaman ?? '-'}</td>
          <td class="juz-terbaca">${dataAbsensi?.juzTerbaca ?? '-'}</td>
          <td class="total-juz">0.00</td>
          <td>
            <div class="nilai-ringkas">
              ${dataAbsensi?.buttonCell
                ? `<strong>${Number(dataAbsensi.buttonCell.nilai).toFixed(1)}</strong> - ${bgHuruf(dataAbsensi.buttonCell.predikatHuruf, dataAbsensi.buttonCell.predikatText)}`
                : ''}
            </div>
            <button type="button" class="lihat-quran-btn">Lembar Penilaian</button>
          </td>
          <td class="total-all-juz">0</td>
        `;

        // DATASET stabil
        const dsId  = keyId(sid);
        const dsNis = keyNis(snis);
        row.dataset.id        = dsId;
        row.dataset.nis       = dsNis;
        row.dataset.key       = (dsNis || dsId || "");
        row.dataset.tanggal   = rowDate;
        row.dataset.kelas     = kelas;
        row.dataset.jenjang   = jenNow || "";
        row.dataset.keterangan= ketNow || "";

        if (dataAbsensi && dataAbsensi.marks) row.markData = dataAbsensi.marks;

        santriTableBody.appendChild(row);

        const totalAllJuzTd = row.querySelector("td.total-all-juz");
        if (totalAllJuzTd && totalAllJuzTd.textContent.trim() === "0") {
          totalAllJuzTd.innerHTML = `0`;
        }

        // Surah/Ayat init (pakai versi "Marked" bila ada)
        const surahDari   = row.querySelector(".surah-dari");
        const ayatDari    = row.querySelector(".ayat-dari");
        const surahSampai = row.querySelector(".surah-sampai");
        const ayatSampai  = row.querySelector(".ayat-sampai");

        const dariArr   = Array.isArray(dari)   ? dari   : String(dari).split(":");
        const sampaiArr = Array.isArray(sampai) ? sampai : String(sampai).split(":");

        if (dariArr[0])   surahDari.value   = dariArr[0];
        if (sampaiArr[0]) surahSampai.value = sampaiArr[0];

        callFillAyatOptions(ayatDari,   surahDari.value || "",   dariArr[1]   || "");
		callFillAyatOptions(ayatSampai, surahSampai.value || "", sampaiArr[1] || "");

        if (dataAbsensi?.tilawahTotalJuz) {
          const tj = Number(dataAbsensi.tilawahTotalJuz);
          if (!Number.isNaN(tj)) row.querySelector(".total-juz").textContent = tj.toFixed(2);
        } else if (dariArr[0] && dariArr[1] && sampaiArr[0] && sampaiArr[1]) {
          updateTotalJuz(row);
        }

        // events: regenerate label + ownerDate context
        const rebuildSurahDari = () => {
          const cur = surahDari.value;
          surahDari.innerHTML = makeSurahOptions(kelas, dsNis || dsId || "", 'dari', cur, { ownerDate: rowDate });
        };
        const rebuildSurahSampai = () => {
          const cur = surahSampai.value;
          surahSampai.innerHTML = makeSurahOptions(kelas, dsNis || dsId || "", 'sampai', cur, { ownerDate: rowDate });
        };

        surahDari.addEventListener("change", () => {
          rebuildSurahDari();
          callFillAyatOptions(ayatDari, surahDari.value || "", "");
          if (surahDari.value) {
            surahSampai.value = surahDari.value;
            rebuildSurahSampai();
            callFillAyatOptions(ayatSampai, surahSampai.value || "", "");
            ayatSampai.value = ayatDari.value || "";
          } else {
            surahSampai.value = "";
            rebuildSurahSampai();
            fillAyatOptionsMarked(ayatSampai, "", "");
          }
          updateTotalJuz(row);
        });

        surahSampai.addEventListener("change", () => {
          rebuildSurahSampai();
          callFillAyatOptions(ayatSampai, surahSampai.value || "", "");
          updateTotalJuz(row);
        });

        ayatDari.addEventListener("change", () => {
          ayatSampai.value = ayatDari.value || "";
          updateTotalJuz(row);
        });

        ayatSampai.addEventListener("change", () => {
          updateTotalJuz(row);
        });

        // Jenjang / Keterangan / Semester (tetap)
        const jenSel = row.querySelector(".jenjang");
        ensureJenjangOptions(jenSel, JENJANG_MAX, jenNow);
        if (jenSel) {
          jenSel.addEventListener("change", async () => {
            const key  = String(row.dataset?.key || row.dataset?.nis || row.dataset?.id || "").trim();
            const oldJ = String(row.dataset?.jenjang ?? (window.jenjangMap?.[key] ?? jenNow ?? ""));
            const newJ = String(jenSel.value || "");
            if (!isValidJenjang(newJ)) {
              alert(`Jenjang harus A1 - A${JENJANG_MAX || '‚àû'} (atau kosong).`);
              jenSel.value = oldJ;
              return;
            }
            jenSel.disabled = true;
            jenSel.style.opacity = "0.6";
            try {
              const res = await fetch(`/api/updateJenjangKelas?kelas=${encodeURIComponent(kelas)}`, {
                method: "POST", credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ key, jenjang: newJ })
              });
              const text = await res.text();
              let out = {}; try { out = JSON.parse(text); } catch {}
              if (!res.ok || out?.success !== true) throw new Error(out?.error || text || "Gagal update jenjang.");
              window.jenjangMap[key] = newJ;
              row.dataset.jenjang    = newJ;
            } catch (e) {
              alert("Gagal menyimpan jenjang ke kelas: " + e.message);
              jenSel.value = oldJ;
            } finally {
              jenSel.disabled = false;
              jenSel.style.opacity = "";
            }
          });
        }

        const ketSel = row.querySelector(".keterangan");
        if (ketSel) {
          ketSel.addEventListener("change", async () => {
            const key  = String(row.dataset?.key || row.dataset?.nis || row.dataset?.id || "").trim();
            const oldK = String(row.dataset?.keterangan ?? (window.keteranganMap?.[key] ?? ketNow ?? ""));
            const newK = String(ketSel.value || "");
            if (newK && !/^SP[1-4]$/.test(newK)) {
              alert("Keterangan harus SP1 - SP4 (atau kosong).");
              ketSel.value = oldK;
              return;
            }
            ketSel.disabled = true;
            ketSel.style.opacity = "0.6";
            try {
              const res = await fetch(`/api/updateKeteranganKelas?kelas=${encodeURIComponent(kelas)}`, {
                method: "POST", credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ key, keterangan: newK })
              });
              const text = await res.text();
              let out = {}; try { out = JSON.parse(text); } catch {}
              if (!res.ok || out?.success !== true) throw new Error(out?.error || text || "Gagal update keterangan.");
              window.keteranganMap[key] = newK;
              row.dataset.keterangan  = newK;
            } catch (e) {
              alert("Gagal menyimpan keterangan ke kelas: " + e.message);
              ketSel.value = oldK;
            } finally {
              ketSel.disabled = false;
              ketSel.style.opacity = "";
            }
          });
        }

        const semSel = row.querySelector(".semester");
        if (semSel) {
          semSel.addEventListener("change", async () => {
            const key    = String(row.dataset?.key || row.dataset?.nis || row.dataset?.id || "").trim();
            const oldSem = String(window.semesterMap?.[key] ?? semNow ?? "1");
            const newSem = String(semSel.value || oldSem);

            if (typeof isValidSemester === "function" && !isValidSemester(newSem)) {
              alert(`Semester harus 1-${SEMESTER_MAX}.`);
              semSel.value = oldSem;
              return;
            }

            semSel.disabled = true;
            semSel.style.opacity = "0.6";
            try {
              const res = await fetch(`/api/updateSemesterKelas?kelas=${encodeURIComponent(kelas)}`, {
                method: "POST", credentials: "include",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ key, semester: newSem })
              });
              const text = await res.text();
              let out = {}; try { out = JSON.parse(text); } catch {}
              if (!res.ok || out?.success !== true) throw new Error(out?.error || text || "Gagal update semester.");
              window.semesterMap[key] = newSem;
            } catch (e) {
              alert("Gagal menyimpan semester ke kelas: " + e.message);
              semSel.value = oldSem;
            } finally {
              semSel.disabled = false;
              semSel.style.opacity = "";
            }
          });
        }

        // ABSENSI FLEX (tetap) ‚Äî REVISI: clone & listener pada root modal
        (function initAbsensiFlexModalForRow(){
          const cell = row.querySelector(".abs-flex-cell");
          const btn  = cell.querySelector(".btn-absensi-flex");
          const mini = cell.querySelector(".abs-mini");
          const { preset, target } = window.__makePresetAbsensiItems(dataAbsensi || {});

          // ‚úÖ clone saat init cell (anti share antar baris)
          const itemsInit = window.__absflex_safeCloneItems(preset);
          const comp = computeLocal(itemsInit, target);
          cell._absensiItems   = itemsInit;
          cell._absensiTarget  = comp.tgt;
          cell._absensiChecked = comp.checked;
          cell._absensiPercent = comp.percent;

          function updateMini(){
            // teks + atribut bantu
            mini.textContent = `${cell._absensiPercent}% (${cell._absensiChecked}/${cell._absensiTarget})`;
            mini.setAttribute('data-progress', String(cell._absensiPercent));

            // indikator complete (kompat lama)
            const complete = Number(cell._absensiPercent) >= 100;
            mini.classList.toggle('is-complete', complete);

            // warna berdasar status dominan
            const st = (typeof window.__absmini_dominantStatus==='function')
              ? window.__absmini_dominantStatus(cell._absensiItems)
              : null;

            mini.classList.remove('is-hadir','is-izin','is-sakit','is-alpha');
            if (st) {
              mini.classList.add(`is-${st}`);
            } else {
              mini.style.background = '';
              mini.style.color = '';
              mini.style.borderRadius = '';
              mini.style.padding = '';
            }
          }

          updateMini();

          btn.addEventListener("click", () => {
            ensureAbsensiModal();
            const modal   = document.getElementById("absensiModalOverlay");
            const content = document.getElementById("absensiModalContent");
            content.innerHTML = "";

            // buat root baru utk widget ‚Üí listener tidak menumpuk
            const root = document.createElement("div");
            content.appendChild(root);

            // kirim clone state cell sebagai preset
            const presetItems = window.__absflex_safeCloneItems(cell._absensiItems);
            const tgt = Number(cell._absensiTarget) || target;
            const widget = renderAbsensiFlex(root, { target: tgt, presetItems });

            // pasang listener pada root (bukan content) + simpan balik pakai clone
            const onRootChange = () => {
              cell._absensiItems   = window.__absflex_safeCloneItems(widget._absensiItems);
              cell._absensiTarget  = Number(widget._absensiTarget)  || cell._absensiTarget || 1;
              cell._absensiChecked = Number(widget._absensiChecked) || 0;
              cell._absensiPercent = Number(widget._absensiPercent) || 0;
              updateMini();
            };
            root.addEventListener("change", onRootChange);

            // sinkron awal (kalau clamp mengubah)
            onRootChange();

            modal.style.display = "flex";
          });
        })();
      });
    });
  } catch (err) {
    alert("Gagal memuat data santri / absensi!");
    console.error(err);
  }

  overlay.style.display = "none";
}
	

// ====== Dropdown Ayat (OWNER-AWARE): ayat terpakai disembunyikan KECUALI jika baris ini adalah owner-nya ======
// ====== Dropdown Ayat (OWNER-AWARE + RENTANG OWNER TETAP TAMPIL) ======
function fillAyatOptionsMarked(selectEl, surahId, selectedAyat = "") {
  if (!selectEl) return;

  const nis    = selectEl.dataset?.nis   || "";
  const kind   = selectEl.dataset?.kind  || "";   // 'dari' | 'sampai'
  const kelas  = selectEl.dataset?.kelas || "";
  const row    = selectEl.closest('tr');
  const ownerDateHere = row?.dataset?.tanggal || "";

  // bucket global
  const usedBucket   = (window.__ayatIndex  && window.__ayatIndex[kelas])  ? window.__ayatIndex[kelas]  : {};
  const latestBucket = (window.__ayatLatest && window.__ayatLatest[kelas]) ? window.__ayatLatest[kelas] : {};
  const ownerBucket  = (window.__ayatOwner  && window.__ayatOwner[kelas])  ? window.__ayatOwner[kelas]  : {};

  const usedSet =
    (usedBucket[nis] && usedBucket[nis][String(surahId)] instanceof Set)
      ? usedBucket[nis][String(surahId)]
      : new Set();

  const latestObj = (latestBucket[nis] && latestBucket[nis][kind]) ? latestBucket[nis][kind] : null;
  const ownerMap  = (ownerBucket[nis] && ownerBucket[nis][String(surahId)]) ? ownerBucket[nis][String(surahId)] : {};

  // Jika surah belum dipilih ‚Üí hanya opsi kosong
  if (!surahId) {
    selectEl.innerHTML = `<option value="">‚Äî Ayat ‚Äî</option>`;
    selectEl.value = "";
    return;
  }

  const surah = surahList.find(s => String(s.id) === String(surahId));
  if (!surah) {
    selectEl.innerHTML = `<option value="">‚Äî Ayat ‚Äî</option>`;
    selectEl.value = "";
    return;
  }

  // ===== Inti perbaikan: hitung RENTANG EDITABLE untuk baris ini =====
  // Ambil pilihan baris saat ini (dari & sampai)
  const sD = Number(row.querySelector(".surah-dari")?.value || 0);
  const aD = Number(row.querySelector(".ayat-dari")?.value || 0);
  const sS = Number(row.querySelector(".surah-sampai")?.value || 0);
  const aS = Number(row.querySelector(".ayat-sampai")?.value || 0);
  const thisSurah = Number(surahId);

  let editableMin = null, editableMax = null;
  if (sD && sS) {
    // Normalisasi urutan
    let sFrom = sD, sTo = sS, ayFrom = aD, ayTo = aS;
    if (sFrom > sTo || (sFrom === sTo && ayFrom > ayTo)) {
      [sFrom, sTo] = [sTo, sFrom];
      [ayFrom, ayTo] = [ayTo, ayFrom];
    }

    if (thisSurah > sFrom && thisSurah < sTo) {
      // Surah di tengah rentang ‚Üí seluruh ayat editable
      editableMin = 1;
      editableMax = surah.jumlah_ayat;
    } else if (thisSurah === sFrom && thisSurah === sTo) {
      // Rentang di satu surah ‚Üí dari ayFrom..ayTo
      editableMin = Math.max(1, ayFrom || 1);
      editableMax = Math.min(surah.jumlah_ayat, ayTo || surah.jumlah_ayat);
    } else if (thisSurah === sFrom && thisSurah !== sTo) {
      // Surah awal ‚Üí dari ayFrom..akhir surah
      editableMin = Math.max(1, ayFrom || 1);
      editableMax = surah.jumlah_ayat;
    } else if (thisSurah === sTo && thisSurah !== sFrom) {
      // Surah akhir ‚Üí dari 1..ayTo
      editableMin = 1;
      editableMax = Math.min(surah.jumlah_ayat, ayTo || surah.jumlah_ayat);
    }
  }

  // Helper cek apakah ayat i berada dalam rentang editable baris ini
  const isInEditableRange = (i) => (
    editableMin !== null && editableMax !== null && i >= editableMin && i <= editableMax
  );

  const frag = document.createDocumentFragment();

  // Opsi kosong di paling atas
  const blank = document.createElement("option");
  blank.value = "";
  blank.textContent = "‚Äî Ayat ‚Äî";
  frag.appendChild(blank);

  const selectedStr = selectedAyat ? String(selectedAyat) : "";

  for (let i = 1; i <= surah.jumlah_ayat; i++) {
    const iStr = String(i);
    const isUsed      = usedSet.has(i) || usedSet.has(iStr);
    const isOwnerHere = String(ownerMap[i]) === String(ownerDateHere);
    const isLatest    = !!(latestObj
                        && String(latestObj.surah) === String(surahId)
                        && Number(latestObj.ayat) === i);

    // ===== RULE BARU =====
    // Ayat terpakai di-hide KECUALI:
    // 1) baris ini adalah OWNER ayat tsb, atau
    // 2) ayat berada di RENTANG EDITABLE (karena baris ini pemilik rentangnya), atau
    // 3) ini adalah nilai yang sedang terpilih di dropdown (agar tidak "hilang" tiba-tiba).
    if (isUsed && !isOwnerHere && !isInEditableRange(i) && selectedStr !== iStr) {
      continue;
    }

    let label = iStr;
    if (isUsed)   label = `‚úì ${label}`;   // tetap beri tanda, meski ditampilkan
    if (isLatest) label = `${label} üü¢`;

    const opt = document.createElement("option");
    opt.value = iStr;
    opt.textContent = label;
    frag.appendChild(opt);
  }

  selectEl.innerHTML = "";
  selectEl.appendChild(frag);

  if (selectedStr && [...selectEl.options].some(o => o.value === selectedStr)) {
    selectEl.value = selectedStr;
  } else {
    selectEl.value = "";
  }
}

// (Opsional) wrapper agar kompatibel dengan pemanggilan lama:
function fillAyatOptions(selectEl, surahId, selectedAyat = "") {
  fillAyatOptionsMarked(selectEl, surahId, selectedAyat);
}

// ====== mapping jumlah ayat per halaman (isi sesuai data Anda) ======
const jumlahAyatPerHalaman = {"1":7,"2":5,"3":11,"4":8,"5":5,"6":8,"7":11,"8":9,"9":4,"10":8,"11":7,"12":7,"13":5,"14":5,"15":8,"16":4,"17":7,"18":7,"19":7,"20":8,"21":7,"22":4,"23":8,"24":10,"25":6,"26":7,"27":5,"28":5,"29":4,"30":6,"31":6,"32":8,"33":5,"34":4,"35":5,"36":6,"37":3,"38":4,"39":8,"40":3,"41":4,"42":4,"43":3,"44":5,"45":5,"46":5,"47":7,"48":1,"49":4,"50":9,"51":6,"52":7,"53":7,"54":8,"55":8,"56":7,"57":9,"58":9,"59":7,"60":6,"61":8,"62":9,"63":8,"64":7,"65":6,"66":11,"67":8,"68":8,"69":5,"70":4,"71":8,"72":8,"73":7,"74":6,"75":8,"76":6,"77":6,"78":5,"79":3,"80":5,"81":4,"82":3,"83":7,"84":4,"85":7,"86":7,"87":8,"88":6,"89":9,"90":5,"91":7,"92":5,"93":3,"94":7,"95":4,"96":8,"97":8,"98":6,"99":7,"100":6,"101":7,"102":7,"103":8,"104":8,"105":5,"106":3,"107":3,"108":4,"109":4,"110":4,"111":6,"112":8,"113":5,"114":5,"115":4,"116":5,"117":7,"118":7,"119":6,"120":6,"121":6,"122":7,"123":6,"124":8,"125":5,"126":5,"127":7,"128":8,"129":10,"130":9,"131":8,"132":9,"133":8,"134":7,"135":9,"136":5,"137":8,"138":9,"139":4,"140":7,"141":9,"142":8,"143":6,"144":7,"145":6,"146":5,"147":4,"148":5,"149":6,"150":8,"151":11,"152":11,"153":8,"154":7,"155":6,"156":8,"157":6,"158":10,"159":6,"160":8,"161":6,"162":8,"163":9,"164":16,"165":10,"166":7,"167":6,"168":6,"169":6,"170":4,"171":4,"172":7,"173":8,"174":9,"175":8,"176":11,"177":8,"178":8,"179":9,"180":8,"181":7,"182":5,"183":7,"184":9,"185":8,"186":6,"187":6,"188":7,"189":7,"190":6,"191":5,"192":5,"193":4,"194":7,"195":7,"196":7,"197":7,"198":4,"199":7,"200":7,"201":7,"202":6,"203":7,"204":5,"205":6,"206":5,"207":7,"208":6,"209":8,"210":6,"211":5,"212":8,"213":9,"214":11,"215":8,"216":9,"217":8,"218":10,"219":9,"220":9,"221":8,"222":7,"223":7,"224":9,"225":9,"226":8,"227":8,"228":9,"229":9,"230":10,"231":7,"232":9,"233":11,"234":9,"235":10,"236":10,"237":8,"238":8,"239":7,"240":6,"241":9,"242":11,"243":6,"244":9,"245":8,"246":9,"247":8,"248":8,"249":5,"250":8,"251":5,"252":10,"253":6,"254":8,"255":6,"256":5,"257":8,"258":6,"259":9,"260":9,"261":10,"262":15,"263":16,"264":20,"265":19,"266":20,"267":15,"268":8,"269":12,"270":8,"271":8,"272":12,"273":10,"274":8,"275":7,"276":8,"277":6,"278":9,"279":8,"280":8,"281":10,"282":7,"283":10,"284":10,"285":11,"286":11,"287":9,"288":8,"289":9,"290":11,"291":10,"292":8,"293":11,"294":11,"295":5,"296":7,"297":7,"298":11,"299":8,"300":8,"301":13,"302":9,"303":14,"304":13,"305":11,"306":14,"307":13,"308":13,"309":13,"310":12,"311":19,"312":15,"313":25,"314":14,"315":13,"316":12,"317":11,"318":11,"319":15,"320":12,"321":10,"322":10,"323":14,"324":11,"325":9,"326":13,"327":15,"328":9,"329":9,"330":11,"331":11,"332":5,"333":10,"334":8,"335":7,"336":8,"337":8,"338":9,"339":9,"340":8,"341":6,"342":17,"343":10,"344":15,"345":17,"346":15,"347":15,"348":15,"349":14,"350":10,"351":10,"352":7,"353":4,"354":5,"355":7,"356":10,"357":5,"358":3,"359":5,"360":9,"361":9,"362":12,"363":11,"364":12,"365":12,"366":10,"367":19,"368":20,"369":21,"370":23,"371":28,"372":25,"373":23,"374":24,"375":23,"376":21,"377":13,"378":9,"379":13,"380":9,"381":11,"382":8,"383":13,"384":12,"385":10,"386":8,"387":8,"388":7,"389":7,"390":8,"391":7,"392":9,"393":11,"394":7,"395":7,"396":10,"397":8,"398":9,"399":7,"400":8,"401":7,"402":7,"403":11,"404":11,"405":10,"406":9,"407":8,"408":9,"409":9,"410":10,"411":11,"412":8,"413":9,"414":6,"415":11,"416":9,"417":10,"418":6,"419":9,"420":7,"421":8,"422":5,"423":8,"424":7,"425":4,"426":8,"427":11,"428":7,"429":7,"430":8,"431":9,"432":8,"433":9,"434":9,"435":8,"436":7,"437":12,"438":8,"439":6,"440":13,"441":15,"442":13,"443":14,"444":16,"445":13,"446":24,"447":27,"448":25,"449":26,"450":24,"451":27,"452":29,"453":16,"454":10,"455":16,"456":19,"457":22,"458":10,"459":5,"460":11,"461":10,"462":9,"463":7,"464":9,"465":11,"466":7,"467":8,"468":9,"469":9,"470":8,"471":7,"472":9,"473":9,"474":8,"475":11,"476":8,"477":11,"478":9,"479":9,"480":9,"481":8,"482":8,"483":10,"484":5,"485":7,"486":9,"487":13,"488":7,"489":12,"490":12,"491":11,"492":14,"493":13,"494":13,"495":16,"496":18,"497":21,"498":20,"499":13,"500":9,"501":10,"502":10,"503":9,"504":6,"505":8,"506":7,"507":11,"508":8,"509":10,"510":9,"511":9,"512":6,"513":8,"514":5,"515":5,"516":7,"517":7,"518":15,"519":20,"520":16,"521":24,"522":21,"523":23,"524":17,"525":18,"526":26,"527":18,"528":24,"529":21,"530":22,"531":22,"532":24,"533":27,"534":27,"535":34,"536":26,"537":23,"538":8,"539":7,"540":6,"541":5,"542":6,"543":5,"544":10,"545":4,"546":6,"547":7,"548":8,"549":5,"550":6,"551":7,"552":9,"553":8,"554":7,"555":7,"556":9,"557":9,"558":5,"559":7,"560":7,"561":5,"562":12,"563":14,"564":19,"565":27,"566":18,"567":26,"568":28,"569":29,"570":15,"571":18,"572":13,"573":15,"574":19,"575":18,"576":30,"577":28,"578":26,"579":20,"580":25,"581":31,"582":30,"583":25,"584":31,"585":42,"586":29,"587":25,"588":28,"589":27,"590":22,"591":32,"592":30,"593":23,"594":27,"595":29,"596":26,"597":27,"598":12,"599":18,"600":21,"601":17,"602":14,"603":14,"604":15
};

// ====== Hitung Total Juz & Halaman (tetap) ======
function updateTotalJuz(row) {
  const surahDari     = row.querySelector(".surah-dari")?.value?.trim() || "";
  const ayatDariStr   = row.querySelector(".ayat-dari")?.value?.trim() || "";
  const surahSampai   = row.querySelector(".surah-sampai")?.value?.trim() || "";
  const ayatSampaiStr = row.querySelector(".ayat-sampai")?.value?.trim() || "";

  if (!surahDari || !ayatDariStr || !surahSampai || !ayatSampaiStr) {
    row.querySelector(".halaman-terbaca").textContent = "-";
    row.querySelector(".total-halaman").textContent   = "0.00";
    row.querySelector(".juz-terbaca").textContent     = "";
    row.querySelector(".total-juz").textContent       = "0.00";
    return;
  }

  const ayatDari   = Number(ayatDariStr);
  const ayatSampai = Number(ayatSampaiStr);

  const halamanAwalJuz = [
    1, 22, 42, 62, 82, 102, 122, 142, 162, 182,
    202, 222, 242, 262, 282, 302, 322, 342, 362, 382,
    402, 422, 442, 462, 482, 502, 522, 542, 562, 582, 602
  ];

  let totalJuz = 0;
  const halamanValid = [];

  for (let s = Number(surahDari); s <= Number(surahSampai); s++) {
    const surah = surahList.find(x => Number(x.id) === s);
    if (!surah) continue;
    const totalAyatSurah = surah.jumlah_ayat;

    const startAyat = (s === Number(surahDari)) ? ayatDari : 1;
    const endAyat   = (s === Number(surahSampai)) ? ayatSampai : totalAyatSurah;

    for (let a = startAyat; a <= endAyat; a++) {
      const key = `${s}:${a}`;
      const halaman = pagesMap[key];
      if (!halaman) continue;

      halamanValid.push(halaman);

      if (halaman === 21 || (halaman >= 602 && halaman <= 604)) continue;

      const ayatDiHalaman = jumlahAyatPerHalaman[halaman];
      if (!ayatDiHalaman) { console.warn(`Jumlah ayat tidak ditemukan untuk halaman ${halaman}`); continue; }

      totalJuz += (0.05 / ayatDiHalaman); // bobot per ayat
    }
  }

  totalJuz = Number(totalJuz.toFixed(2));

  const halamanUnik = [...new Set(halamanValid)].sort((a, b) => a - b);

  const juzTercakup = [];
  for (let i = 0; i < halamanAwalJuz.length; i++) {
    const awalJuz = halamanAwalJuz[i];
    const akhirJuz = i < halamanAwalJuz.length - 1 ? halamanAwalJuz[i + 1] - 1 : 604;
    if (akhirJuz >= 602 && awalJuz <= 604) continue;
    for (let h of halamanUnik) {
      if (h >= awalJuz && h <= akhirJuz) { juzTercakup.push(i + 1); break; }
    }
  }

  function compressJuzRanges(list) {
    if (list.length === 0) return "";
    list.sort((a, b) => a - b);
    const ranges = [];
    let start = list[0], end = start;
    for (let i = 1; i < list.length; i++) {
      if (list[i] === end + 1) { end = list[i]; }
      else { ranges.push(start === end ? `${start}` : `${start}-${end}`); start = end = list[i]; }
    }
    ranges.push(start === end ? `${start}` : `${start}-${end}`);
    return ranges.join(", ");
  }

  const juzTerbacaFormatted = compressJuzRanges(juzTercakup);

  function calculateHalamanTerbaca(halamanList) {
    if (!halamanList || halamanList.length === 0) return { ranges: "-", total: 0 };

    const halamanCountMap = {};
    for (let h of halamanList) halamanCountMap[h] = (halamanCountMap[h] || 0) + 1;

    const uniqueHalaman = Object.keys(halamanCountMap).map(Number).sort((a, b) => a - b);

    const ranges = [];
    let totalHalaman = 0;
    let start = uniqueHalaman[0];
    let end = start;

    for (let i = 0; i < uniqueHalaman.length; i++) {
      const h = uniqueHalaman[i];
      const ayatTerbaca = halamanCountMap[h];
      const ayatTotal = jumlahAyatPerHalaman[h] || 1;
      totalHalaman += ayatTerbaca / ayatTotal;

      if (i > 0) {
        if (h === end + 1) { end = h; }
        else { ranges.push(start === end ? `${start}` : `${start}-${end}`); start = end = h; }
      }
    }
    ranges.push(start === end ? `${start}` : `${start}-${end}`);

    return { ranges: ranges.join(", "), total: totalHalaman };
  }

  const result = calculateHalamanTerbaca(halamanValid);
  row.querySelector(".halaman-terbaca").textContent = result.ranges;
  row.querySelector(".total-halaman").textContent   = result.total.toFixed(2);
  row.querySelector(".juz-terbaca").textContent     = juzTerbacaFormatted;
  row.querySelector(".total-juz").textContent       = totalJuz.toFixed(2);
}

// Listener tetap
kelasSelect.addEventListener("change", loadSantriData);
tanggalInput.addEventListener("change", loadSantriData);
	 

// ============================
// A. LOAD SANTRI DATA
// ============================
// ====== SIMPAN DATA MUTABAAH ======
async function simpanDataMutabaah(saveBtn){

  try {
    if (window.currentRowEl && typeof window.renderSession === 'function') {
      [1,2,3].forEach(i => window.renderSession(i));
    }
  } catch(_) {}
  
  const rows  = document.querySelectorAll('#santri-table tbody tr');

  function resolveKelas(){
    const byWin=(window.kelasSelect?.value)||'';
    const byId =document.querySelector('#kelasSelect')?.value || document.querySelector('#kelas')?.value || '';
    const byNm =document.querySelector('select[name="kelas"]')?.value || document.querySelector('input[name="kelas"]')?.value || '';
    const byDt =document.querySelector('#santri-table')?.dataset?.kelas || document.body?.dataset?.kelas || '';
    if (String(byWin).trim()) return String(byWin).trim();
    if (String(byId).trim())  return String(byId).trim();
    if (String(byNm).trim())  return String(byNm).trim();
    if (String(byDt).trim())  return String(byDt).trim();
    const r=document.querySelector('#santri-table tbody tr');
    return String(r?.dataset?.kelas||'').trim();
  }
  function resolveTanggalGlobal(){
    const byWin=(window.tanggalInput?.value)||'';
    const byId =document.querySelector('#tanggalInput')?.value || document.querySelector('#tanggal')?.value || document.querySelector('#date')?.value || '';
    const byNm =document.querySelector('input[name="tanggal"]')?.value || document.querySelector('input[name="date"]')?.value || '';
    if (String(byWin).trim()) return String(byWin).trim();
    if (String(byId).trim())  return String(byId).trim();
    if (String(byNm).trim())  return String(byNm).trim();
    return '';
  }

  const kelas = resolveKelas();
  const tanggalUtama = resolveTanggalGlobal();
  if (!kelas){ alert('Kelas belum terdeteksi.'); return; }

  const parseNum=(v)=>{ if(typeof v==='number')return Number.isFinite(v)?v:0; const s=String(v??'').replace(/[^0-9.,-]/g,'').replace(',', '.'); const n=parseFloat(s); return Number.isFinite(n)?n:0; };
  function getNamaFromCell(cell){ if(!cell)return ""; const first=cell.childNodes&&cell.childNodes[0]; const txt=(first&&first.textContent)?first.textContent:cell.textContent; return String(txt).trim(); }
  function getRowId(row){ const raw=row.children[0]?.textContent?.trim()||""; const asNum=parseInt(raw,10); return Number.isNaN(asNum)?raw:asNum; }
  function parseNilaiStr(nilaiStr){
    if(!nilaiStr) return {nilai:null,predikatText:null,predikatHuruf:null};
    const parts=nilaiStr.trim().split(/\s+/).filter(Boolean);
    let numIdx=parts.findIndex(p=>/^-?\d+(,\d+|\.\d+)?$/.test(p));
    if(numIdx===-1) numIdx=parts.findIndex(p=>!Number.isNaN(parseFloat(p.replace(',','.'))));
    let nilai=null; if(numIdx!==-1) nilai=parseFloat(parts[numIdx].replace(',','.'));
    const rest=parts.filter((_,i)=>i!==numIdx).map(p=>p.replace(/[^\p{L}\p{N}\-]/gu,'')).filter(Boolean);
    const gIdx=rest.findIndex(p=>/^[A-E]$/i.test(p));
    const huruf=gIdx!==-1?rest[gIdx].toUpperCase():null;
    const teks =rest.filter((_,i)=>i!==gIdx && rest[i]!=='-');
    return { nilai, predikatText:(teks.length?teks.join(' '):null), predikatHuruf:huruf };
  }

  // ==== util ABSENSI FLEX (tetap) ====
  function buildAbsensi6(items, target){
    const t = Math.max(1, Math.min(6, Number(target)||1));
    const chosen = (items||[]).filter(it=>it.checked).map(it=>String(it.key).toLowerCase().replace(/\d+$/,''));
    const out=[]; for(let i=0;i<t;i++) out.push(chosen[i]||"");
    return out;
  }
  function buildAbsensiExpanded(items, target){
    const t = Math.max(1, Math.min(6, Number(target)||1));
    const perStatus = Number(window.ABS_FLEX_CFG?.perStatus ?? 2);
    const stOrder = Array.isArray(window.ABS_FLEX_CFG?.statuses) && window.ABS_FLEX_CFG.statuses.length
      ? window.ABS_FLEX_CFG.statuses : ["hadir","izin","sakit","alpha"];
    const checkedSet = new Set((items||[]).filter(it=>it.checked).map(it=>String(it.key).toLowerCase()));
    const title = s => s.charAt(0).toUpperCase() + s.slice(1);
    const result=[]; let seq=1;
    for (const st of stOrder){
      for(let i=1;i<=perStatus;i++){
        const key=`${st}${i}`;
        if (checkedSet.has(key) && seq<=t){ result.push(`${title(st)}${i}`); seq++; }
      }
    }
    return result;
  }
  function getAbsensiFlexFromRow(row, existing = {}){
    const cell = row.querySelector(".abs-flex-cell");
    if (!cell){
      const items = Array.isArray(existing.absensiItems)? existing.absensiItems : [];
      const target = Number(existing.absensiTarget)||0;
      const expanded = buildAbsensiExpanded(items, target);
      return {
        absensiItems: items,
        absensiTarget: target,
        absensiChecked: Number(existing.absensiChecked)||0,
        absensiPercent: Number(existing.absensiPercent)||0,
        absensi6: Array.isArray(existing.absensi6)? existing.absensi6 : [],
        absensiExpanded: expanded,
        absensiExpandedStr: expanded.join(", ")
      };
    }
    const absensiItems   = Array.isArray(cell._absensiItems)? cell._absensiItems : [];
    const absensiTarget  = Number(cell._absensiTarget||0);
    const absensiChecked = Number(cell._absensiChecked||0);
    const absensiPercent = Number(cell._absensiPercent||0);
    const absensi6       = buildAbsensi6(absensiItems, absensiTarget);
    const absensiExpanded= buildAbsensiExpanded(absensiItems, absensiTarget);
    const absensiExpandedStr = absensiExpanded.join(", ");
    return { absensiItems, absensiTarget, absensiChecked, absensiPercent, absensi6, absensiExpanded, absensiExpandedStr };
  }

  // ==== Murajaah 3 sesi (REVISI: anti-fallback saat wipe, total 0) ====
  function getMurFromRow(row, existing={}){
    const cell = row.querySelector('.murajaah-cell');
    const out  = { sessions: [], total: null };

    const num = (v, fb=0)=>{ const n=parseNum(v); return Number.isFinite(n)?n:fb; };
    function pick(dsKey, fallback){
      const v = cell?.dataset?.[dsKey];
      return (v!==undefined && v!==null && String(v)!=='') ? v : fallback;
    }

    for (let i=1;i<=3;i++){
      const sF = pick(`sf${i}`,  undefined);
      const aF = pick(`af${i}`,  undefined);
      const sT = pick(`st${i}`,  undefined);
      const aT = pick(`at${i}`,  undefined);
      const pF = pick(`pf${i}`,  undefined);
      const pT = pick(`pt${i}`,  undefined);
      const jF = pick(`jfrom${i}`, undefined);
      const jT = pick(`jto${i}`,   undefined);
      const jzRaw = pick(`juz${i}`,   undefined);
      const sc = pick(`score${i}`, undefined);
      const pt = pick(`ptext${i}`, undefined);
      const ph = pick(`phuruf${i}`,undefined);

      const ex = existing || {};
      const exSes = (Array.isArray(ex.murSessions) && ex.murSessions[i-1]) ? ex.murSessions[i-1] : {};

      // Wipe logic: jika jzRaw ada dan bernilai 0 -> HAPUS from/to/pages (tanpa fallback)
      const wiped = (jzRaw !== undefined) && (num(jzRaw) === 0);

      const sess = {
        from:  (sF||aF) ? `${sF||''}:${aF||''}` : (wiped ? "" : (ex[`murFrom${i}`] ?? exSes.from ?? "")),
        to:    (sT||aT) ? `${sT||''}:${aT||''}` : (wiped ? "" : (ex[`murTo${i}`]   ?? exSes.to   ?? "")),
        pages: (pF||pT) ? `${pF||''}-${pT||''}` : (wiped ? "" : (ex[`murPages${i}`]?? exSes.pages?? "")),
        jFrom: (jF !== undefined) ? (jF===""? null : Number(jF)) : (ex[`jFrom${i}`] ?? exSes.jFrom ?? null),
        jTo:   (jT !== undefined) ? (jT===""? null : Number(jT)) : (ex[`jTo${i}`]   ?? exSes.jTo   ?? null),
        juz:   (jzRaw!==undefined) ? num(jzRaw) : num(ex[`juzmur${i}`] ?? ex[`juzSesi${i}`] ?? exSes.juz ?? 0),
        score: num(sc ?? (ex[`murScore${i}`] ?? exSes.score ?? 0)),
        predikatText:  (pt !== undefined) ? pt : (ex[`murPredText${i}`]  ?? exSes.predikatText  ?? ""),
        predikatHuruf: (ph !== undefined) ? ph : (ex[`murPredHuruf${i}`] ?? exSes.predikatHuruf ?? "")
      };
      out.sessions.push(sess);
    }

    const sum = out.sessions.reduce((a,s)=>a + (Number(s.juz)||0), 0);
    out.total = +sum.toFixed(2); // 0.00 jika semuanya 0

    return out;
  }

  if (saveBtn){ saveBtn.disabled=true; saveBtn.dataset._old=saveBtn.textContent; saveBtn.textContent='‚è≥ Menyimpan...'; }

  try{
    const groupByTanggal = new Map();
    rows.forEach(row=>{
      const tglBaris = (row.dataset?.tanggal && row.dataset.tanggal.trim()) ? row.dataset.tanggal.trim() : tanggalUtama;
      if (!groupByTanggal.has(tglBaris)) groupByTanggal.set(tglBaris, []);
      groupByTanggal.get(tglBaris).push(row);
    });

    const hasilKirim=[];

    for (const [tanggal, rowsTanggal] of groupByTanggal.entries()){
      let dataLama=[];
      try{
        const resLama=await fetch(`/api/getAbsensi?kelas=${encodeURIComponent(kelas)}&tanggal=${encodeURIComponent(tanggal)}`, {credentials:'include'});
        if(resLama.ok) dataLama=await resLama.json();
      }catch(e){ console.warn('Tidak bisa ambil data lama', e); }

      const dataMerged = Array.isArray(dataLama)?[...dataLama]:[];

      rowsTanggal.forEach(row=>{
        const id   = getRowId(row);
        const nama = getNamaFromCell(row.children[1]);
        const nis  = String(row.dataset?.nis||"").trim();

        let existing = dataMerged.find(d=>String(d.id)===String(id));
        if (!existing && nis) existing = dataMerged.find(d=>String(d.nis||"")===nis) || {};

        const keySem = String((row.dataset?.nis||row.dataset?.id||"")||"").trim();
        const semester   = (window.semesterMap?.[keySem])   ?? existing.semester ?? "";
        const jenjang    = (window.jenjangMap?.[keySem])    ?? existing.jenjang  ?? "";
        const keterangan = (window.keteranganMap?.[keySem]) ?? existing.keterangan ?? "";

        const flex = getAbsensiFlexFromRow(row, existing||{});
        const { absensiItems, absensiTarget, absensiChecked, absensiPercent, absensi6, absensiExpanded, absensiExpandedStr } = flex;

        const surahDari    = (row.querySelector(".surah-dari")?.value ?? "").trim();
        const ayatDari     = (row.querySelector(".ayat-dari")?.value ?? "").trim();
        const surahSampai  = (row.querySelector(".surah-sampai")?.value ?? "").trim();
        const ayatSampai   = (row.querySelector(".ayat-sampai")?.value ?? "").trim();
        const tilawahTotalJuz = row.querySelector(".total-juz")?.textContent || "0";
        const halaman      = row.querySelector(".halaman-terbaca")?.textContent ?? existing?.halaman ?? "";
        const totalHalaman = row.querySelector(".total-halaman")?.textContent ?? existing?.totalHalaman ?? "";
        const juzTerbaca   = row.querySelector(".juz-terbaca")?.textContent ?? existing?.juzTerbaca ?? "";

        const mur = getMurFromRow(row, existing);

        const nilaiCell = row.querySelector(".lihat-quran-btn")?.parentElement;
        const nilaiStr  = nilaiCell?.querySelector("div:nth-child(1)")?.innerText?.trim()||"";
        const parsed    = parseNilaiStr(nilaiStr);

        // DETEKSI MODE RESET dari DOM (baik di <tr> maupun di cell)
        const resetFlag = (row.dataset?.resetNilai === "1") ||
                          (nilaiCell && nilaiCell.dataset?.resetNilai === "1");

        let buttonCell;
        if (resetFlag) {
          buttonCell = null; // paksa kosong di server
        } else if (typeof parsed.nilai==="number" && !Number.isNaN(parsed.nilai)){
          const predikatText  =(parsed.predikatText && parsed.predikatText!=='-') ? parsed.predikatText : (existing?.buttonCell?.predikatText ?? "-");
          const predikatHuruf =(parsed.predikatHuruf && parsed.predikatHuruf!=='-') ? parsed.predikatHuruf : (existing?.buttonCell?.predikatHuruf ?? "-");
          buttonCell = { nilai: parsed.nilai, predikatText, predikatHuruf };
        } else if (existing?.buttonCell) {
          buttonCell = existing.buttonCell;
        }

        const base = {
          ...existing,
          id, nis, nama, jenjang, semester,

          absensi: absensiExpandedStr,
          absensiItems, absensiTarget, absensiChecked, absensiPercent, absensi6,
          absensiExpanded, absensiExpandedStr,

          dari:   (surahDari && ayatDari)     ? `${surahDari}:${ayatDari}`     : "",
          sampai: (surahSampai && ayatSampai) ? `${surahSampai}:${ayatSampai}` : "",

          tilawahTotalJuz: Number(parseNum(tilawahTotalJuz).toFixed(2)),
          totalJuz: Number(parseNum(tilawahTotalJuz).toFixed(2)),

          halaman, totalHalaman, juzTerbaca, keterangan,

          // PAKAI ?? agar "" tidak difallback ke data lama
          murSessions: mur.sessions.map(s => ({
            from:  s.from  ?? "",
            to:    s.to    ?? "",
            pages: s.pages ?? "",
            jFrom: (s.jFrom!==undefined && s.jFrom!=="") ? Number(s.jFrom) : null,
            jTo:   (s.jTo  !==undefined && s.jTo  !=="") ? Number(s.jTo)   : null,
            juz:   Number((Number(s.juz)||0).toFixed(2)),
            score: Number(s.score||0),
            predikatText:  s.predikatText  ?? "",
            predikatHuruf: s.predikatHuruf ?? ""
          })),

          // legacy mirror (PAKAI ??, bukan ||)
          murFrom1:  mur.sessions[0]?.from  ?? existing?.murFrom1  ?? "",
          murTo1:    mur.sessions[0]?.to    ?? existing?.murTo1    ?? "",
          murPages1: mur.sessions[0]?.pages ?? existing?.murPages1 ?? "",
          jFrom1:    (mur.sessions[0]?.jFrom ?? existing?.jFrom1 ?? null),
          jTo1:      (mur.sessions[0]?.jTo   ?? existing?.jTo1   ?? null),
          juzmur1:   Number((mur.sessions[0]?.juz ?? existing?.juzmur1 ?? 0).toFixed?.(2) ?? 0),
          murScore1: Number(mur.sessions[0]?.score ?? existing?.murScore1 ?? 0),
          murPredText1:  mur.sessions[0]?.predikatText  ?? existing?.murPredText1  ?? "",
          murPredHuruf1: mur.sessions[0]?.predikatHuruf ?? existing?.murPredHuruf1 ?? "",

          murFrom2:  mur.sessions[1]?.from  ?? existing?.murFrom2  ?? "",
          murTo2:    mur.sessions[1]?.to    ?? existing?.murTo2    ?? "",
          murPages2: mur.sessions[1]?.pages ?? existing?.murPages2 ?? "",
          jFrom2:    (mur.sessions[1]?.jFrom ?? existing?.jFrom2 ?? null),
          jTo2:      (mur.sessions[1]?.jTo   ?? existing?.jTo2   ?? null),
          juzmur2:   Number((mur.sessions[1]?.juz ?? existing?.juzmur2 ?? 0).toFixed?.(2) ?? 0),
          murScore2: Number(mur.sessions[1]?.score ?? existing?.murScore2 ?? 0),
          murPredText2:  mur.sessions[1]?.predikatText  ?? existing?.murPredText2  ?? "",
          murPredHuruf2: mur.sessions[1]?.predikatHuruf ?? existing?.murPredHuruf2 ?? "",

          murFrom3:  mur.sessions[2]?.from  ?? existing?.murFrom3  ?? "",
          murTo3:    mur.sessions[2]?.to    ?? existing?.murTo3    ?? "",
          murPages3: mur.sessions[2]?.pages ?? existing?.murPages3 ?? "",
          jFrom3:    (mur.sessions[2]?.jFrom ?? existing?.jFrom3 ?? null),
          jTo3:      (mur.sessions[2]?.jTo   ?? existing?.jTo3   ?? null),
          juzmur3:   Number((mur.sessions[2]?.juz ?? existing?.juzmur3 ?? 0).toFixed?.(2) ?? 0),
          murScore3: Number(mur.sessions[2]?.score ?? existing?.murScore3 ?? 0),
          murPredText3:  mur.sessions[2]?.predikatText  ?? existing?.murPredText3  ?? "",
          murPredHuruf3: mur.sessions[2]?.predikatHuruf ?? existing?.murPredHuruf3 ?? "",

          // total murajaah: 0.00 saat reset
          juzmurajaah: (mur.total!=null ? mur.total : Number(parseNum(existing?.juzmurajaah||0).toFixed?.(2) ?? 0)),

          // simpan marks (audio tetap dipertahankan)
          marks: (row.markData && typeof row.markData === 'object') ? row.markData : (existing?.marks || { audio: [] })
        };

        // Jika reset nilai ‚Üí benar-benar hapus field nilai dari payload
        if (resetFlag) {
          delete base.buttonCell;
          delete base.nilai;
          delete base.predikat;
        }

        const newData = (resetFlag || !buttonCell) ? { ...base } : { ...base, buttonCell };

        const idx = dataMerged.findIndex(d=>String(d.id)===String(id));
        if (idx!==-1) dataMerged[idx]=newData;
        else dataMerged.push(newData);
      });

      const res=await fetch('/api/saveData',{
// ... (tidak berubah)
        method:'POST',
        credentials:'include',
        headers:{'Content-Type':'application/json','Accept':'application/json'},
        body: JSON.stringify({ tanggal, kelas, data: dataMerged })
      });
      let result={}; try { result = await res.json(); } catch { result = {}; }
      hasilKirim.push({tanggal, ok:!!result?.success, result});

      // ===== perbarui INDEX + OWNER (rentang penuh, owner= tanggal paling awal) =====
      (function updateAyatIndexFromRows(){
        window.__ayatIndex  ??= {};
        window.__ayatLatest ??= {};
        window.__ayatOwner  ??= {};
        window.__ayatIndex[kelas]  ??= {};
        window.__ayatLatest[kelas] ??= {};
        window.__ayatOwner[kelas]  ??= {};

        const earlier = (a, b) => String(a||"").localeCompare(String(b||"")) < 0;

        const addPoint = (nis, kind, s, a, tanggal) => {
          if (!nis || !s || !a) return;
          // index
          window.__ayatIndex[kelas][nis] ??= {};
          window.__ayatIndex[kelas][nis][s] ??= new Set();
          window.__ayatIndex[kelas][nis][s].add(Number(a));
          // owner (tahan yang paling awal)
          window.__ayatOwner[kelas][nis] ??= {};
          window.__ayatOwner[kelas][nis][s] ??= {};
          const cur = window.__ayatOwner[kelas][nis][s][a];
          if (!cur || earlier(tanggal, cur)) window.__ayatOwner[kelas][nis][s][a] = String(tanggal);

          // latest
          const prev = window.__ayatLatest[kelas][nis]?.[kind];
          const cand = { surah: String(s), ayat: Number(a), tanggal: String(tanggal) };
          if (!prev || String(cand.tanggal).localeCompare(String(prev.tanggal)) > 0) {
            window.__ayatLatest[kelas][nis] ??= {};
            window.__ayatLatest[kelas][nis][kind] = cand;
          }
        };

        const addRange = (nis, sFrom, aFrom, sTo, aTo, tanggal) => {
          if (!nis || !sFrom || !aFrom || !sTo || !aTo) return;
          if (sFrom > sTo || (sFrom === sTo && aFrom > aTo)) {
            [sFrom, sTo] = [sTo, sFrom];
            [aFrom, aTo] = [aTo, aFrom];
          }
          window.__ayatIndex[kelas][nis] ??= {};
          window.__ayatOwner[kelas][nis] ??= {};
          for (let s = Number(sFrom); s <= Number(sTo); s++) {
            const surah = surahList.find(x => Number(x.id) === s);
            if (!surah) continue;
            const totalAy = Number(surah.jumlah_ayat || 0); // ‚úÖ FIX
            const startAy = (s === Number(sFrom)) ? Number(aFrom) : 1;
            const endAy   = (s === Number(sTo))   ? Number(aTo)   : totalAy;

            const keyS = String(s);
            const set  = (window.__ayatIndex[kelas][nis][keyS] ??= new Set());
            const ownS = (window.__ayatOwner[kelas][nis][keyS] ??= {});
            for (let a = startAy; a <= endAy; a++) {
              set.add(a);
              const cur = ownS[a];
              if (!cur || earlier(tanggal, cur)) ownS[a] = String(tanggal);
            }
          }
        };

        rowsTanggal.forEach(row=>{
          const nis = String(row.dataset?.nis||row.dataset?.id||"").trim();
          if (!nis) return;
          const surD = (row.querySelector(".surah-dari")?.value||"").trim();
          const ayD  = Number((row.querySelector(".ayat-dari")?.value||"").trim());
          const surS = (row.querySelector(".surah-sampai")?.value||"").trim();
          const ayS  = Number((row.querySelector(".ayat-sampai")?.value||"").trim());

          if (surD && ayD) addPoint(nis, 'dari',   String(surD), ayD, tanggal);
          if (surS && ayS) addPoint(nis, 'sampai', String(surS), ayS, tanggal);
          if (surD && ayD && surS && ayS) addRange(nis, Number(surD), Number(ayD), Number(surS), Number(ayS), tanggal);
        });
      })();
    }

    const gagal=hasilKirim.filter(h=>!h.ok);
    if(!gagal.length){
      if(saveBtn) saveBtn.textContent='‚úÖ Tersimpan';
      if (window.murajaah && typeof window.murajaah.refreshServer==='function'){
        await window.murajaah.refreshServer();
      }
      // segarkan dropdown sesuai index + owner baru
      document.querySelectorAll('#santri-table tbody tr').forEach(row=>{
        const kelasRow = row.dataset?.kelas || resolveKelas() || "";
        const key      = String(row.dataset?.nis||row.dataset?.id||"").trim();
        const rowDate  = row.dataset?.tanggal || "";
        const sd = row.querySelector('.surah-dari');
        const ss = row.querySelector('.surah-sampai');
        const ad = row.querySelector('.ayat-dari');
        const as = row.querySelector('.ayat-sampai');

        if (sd) {
          const cur = sd.value || "";
          sd.innerHTML = (typeof window.__makeSurahOptions==='function')
            ? window.__makeSurahOptions(kelasRow, key, 'dari', cur, { ownerDate: rowDate })
            : sd.innerHTML;
        }
        if (ss) {
          const cur = ss.value || "";
          ss.innerHTML = (typeof window.__makeSurahOptions==='function')
            ? window.__makeSurahOptions(kelasRow, key, 'sampai', cur, { ownerDate: rowDate })
            : ss.innerHTML;
        }
        if (ad) window.fillAyatOptionsMarked(ad, sd?.value||"", ad.value||"");
        if (as) window.fillAyatOptionsMarked(as, ss?.value||"", as.value||"");
      });

      // setelah sukses simpan, bersihkan flag reset
      document.querySelectorAll('#santri-table tbody tr[data-reset-nilai="1"]').forEach(tr => {
        delete tr.dataset.resetNilai;
        const cell = [...tr.cells].find(td => td.querySelector(".lihat-quran-btn"));
        if (cell) delete cell.dataset.resetNilai;
      });

    }else{
      const daftar=gagal.map(g=>g.tanggal).join(', ');
      alert(`‚ùå Sebagian tanggal gagal disimpan: ${daftar}`);
      if(saveBtn) saveBtn.textContent='‚ùå Gagal Sebagian';
    }

  }catch(e){
    console.error(e);
    alert('‚ö†Ô∏è Error menyimpan data!');
  }finally{
    if(saveBtn){
      setTimeout(()=>{
        saveBtn.textContent = saveBtn.dataset._old || 'Save Data';
        saveBtn.disabled=false;
        delete saveBtn.dataset._old;
      }, 1200);
    }
  }
}

// Listener tombol (tetap)
document.getElementById('save-btn')?.addEventListener('click', function(){ simpanDataMutabaah(this); });
document.getElementById('save-btn-modal')?.addEventListener('click', function(){ simpanDataMutabaah(this); });
document.getElementById('mur-save')?.addEventListener('click', function(){ simpanDataMutabaah(this); });

// re-sync badge .abs-mini semua baris setelah simpan (tambahkan warna status dominan)
document.querySelectorAll('#santri-table tbody tr .abs-flex-cell').forEach(cell=>{
  const mini = cell.querySelector('.abs-mini');
  if (!mini) return;
  const percent = Number(cell._absensiPercent || 0);
  mini.textContent = `${percent}% (${Number(cell._absensiChecked||0)}/${Number(cell._absensiTarget||0)})`;
  mini.setAttribute('data-progress', String(percent));

  // kompat lama: tanda complete
  const complete = percent >= 100;
  mini.classList.toggle('is-complete', complete);

  // warna dominan
  const st = (typeof window.__absmini_dominantStatus==='function')
    ? window.__absmini_dominantStatus(cell._absensiItems)
    : null;

  mini.classList.remove('is-hadir','is-izin','is-sakit','is-alpha');
  if (st) {
    mini.classList.add(`is-${st}`);
  } else {
    mini.style.background = '';
    mini.style.color = '';
    mini.style.borderRadius = '';
    mini.style.padding = '';
  }
});

// ============================
// A. LOAD SANTRI DATA
// ============================	 

// ============================
// B. DOWNLOAD PDF
// ============================		 
// ============================
// Download PDF/Excel Rekap (slot-based attendance)
// ============================
(function(){
  const $ = sel => document.querySelector(sel);

  function fmtD_M_YYYY(iso){
    if (!iso) return '';
    const m = String(iso).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (!m) return iso;
    return `${Number(m[3])}-${Number(m[2])}-${m[1]}`;
  }

  // ===== Inject CSS kontrol =====
  (function injectStyles(){
    if (document.getElementById('rekap-style')) return;
    const s = document.createElement('style');
    s.id = 'rekap-style';
    s.textContent = `
      .pdf-rekap-controls{
        display:flex; flex-wrap:wrap; gap:.6rem; align-items:center;
        background:#fff; border:1px solid #e5e7eb; border-radius:12px;
        padding:.6rem .8rem; box-shadow:0 1px 2px rgba(0,0,0,.04);
        margin:.6rem 0 .9rem;
      }
      .pdf-rekap-controls label{
        display:flex; gap:.35rem; align-items:center; font-weight:600; color:#111827;
      }
      .pdf-rekap-controls input[type="date"],
      .pdf-rekap-controls select{
        padding:.42rem .55rem; border:1px solid #d1d5db; border-radius:10px;
        min-height:2.1rem; font:inherit; color:#111827; background:#fff;
      }
      .pdf-rekap-controls .rekap-btn{
        padding:.55rem .9rem; border:none; border-radius:10px; font-weight:700; letter-spacing:.2px;
        box-shadow:0 1px 1px rgba(0,0,0,.05); color:#fff; cursor:pointer;
      }
      #download-pdf-rekap.rekap-btn{ background:#0ea5e9; }
      #download-xls-rekap.rekap-btn{ background:#22c55e; }
      #download-pdf-santri.rekap-btn{ background:#8b5cf6; }
      #download-pdf-allkelas.rekap-btn{ background:#f59e0b; }
      .pdf-rekap-controls .rekap-btn:hover{ filter:brightness(.97); }
      .pdf-rekap-controls .rekap-btn:disabled{ opacity:.6; cursor:not-allowed; }
    `;
    document.head.appendChild(s);
  })();

 /** Ambil label jenjang dari DOM <select class="jenjang">.
 *  - Jika code bukan "A<number>", kembalikan apa adanya (mis. "1 PDF", "1 SD", dll).
 *  - Jika "A<number>", cari option[value=code] pada semua <select.jenjang> dan
 *    kembalikan textContent-nya (mis. A4 -> "1 MA"). Tanpa batas jumlah kode.
 *  - Cache hasil scan option supaya cepat.
 */
(function(){
  function buildJenjangMapFromDOM(){
    const m = new Map();
    // ambil semua option dari semua <select class="jenjang">
    document.querySelectorAll('select.jenjang option').forEach(opt=>{
      const val = String(opt.value || '').trim();
      const txt = String(opt.textContent || '').trim();
      if (val && txt && /^A\d+$/i.test(val)) {
        if (!m.has(val)) m.set(val, txt);
      }
    });
    return m;
  }

  // cache di window agar tidak scan DOM berulang-ulang
  window._jenjangValueToTextMap = window._jenjangValueToTextMap || buildJenjangMapFromDOM;

  window.jenjangLabel = function jenjangLabel(code){
    const raw = String(code ?? '').trim();
    if (!raw) return '';
    // kalau sudah berupa label final (bukan A<number>), kembalikan apa adanya
    if (!/^A\d+$/i.test(raw)) return raw;

    // cari teks option untuk value Axx
    const map = (typeof window._jenjangValueToTextMap === 'function')
      ? window._jenjangValueToTextMap()
      : buildJenjangMapFromDOM();

    return map.get(raw) || raw; // fallback: kalau belum ada di DOM, tampilkan code mentah
  };

  // Opsional: jika option berubah dinamis, refresh cache otomatis
  try{
    const mo = new MutationObserver(()=>{ window._jenjangValueToTextMap = buildJenjangMapFromDOM; });
    document.querySelectorAll('select.jenjang').forEach(sel=>{
      mo.observe(sel, {subtree:true, childList:true, characterData:true});
    });
  }catch{}
})();

  // ====== Helper slot absensi (BARU) ======
  function _slotMetricsFromRecord(rec){
    const items = Array.isArray(rec?.absensiItems) ? rec.absensiItems : [];
    const target = Number(rec?.absensiTarget) || 0;
    const checked = Number(rec?.absensiChecked) || items.filter(it=>it?.checked).length;

    const counts = { hadir:0, izin:0, sakit:0, alpha:0 };
    for (const it of items){
      if (!it?.checked) continue;
      const st = String(it.key||'').toLowerCase().replace(/\d+$/,''); // "hadir1" -> "hadir"
      if (st in counts) counts[st]++;
    }
    return {
      _slotCounts: counts,
      _slotTarget: target,
      _slotChecked: checked
    };
  }


function getSelectedSemester(){
  const el =
    document.querySelector('select.semester') ||
    document.querySelector('.semester select') ||
    document.querySelector('#semester') ||
    document.querySelector('select[name="semester"]');
  const v = Number(el?.value);
  return Number.isFinite(v) ? v : null;
}

function getSelectedJenjang(){
  const el =
    document.querySelector('select.jenjang') ||
    document.querySelector('.jenjang select') ||
    document.querySelector('#jenjang') ||
    document.querySelector('select[name="jenjang"]');
  const v = (el?.value ?? '').trim();
  return v ? v : null;       // contoh: "A12", "2B", dst ‚Äî biarkan string apa adanya
}

function getSelectedKeterangan(){
  const el =
    document.querySelector('select.keterangan') ||
    document.querySelector('.keterangan select') ||
    document.querySelector('#keterangan') ||
    document.querySelector('select[name="keterangan"]') ||
    document.querySelector('input.keterangan');
  const v = (el?.value ?? '').trim();
  return v ? v : null;       // contoh: "SP1", "SP2", "SP3", atau teks lain
}

// BACA OVERRIDE PER NIS/ID dari DOM (fleksibel terhadap berbagai struktur)
function _readPerKeyOverrides(){
  const map = new Map();

  // Helper set nilai aman
  function setOv(key, field, val){
    if (val == null || String(val).trim() === '') return;
    const k = String(key || '').trim();
    if (!k) return;
    if (!map.has(k)) map.set(k, {});
    map.get(k)[field] = val;
  }

  // Pola 1: baris punya data-key/nis/id, lalu ada child .semester/.jenjang/.keterangan
  document.querySelectorAll('[data-key], [data-nis], [data-id]').forEach(row => {
    const key = row.dataset.key || row.dataset.nis || row.dataset.id;
    if (!key) return;

    const sem = row.querySelector('select.semester, input.semester, [name="semester"].semester');
    const jen = row.querySelector('select.jenjang,  input.jenjang,  [name="jenjang"].jenjang');
    const ket = row.querySelector('select.keterangan, input.keterangan, [name="keterangan"].keterangan');

    if (sem) setOv(key, 'semester', Number(sem.value));
    if (jen) setOv(key, 'jenjang',  String(jen.value).trim());
    if (ket) setOv(key, 'keterangan', String(ket.value).trim());
  });

  // Pola 2: input/select berdiri sendiri dengan data-key/data-nis/data-id
  const fields = [
    {sel:'select.semester, input.semester, [name="semester"].semester', f:'semester', coerce:v=>Number(v)},
    {sel:'select.jenjang,  input.jenjang,  [name="jenjang"].jenjang',   f:'jenjang',  coerce:v=>String(v).trim()},
    {sel:'select.keterangan, input.keterangan, [name="keterangan"].keterangan', f:'keterangan', coerce:v=>String(v).trim()},
  ];
  for (const {sel, f, coerce} of fields){
    document.querySelectorAll(sel).forEach(el => {
      const key = el.dataset.key || el.dataset.nis || el.dataset.id || '';
      if (!key) return;
      setOv(key, f, coerce(el.value));
    });
  }

  // Pola 3 (fallback ringan): nama input mengandung NIS, mis. name="semester-110123"
  document.querySelectorAll('input[name^="semester-"], select[name^="semester-"]').forEach(el=>{
    const m = String(el.name||'').match(/^semester-(.+)$/);
    if (m) setOv(m[1], 'semester', Number(el.value));
  });
  document.querySelectorAll('input[name^="jenjang-"], select[name^="jenjang-"]').forEach(el=>{
    const m = String(el.name||'').match(/^jenjang-(.+)$/);
    if (m) setOv(m[1], 'jenjang', String(el.value).trim());
  });
  document.querySelectorAll('input[name^="keterangan-"], select[name^="keterangan-"]').forEach(el=>{
    const m = String(el.name||'').match(/^keterangan-(.+)$/);
    if (m) setOv(m[1], 'keterangan', String(el.value).trim());
  });

  return map; // Map<key, {semester?, jenjang?, keterangan?}>
}
	 

// ====== Apakah record harian ini "bermakna" untuk dihitung sebagai 1 hari KBM? ======
// ====== Apakah record harian ini "bermakna" untuk dihitung sebagai 1 hari KBM? (slot-only) ======
function _isMeaningfulKBM(rec){
  // 1) SLOT absensi (btn-absensi-flex): minimal 1 slot tercentang
  const checked = Number(rec?._slotChecked ?? 0);
  if (Number.isFinite(checked) && checked > 0) return true;

  // 2) Fallback legacy (jika belum pakai slot): 1 field absensi/status yang valid
  //    Catatan: ini masih "input absensi", bukan setoran/mur/halaman/nilai/keterangan.
  const raw = (rec?.absensi ?? rec?.status ?? '').toString().trim().toLowerCase();
  if (raw) {
    const st = (typeof PDF_normStatus === 'function') ? PDF_normStatus(raw) : raw;
    if (st === 'hadir' || st === 'izin' || st === 'sakit' || st === 'alpha') return true;
  }

  // 3) Sinyal non-absensi (setoran/murajaah/halaman/nilai/keterangan) TIDAK menghitung KBM
  return false;
}

  // ====== Helper agregasi slot per santri (BARU) ======
  function _aggregateSlotsPerKey(items){
    const map = new Map();
    for (const r of (items || [])) {
      const key = (r?.nis && String(r.nis).trim()) || (r?.id && String(r.id).trim());
      if (!key) continue;

      const sc = r?._slotCounts || { hadir:0, izin:0, sakit:0, alpha:0 };
      const t0 = Number(r?._slotTarget)  || 0;
      const ch = Number(r?._slotChecked) || 0;
      const targetToday = t0 > 0 ? t0 : (ch > 0 ? ch : (sc.hadir + sc.izin + sc.sakit + sc.alpha));

      if (!map.has(key)) map.set(key, { hadir:0, izin:0, sakit:0, alpha:0, target:0 });
      const agg = map.get(key);
      agg.hadir += sc.hadir;
      agg.izin  += sc.izin;
      agg.sakit += sc.sakit;
      agg.alpha += sc.alpha;
      agg.target += targetToday;
    }
    return map;
  }

// ====== Agregasi "hari hadir" per santri (slot-based) ======
function _aggregateHadirDaysPerKey(items){
  // key -> Set(tanggal_hadir)
  const map = new Map();
  for (const r of (items || [])) {
    const key = (r?.nis && String(r.nis).trim()) || (r?.id && String(r.id).trim());
    const tgl = r?.tanggal ? String(r.tanggal).slice(0,10) : '';
    if (!key || !tgl) continue;

    // slot-based: minimal 1 slot 'hadir' di hari tsb
    const sc = r?._slotCounts;
    const hadHadirSlot = sc ? Number(sc.hadir||0) > 0 : false;

    // fallback: kalau tidak ada slot, pakai field absensi/status
    const st = (!sc) ? PDF_normStatus(r?.absensi ?? r?.status) : null;
    const hadHadirNonSlot = (!sc) && (st === 'hadir');

    if (hadHadirSlot || hadHadirNonSlot) {
      if (!map.has(key)) map.set(key, new Set());
      map.get(key).add(tgl);
    }
  }
  const out = new Map();
  for (const [k, set] of map.entries()){
    out.set(k, { hadirDays: set.size });
  }
  return out;
}

// --- Helper aman ambil nilai kelas ---
function getSelectedKelas(){
  const el = (typeof kelasSelect !== 'undefined' && kelasSelect)
    ? kelasSelect
    : document.getElementById('kelasSelect');

  if (!el) return { value: '', el: null };

  // nilai sekarang
  const v = (el.value || '').trim();
  if (v) return { value: v, el };

  // fallback: pilih opsi pertama yang non-empty (jika ada)
  const first = [...el.options || []].map(o => (o.value || '').trim()).find(Boolean);
  if (first) {
    el.value = first;
    return { value: first, el };
  }
  return { value: '', el };
}


function applyUIOverrides(allDataNorm, aggMap){
  const perKey = _readPerKeyOverrides();     // baca dari DOM (tiap baris)
  if (!perKey || perKey.size === 0) return;

  // timpa di raw-normalized (hanya key yang ada di map)
  (allDataNorm || []).forEach(it => {
    const key = (it?.nis && String(it.nis)) || (it?.id && String(it.id)) || '';
    if (!key) return;
    const ov = perKey.get(String(key));
    if (!ov) return;
    if (ov.semester != null && Number.isFinite(Number(ov.semester))) it.semester = Number(ov.semester);
    if (ov.jenjang)    it.jenjang = String(ov.jenjang).trim();
    if (ov.keterangan) it.keterangan = String(ov.keterangan).trim();
  });

  // timpa di agregat
  Object.keys(aggMap || {}).forEach(k => {
    const r  = aggMap[k];
    const ov = perKey.get(String(k));
    if (!ov) return;
    if (ov.semester != null && Number.isFinite(Number(ov.semester))) r.semester = Number(ov.semester);
    if (ov.jenjang)    r.jenjang = String(ov.jenjang).trim();
    if (ov.keterangan) r.keterangan = String(ov.keterangan).trim();
  });
}


// === Ambil TEKS yang tampil di dashboard (per NIS/ID) ===
function _findRowElByKey(key){
  const k = String(key||'').trim(); if (!k) return null;
  let row = document.querySelector(`[data-key="${k}"], [data-nis="${k}"], [data-id="${k}"]`);
  if (row) return row;
  const all = document.querySelectorAll('[data-key], [data-nis], [data-id]');
  for (const el of all){
    const kk = (el.dataset.key||el.dataset.nis||el.dataset.id||'').trim();
    if (kk === k) return el;
  }
  return null;
}

function _readDisplayFieldFromRow(key, className){ // 'semester' | 'keterangan' | 'jenjang'
  const row = _findRowElByKey(key);
  if (!row) return null;

  const sel = row.querySelector(`select.${className}, [name="${className}"].${className}`);
  if (sel) {
    const opt = sel.options[sel.selectedIndex];
    return { value: (sel.value ?? '').trim(), text: (opt?.text ?? sel.value ?? '').trim() };
  }
  const inp = row.querySelector(`input.${className}, [name="${className}"].${className}`);
  if (inp) {
    const v = (inp.value ?? '').trim();
    return { value: v, text: v };
  }
  return null;
}

// Dipakai oleh semua exporter
function semesterDisplayForKey(key, fallback){
  const f = _readDisplayFieldFromRow(key, 'semester');
  if (f && (f.text || f.value)) return f.text || f.value;
  return (fallback!=null && fallback!=='') ? String(fallback) : '-';
}
function keteranganDisplayForKey(key, fallback){
  const f = _readDisplayFieldFromRow(key, 'keterangan');
  if (f && (f.text || f.value)) return f.text || f.value;
  return (fallback!=null && String(fallback).trim()!=='') ? String(fallback) : '-';
}	

  // === Helper Kelas/Kelompok ===
function buildKelasKelompokLine(kelas, kelasEl) {
  const kelasNum = (String(kelas||'').match(/(\d+)/)?.[1]) || (kelas || '-');
  const custom = window.namaKelasCustom || window.NAMA_KELAS_CUSTOM || {  kelas_012526: "Ustadz M. Taqi Lazuardi",
  kelas_012025: "Ahmad Wildan"};
    let kelompok = custom[kelas] || "";
    if (!kelompok) {
      const optText = kelasEl?.options?.[kelasEl.selectedIndex]?.text?.trim() || "";
      const fromOpt = (optText.match(/Kelompok\s+(.+)/i)?.[1] || optText).trim();
      if (fromOpt) kelompok = fromOpt;
    }
    kelompok = (kelompok || '').replace(/^Kelompok\s+/i, '').trim() || '-';
    return { kelasNum, kelompok, line: `Halaqoh: ${kelasNum}, ${kelompok}` };
  }

  function setBtnLoading(btn, loading, loadingText='Mengerjakan‚Ä¶') {
    if (!btn) return;
    if (loading) {
      btn.dataset._oldText = btn.textContent;
      btn.textContent = loadingText;
      btn.disabled = true;
    } else {
      if (btn.dataset._oldText) btn.textContent = btn.dataset._oldText;
      btn.disabled = false;
      delete btn.dataset._oldText;
    }
  }

  // ====== Tombol ======
  const pdfBtn = document.getElementById('download-pdf-rekap');
  let xlsBtn = document.getElementById('download-xls-rekap');
  let allKelasBtn = document.getElementById('download-pdf-allkelas');
  let pdfSantriBtn = document.getElementById('download-pdf-santri'); // pemicu modal (opsional)
  const santriSelect = document.getElementById('pdf-santri-select');

  if (!xlsBtn) {
    const wrap = document.querySelector('.pdf-rekap-controls');
    if (wrap) {
      xlsBtn = document.createElement('button');
      xlsBtn.id = 'download-xls-rekap';
      xlsBtn.className = 'rekap-btn';
      xlsBtn.textContent = 'Download Excel Rekap';
      wrap.appendChild(xlsBtn);
    }
  }
  pdfBtn?.classList.add('rekap-btn');
  pdfBtn?.addEventListener('click', pdfRekapDownload);
  xlsBtn?.addEventListener('click', xlsRekapDownload);

// -- Guard: pastikan drawTableHeader tersedia secara global --
if (typeof window.drawTableHeader !== 'function') {
  window.drawTableHeader = function drawTableHeader(doc, cols, x, y, rowH, fontSize, theme, padX){
    const totalW = (typeof window.sumWidth === 'function')
      ? window.sumWidth(cols)
      : cols.reduce((s,c)=>s + (Number(c.w)||0), 0);

    doc.setFillColor(...theme.tableHeadFill);
    doc.setDrawColor(...theme.border);
    doc.rect(x, y, totalW, rowH, 'FD');

    doc.setFont('helvetica','bold');
    doc.setFontSize(fontSize);
    doc.setTextColor(255,255,255);

    let cx = x;
    const lh = fontSize * 0.3528 * 1.18;

    for (const col of cols){
      const lines = doc.splitTextToSize(String(col.title||''), Math.max(1, col.w - 2*padX));
      const textH = lines.length * lh;
      const yy = y + (rowH - textH)/2 + lh*0.82;

      const tx = (col.align==='right')  ? (cx + col.w - padX)
               : (col.align==='center') ? (cx + col.w/2)
               : (cx + padX);

      const opt = (col.align==='right')  ? {align:'right'}
               : (col.align==='center') ? {align:'center'}
               : {};

      for (let i=0;i<lines.length;i++) doc.text(String(lines[i]), tx, yy + i*lh, opt);

      doc.rect(cx, y, col.w, rowH);
      cx += col.w;
    }

    doc.setTextColor(31,41,55);
    doc.setFont('helvetica','normal');
  };
}


  if (!allKelasBtn) {
    const wrap = document.querySelector('.pdf-rekap-controls');
    if (wrap) {
      allKelasBtn = document.createElement('button');
      allKelasBtn.id = 'download-pdf-allkelas';
      allKelasBtn.className = 'rekap-btn';
      allKelasBtn.textContent = 'Download PDF All Kelas';
      wrap.appendChild(allKelasBtn);
    }
  }
  allKelasBtn?.addEventListener('click', pdfAllKelasDownload);

  // Saat tanggal berubah, muat ulang opsi santri (opsional)
  $('#pdf-start-date')?.addEventListener('change', () => {
  const { value: kelas } = getSelectedKelas();
  if (kelas) window._populateSantriSelect?.();
});
$('#pdf-end-date')?.addEventListener('change', () => {
  const { value: kelas } = getSelectedKelas();
  if (kelas) window._populateSantriSelect?.();
});

  // ====== Loader XLSX ======
  async function ensureXLSX(){
    if (window.XLSX) return;
    await new Promise((resolve, reject) => {
      const sc = document.createElement('script');
      sc.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
      sc.onload = resolve; sc.onerror = () => reject(new Error('Gagal memuat XLSX'));
      document.head.appendChild(sc);
    });
  }

  // --- Whitelist berbasis roster (NIS/ID) ---
function buildRosterWhitelist(santriData){
  const allow = new Set();
  for (const s of (santriData||[])) {
    const nis = (s?.nis===0 || s?.nis) ? String(s.nis).trim() : "";
    const id  = (s?.id===0  || s?.id)  ? String(s.id).trim()  : "";
    if (nis) allow.add(nis);
    if (id)  allow.add(id);
  }
	 // Ambil juga santri yang baru ditambahkan di tabel dashboard (DOM)
	document.querySelectorAll('[data-key], [data-nis], [data-id]').forEach(row => {
	const k = (row.dataset.key || row.dataset.nis || row.dataset.id || '').trim();
	if (k) allow.add(k);
	});
  return allow;
}

// --- Helper ambil roster santri yang fleksibel (?kelas= ATAU ?kelasId=) ---
async function fetchSantriFlexible(kelasKey){
  // coba ?kelas=
  try{
    const d = await fetch(`/api/getSantri?kelas=${encodeURIComponent(kelasKey)}&t=${Date.now()}`).then(r=>r.json());
    if (Array.isArray(d) && d.length) return d;
    if (d && Array.isArray(d.santri)) return d.santri; // kalau API balikin {santri:[...]}
  }catch{}

  // fallback ?kelasId=
  try{
    const d = await fetch(`/api/getSantri?kelasId=${encodeURIComponent(kelasKey)}&t=${Date.now()}`).then(r=>r.json());
    if (Array.isArray(d)) return d;
    if (d && Array.isArray(d.santri)) return d.santri;
  }catch{}

  return [];
}	 

// --- D1 helpers (sesuai getAbsensiRange.js yang kamu kirim) ---
async function d1FetchAbsensi({ kelas, start, end, aggregate=false }) {
  const url = `/api/getAbsensiRange?kelas=${encodeURIComponent(kelas)}&start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}${aggregate ? '&aggregate=1' : ''}&t=${Date.now()}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error('getAbsensiRange gagal');
  const json = await res.json();
  // Wajib { aggregate:boolean, list:[] }
  if (!json || typeof json !== 'object' || !('aggregate' in json) || !Array.isArray(json.list)) {
    throw new Error('Format getAbsensiRange tidak valid');
  }
  return json;
}

async function d1FetchAbsensiRawList({ kelas, start, end }) {
  const j = await d1FetchAbsensi({ kelas, start, end, aggregate: false });
  if (j.aggregate) return [];
  return j.list || []; // daftar objek payload harian (sudah ada field "tanggal")
}

async function d1FetchAbsensiAggMap({ kelas, start, end }) {
  const j = await d1FetchAbsensi({ kelas, start, end, aggregate: true });
  if (!j.aggregate) return new Map();
  const m = new Map();
  for (const r of j.list || []) {
    const key = String(r.key || '').trim();
    if (!key) continue;
    m.set(key, {
      totalJuz: Number(r.totalJuz || 0), // dari D1 SUM(total_juz_num)
      totalMur: Number(r.totalMur || 0), // dari D1 SUM(total_mur_num)
    });
  }
  return m;
}

  // ====== Ambil & Agregasi Data (Rekap Kelas) ======
  // ====== Ambil & Agregasi Data (Rekap Kelas) ======
async function collectRekapData(){
  const { value: kelas, el: kelasEl } = getSelectedKelas();
  const startDate = document.querySelector('#pdf-start-date')?.value;
  const endDate   = document.querySelector('#pdf-end-date')?.value;
  if (!startDate || !endDate) throw new Error('Mohon pilih tanggal mulai dan tanggal akhir.');
  if (!kelas) throw new Error('Mohon pilih kelas terlebih dahulu.');
  const { line: kelasLine } = buildKelasKelompokLine(kelas, kelasEl);

  // 1) ABSENSI: raw (detail harian) + aggregate (ringkas per santri)
  const [rawList, aggMapD1] = await Promise.all([
    d1FetchAbsensiRawList({ kelas, start:startDate, end:endDate }),
    d1FetchAbsensiAggMap({ kelas, start:startDate, end:endDate }).catch(()=>new Map())
  ]);
  if (!Array.isArray(rawList) || rawList.length === 0) {
    throw new Error('Tidak ada data pada rentang tanggal tersebut.');
  }

  // 2) ROSTER
  // 2) ROSTER (fleksibel)
let santriData = await fetchSantriFlexible(kelas);

  const allowSet = buildRosterWhitelist(santriData);
  const keyId   = v => (v === 0 || v) ? String(v).trim() : "";
  const keyNis  = v => (v === 0 || v) ? String(v).trim() : "";
  const keyName = v => String(v || "").trim().toLowerCase();
  const byIdMap = (arr, pick = x => x) => { const m = new Map(); for (const a of arr||[]) { const id = keyId(a?.id); if (id) m.set(id, pick(a)); } return m; };
  const byNisMap = (arr, pick = x => x) => { const m = new Map(); for (const a of arr||[]) { const nis = keyNis(a?.nis); if (nis) m.set(nis, pick(a)); } return m; };
  const byNameMap = (arr, pick = x => x) => { const m = new Map(); for (const a of arr||[]) { const nm = keyName(a?.nama); if (nm && !m.has(nm)) m.set(nm, pick(a)); } return m; };
  const rosterById   = byIdMap(santriData, s => s);
  const rosterByNis  = byNisMap(santriData, s => s);
  const rosterByName = byNameMap(santriData, s => s);

  // 3) Normalisasi raw + injeksi slot
  const allDataNorm = rawList
    .filter(r => {
      const id  = keyId(r?.id ?? "");
      const nis = keyNis(r?.nis ?? "");
      if (nis && allowSet.has(nis)) return true;
      if (id  && allowSet.has(id))  return true;
      const nmK = keyName(r?.nama);
      const guessNis = nmK && rosterByName.get(nmK)?.nis ? keyNis(rosterByName.get(nmK).nis) : "";
      const guessId  = nmK && rosterByName.get(nmK)?.id  ? keyId(rosterByName.get(nmK).id)  : "";
      return (guessNis && allowSet.has(guessNis)) || (guessId && allowSet.has(guessId));
    })
    .map(r => {
      let id   = keyId(r?.id ?? "");
      let nis  = keyNis(r?.nis ?? "");
      const nmK = keyName(r?.nama);
      if (!nis && id && rosterById.get(id)?.nis) nis = keyNis(rosterById.get(id).nis);
      if (!nis && nmK && rosterByName.get(nmK)?.nis) nis = keyNis(rosterByName.get(nmK).nis);

      let nama = r?.nama;
      if (!nama && nis && rosterByNis.get(nis)?.nama) nama = rosterByNis.get(nis).nama;
      if (!nama && id  && rosterById.get(id)?.nama)  nama = rosterById.get(id).nama;
      if (!id && nis && rosterByNis.get(nis)?.id) id = keyId(rosterByNis.get(nis).id);

      let semester = (r?.semester != null) ? Number(r.semester) : null;
      if (semester == null) {
        if (nis && rosterByNis.get(nis)?.semester != null) semester = Number(rosterByNis.get(nis).semester);
        else if (id && rosterById.get(id)?.semester != null) semester = Number(rosterById.get(id).semester);
      }

      let jenjang = r?.jenjang ?? null;
      if (!jenjang && nis && rosterByNis.get(nis)?.jenjang) jenjang = rosterByNis.get(nis).jenjang;
      if (!jenjang && id  && rosterById.get(id)?.jenjang)  jenjang = rosterById.get(id).jenjang;

      let keterangan = r?.keterangan ?? null;
      if (!keterangan && nis && rosterByNis.get(nis)?.keterangan) keterangan = rosterByNis.get(nis).keterangan;
      if (!keterangan && id  && rosterById.get(id)?.keterangan)  keterangan = rosterById.get(id).keterangan;

      const slot = _slotMetricsFromRecord(r);
      return {
        ...r, ...slot, id, nis, nama, semester, jenjang, keterangan,
        tanggal: r?.tanggal ? String(r.tanggal).slice(0,10) : null
      };
    });

  // === [FIX] Terapkan toggle Rentang Absensi untuk perhitungan SLOT & KBM ===
  const { start: absS, end: absE, source: absSrc } = getAbsensiRangeOrDefault();
  const useAbsensiRange = (absSrc === 'absensi');
  const allDataAbsensi = useAbsensiRange
    ? (allDataNorm || []).filter(it => {
        const t = String(it?.tanggal || '');
        return t >= absS && t <= absE;
      })
    : allDataNorm;

	// === HITUNG "keterangan terakhir" per santri di rentang aktif ===
const _sortedAbsensi = [...(allDataAbsensi||[])].sort((a,b)=>{
  const ta = String(a?.tanggal||'');
  const tb = String(b?.tanggal||'');
  return ta.localeCompare(tb);
});
const lastKetMap = new Map();   // key -> last non-empty ket
for (const it of _sortedAbsensi){
  const key = (it?.nis && String(it.nis).trim()) || (it?.id && String(it.id).trim());
  if (!key) continue;
  const ket = (it?.keterangan ?? it?.note ?? it?.catatan ?? '').toString().trim();
  if (ket) lastKetMap.set(key, ket); // entri paling akhir = "terakhir"
}
	
  // 4) KBM hari unik (HANYA hari bermakna) ‚Äî pakai dataset yang sama dengan slot
  const kbmDaySet = new Set();
  (allDataAbsensi||[]).forEach(it => {
    if (it?.tanggal && _isMeaningfulKBM(it)) kbmDaySet.add(String(it.tanggal));
  });
  const kbmDays = kbmDaySet.size;

  // 5) Agregasi base + merge angka aggregate D1
  const aggMap = PDF_buildRekapPerKey(allDataNorm);
  applyUIOverrides(allDataNorm, aggMap);

	// ===== Outer join ringan: pastikan semua santri roster muncul minimal 1 baris =====
	for (const s of (santriData || [])) {
	const key = String(s.nis || s.id || '').trim();
	if (!key) continue;
	if (!aggMap[key]) {
	aggMap[key] = {
	id: String(s.id || ''), nis: String(s.nis || ''), nama: s.nama || '-',
	semester: (s.semester != null ? Number(s.semester) : null),
	jenjang: s.jenjang ?? null,
	keterangan: s.keterangan ?? null,
	// nilai default nol
	hadir:0, izin:0, sakit:0, alpha:0, lainnya:0,
	hadirSlots:0, izinSlots:0, sakitSlots:0, alphaSlots:0, targetSlots:0,
	totalPageSum:0, totalJuz:0, murTotalJuz:0, murCount:0,
	nilaiSum:0, nilaiCount:0, nilaiMin:0, nilaiMax:0,
	saSegments:[], pageSegments:[], juzSegments:[],
	juzSet:new Set(),
	};
	}
	}
	 
  Object.values(aggMap).forEach(r => {
    const k = (r.nis && String(r.nis).trim()) || (r.id && String(r.id).trim());
    if (!k) return;
    const a = aggMapD1.get(k);
    if (a) {
      r.totalJuz    = Number(a.totalJuz || r.totalJuz || 0);
      r.murTotalJuz = Number(a.totalMur || r.murTotalJuz || 0);
    }
  });

  // 6) Merge slot (pakai data yang sudah difilter absensi jika toggle aktif)
  const slotAgg = _aggregateSlotsPerKey(allDataAbsensi);
  for (const [k, a] of slotAgg.entries()) {
    if (!aggMap[k]) continue;
    aggMap[k].hadirSlots  = a.hadir;
    aggMap[k].izinSlots   = a.izin;
    aggMap[k].sakitSlots  = a.sakit;
    aggMap[k].alphaSlots  = a.alpha;
    aggMap[k].targetSlots = a.target;
  }

// 6b) Hari hadir per santri (slot-based) ‚Üí untuk Hadir % berbasis HARI KBM
const hadirDayAgg = _aggregateHadirDaysPerKey(allDataAbsensi);
for (const [k, v] of hadirDayAgg.entries()){
  if (!aggMap[k]) continue;
  aggMap[k].hadirDays = v.hadirDays; // jumlah HARI hadir santri
}

// --- META LIVE ke agregat (semester/jenjang dari roster, keterangan dari absensi terfilter) ---
for (const k of Object.keys(aggMap)) {
  const r = aggMap[k];

  // key normalisasi
  const key = (r.nis && String(r.nis).trim()) || (r.id && String(r.id).trim()) || '';

  // dari roster (byNis/byId sudah dibuat di atas)
  const sByNis = key && rosterByNis.get?.(key);
  const sById  = key && rosterById.get?.(key);
  const s = sByNis || sById || null;

  if (r.semester == null && s?.semester != null) r.semester = Number(s.semester);
  if ((r.jenjang == null || r.jenjang === '') && (s?.jenjang ?? s?.level)) {
    r.jenjang = s.jenjang ?? s.level;
  }

  // keterangan terakhir dari rentang aktif
  const liveKet = lastKetMap.get(key);
  if (liveKet) r.keterangan = liveKet;
}
	
  const allRows = Object.values(aggMap).sort((a,b)=> (a.nama||a.nis||a.id).localeCompare(b.nama||b.nis||b.id,'id'));
  const rows = allRows.filter(r => String(r.nis || r.id || '').trim() !== '');
  if (rows.length === 0) throw new Error('Tidak ada data ber-NIS pada rentang tanggal tersebut.');

  // 7) Ringkasan (slot)
  let totJuz=0, totH=0, totA=0, totS=0, totI=0, totPages=0;
  rows.forEach(r=>{
    totJuz += r.totalJuz;
    totH   += (Number(r.hadirSlots ?? r.hadir) || 0);
    totA   += (Number(r.alphaSlots ?? r.alpha) || 0);
    totS   += (Number(r.sakitSlots ?? r.sakit) || 0);
    totI   += (Number(r.izinSlots  ?? r.izin)  || 0);
    totPages += r.totalPageSum;
  });

  return { kelas, startDate, endDate, kelasLine, kbmDays, rows, allDataNorm,
           totals: { totJuz, totH, totA, totS, totI, totPages } };
}

  // === Isi dropdown santri (modal) ===
  async function populateSantriSelect(){
  const sel = santriSelect;
  if (!sel) return;

  const { value: kelas, el: kelasEl } = getSelectedKelas();
  const startDate = $('#pdf-start-date')?.value;
  const endDate   = $('#pdf-end-date')?.value;

  if (!kelas) {
    sel.innerHTML = `<option value="">‚Äî Pilih kelas terlebih dahulu ‚Äî</option>`;
    return; // << JANGAN fetch apa-apa sebelum kelas ada
  }

  sel.innerHTML = `<option value="">Memuat‚Ä¶</option>`;

    try {
      if (startDate && endDate) {
        const { allDataNorm } = await collectRekapData();
        const map = new Map();
        for (const it of allDataNorm) {
          const key = (it.nis && String(it.nis).trim()) || (it.id && String(it.id).trim());
          if (!key) continue;
          const nama = it.nama || '-';
          if (!map.has(key)) map.set(key, { key, nama, nis: it.nis||'', id: it.id||'' });
        }
        const arr = [...map.values()].sort((a,b)=>a.nama.localeCompare(b.nama,'id'));
        if (!arr.length) {
          sel.innerHTML = `<option value="">‚Äî Tidak ada data di rentang tanggal ‚Äî</option>`;
          return;
        }
        sel.innerHTML = `<option value="">‚Äî Pilih santri (ada data) ‚Äî</option>` +
          arr.map(x => `<option value="${x.key}" data-nama="${(x.nama||'').replace(/"/g,'&quot;')}">${x.nis ? x.nis : x.id} ‚Äî ${x.nama}</option>`).join('');
      } else {
        let santriData = await fetchSantriFlexible(kelas);

        const arr = (santriData||[]).map(s => ({ key: (s.nis||s.id||'').toString(), nama: s.nama||'-', nis: s.nis||'', id: s.id||'' }))
                              .filter(x => x.key).sort((a,b)=>a.nama.localeCompare(b.nama,'id'));
        sel.innerHTML = `<option value="">‚Äî Pilih santri ‚Äî</option>` +
          arr.map(x => `<option value="${x.key}" data-nama="${(x.nama||'').replace(/"/g,'&quot;')}">${x.nis ? x.nis : x.id} ‚Äî ${x.nama}</option>`).join('');
      }
    } catch(e){
      sel.innerHTML = `<option value="">‚Äî Gagal memuat daftar santri ‚Äî</option>`;
      console.error(e);
    }
  }
  window._populateSantriSelect = populateSantriSelect;

  // ==================== Util Nama Surah & Setoran ====================
  const QURAN_SURAH_NAMES = [
    null,
    "Al-Fatihah","Al-Baqarah","Ali 'Imran","An-Nisa'","Al-Ma'idah","Al-An'am","Al-A'raf","Al-Anfal","At-Taubah",
    "Yunus","Hud","Yusuf","Ar-Ra'd","Ibrahim","Al-Hijr","An-Nahl","Al-Isra'","Al-Kahfi","Maryam","Ta Ha","Al-Anbiya'",
    "Al-Hajj","Al-Mu'minun","An-Nur","Al-Furqan","Asy-Syu'ara'","An-Naml","Al-Qasas","Al-'Ankabut","Ar-Rum","Luqman",
    "As-Sajdah","Al-Ahzab","Saba'","Fatir","Ya-Sin","As-Saffat","Sad","Az-Zumar","Ghafir","Fussilat","Asy-Syura",
    "Az-Zukhruf","Ad-Dukhan","Al-Jasiyah","Al-Ahqaf","Muhammad","Al-Fath","Al-Hujurat","Qaf","Az-Zariyat","At-Tur",
    "An-Najm","Al-Qamar","Ar-Rahman","Al-Waqi'ah","Al-Hadid","Al-Mujadalah","Al-Hasyr","Al-Mumtahanah","As-Saff",
    "Al-Jumu'ah","Al-Munafiqun","At-Tagabun","At-Talaq","At-Tahrim","Al-Mulk","Al-Qalam","Al-Haqqah","Al-Ma'arij",
    "Nuh","Al-Jinn","Al-Muzzammil","Al-Muddatsir","Al-Qiyamah","Al-Insan","Al-Mursalat","An-Naba'","An-Nazi'at",
    "'Abasa","At-Takwir","Al-Infitar","Al-Mutaffifin","Al-Insyiqaq","Al-Buruj","At-Tariq","Al-A'la","Al-Gasyiyah",
    "Al-Fajr","Al-Balad","Asy-Syams","Al-Lail","Ad-Duha","Asy-Syarh","At-Tin","Al-'Alaq","Al-Qadr","Al-Bayyinah",
    "Az-Zalzalah","Al-'Adiyat","Al-Qari'ah","At-Takasur","Al-'Asr","Al-Humazah","Al-Fil","Quraisy","Al-Ma'un",
    "Al-Kausar","Al-Kafirun","An-Nasr","Al-Lahab","Al-Ikhlas","Al-Falaq","An-Nas"
  ];
  function PDF_surahName(n){
    const i = Number(n);
    if (!Number.isFinite(i) || i<1 || i>114) return `Surah ${n}`;
    return QURAN_SURAH_NAMES[i] || `Surah ${n}`;
  }
  function PDF_fmtSASegmentNama(seg){
    const from = seg?.from, to = seg?.to;
    if (!from || !to) return '';
    const fName = PDF_surahName(from.s), tName = PDF_surahName(to.s);
    return `${fName}: ${from.a} s.d. ${tName}: ${to.a}`;
  }
  function PDF_joinSAsegmentsNama(arr){
    const list = PDF_sortSASegments(PDF_dedupSASegments(arr));
    if (!list.length) return '-';
    return list.map(PDF_fmtSASegmentNama).join(', ');
  }

	// --- MERGE setoran yang berurutan/tumpang-tindih + formatter ringkas ---
function PDF_mergeSASegmentsContinuous(list){
  const segs = PDF_sortSASegments(PDF_dedupSASegments(list));
  if (!segs.length) return [];

  const out = [];
  for (const seg of segs){
    if (!seg?.from || !seg?.to) continue;
    const s = (PDF_compareSA(seg.from, seg.to) <= 0) ? {from: seg.from, to: seg.to} : {from: seg.to, to: seg.from};

    if (!out.length) { out.push({...s}); continue; }

    const cur = out[out.length - 1];
    // 1) Dalam surah yang sama: bersisian / overlap ayat
    const sameSurahTouch = (s.from.s === cur.to.s) && (s.from.a <= cur.to.a + 1);
    // 2) Lintas surah bertetangga & mulai ayat 1 (contoh: 1:‚Ä¶ ‚Üí 2:1)
    const nextSurahFrom1 = (s.from.s === cur.to.s + 1) && (s.from.a === 1);

    if (sameSurahTouch || nextSurahFrom1){
      if (PDF_compareSA(s.to, cur.to) > 0) cur.to = s.to;   // perpanjang ujung kanan
    } else {
      out.push({...s});
    }
  }
  return out;
}

function PDF_joinSAsegmentsNamaMerged(arr){
  const merged = PDF_mergeSASegmentsContinuous(arr);
  if (!merged.length) return '-';
  return merged.map(seg => {
    if (seg.from.s === seg.to.s){
      const name = PDF_surahName(seg.from.s);
      return `${name}: ${seg.from.a} s.d. ${seg.to.a}`;
    } else {
      const n1 = PDF_surahName(seg.from.s), n2 = PDF_surahName(seg.to.s);
      return `${n1}: ${seg.from.a} s.d. ${n2}: ${seg.to.a}`;
    }
  }).join(', ');
}

// optional: expose global
window.PDF_mergeSASegmentsContinuous = PDF_mergeSASegmentsContinuous;
window.PDF_joinSAsegmentsNamaMerged  = PDF_joinSAsegmentsNamaMerged;


// === Compact Juz ranges: dedup + sort + merge touching/overlapping ===
function PDF_mergeRanges(arr){
  // normalisasi -> [a,b] dengan a<=b
  const tmp = [];
  const seen = new Set();
  for (const seg of (arr||[])){
    if (!Array.isArray(seg) || seg.length < 2) continue;
    let a = Number(seg[0]), b = Number(seg[1]);
    if (!Number.isFinite(a) || !Number.isFinite(b)) continue;
    if (a > b) [a,b] = [b,a];
    const key = `${a}-${b}`;
    if (!seen.has(key)) { seen.add(key); tmp.push([a,b]); }
  }
  if (!tmp.length) return [];

  // sort by start then end
  tmp.sort((x,y)=> (x[0]-y[0]) || (x[1]-y[1]));

  // merge jika nempel/overlap (start <= curEnd+1)
  const merged = [];
  let cur = [...tmp[0]];
  for (let i=1;i<tmp.length;i++){
    const [a,b] = tmp[i];
    if (a <= cur[1] + 1) {
      if (b > cur[1]) cur[1] = b; // extend
    } else {
      merged.push(cur);
      cur = [a,b];
    }
  }
  merged.push(cur);
  return merged;
}

function PDF_joinRangeSegmentsCompact(arr, collapseSingle=true){
  const merged = PDF_mergeRanges(arr);
  if (!merged.length) return '-';
  return merged.map(([a,b]) => (collapseSingle && a===b) ? `${a}` : `${a}-${b}`).join(', ');
}

// expose global (opsional)
window.PDF_joinRangeSegmentsCompact = PDF_joinRangeSegmentsCompact;



  // === Pewarnaan sel SP ===
  function PDF_spPaintCell(doc, x, y, w, h, spValue){
    const v = String(spValue||'').toUpperCase().replace(/\s+/g,''); // SP1 / SP 1 -> SP1
    if (v === 'SP1'){
      doc.setFillColor(255,241,118);
      doc.rect(x, y, w, h, 'F');
      return null;
    }
    if (v === 'SP2'){
      doc.setFillColor(255,205,210);
      doc.rect(x, y, w, h, 'F');
      return null;
    }
    if (v === 'SP3'){
      doc.setFillColor(0,0,0);
      doc.rect(x, y, w, h, 'F');
      return [255,255,255];
    }
    return null;
  }

  // ================= PDF Rekap Kelas =================
  async function pdfRekapDownload(){
    setBtnLoading(pdfBtn, true, 'Membuat PDF‚Ä¶');
    try {
      const { kelas, startDate, endDate, kelasLine, kbmDays, rows } = await collectRekapData();
	  const rangeLabel = (typeof buildRangeLabel === 'function')
  ? buildRangeLabel(startDate, endDate)
  : `${startDate} s.d. ${endDate}`;

      const { jsPDF } = window.jspdf || {};
      if (!jsPDF) { alert('jsPDF belum dimuat. Tambahkan <script> jsPDF.'); return; }
      const doc = new jsPDF({ orientation: 'l', unit: 'mm', format: 'a3' });

      // === Tema
      const theme = {
        cardBorder: [229,231,235],
        headerText: [15,23,42],
        tableHeadFill: [30,136,229],
        zebraFill: [248,250,252],
        border: [229,231,235],
        text: [31,41,55],
        statusFill: { tuntas: [220,252,231], khatam: [237,233,254] }
      };

      const pageW  = doc.internal.pageSize.getWidth();
      const pageH  = doc.internal.pageSize.getHeight();
      const margin = { left: 12, right: 12, top: 12, bottom: 12 };

      const headerGap = 30;
      const fontBody = 8.5;
      const fontHead = fontBody + 1;
      const lineFactor = 1.18;
      const lineH = fontBody * 0.3528 * lineFactor;
      const cellPadX = 1.6;
      const cellPadY = 1.2;
      const headerRowH = Math.max(9, fontHead * 0.3528 * lineFactor + 2*cellPadY);

      function drawHeaderBar(){
        doc.setDrawColor(...theme.cardBorder);
        doc.roundedRect(margin.left-3, margin.top-6, pageW - margin.left - margin.right + 6, 22, 3, 3);
        doc.setTextColor(...theme.headerText);
        doc.setFont('helvetica','bold'); doc.setFontSize(14);
        doc.text('Rekap Absensi & Setoran', margin.left, margin.top);
        doc.setFont('helvetica','normal'); doc.setFontSize(10);
        doc.text(kelasLine, margin.left, margin.top + 6);
        doc.text(`Periode Tahfiz: ${fmtD_M_YYYY(startDate)} s.d. ${fmtD_M_YYYY(endDate)}`, margin.left, margin.top + 12);
        const rightX = pageW - margin.right - 70;
        doc.text(`KBM: ${kbmDays} hari (${buildRangeLabel(startDate, endDate)})`, rightX, margin.top + 6);
        doc.text(`Total Santri: ${rows.length}`, rightX, margin.top + 12);
        doc.setTextColor(...theme.text);
      }
      function drawFooter(pageNo, totalPages, printedAt){
        const y = pageH - 6;
        doc.setDrawColor(...theme.border); doc.setLineWidth(0.2);
        doc.line(margin.left-2, y-3, pageW-margin.right+2, y-3);
        doc.setFontSize(8);
        doc.text(`Dicetak: ${printedAt}`, margin.left, y);
        doc.text(`Halaman ${pageNo} / ${totalPages}`, pageW - margin.right - 30, y);
      }

      const cols = [
        { key:'no',       title:'No.',  w:11, minW:11, maxW:12, align:'center' },
        { key:'nis',      title:'NIS',  w:24, minW:18, maxW:34, align:'left'   },
        { key:'nama',     title:'Nama', w:46, minW:36, maxW:80, align:'left'   },
        { key:'sem',      title:'SM',   w:12, minW:12, maxW:12, align:'center' },
        { key:'jenjang',  title:'KLS',  w:14, minW:14, maxW:14, align:'center' },
        { key:'h',        title:'H',    w:8,  minW:6,  maxW:10, align:'center' },
        { key:'a',        title:'A',    w:8,  minW:6,  maxW:10, align:'center' },
        { key:'s',        title:'S',    w:8,  minW:6,  maxW:10, align:'center' },
        { key:'i',        title:'I',    w:8,  minW:6,  maxW:10, align:'center' },
        { key:'hadirPct', title:'Hadir %', w:16, minW:16, maxW:18, align:'center' },
        { key:'ket',      title:'SP',   w:12, minW:12, maxW:12, align:'center' },
        { key:'setoran',  title:'Setoran',  w:48, minW:32, maxW:120, align:'left'  },
        { key:'juz',      title:'Juz',      w:18, minW:18, maxW:18, align:'left'   },
        { key:'totJuz',   title:'Total Juz',    w:14, minW:14, maxW:22, align:'right'  },
		{ key:'murRange', title:'Murajaah', w:20, minW:18, maxW:26, align:'right' },
        { key:'persen',   title:'THMS',     w:17, minW:17, maxW:18, align:'center' },
        { key:'nilai',    title:'Nilai',    w:14, minW:14, maxW:20, align:'right'  },
        { key:'pred',     title:'Predikat', w:18, minW:18, maxW:18, align:'center' },
      ];
      const contentW = pageW - margin.left - margin.right;

      const tableData = rows.map((r, idx) => {
        const hasNilai  = (r.nilaiCount ?? 0) > 0;
		const nilaiAvg  = hasNilai ? (r.nilaiSum / r.nilaiCount) : null;
		const predHuruf = hasNilai ? PDF_predikatFromScore(nilaiAvg).huruf : '-';
        const statusJuz = PDF_totalAllJuzStatus(r.totalJuz, r.semester);
        const setoranText = PDF_joinSAsegmentsNamaMerged(r.saSegments);
        const juzText     = PDF_joinRangeSegmentsCompact(r.juzSegments, true);

        // SLOT-based
        const hadirSlots = Number(r.hadirSlots ?? r.hadir ?? 0);
        const izinSlots  = Number(r.izinSlots  ?? r.izin  ?? 0);
        const sakitSlots = Number(r.sakitSlots ?? r.sakit ?? 0);
        const alphaSlots = Number(r.alphaSlots ?? r.alpha ?? 0);
        const targetSlots= Number(r.targetSlots ?? 0);
        // === Hadir % berbasis HARI KBM ===
const hadirDays = Number(r.hadirDays || 0);
const denomDays = Number(kbmDays || 0);
const hadirPct  = denomDays > 0
  ? Math.round(100 * hadirDays / denomDays)
  : (
      (hadirSlots + izinSlots + sakitSlots + alphaSlots) > 0
      ? Math.round(100 * hadirirSlots / (hadirSlots + izinSlots + sakitSlots + alphaSlots))
      : (targetSlots > 0 ? Math.round(100 * hadirSlots / targetSlots) : 0)
    );

        return {
          no: String(idx+1),
          nis: r.nis || r.id || '-',
          nama: r.nama || '-',
          sem: semesterDisplayForKey(r.nis || r.id || '', r.semester),
          jenjang: jenjangLabel(r.jenjang ?? ''),
          ket: keteranganDisplayForKey(r.nis || r.id || '', r.keterangan),
          h: hadirSlots, a: alphaSlots, s: sakitSlots, i: izinSlots,
          hadirPct: `${hadirPct}%`,
          setoran: setoranText,
          juz: juzText,
          totJuz: r.totalJuz.toFixed(2),
		  murRange: fmtMurRange(r.murTotalJuz || 0, r.murCount || 0),
          persen: statusJuz.label,
          nilai: hasNilai ? nilaiAvg.toFixed(1) : '-',
		  pred: predHuruf
        };
      });

      fitColumnsFlex(doc, cols, tableData, fontBody, contentW, cellPadX);

      function drawTableHeader(doc, cols, x, y, rowH, fontSize, theme, padX){
        const totalW = sumWidth(cols);
        doc.setFillColor(...theme.tableHeadFill);
        doc.setDrawColor(...theme.border);
        doc.rect(x, y, totalW, rowH, 'FD');
        doc.setFont('helvetica','bold');
        doc.setFontSize(fontSize);
        doc.setTextColor(255,255,255);
        let cx = x;
        const lh = fontSize * 0.3528 * 1.18;
        for (const col of cols){
          const lines = doc.splitTextToSize(String(col.title||''), Math.max(1, col.w - 2*padX));
          const textH = lines.length * lh;
          const yy = y + (rowH - textH)/2 + lh*0.82;
          const tx = (col.align==='right') ? (cx + col.w - padX)
                   : (col.align==='center') ? (cx + col.w/2)
                   : (cx + padX);
          const opt = (col.align==='right') ? {align:'right'} : (col.align==='center') ? {align:'center'} : {};
          for (let i=0;i<lines.length;i++) doc.text(String(lines[i]), tx, yy + i*lh, opt);
          doc.rect(cx, y, col.w, rowH);
          cx += col.w;
        }
        doc.setTextColor(31,41,55);
        doc.setFont('helvetica','normal');
      }

      // Render tabel + footer
      drawHeaderBar();
      let x0 = margin.left;
      let y  = margin.top + headerGap;

      drawTableHeader(doc, cols, x0, y, headerRowH, fontHead, theme, cellPadX);
      y += headerRowH;

      let rowIndex = 0;
      doc.setLineWidth(0.2);

      for (const row of tableData) {
        const wraps = cols.map(col =>
          doc.splitTextToSize(String(row[col.key] ?? ''), Math.max(1, col.w - 2*cellPadX))
        );
        const rowTextHeights = wraps.map(lines => lines.length * lineH);
        const rowH = Math.max(lineH + 2*cellPadY, Math.max(...rowTextHeights) + 2*cellPadY);

        if (y + rowH > pageH - margin.bottom) {
          doc.addPage('a3', 'landscape');
          drawHeaderBar();
          y = margin.top + headerGap;
          drawTableHeader(doc, cols, x0, y, headerRowH, fontHead, theme, cellPadX);
          y += headerRowH;
          rowIndex = 0;
        }

        if (rowIndex % 2 === 1) {
          doc.setFillColor(248,250,252);
          doc.rect(x0, y, sumWidth(cols), rowH, 'F');
        }

        let x = x0;
        doc.setFont('helvetica','normal');
        doc.setFontSize(fontBody);
        doc.setTextColor(...theme.text);
        doc.setDrawColor(...theme.border);

        for (let ci=0; ci<cols.length; ci++){
          const col = cols[ci];
          const lines = wraps[ci];

          if (col.key === 'persen') {
            const val = String(row[col.key] || '').toUpperCase();
            if (val === 'TUNTAS' || val === 'KHATAM') {
              const fill = (val === 'TUNTAS') ? theme.statusFill.tuntas : theme.statusFill.khatam;
              doc.setFillColor(...fill);
              doc.rect(x, y, col.w, rowH, 'F');
            }
          }

          let spTextColor = null;
          if (col.key === 'ket') {
            spTextColor = PDF_spPaintCell(doc, x, y, col.w, rowH, row.ket);
            if (spTextColor) doc.setTextColor(...spTextColor);
          }

          const textBlockH = lines.length * lineH;
          let yy = y + (rowH - textBlockH)/2 + lineH*0.82;
          let tx, opt = {};
          if (col.align === 'right') { tx = x + col.w - cellPadX; opt = { align:'right' }; }
          else if (col.align === 'center') { tx = x + col.w/2; opt = { align:'center' }; }
          else { tx = x + cellPadX; }
          for (let li=0; li<lines.length; li++){
            doc.text(String(lines[li]), tx, yy, opt);
            yy += lineH;
          }

          doc.rect(x, y, col.w, rowH);
          if (spTextColor) doc.setTextColor(...theme.text);
          x += col.w;
        }
        y += rowH;
        rowIndex++;
      }

      // Tanda tangan + footer
      function fmtDDMMYYYY(iso){
        if (!iso) return null;
        const m = String(iso).match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (!m) return null;
        return `${m[3]}-${m[2]}-${m[1]}`;
      }
      const printedAt = new Date();
      const printedISO = printedAt.toISOString().slice(0,10);
      const ttdDate = fmtDDMMYYYY(endDate) || fmtDDMMYYYY(printedISO) || printedAt.toLocaleDateString('id-ID');

      const spaceTop = 10, neededH = 36;
      if (y + spaceTop + neededH > pageH - margin.bottom){
        doc.addPage('a3', 'landscape');
        drawHeaderBar();
        y = margin.top + headerGap;
      }
      y += spaceTop;

      const totalW = sumWidth(cols);
      const colGap = 8;
      const colW   = (totalW - colGap) / 2;
      const leftX  = margin.left;
      const rightX = margin.left + colW + colGap;

      doc.setFont('helvetica','normal'); doc.setFontSize(11);
      doc.text(`Kota Bima, ${ttdDate}`, margin.left + totalW, y, { align:'right' });

      const headY = y + 8;
      doc.text('Mengetahui,', leftX, headY);
      doc.text('Pengampu Halaqoh,', rightX, headY);

      const lineY = headY + 24;
      doc.setDrawColor(...theme.border);
      doc.line(leftX,  lineY, leftX  + colW - 10, lineY);
      doc.line(rightX, lineY, rightX + colW - 10, lineY);

      const totalPages = doc.internal.getNumberOfPages();
      for (let p = 1; p <= totalPages; p++) { doc.setPage(p); drawFooter(p, totalPages, printedAt.toLocaleString()); }

      const fileName = `Rekap_${kelas || 'kelas'}_${startDate}_sd_${endDate}.pdf`;
      doc.save(fileName);

    } catch (err) {
      console.error(err);
      alert('Gagal mengunduh PDF: ' + (err.message || err));
    } finally {
      setBtnLoading(pdfBtn, false);
    }
  }

  // ===== Helper: ambil semua key kelas =====
  function _getAllKelasKeys(){
    if (Array.isArray(window.ALL_KELAS_KEYS) && window.ALL_KELAS_KEYS.length){
      return [...new Set(window.ALL_KELAS_KEYS.map(String))].sort((a,b)=>{
        const na = +(String(a).match(/(\d+)/)?.[1]||1e9);
        const nb = +(String(b).match(/(\d+)/)?.[1]||1e9);
        return na-nb || String(a).localeCompare(String(b),'id');
      });
    }
    const el = (typeof kelasSelect !== 'undefined' && kelasSelect) ? kelasSelect : document.getElementById('kelasSelect');
    const vals = el ? [...el.options].map(o=>o.value).filter(Boolean) : [];
    let keys = vals.length ? [...new Set(vals)] : [];

    if (!keys.length){
      const custom = window.namaKelasCustom || window.NAMA_KELAS_CUSTOM || {};
      keys = Object.keys(custom||{});
    }

    keys.sort((a,b)=>{
      const na = +(String(a).match(/(\d+)/)?.[1]||1e9);
      const nb = +(String(b).match(/(\d+)/)?.[1]||1e9);
      return na-nb || String(a).localeCompare(String(b),'id');
    });
    return keys;
  }

  // ===== Helper: line "Kelas: X, Kelompok: Y" untuk kelas tertentu =====
  function _kelasKelompokLineFor(kelasKey){
    const kelasNum = (String(kelasKey||'').match(/(\d+)/)?.[1]) || (kelasKey || '-');
    const el = (typeof kelasSelect !== 'undefined' && kelasSelect) ? kelasSelect : document.getElementById('kelasSelect');
    const custom = window.namaKelasCustom || window.NAMA_KELAS_CUSTOM || {};
    let kelompok = custom[kelasKey] || "";

    if (!kelompok && el){
      const opt = [...el.options].find(o => o.value === kelasKey);
      const optText = opt?.text?.trim() || "";
      if (optText){
        const fromOpt = (optText.match(/Kelompok\s+(.+)/i)?.[1] || optText).trim();
        kelompok = fromOpt;
      }
    }
    kelompok = (kelompok || '').replace(/^Kelompok\s+/i, '').trim() || '-';
    return { kelasNum, kelompok, line: `Halaqoh: ${kelasNum}, ${kelompok}` };
  }

  // ====== Ambil & Agregasi Data utk 1 kelas spesifik ======
  // ====== Ambil & Agregasi Data utk 1 kelas spesifik ======
async function collectRekapDataForClass(kelasKey, startDate, endDate){
  if (!kelasKey) return null;
  if (!startDate || !endDate) return null;
  const { line: kelasLine } = _kelasKelompokLineFor(kelasKey);

  // 1) ABSENSI: raw + aggregate
  const [rawList, aggMapD1] = await Promise.all([
    d1FetchAbsensiRawList({ kelas: kelasKey, start: startDate, end: endDate }),
    d1FetchAbsensiAggMap({ kelas: kelasKey, start: startDate, end: endDate }).catch(()=>new Map())
  ]);
  if (!Array.isArray(rawList) || rawList.length === 0) return null;

  // 2) ROSTER
  // 2) ROSTER (fleksibel)
let santriData = await fetchSantriFlexible(kelasKey);

  const allowSet = buildRosterWhitelist(santriData);
  const keyId   = v => (v === 0 || v) ? String(v).trim() : "";
  const keyNis  = v => (v === 0 || v) ? String(v).trim() : "";
  const keyName = v => String(v || "").trim().toLowerCase();
  const byIdMap = (arr, pick = x => x) => { const m = new Map(); for (const a of arr||[]) { const id = keyId(a?.id); if (id) m.set(id, pick(a)); } return m; };
  const byNisMap = (arr, pick = x => x) => { const m = new Map(); for (const a of arr||[]) { const nis = keyNis(a?.nis); if (nis) m.set(nis, pick(a)); } return m; };
  const byNameMap = (arr, pick = x => x) => { const m = new Map(); for (const a of arr||[]) { const nm = keyName(a?.nama); if (nm && !m.has(nm)) m.set(nm, pick(a)); } return m; };
  const rosterById   = byIdMap(santriData, s => s);
  const rosterByNis  = byNisMap(santriData, s => s);
  const rosterByName = byNameMap(santriData, s => s);

  // 3) Normalisasi raw + injeksi slot
  const allDataNorm = rawList
    .filter(r => {
      const id  = keyId(r?.id ?? "");  const nis = keyNis(r?.nis ?? "");
      if (nis && allowSet.has(nis)) return true;
      if (id  && allowSet.has(id))  return true;
      const nmK = keyName(r?.nama);
      const guessNis = nmK && rosterByName.get(nmK)?.nis ? keyNis(rosterByName.get(nmK).nis) : "";
      const guessId  = nmK && rosterByName.get(nmK)?.id  ? keyId(rosterByName.get(nmK).id)  : "";
      return (guessNis && allowSet.has(guessNis)) || (guessId && allowSet.has(guessId));
    })
    .map(r => {
      let id   = keyId(r?.id ?? "");
      let nis  = keyNis(r?.nis ?? "");
      const nmK = keyName(r?.nama);
      if (!nis && id && rosterById.get(id)?.nis) nis = keyNis(rosterById.get(id).nis);
      if (!nis && nmK && rosterByName.get(nmK)?.nis) nis = keyNis(rosterByName.get(nmK).nis);

      let nama = r?.nama;
      if (!nama && nis && rosterByNis.get(nis)?.nama) nama = rosterByNis.get(nis).nama;
      if (!nama && id  && rosterById.get(id)?.nama)  nama = rosterById.get(id).nama;
      if (!id && nis && rosterByNis.get(nis)?.id) id = keyId(rosterByNis.get(nis).id);

      let semester = (r?.semester != null) ? Number(r.semester) : null;
      if (semester == null) {
        if (nis && rosterByNis.get(nis)?.semester != null) semester = Number(rosterByNis.get(nis).semester);
        else if (id && rosterById.get(id)?.semester != null) semester = Number(rosterById.get(id).semester);
      }

      let jenjang = r?.jenjang ?? null;
      if (!jenjang && nis && rosterByNis.get(nis)?.jenjang) jenjang = rosterByNis.get(nis).jenjang;
      if (!jenjang && id  && rosterById.get(id)?.jenjang)  jenjang = rosterById.get(id).jenjang;

      let keterangan = r?.keterangan ?? null;
      if (!keterangan && nis && rosterByNis.get(nis)?.keterangan) keterangan = rosterByNis.get(nis).keterangan;
      if (!keterangan && id  && rosterById.get(id)?.keterangan)  keterangan = rosterById.get(id).keterangan;

      const slot = _slotMetricsFromRecord(r);
      return {
        ...r, ...slot, id, nis, nama, semester, jenjang, keterangan,
        tanggal: r?.tanggal ? String(r.tanggal).slice(0,10) : null
      };
    });

  // === [Terapkan toggle Rentang Absensi] untuk SLOT & KBM
  const { start: absS, end: absE, source: absSrc } = getAbsensiRangeOrDefault();
  const useAbsensiRange = (absSrc === 'absensi');
  const allDataAbsensi = useAbsensiRange
    ? (allDataNorm || []).filter(it => {
        const t = String(it?.tanggal || '');
        return t >= absS && t <= absE;
      })
    : allDataNorm;

	// === HITUNG "keterangan terakhir" per santri di rentang aktif ===
const _sortedAbsensi = [...(allDataAbsensi||[])].sort((a,b)=>{
  const ta = String(a?.tanggal||'');
  const tb = String(b?.tanggal||'');
  return ta.localeCompare(tb);
});
const lastKetMap = new Map();
for (const it of _sortedAbsensi){
  const key = (it?.nis && String(it.nis).trim()) || (it?.id && String(it.id).trim());
  if (!key) continue;
  const ket = (it?.keterangan ?? it?.note ?? it?.catatan ?? '').toString().trim();
  if (ket) lastKetMap.set(key, ket);
}
	
  // 4) KBM unik (HANYA hari bermakna) ‚Äî pakai dataset yang sudah difilter
  const kbmDaySet = new Set();
  (allDataAbsensi||[]).forEach(it => {
    if (it?.tanggal && _isMeaningfulKBM(it)) kbmDaySet.add(String(it.tanggal));
  });
  const kbmDays = kbmDaySet.size;

  // 5) Agregasi base + merge angka aggregate D1
  const aggMap = PDF_buildRekapPerKey(allDataNorm);

	// ===== Outer join ringan: pastikan semua santri roster muncul minimal 1 baris =====
	for (const s of (santriData || [])) {
	const key = String(s.nis || s.id || '').trim();
	if (!key) continue;
	if (!aggMap[key]) {
	aggMap[key] = {
	id: String(s.id || ''), nis: String(s.nis || ''), nama: s.nama || '-',
	semester: (s.semester != null ? Number(s.semester) : null),
	jenjang: s.jenjang ?? null,
	keterangan: s.keterangan ?? null,
	// nilai default nol
	hadir:0, izin:0, sakit:0, alpha:0, lainnya:0,
	hadirSlots:0, izinSlots:0, sakitSlots:0, alphaSlots:0, targetSlots:0,
	totalPageSum:0, totalJuz:0, murTotalJuz:0, murCount:0,
	nilaiSum:0, nilaiCount:0, nilaiMin:0, nilaiMax:0,
	saSegments:[], pageSegments:[], juzSegments:[],
	juzSet:new Set(),
	};
	}
	}
	 
  applyUIOverrides(allDataNorm, aggMap);
  Object.values(aggMap).forEach(r => {
    const k = (r.nis && String(r.nis).trim()) || (r.id && String(r.id).trim());
    if (!k) return;
    const a = aggMapD1.get(k);
    if (a) {
      r.totalJuz    = Number(a.totalJuz || r.totalJuz || 0);
      r.murTotalJuz = Number(a.totalMur || r.murTotalJuz || 0);
    }
  });

  // 6) Merge slot ‚Äî pakai data absensi yang difilter
  const slotAgg = _aggregateSlotsPerKey(allDataAbsensi);
  for (const [k, a] of slotAgg.entries()) {
    if (!aggMap[k]) continue;
    aggMap[k].hadirSlots  = a.hadir;
    aggMap[k].izinSlots   = a.izin;
    aggMap[k].sakitSlots  = a.sakit;
    aggMap[k].alphaSlots  = a.alpha;
    aggMap[k].targetSlots = a.target;
  }

// 6b) Hari hadir per santri (slot-based) ‚Üí Hadir % berbasis HARI pada PDF All Kelas
const hadirDayAgg = _aggregateHadirDaysPerKey(allDataAbsensi);
for (const [k, v] of hadirDayAgg.entries()){
  if (!aggMap[k]) continue;
  aggMap[k].hadirDays = v.hadirDays;
}

  // --- META LIVE ke agregat (semester/jenjang roster, keterangan dari absensi terfilter) ---
for (const k of Object.keys(aggMap)) {
  const r = aggMap[k];
  const key = (r.nis && String(r.nis).trim()) || (r.id && String(r.id).trim()) || '';

  const sByNis = key && rosterByNis.get?.(key);
  const sById  = key && rosterById.get?.(key);
  const s = sByNis || sById || null;

  if (r.semester == null && s?.semester != null) r.semester = Number(s.semester);
  if ((r.jenjang == null || r.jenjang === '') && (s?.jenjang ?? s?.level)) {
    r.jenjang = s.jenjang ?? s.level;
  }

  const liveKet = lastKetMap.get(key);
  if (liveKet) r.keterangan = liveKet;
}

  const allRows = Object.values(aggMap).sort((a,b)=> (a.nama||a.nis||a.id).localeCompare(b.nama||b.nis||b.id,'id'));
  const rows = allRows.filter(r => String(r.nis || r.id || '').trim() !== '');
  if (!rows.length) return null;

  // 7) Ringkasan kelas
  let totJuz=0, totH=0, totA=0, totS=0, totI=0, totPages=0;
  rows.forEach(r=>{
    totJuz += r.totalJuz;
    totH   += (Number(r.hadirSlots ?? r.hadir) || 0);
    totA   += (Number(r.alphaSlots ?? r.alpha) || 0);
    totS   += (Number(r.sakitSlots ?? r.sakit) || 0);
    totI   += (Number(r.izinSlots  ?? r.izin)  || 0);
    totPages += r.totalPageSum;
  });

  return { kelas: kelasKey, startDate, endDate, kelasLine, kbmDays, rows,
           totals: { totJuz, totH, totA, totS, totI, totPages } };
}

  // ===== PDF ALL KELAS =====
  async function pdfAllKelasDownload(){
    const btn = document.getElementById('download-pdf-allkelas');
    setBtnLoading(btn, true, 'Membuat PDF‚Ä¶');
    try {
      const startDate = document.querySelector('#pdf-start-date')?.value;
      const endDate   = document.querySelector('#pdf-end-date')?.value;
      if (!startDate || !endDate) throw new Error('Mohon pilih tanggal mulai & akhir.');

      const kelasKeys = _getAllKelasKeys();
      if (!kelasKeys.length) throw new Error('Tidak menemukan daftar kelas.');

      const { jsPDF } = window.jspdf || {};
      if (!jsPDF) { alert('jsPDF belum dimuat. Tambahkan <script> jsPDF.'); return; }

      const doc = new jsPDF({ orientation: 'l', unit: 'mm', format: 'a3' });

      // Tema konsisten
      const theme = {
        cardBorder: [229,231,235],
        headerText: [15,23,42],
        tableHeadFill: [30,136,229],
        zebraFill: [248,250,252],
        border: [229,231,235],
        text: [31,41,55],
        statusFill: { tuntas: [220,252,231], khatam: [237,233,254] }
      };

      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      const margin = { left: 12, right: 12, top: 12, bottom: 12 };
      const fontBody = 8.5, fontHead = fontBody + 1;
      const lineFactor = 1.18;
      const lineH = fontBody * 0.3528 * lineFactor;
      const cellPadX = 1.6, cellPadY = 1.2;
      const headerRowH = Math.max(9, fontHead * 0.3528 * lineFactor + 2*cellPadY);

      const CLASS_HEADER_FONT = 10;
      const CLASS_HEADER_LINE_H = CLASS_HEADER_FONT * 0.3528 * 1.10;
      const HEADER_TO_TABLE_GAP = 0.8;
      const BETWEEN_CLASSES_GAP = 5.0;
      const ROW_MIN_H = (fontBody * 0.3528 * 1.18) + 2*cellPadY;

      function drawMainTitle(){
        doc.setTextColor(...theme.headerText);
        doc.setFont('helvetica','bold'); doc.setFontSize(14);
        doc.text('Rekap Absensi & Setoran', margin.left, margin.top);
        doc.setFont('helvetica','normal'); doc.setFontSize(9.5);
        doc.text(`Periode Tahfiz: ${fmtD_M_YYYY(startDate)} s.d. ${fmtD_M_YYYY(endDate)}`, margin.left, margin.top + 6);
        doc.setTextColor(...theme.text);
      }
      function drawFooter(pageNo, totalPages, printedAt){
        const y = pageH - 6;
        doc.setDrawColor(...theme.border); doc.setLineWidth(0.2);
        doc.line(margin.left-2, y-3, pageW-margin.right+2, y-3);
        doc.setFontSize(8);
        doc.text(`Dicetak: ${printedAt}`, margin.left, y);
        doc.text(`Halaman ${pageNo} / ${totalPages}`, pageW - margin.right - 30, y);
      }
      function drawClassHeaderCompact(kelasLine, kbmDays, totalSantri, yStart, startDate, endDate){
  const headerText = `${kelasLine}, KBM: ${kbmDays} hari (${buildRangeLabel(startDate, endDate)}), Total Santri: ${totalSantri}`;
  doc.setFont('helvetica','bold'); doc.setFontSize(CLASS_HEADER_FONT);
  const baseline = yStart + CLASS_HEADER_LINE_H * 0.72;
  doc.text(headerText, margin.left, baseline);
  return CLASS_HEADER_LINE_H;
}
      function ensureSpaceForClassBlock(yCurrent){
        const need = CLASS_HEADER_LINE_H + HEADER_TO_TABLE_GAP + headerRowH + ROW_MIN_H;
        if (yCurrent + need > pageH - margin.bottom){
          doc.addPage('a3','landscape');
          return margin.top + 6;
        }
        return yCurrent;
      }

      const baseCols = [
        { key:'no',       title:'No.',  w:11, minW:11, maxW:12, align:'center' },
        { key:'nis',      title:'NIS',  w:24, minW:18, maxW:34, align:'left'   },
        { key:'nama',     title:'Nama', w:46, minW:36, maxW:80, align:'left'   },
        { key:'sem',      title:'SM',   w:12, minW:12, maxW:12, align:'center' },
        { key:'jenjang',  title:'KLS',  w:14, minW:14, maxW:14, align:'center' },
        { key:'h',        title:'H',    w:8,  minW:6,  maxW:10, align:'center' },
        { key:'a',        title:'A',    w:8,  minW:6,  maxW:10, align:'center' },
        { key:'s',        title:'S',    w:8,  minW:6,  maxW:10, align:'center' },
        { key:'i',        title:'I',    w:8,  minW:6,  maxW:10, align:'center' },
        { key:'hadirPct', title:'Hadir %', w:16, minW:16, maxW:18, align:'center' },
        { key:'ket',      title:'SP',   w:12, minW:12, maxW:12, align:'center' },
        { key:'setoran',  title:'Setoran',  w:48, minW:32, maxW:120, align:'left'  },
        { key:'juz',      title:'Juz',      w:18, minW:18, maxW:18, align:'left'   },
        { key:'totJuz',   title:'Total Juz',    w:14, minW:14, maxW:22, align:'right'  },
		{ key:'murRange',  title:'Murajaah', w:20, minW:18, maxW:26, align:'right' },
        { key:'persen',   title:'THMS',     w:17, minW:17, maxW:18, align:'center' },
        { key:'nilai',    title:'Nilai',    w:14, minW:14, maxW:20, align:'right'  },
        { key:'pred',     title:'Predikat', w:18, minW:18, maxW:18, align:'center' },
      ];

      const contentW = pageW - margin.left - margin.right;
      let y = margin.top + 12; // judul + periode
      drawMainTitle();
      const printedAt = new Date().toLocaleString();

      for (const kelasKey of _getAllKelasKeys()){
        let data = null;
        try {
          data = await collectRekapDataForClass(kelasKey, startDate, endDate);
        } catch (e) {
          console.warn('Gagal kelas', kelasKey, e);
          continue;
        }
        if (!data) continue;

        const { kelasLine, kbmDays, rows } = data;

		const rangeLabel = (typeof buildRangeLabel === 'function')
  ? buildRangeLabel(startDate, endDate)
  : `${startDate} s.d. ${endDate}`;

        const tableData = rows.map((r, idx) => {
          const hasNilai  = (r.nilaiCount ?? 0) > 0;
			const nilaiAvg  = hasNilai ? (r.nilaiSum / r.nilaiCount) : null;
			const predHuruf = hasNilai ? PDF_predikatFromScore(nilaiAvg).huruf : '-';
          const statusJuz = PDF_totalAllJuzStatus(r.totalJuz, r.semester);
          const setoranText = PDF_joinSAsegmentsNamaMerged(r.saSegments);
          const juzText     = PDF_joinRangeSegmentsCompact(r.juzSegments, true);

          const hadirSlots = Number(r.hadirSlots ?? r.hadir ?? 0);
          const izinSlots  = Number(r.izinSlots  ?? r.izin  ?? 0);
          const sakitSlots = Number(r.sakitSlots ?? r.sakit ?? 0);
          const alphaSlots = Number(r.alphaSlots ?? r.alpha ?? 0);
          const targetSlots= Number(r.targetSlots ?? 0);
          // === Hadir % berbasis HARI KBM per kelas ===
const hadirDays = Number(r.hadirDays || 0);
const denomDays = Number(kbmDays || 0);
const hadirPct  = denomDays > 0
  ? Math.round(100 * hadirDays / denomDays)
  : (
      (hadirSlots + izinSlots + sakitSlots + alphaSlots) > 0
      ? Math.round(100 * hadirSlots / (hadirSlots + izinSlots + sakitSlots + alphaSlots))
      : (targetSlots > 0 ? Math.round(100 * hadirSlots / targetSlots) : 0)
    );


          return {
            no: String(idx+1),
            nis: r.nis || r.id || '-',
            nama: r.nama || '-',
            sem: semesterDisplayForKey(r.nis || r.id || '', r.semester),
            jenjang: jenjangLabel(r.jenjang ?? ''),
            ket: keteranganDisplayForKey(r.nis || r.id || '', r.keterangan),
            h: hadirSlots, a: alphaSlots, s: sakitSlots, i: izinSlots,
            hadirPct: `${hadirPct}%`,
            setoran: setoranText,
            juz: juzText,
            totJuz: r.totalJuz.toFixed(2),
			murRange: fmtMurRange(r.murTotalJuz || 0, r.murCount || 0),
            persen: statusJuz.label,
            nilai: hasNilai ? nilaiAvg.toFixed(1) : '-',
			pred: predHuruf
          };
        });

        const cols = JSON.parse(JSON.stringify(baseCols));
        fitColumnsFlex(doc, cols, tableData, fontBody, contentW, cellPadX);

        // jangan biarkan header kelas 'gantung'
        y = (function ensure(yCurrent){
          const need = CLASS_HEADER_LINE_H + HEADER_TO_TABLE_GAP + headerRowH + ROW_MIN_H;
          if (yCurrent + need > pageH - margin.bottom){
            doc.addPage('a3','landscape');
            return margin.top + 6;
          }
          return yCurrent;
        })(y);

        y += drawClassHeaderCompact(kelasLine, kbmDays, rows.length, y, startDate, endDate);
        y += HEADER_TO_TABLE_GAP;

        drawTableHeader(doc, cols, margin.left, y, headerRowH, fontHead, theme, cellPadX);
        y += headerRowH;

        let rowIndex = 0;
        doc.setLineWidth(0.2);

        for (const row of tableData) {
          const wraps = cols.map(col =>
            doc.splitTextToSize(String(row[col.key] ?? ''), Math.max(1, col.w - 2*cellPadX))
          );
          const rowTextHeights = wraps.map(lines => lines.length * lineH);
          const rowH = Math.max(lineH + 2*cellPadY, Math.max(...rowTextHeights) + 2*cellPadY);

          if (y + rowH > pageH - margin.bottom) {
            doc.addPage('a3', 'landscape');
            y = margin.top + 6;
            y += drawClassHeaderCompact(kelasLine, kbmDays, rows.length, y, startDate, endDate);
            y += HEADER_TO_TABLE_GAP;
            drawTableHeader(doc, cols, margin.left, y, headerRowH, fontHead, theme, cellPadX);
            y += headerRowH;
            rowIndex = 0;
          }

          if (rowIndex % 2 === 1) {
            doc.setFillColor(248,250,252);
            doc.rect(margin.left, y, sumWidth(cols), rowH, 'F');
          }

          let x = margin.left;
          doc.setFont('helvetica','normal');
          doc.setFontSize(fontBody);
          doc.setTextColor(...theme.text);
          doc.setDrawColor(...theme.border);

          for (let ci=0; ci<cols.length; ci++){
            const col = cols[ci];
            const lines = wraps[ci];

            if (col.key === 'persen') {
              const val = String(row[col.key] || '').toUpperCase();
              if (val === 'TUNTAS' || val === 'KHATAM') {
                const fill = (val === 'TUNTAS') ? theme.statusFill.tuntas : theme.statusFill.khatam;
                doc.setFillColor(...fill);
                doc.rect(x, y, col.w, rowH, 'F');
              }
            }

            let spTextColor = null;
            if (col.key === 'ket') {
              spTextColor = PDF_spPaintCell(doc, x, y, col.w, rowH, row.ket);
              if (spTextColor) doc.setTextColor(...spTextColor);
            }

            const textBlockH = lines.length * lineH;
            let yy = y + (rowH - textBlockH)/2 + lineH*0.82;
            let tx, opt = {};
            if (col.align === 'right') { tx = x + col.w - cellPadX; opt = { align:'right' }; }
            else if (col.align === 'center') { tx = x + col.w/2; opt = { align:'center' }; }
            else { tx = x + cellPadX; }
            for (let li=0; li<lines.length; li++){
              doc.text(String(lines[li]), tx, yy, opt);
              yy += lineH;
            }

            doc.rect(x, y, col.w, rowH);
            if (spTextColor) doc.setTextColor(...theme.text);
            x += col.w;
          }

          y += rowH;
          rowIndex++;
        }

        y += BETWEEN_CLASSES_GAP;
      }

      // ===== Tanda tangan sekali di paling bawah =====
      const printed = new Date();
      const printedISO = printed.toISOString().slice(0,10);
      const m = String(endDate||'').match(/^(\d{4})-(\d{2})-(\d{2})$/);
      const ttdDate = m ? `${m[3]}-${m[2]}-${m[1]}` : (String(printedISO).match(/^(\d{4})-(\d{2})-(\d{2})$/) ? String(printedISO).replace(/^(\d{4})-(\d{2})-(\d{2})$/, '$3-$2-$1') : printed.toLocaleDateString('id-ID'));

      const signNeededH = 36, spaceTop = 6;
      if (y + spaceTop + signNeededH > pageH - margin.bottom){
        doc.addPage('a3', 'landscape');
        y = margin.top + 6;
      }
      y += spaceTop;

      const totalW = pageW - margin.left - margin.right;
      const colGap = 8;
      const colW   = (totalW - colGap) / 2;
      const leftX  = margin.left;
      const rightX = margin.left + colW + colGap;

      doc.setFont('helvetica','normal'); doc.setFontSize(11);
      doc.text(`Kota Bima, ${ttdDate}`, margin.left + totalW, y, { align:'right' });

      const headY = y + 8;
      doc.text('Mengetahui,', leftX, headY);
      doc.text('Pengampu Halaqoh,', rightX, headY);

      const lineY = headY + 24;
      doc.setDrawColor(...theme.border);
      doc.line(leftX,  lineY, leftX  + colW - 10, lineY);
      doc.line(rightX, lineY, rightX + colW - 10, lineY);

      const totalPages = doc.internal.getNumberOfPages();
      for (let p = 1; p <= totalPages; p++) { doc.setPage(p); drawFooter(p, totalPages, printedAt); }

      const fileName = `Rekap_AllKelas_${startDate}_sd_${endDate}.pdf`;
      doc.save(fileName);
    } catch (err) {
      console.error(err);
      alert('Gagal mengunduh PDF All Kelas: ' + (err.message || err));
    } finally {
      setBtnLoading(btn, false);
    }
  }

  // ================= Excel (.xlsx) =================
  // ================= Excel (.xlsx) ‚Äî ALL KELAS (judul kelas sekali + header di bawahnya + pemisah) =================
async function xlsRekapDownload(){
  setBtnLoading(xlsBtn, true, 'Membuat Excel‚Ä¶');
  try {
    await ensureXLSX();

    const startDate = document.querySelector('#pdf-start-date')?.value;
    const endDate   = document.querySelector('#pdf-end-date')?.value;
    if (!startDate || !endDate) throw new Error('Mohon pilih tanggal mulai & akhir.');

    const kelasKeys = _getAllKelasKeys();
    if (!kelasKeys.length) throw new Error('Tidak menemukan daftar kelas.');

    // Header kolom data (tanpa kolom Kelas/Kelompok)
    const baseHeader = [
      "No","NIS","Nama","SM","KLS","H","A","S","I","Hadir %","SP",
      "Setoran (Surah: Ayat s.d. Surah: Ayat)","Juz","Total Juz","Murajaah","THMS","Nilai Rata2","Predikat"
    ];

    const rowsAll = [];          // AOA semua baris
    const merges  = [];          // daftar merge untuk judul kelas
    let rCursor   = 0;           // index baris (0-based) saat menulis AOA

    for (const k of kelasKeys) {
      const data = await collectRekapDataForClass(k, startDate, endDate).catch(()=>null);
      if (!data) continue;

      const { kelas: kelasKey, kelasLine, kbmDays, rows } = data;
      const kelompokLine = (kelasLine || '-').replace(/^Halaqoh:\s*/i,'').trim();
      const kkLabel = kelompokLine ? `${kelasKey} ‚Äî ${kelompokLine}` : String(k);

      // ---- 1) Judul kelas (merge A..last) + keterangan ringkas
      const judul =
        `Kelas/Kelompok: ${kkLabel}   |   Total Santri: ${rows.length}   |   KBM: ${kbmDays} hari (${buildRangeLabel(startDate, endDate)})   |   Periode Tahfiz: ${fmtD_M_YYYY(startDate)} s.d. ${fmtD_M_YYYY(endDate)}`;
      const judulRow = [judul, ...Array(baseHeader.length - 1).fill("")];
      rowsAll.push(judulRow);

      // catat merge: dari kolom 0 (A) ke kolom baseHeader.length-1
      merges.push({
        s: { r: rCursor, c: 0 },
        e: { r: rCursor, c: baseHeader.length - 1 }
      });
      rCursor += 1;

      // ---- 2) Header kolom tepat di bawah judul
      rowsAll.push([...baseHeader]);
      rCursor += 1;

	  // label rentang (ikut toggle "Rentang Absensi" kalau ada)
	  const rangeLabel = (typeof buildRangeLabel === 'function')
  	  ? buildRangeLabel(startDate, endDate)
  	  : `${startDate} s.d. ${endDate}`;
		
      // ---- 3) Baris data (tanpa kolom Kelas/Kelompok)
      const body = rows.map((r, idx) => {
        const hasNilai  = (r.nilaiCount ?? 0) > 0;
		const nilaiAvg  = hasNilai ? (r.nilaiSum / r.nilaiCount) : null;
		const predHuruf = hasNilai ? PDF_predikatFromScore(nilaiAvg).huruf : '-';
        const statusJuz = PDF_totalAllJuzStatus(r.totalJuz, r.semester);
        const setoranText = PDF_joinSAsegmentsNamaMerged(r.saSegments);
        const juzText     = PDF_joinRangeSegmentsCompact(r.juzSegments, true);

        const hadirSlots = Number(r.hadirSlots ?? r.hadir ?? 0);
        const izinSlots  = Number(r.izinSlots  ?? r.izin  ?? 0);
        const sakitSlots = Number(r.sakitSlots ?? r.sakit ?? 0);
        const alphaSlots = Number(r.alphaSlots ?? r.alpha ?? 0);
        const targetSlots= Number(r.targetSlots ?? 0);
        // === Hadir % berbasis HARI KBM ===
const hadirDays = Number(r.hadirDays || 0);
const denomDays = Number(kbmDays || 0);
const hadirPct  = denomDays > 0
  ? Math.round(100 * hadirDays / denomDays)
  : (targetSlots > 0 ? Math.round(100 * hadirSlots / targetSlots) : 0);

        return [
          idx+1,
          r.nis || r.id || '',
          r.nama || '',
          semesterDisplayForKey(r.nis || r.id || '', r.semester),
          jenjangLabel(r.jenjang ?? ''),
          hadirSlots, alphaSlots, sakitSlots, izinSlots,
          hadirPct,
          keteranganDisplayForKey(r.nis || r.id || '', r.keterangan),
          setoranText,
          juzText,
          Number(r.totalJuz.toFixed(2)),
          fmtMurRange(r.murTotalJuz || 0, r.murCount || 0),
          statusJuz.label,
          (hasNilai ? Number(nilaiAvg.toFixed(1)) : null), // biar sel Excel kosong
		  predHuruf                                        // kalau tak ada nilai ‚Üí "-"
        ];
      });

      rowsAll.push(...body);
      rCursor += body.length;

      // ---- 4) Pemisah 1 baris kosong antar kelas
      rowsAll.push(Array(baseHeader.length).fill(""));
      rCursor += 1;
    }

    if (!rowsAll.length) throw new Error('Tidak ada data pada rentang tanggal tersebut.');

    // Workbook 1 sheet
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(rowsAll);

    // Terapkan merge judul per kelas
    ws['!merges'] = merges;

    // Autofit kolom pakai sampel data (gunakan baseHeader untuk lebar minimal)
    ws['!cols'] = autoFitColumns([baseHeader, ...rowsAll]);

    XLSX.utils.book_append_sheet(wb, ws, 'Rekap');

    // Nama file
    const pad = n => String(n).padStart(2,'0');
    const now = new Date();
    const ts  = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}`;
    const fname = `Rekap_AllKelas_${startDate}_sd_${endDate}_${ts}.xlsx`;

    XLSX.writeFile(wb, fname);
  } catch (err) {
    console.error(err);
    alert('Gagal mengunduh Excel All Kelas: ' + (err.message || err));
  } finally {
    setBtnLoading(xlsBtn, false);
  }
}



	
  // ===== Util umum (widths) =====
  function fmtMurRange(total, count){
  const t = Number(total||0);
  const c = Number(count||0);
  return `${t.toFixed(2)} (${c})`;
}	
	
  function sumWidth(cols){ return cols.reduce((s,c)=>s + (Number(c.w)||0), 0); }
  function autoFitColumns(aoa){
    const colCount = Math.max(...aoa.map(r => r.length));
    const cols = Array.from({length: colCount}, (_,i) => {
      const maxLen = Math.max(...aoa.map(row => {
        const v = row[i];
        if (v == null) return 0;
        const s = (typeof v === 'string') ? v : String(v);
        return s.length;
      }), 0);
      return { wch: Math.min(60, Math.max(6, Math.ceil(maxLen * 1.1) + 2)) };
    });
    return cols;
  }
  function fitColumnsFlex(doc, cols, tableData, fontSize, contentW, padX){
    const keys = cols.map(c => c.key);
    const weights = keys.map((k,i) => {
      const headLen = String(cols[i].title || '').length;
      let maxLen = headLen;
      const sampleLimit = Math.min(300, tableData.length);
      for (let r=0; r<sampleLimit; r++){
        const s = String(tableData[r][k] ?? '');
        if (s.length > maxLen) maxLen = s.length;
      }
      if (['nama','setoran','juz'].includes(k)) maxLen *= 1.25;
      return maxLen;
    });

    const minSum = cols.reduce((a,c)=>a+(c.minW||c.w||8),0);
    const maxSum = cols.reduce((a,c)=>a+(c.maxW||c.w||8),0);
    const target = Math.max(minSum, Math.min(maxSum, contentW));
    const sumWgt = weights.reduce((a,b)=>a+b,0) || 1;

    let widths = cols.map((c,i)=>{
      const minW = c.minW ?? c.w ?? 8;
      const maxW = c.maxW ?? (minW+20);
      const frac = weights[i] / sumWgt;
      const raw  = minW + (target - minSum) * frac;
      return Math.max(minW, Math.min(maxW, raw));
    });

    let used = widths.reduce((a,b)=>a+b,0);
    let diff = target - used;
    const step = diff >= 0 ? 0.1 : -0.1;
    let guard = 0;
    while (Math.abs(diff) > 0.09 && guard++ < 200){
      for (let i=0; i<cols.length && Math.abs(diff)>0.09; i++){
        const minW = cols[i].minW ?? cols[i].w ?? 8;
        const maxW = cols[i].maxW ?? (minW+20);
        const canGrow = diff>0 && widths[i] + step <= maxW;
        const canShrink = diff<0 && widths[i] + step >= minW;
        if (canGrow || canShrink){ widths[i] += step; diff -= step; }
      }
    }

    widths = widths.map(w => Math.round(w*10)/10);
    const sumRounded = widths.reduce((a,b)=>a+b,0);
    const fix = Math.round((target - sumRounded)*10)/10;
    widths[widths.length-1] += fix;

    for (let i=0;i<cols.length;i++) cols[i].w = widths[i];
  }

  // ======= Parser & Aggregator util (lengkap) =======
  function PDF_normKey(v){ return String(v ?? '').trim(); }
  function PDF_num2(v){ if (v===0 || v==='0') return 0; const n=parseFloat(String(v??'').replace(',','.')); return Number.isFinite(n)?n:null; }
  function PDF_parseRange(r){ const m=String(r||'').trim().match(/^(\d+)\s*-\s*(\d+)$/); if(!m) return null; let a=+m[1], b=+m[2]; if(!Number.isFinite(a)||!Number.isFinite(b)) return null; return a<=b?[a,b]:[b,a]; }
  function PDF_parseSA(sa){ const m=String(sa||'').trim().match(/^(\d+)\s*:\s*(\d+)$/); return m?{s:+m[1], a:+m[2]}:null; }
  function PDF_compareSA(x,y){ if(!x||!y) return 0; return x.s!==y.s?x.s-y.s:x.a-y.a; }
  function PDF_normStatus(s){
    s = String(s||'').trim().toLowerCase();
    if (['hadir','h'].includes(s)) return 'hadir';
    if (['alpha','alfa','alpa','a'].includes(s)) return 'alpha';
    if (['sakit','skt','s'].includes(s)) return 'sakit';
    if (['izin','ijin','izn','i'].includes(s)) return 'izin';
    return 'lainnya';
  }
  function PDF_predikatFromScore(nilai){
    const map = [
      { max: 59,  text: 'ROSIB',         huruf: 'D' },
      { max: 69,  text: 'MAQBUL',        huruf: 'C' },
      { max: 79,  text: 'JAYYID',        huruf: 'B' },
      { max: 89,  text: 'JAYYID JIDDAN', huruf: 'A' },
      { max: 100, text: 'MUMTAZ',        huruf: 'A+' }
    ];
    return map.find(p => nilai <= p.max) || map[map.length-1];
  }
  function PDF_parseJuzTerbacaField(val){
    const out = new Set();
    if (val == null) return out;
    if (Array.isArray(val)) {
      val.forEach(v => {
        if (typeof v === 'number' && Number.isFinite(v)) out.add(v);
        else if (typeof v === 'string') PDF_parseJuzTerbacaField(v).forEach(n => out.add(n));
      });
      return out;
    }
    if (typeof val === 'number' && Number.isFinite(val)) { out.add(val); return out; }
    let str = String(val);
    str = str.replace(/[‚Äì‚Äî‚àí]/g, '-');
    str = str.replace(/\s*(s\.?d\.?|sd|sampai|to)\s*/gi, '-');
    str = str.replace(/juz\s*:?/gi, 'juz ');
    const re = /(?:juz\s*)?(\d{1,2})(?:\s*-\s*(\d{1,2}))?/gi;
    let m;
    while ((m = re.exec(str)) !== null) {
      let a = parseInt(m[1], 10);
      let b = m[2] ? parseInt(m[2], 10) : a;
      if (a > b) [a, b] = [b, a];
      a = Math.max(1, Math.min(30, a));
      b = Math.max(1, Math.min(30, b));
      for (let x = a; x <= b; x++) out.add(x);
    }
    return out;
  }
  function PDF_fmtSASegment(seg){ return `${seg.from.s}:${seg.from.a}-${seg.to.s}:${seg.to.a}`; }
  function PDF_dedupSASegments(arr){
    const seen = new Set(), out = [];
    for (const seg of (arr||[])) {
      if (!seg?.from || !seg?.to) continue;
      const norm = (PDF_compareSA(seg.from, seg.to) <= 0) ? seg : {from: seg.to, to: seg.from};
      const key = `${norm.from.s}:${norm.from.a}-${norm.to.s}:${norm.to.a}`;
      if (!seen.has(key)) { seen.add(key); out.push(norm); }
    }
    return out;
  }
  function PDF_sortSASegments(list){
    return [...(list||[])].sort((A,B)=>{
      const c1 = PDF_compareSA(A?.from, B?.from);
      if (c1 !== 0) return c1;
      return PDF_compareSA(A?.to, B?.to);
    });
  }
  function PDF_joinSAsegments(arr){
    const list = PDF_sortSASegments(PDF_dedupSASegments(arr));
    if (!list.length) return '-';
    return list.map(PDF_fmtSASegment).join(', ');
  }
  function PDF_sortRangeSegments(list){
    return [...(list||[])].sort((a,b)=>{
      const a0 = Number(a?.[0]), a1 = Number(a?.[1]);
      const b0 = Number(b?.[0]), b1 = Number(b?.[1]);
      if (a0 !== b0) return a0 - b0;
      return a1 - b1;
    });
  }
  function PDF_joinRangeSegments(arr, collapseSingle=false){
    if (!arr || !arr.length) return '-';
    const seen = new Set(), tmp = [];
    for (const seg of arr){
      if (!Array.isArray(seg) || seg.length<2) continue;
      let a = Number(seg[0]), b = Number(seg[1]);
      if (!Number.isFinite(a) || !Number.isFinite(b)) continue;
      if (a > b) [a,b] = [b,a];
      const key = `${a}-${b}`;
      if (!seen.has(key)) { seen.add(key); tmp.push([a,b]); }
    }
    const out = PDF_sortRangeSegments(tmp).map(([a,b]) => (collapseSingle && a===b) ? `${a}` : `${a}-${b}`);
    return out.length ? out.join(', ') : '-';
  }
  function PDF_percentCapaian(totalJuzNum, semester){
    const batasSemester = {1: 1, 2: 1, 3: 2, 4: 2, 5: 3, 6: 3, 7: 4, 8: 4, 9: 5, 10: 5, 11: 6, 12: 6};
    const total = Number(totalJuzNum);
    const sem   = Number(semester);
    if (!Number.isFinite(total)) return 0;
    if (total >= 30) return 100;
    const batas = batasSemester[sem] || 0;
    if (batas <= 0) return 0;
    let p = Math.floor((total / batas) * 100);
    return Math.max(0, Math.min(100, p));
  }
  function PDF_totalAllJuzStatus(totalJuzNum, semester){
    const p = PDF_percentCapaian(totalJuzNum, semester);
    if (Number(totalJuzNum) >= 30) return { label:'KHATAM', percent:100 };
    if (p >= 100) return { label:'TUNTAS', percent:p };
    return { label: `${p}%`, percent:p };
  }

// --- expose things used by pdfSantriDownload (which lives outside the IIFE) ---
window.setBtnLoading = setBtnLoading;
window.collectRekapData = collectRekapData;

window.sumWidth = sumWidth;
window.fitColumnsFlex = fitColumnsFlex;

window.jenjangLabel = jenjangLabel;
window.fmtD_M_YYYY = fmtD_M_YYYY;

// expose PDF helpers used by per-santri
window.PDF_normStatus = PDF_normStatus;
window.PDF_parseSA = PDF_parseSA;
window.PDF_compareSA = PDF_compareSA;
window.PDF_parseRange = PDF_parseRange;
window.PDF_num2 = PDF_num2;
window.PDF_parseJuzTerbacaField = PDF_parseJuzTerbacaField;
window.PDF_joinSAsegmentsNama = PDF_joinSAsegmentsNama;
window.PDF_joinRangeSegments = PDF_joinRangeSegments;
window.PDF_totalAllJuzStatus = PDF_totalAllJuzStatus;
window.PDF_predikatFromScore = PDF_predikatFromScore;
window.PDF_spPaintCell = PDF_spPaintCell;

// juga expose fmtMurRange (tak masalah jika sudah ada dari FIX-1)
if (typeof window.fmtMurRange !== 'function') {
  window.fmtMurRange = function(total, count){
    const t = Number(total||0);
    const c = Number(count||0);
    return `${t.toFixed(2)} (${c})`;
  };
}

// expose DOM refs so pdfSantriDownload bisa akses
window.pdfSantriBtn = pdfSantriBtn;
window.santriSelect = santriSelect;

// tombol OK di modal -> panggil pdfSantriDownload
document.getElementById('okSantriSelect')
  ?.addEventListener('click', () => window._pdfSantriDownload?.());

// (opsional) tombol "PDF Individual" langsung jalankan pdfSantriDownload jika tanpa modal
document.getElementById('download-pdf-santri')
  ?.addEventListener('click', () => window._pdfSantriDownload?.());


// === Expose helper yang dipakai blok per-santri ===
window.setBtnLoading = setBtnLoading;
window.collectRekapData = collectRekapData;

window.sumWidth = sumWidth;
window.fitColumnsFlex = fitColumnsFlex;

window.jenjangLabel = jenjangLabel;
window.fmtD_M_YYYY = fmtD_M_YYYY;

// PDF helpers
window.PDF_normStatus = PDF_normStatus;
window.PDF_parseSA = PDF_parseSA;
window.PDF_compareSA = PDF_compareSA;
window.PDF_parseRange = PDF_parseRange;
window.PDF_num2 = PDF_num2;
window.PDF_parseJuzTerbacaField = PDF_parseJuzTerbacaField;
window.PDF_joinSAsegmentsNama = PDF_joinSAsegmentsNama;
window.PDF_joinRangeSegments = PDF_joinRangeSegments;
window.PDF_totalAllJuzStatus = PDF_totalAllJuzStatus;
window.PDF_predikatFromScore = PDF_predikatFromScore;
window.PDF_spPaintCell = PDF_spPaintCell;

// DOM refs
window.pdfSantriBtn = document.getElementById('download-pdf-santri');
window.santriSelect = document.getElementById('pdf-santri-select');

// expose populateSantriSelect dengan nama global yang konsisten
window.populateSantriSelect = populateSantriSelect;

// === Listener TANPA duplikasi ===
const okBtn = document.getElementById('okSantriSelect');
if (okBtn && !okBtn.dataset.listenerAttached) {
  okBtn.addEventListener('click', () => window._pdfSantriDownload?.());
  okBtn.dataset.listenerAttached = '1';
}

// Tombol "PDF Individual" hanya buka modal + muat dropdown, BUKAN download
const indBtn = document.getElementById('download-pdf-santri');
if (indBtn && !indBtn.dataset.listenerAttached) {
  indBtn.addEventListener('click', async () => {
    const modal = document.getElementById('santriModalOverlay');
    if (modal) modal.style.display = 'block';
    await window.populateSantriSelect?.();
    // fokus ke select biar jelas
    setTimeout(() => window.santriSelect?.focus?.(), 0);
  });
  indBtn.dataset.listenerAttached = '1';
}


	
  // === Aggregator utama per santri (base; tidak slot) ===
  function PDF_buildRekapPerKey(items){
    const map = Object.create(null);
    for (const it of (items||[])) {
      const id  = PDF_normKey(it?.id);
      const nis = PDF_normKey(it?.nis);
      const key = PDF_normKey(nis || id);
      if (!key) continue;

      if (!map[key]) map[key] = {
        id:id||'', nis:nis||'', nama: it?.nama || '',
        hadir:0, alpha:0, sakit:0, izin:0, lainnya:0,
        dariMin:null, sampaiMax:null,
        pageStartMin:null, pageEndMax:null,
        totalPageSum:0,
		totalJuz:0,            // semua juz (setoran)
		murTotalJuz: 0,        // << BARU: total juz murajaah (dari 'juzmurajaah')
		murCount: 0,           // << BARU: jumlah hari yang memiliki murajaah (>0)
        _nilaiByDate:Object.create(null),
        nilaiSum:0, nilaiCount:0, nilaiMin:Infinity, nilaiMax:-Infinity,
        juzSet:new Set(),
        semester: (it?.semester!=null ? Number(it.semester) : null),
        jenjang: (it?.jenjang ?? null),
        keterangan: (it?.keterangan ?? null),
        saSegments: [], pageSegments: [], juzSegments: [],
        _datesAll: new Set(), _datesHadir: new Set()
      };
      const r = map[key];
      if (!r.nama && it?.nama) r.nama = it.nama;

      const tgl = it?.tanggal ? String(it.tanggal).slice(0,10) : null;
      const st  = PDF_normStatus(it?.absensi ?? it?.status);

      if (st==='hadir') r.hadir++;
      else if (st==='alpha') r.alpha++;
      else if (st==='sakit') r.sakit++;
      else if (st==='izin') r.izin++;
      else r.lainnya++;

      if (tgl && r.nis && nis && nis === r.nis) {
        r._datesAll.add(tgl);
        if (st === 'hadir') r._datesHadir.add(tgl);
      }

      const dari = PDF_parseSA(it?.dari || it?.dariSetoran);
      const smp  = PDF_parseSA(it?.sampai || it?.sampaiSetoran);
      if (dari && smp) {
        const seg = (PDF_compareSA(dari, smp) <= 0) ? {from: dari, to: smp} : {from: smp, to: dari};
        r.saSegments.push(seg);
      }

      const rng = PDF_parseRange(it?.halaman || it?.page);
      const tp  = PDF_num2(it?.totalHalaman ?? it?.totalPage);
      if (tp!=null) r.totalPageSum += tp;
      else if (rng) r.totalPageSum += Math.max(0, rng[1]-rng[0]+1);
      if (rng){
        let [a,b] = rng; if (a>b) [a,b]=[b,a];
        r.pageSegments.push([a,b]);
        if (Number.isFinite(a) && (r.pageStartMin==null || a<r.pageStartMin)) r.pageStartMin=a;
        if (Number.isFinite(b) && (r.pageEndMax==null   || b>r.pageEndMax))   r.pageEndMax=b;
      }

      const vJ = PDF_num2(it?.totalJuz ?? it?.juz);
      if (vJ!=null) r.totalJuz += vJ;

		// --- Murajaah dari server ('juzmurajaah') ---
		const vM = PDF_num2(it?.juzmurajaah ?? it?.murajaah ?? it?.mur_juz);
		if (vM != null) {
  		r.murTotalJuz += vM;
  		if (vM > 0) r.murCount += 1;
		}


      const vNraw = (it?.buttonCell?.nilai ?? it?.nilai ?? it?.score);
      const vN = PDF_num2(vNraw);
      if (tgl && vN!=null) r._nilaiByDate[tgl] = vN;

      const jtRaw = it?.juzTerbaca ?? it?.juz_terbaca ?? it?.juzTerbacaText ?? it?.juzText ?? it?.juzs ?? it?.juz;
      const set = PDF_parseJuzTerbacaField(jtRaw);
      if (set.size) {
        set.forEach(n=> r.juzSet.add(n));
        const arr = Array.from(set).sort((a,b)=>a-b);
        let start = arr[0], prev = arr[0];
        for (let i=1; i<=arr.length; i++){
          const curr = arr[i];
          if (curr === prev + 1) { prev = curr; continue; }
          r.juzSegments.push([start, prev]);
        }
      }

      if (r.semester==null   && it?.semester   !=null) r.semester   = Number(it.semester);
      if (r.jenjang == null  && it?.jenjang    !=null) r.jenjang    = it.jenjang;
      if (r.keterangan == null && it?.keterangan !=null) r.keterangan = it.keterangan;
    }

    for (const k in map){
      const r = map[k];
      r.nilaiSum = 0; r.nilaiCount = 0; r.nilaiMin = Infinity; r.nilaiMax = -Infinity;
      for (const t in r._nilaiByDate){
        const v = r._nilaiByDate[t];
        r.nilaiSum += v; r.nilaiCount += 1;
        if (v < r.nilaiMin) r.nilaiMin = v;
        if (v > r.nilaiMax) r.nilaiMax = v;
      }
      if (!Number.isFinite(r.nilaiMin)) r.nilaiMin = 0;
      if (!Number.isFinite(r.nilaiMax)) r.nilaiMax = 0;

      r.daysCount  = r._datesAll.size;
      r.hadirDays  = r._datesHadir.size;

      r.saSegments   = PDF_dedupSASegments(r.saSegments);
      r.pageSegments = (function dedupRange(list){
        const seen = new Set(), out=[];
        for (const seg of (list||[])){
          if (!Array.isArray(seg) || seg.length<2) continue;
          let a = Number(seg[0]), b = Number(seg[1]);
          if (!Number.isFinite(a) || !Number.isFinite(b)) continue;
          if (a>b) [a,b]=[b,a];
          const key = `${a}-${b}`;
          if (!seen.has(key)) { seen.add(key); out.push([a,b]); }
        }
        return out;
      })(r.pageSegments);
      r.juzSegments  = (function dedupRange(list){
        const seen = new Set(), out=[];
        for (const seg of (list||[])){
          if (!Array.isArray(seg) || seg.length<2) continue;
          let a = Number(seg[0]), b = Number(seg[1]);
          if (!Number.isFinite(a) || !Number.isFinite(b)) continue;
          if (a>b) [a,b]=[b,a];
          const key = `${a}-${b}`;
          if (!seen.has(key)) { seen.add(key); out.push([a,b]); }
        }
        return out;
      })(r.juzSegments);
    }
    return map;
  }
})(); // end IIFE

var semesterDisplayForKey = window.semesterDisplayForKey || function(key, fb){ return fb ?? '-'; };
var keteranganDisplayForKey = window.keteranganDisplayForKey || function(key, fb){ return fb ?? '-'; };

	 // === [FIX-1] Global fmtMurRange (agar bisa dipakai di semua blok) ===
if (typeof window.fmtMurRange !== 'function') {
  window.fmtMurRange = function(total, count){
    const t = Number(total||0);
    const c = Number(count||0);
    return `${t.toFixed(2)} (${c})`;
  };
}
// alias global (tanpa window.) supaya panggilan lama tetap aman
var fmtMurRange = window.fmtMurRange;
// === [END FIX-1] ===
	
  // ============== PDF per Santri (slot-based) ==============
async function pdfSantriDownload(){
  // Tentukan tombol pemicu yang benar (OK vs Individual)
  const srcFromOK = document.activeElement && document.activeElement.id === 'okSantriSelect';
  const triggerBtn = srcFromOK
    ? document.getElementById('okSantriSelect')
    : document.getElementById('download-pdf-santri');

  // Hindari unduhan dobel bila user klik cepat
  if (window._pdfSantriBusy) return;
  window._pdfSantriBusy = true;

  setBtnLoading(triggerBtn, true, 'Membuat PDF‚Ä¶');
  try {
    const sel = window.santriSelect || document.getElementById('pdf-santri-select');

    // Jika belum memilih santri: tampilkan modal & muat daftar, lalu KELUAR tanpa error
    if (!sel || !sel.value) {
      const modal = document.getElementById('santriModalOverlay');
      if (modal) modal.style.display = 'block';
      await (window.populateSantriSelect?.());
      setBtnLoading(triggerBtn, false);
      window._pdfSantriBusy = false;
      return; // <=== penting: jangan lanjut render PDF
    }

    const key = sel.value;
    const selectedNama = sel.options[sel.selectedIndex]?.dataset?.nama || '';

    const { startDate, endDate, kelasLine, rows: aggRows, allDataNorm, kbmDays } = await collectRekapData();

	// === Range efektif (pakai Absensi jika toggle aktif) ===
  const { start: absS, end: absE, source: absSrc } =
    (typeof getAbsensiRangeOrDefault === 'function')
      ? getAbsensiRangeOrDefault()
      : { start: startDate, end: endDate, source: 'global' };

  const usingAbsensiRange = (absSrc === 'absensi');
  const effStart = usingAbsensiRange ? absS : startDate;
  const effEnd   = usingAbsensiRange ? absE : endDate;

  // === Data santri terpilih (filter dulu dari allDataNorm) ===
  let mine = (allDataNorm || []).filter(it =>
    String(it.nis || it.id || '') === key
  );

  if (usingAbsensiRange) {
    mine = mine.filter(it => {
      const t = String(it?.tanggal || '');
      return t >= effStart && t <= effEnd;
    });
  }

  if (!mine.length) {
    throw new Error('Tidak ada data untuk santri terpilih pada rentang tanggal.');
  }

  // === Keterangan terakhir (per-santri, dalam rentang efektif) ===
  const sortedMine = [...mine].sort((a, b) =>
    String(a?.tanggal || '').localeCompare(String(b?.tanggal || ''))
  );

  let keteranganLive = '-';
  for (const it of sortedMine) {
    const ket = (it?.keterangan ?? it?.note ?? it?.catatan ?? '').toString().trim();
    if (ket) keteranganLive = ket;
  }

    // --- dapatkan helper override UI (fallback ke no-op bila belum ada) ---
const _getSelectedSemester   = (window.getSelectedSemester   || (() => null));
const _getSelectedJenjang    = (window.getSelectedJenjang    || (() => null));
const _getSelectedKeterangan = (window.getSelectedKeterangan || (() => null));

// --- util kecil untuk cari data berdasarkan key (nis||id) ---
const _byKey = (arr) => (arr || []).find(it => String(it?.nis || it?.id || '') === key) || null;
const _byKeyAgg = (arr) => (arr || []).find(r => (r?.nis && String(r.nis) === key) || (!r?.nis && String(r?.id || '') === key)) || null;

// --- ambil kandidat dari sumber yang paling reliabel ---
const mineOne   = _byKey(mine);        // dari raw harian yang sudah dinormalisasi
const aggOne    = _byKeyAgg(aggRows);  // dari agregat

// --- Nama: prioritas selectedNama -> raw -> agregat -> '-' ---
const namaSantri =
  selectedNama ||
  (mineOne?.nama && String(mineOne.nama).trim()) ||
  (aggOne?.nama && String(aggOne.nama).trim()) ||
  '-';

// --- Semester: coba raw -> agregat; nanti bisa di-override UI ---
let semesterSantri =
  (mineOne?.semester != null ? Number(mineOne.semester) : null) ??
  (aggOne?.semester != null ? Number(aggOne.semester) : null) ??
  null;

// --- Jenjang: coba agregat -> raw; nanti bisa di-override UI ---
let jenjangSantri =
  (aggOne?.jenjang ?? null) ??
  (mineOne?.jenjang ?? null) ??
  '';

// --- Keterangan (SP): coba agregat -> raw; nanti bisa di-override UI ---
let keteranganSantri =
  (aggOne?.keterangan ?? null) ??
  (mineOne?.keterangan ?? null) ??
  '';

// --- Override dari UI bila ada pilihan --- 
const semSel = _getSelectedSemester();
const jenSel = _getSelectedJenjang();
const ketSel = _getSelectedKeterangan();

if (semSel != null && Number.isFinite(Number(semSel))) {
  semesterSantri = Number(semSel);
}
if (jenSel != null && String(jenSel).trim() !== '') {
  jenjangSantri = String(jenSel).trim();
}
if (ketSel != null && String(ketSel).trim() !== '') {
  keteranganSantri = String(ketSel).trim();
}

// --- Label jenjang untuk tampilan ---
const jenjangSantriLabel = jenjangLabel(jenjangSantri || '');

    // ==== Kelompokkan per tanggal (slot-based) ====
    const byDate = new Map();
    for (const it of mine) {
      const tgl = it.tanggal || '-';
      if (!byDate.has(tgl)) {
  byDate.set(tgl, {
    tanggal: tgl,
    cnt: { hadir:0, alpha:0, sakit:0, izin:0, lainnya:0 },
    sa: [], pages: [], juz: [],
    totalPage: 0, totalJuz: 0,
    murJuz: 0,
    nilaiSum: 0, nilaiCount: 0,
    // --- [FIX-2] inisialisasi slot harian ---
    targetSlots: 0,
    checkedSlots: 0
    // --- [END FIX-2] ---
  });
}
      const d = byDate.get(tgl);

      // --- ABSENSI SLOT ---
      const sc = it?._slotCounts;
      if (sc) {
        d.cnt.hadir += Number(sc.hadir||0);
        d.cnt.izin  += Number(sc.izin ||0);
        d.cnt.sakit += Number(sc.sakit||0);
        d.cnt.alpha += Number(sc.alpha||0);
        d.targetSlots  += Number(it?._slotTarget||0);
        d.checkedSlots += Number(it?._slotChecked||0);
      } else {
        // fallback lama
        const st = PDF_normStatus(it?.absensi ?? it?.status);
        if (d.cnt[st] != null) d.cnt[st]++; else d.cnt.lainnya++;
        d.targetSlots += 1;
        if (st!=='lainnya') d.checkedSlots += 1;
      }

      // --- Setoran, halaman, juz, nilai ---
      const dari = PDF_parseSA(it?.dari || it?.dariSetoran);
      const smp  = PDF_parseSA(it?.sampai || it?.sampaiSetoran);
      if (dari && smp) d.sa.push((PDF_compareSA(dari, smp) <= 0) ? {from:dari, to:smp} : {from:smp, to:dari});

      const rng = PDF_parseRange(it?.halaman || it?.page);
      const tp  = PDF_num2(it?.totalHalaman ?? it?.totalPage);
      if (tp!=null) d.totalPage += tp; else if (rng) d.totalPage += Math.max(0, rng[1]-rng[0]+1);
      if (rng) { let [a,b] = rng; if (a>b) [a,b]=[b,a]; d.pages.push([a,b]); }

      const vJ = PDF_num2(it?.totalJuz ?? it?.juz);
      if (vJ!=null) d.totalJuz += vJ;
	  const vM = PDF_num2(it?.juzmurajaah ?? it?.murajaah ?? it?.mur_juz);
	  if (vM != null) d.murJuz += vM;


      const jtSet = PDF_parseJuzTerbacaField(it?.juzTerbaca ?? it?.juz_terbaca ?? it?.juzTerbacaText ?? it?.juzText ?? it?.juzs ?? null);
      if (jtSet.size) {
        const arr = Array.from(jtSet).sort((a,b)=>a-b);
        let start = arr[0], prev = arr[0];
        for (let i=1; i<=arr.length; i++){
          const curr = arr[i];
          if (curr === prev + 1) { prev = curr; continue; }
          d.juz.push([start, prev]);
        }
      }

      const vN = PDF_num2(it?.buttonCell?.nilai ?? it?.nilai ?? it?.score);
      if (vN!=null) { d.nilaiSum += vN; d.nilaiCount++; }
    }

    let dayRows = [...byDate.values()].sort((a,b)=> (a.tanggal||'').localeCompare(b.tanggal||''));
	// Buang hari yang benar-benar kosong: tidak ada slot cek, setoran, murajaah, halaman, atau nilai
	dayRows = dayRows.filter(d =>
	Number(d.checkedSlots||0) > 0 ||
	Number(d.totalJuz||0) > 0 ||
	Number(d.murJuz||0) > 0 ||
	Number(d.totalPage||0) > 0 ||
	Number(d.nilaiCount||0) > 0
	);

    // ==== Rekap total slot (pakai dari agregat jika ada) ====
    const agg = aggRows.find(r => r.nis === key || (!r.nis && r.id === key));

    const totH = (agg?.hadirSlots != null) ? agg.hadirSlots : dayRows.reduce((s,d)=>s+d.cnt.hadir,0);
    const totA = (agg?.alphaSlots != null) ? agg.alphaSlots : dayRows.reduce((s,d)=>s+d.cnt.alpha,0);
    const totS = (agg?.sakitSlots != null) ? agg.sakitSlots : dayRows.reduce((s,d)=>s+d.cnt.sakit,0);
    const totI = (agg?.izinSlots  != null) ? agg.izinSlots  : dayRows.reduce((s,d)=>s+d.cnt.izin,0);

    const totalTargetSlots = (agg?.targetSlots != null)
      ? agg.targetSlots
      : dayRows.reduce((s,d)=>s + Number(d.targetSlots||0), 0);

    const totPages = Math.round(agg?.totalPageSum ?? dayRows.reduce((s,d)=>s+d.totalPage,0));
    const totJuz   = +(agg?.totalJuz ?? dayRows.reduce((s,d)=>s+d.totalJuz,0)).toFixed(2);

	const murCountTotal = dayRows.reduce((s,d)=> s + ((d.murJuz||0) > 0 ? 1 : 0), 0);
	const murJuzTotal   = +( (agg?.murTotalJuz ?? dayRows.reduce((s,d)=> s + (d.murJuz||0), 0)).toFixed(2) );

    const totalNilaiCount = (agg?.nilaiCount != null)
	? agg.nilaiCount
	: dayRows.reduce((s,d)=> s + (d.nilaiCount||0), 0);
	const hasNilaiTotal = totalNilaiCount > 0;
	const nilaiAvg = hasNilaiTotal
	? ((agg?.nilaiCount != null && agg.nilaiCount > 0)
	? (agg.nilaiSum / agg.nilaiCount)
	: (dayRows.reduce((s,d)=> s + (d.nilaiSum||0), 0) / totalNilaiCount))
	: null;
    const statusJuzTotal = PDF_totalAllJuzStatus(totJuz, agg?.semester ?? semesterSantri);

	// total hari hadir santri (‚â•1 slot hadir dalam 1 hari)
const hadirDaysSantri = dayRows.reduce(
  (s,d) => s + (Number(d.cnt?.hadir || 0) > 0 ? 1 : 0), 0
);

    // Persentase kehadiran total (berdasar HARI KBM)
const denomDaysTotal = Number(kbmDays || 0);
const hadirPctTotal  = denomDaysTotal > 0
  ? Math.round(100 * hadirDaysSantri / denomDaysTotal)
  : (
      (totH + totI + totS + totA) > 0
      ? Math.round(100 * totH / (totH + totI + totS + totA))
      : (totalTargetSlots > 0 ? Math.round(100 * totH / totalTargetSlots) : 0)
    );

    // ==== Baris harian (slot-based) ====
    const tableRows = dayRows.map((d, idx) => {
      const targetSlots = Number(d.targetSlots || 0);
	  const denomDay = d.cnt.hadir + d.cnt.izin + d.cnt.sakit + d.cnt.alpha;
  	  const hadirPct = (targetSlots > 0)
  	  ? Math.round(100 * d.cnt.hadir / targetSlots)
  	  : (denomDay > 0 ? Math.round(100 * d.cnt.hadir / denomDay) : 0);

      const hasNilaiHarian = d.nilaiCount > 0;
		const nilaiHarian = hasNilaiHarian ? (d.nilaiSum/d.nilaiCount) : null;
		const predHurufHarian = hasNilaiHarian
		? PDF_predikatFromScore(nilaiHarian).huruf
		: '-';
      const statusJuzHarian = PDF_totalAllJuzStatus(d.totalJuz, semesterSantri);

      return {
        tanggal: d.tanggal,
        no: String(idx+1),
        nis: key,
        nama: namaSantri,
        sem: semesterDisplayForKey(key, semesterSantri ?? (agg?.semester ?? '-')),
        jenjang: jenjangSantriLabel,
        ket: keteranganDisplayForKey(key, keteranganLive),
        h: d.cnt.hadir, a: d.cnt.alpha, s: d.cnt.sakit, i: d.cnt.izin,
        hadirPct: `${hadirPct}%`,
        setoran: PDF_joinSAsegmentsNamaMerged(d.sa),
        juz: PDF_joinRangeSegmentsCompact(d.juz, true),
        totJuz: d.totalJuz ? d.totalJuz.toFixed(2) : '0.00',
		murRange: fmtMurRange(d.murJuz || 0, (d.murJuz||0) > 0 ? 1 : 0),
        persen: statusJuzHarian.label,
        nilai: hasNilaiHarian ? nilaiHarian.toFixed(1) : '-',
		pred: predHurufHarian
      };
    });

	 function _mergeSAfromDayRows(dayRows){
  const list = [];
  dayRows.forEach(d => (d.sa||[]).forEach(seg => seg?.from && seg?.to && list.push(seg)));
  return PDF_joinSAsegmentsNamaMerged(list); // sudah ada di file
}
function _mergeJuzFromDayRows(dayRows){
  const list = [];
  dayRows.forEach(d => (d.juz||[]).forEach(seg => Array.isArray(seg) && seg.length>=2 && list.push(seg)));
  return PDF_joinRangeSegmentsCompact(list, true); // sudah ada di file
}

    // ==== Baris REKAP (slot-based) ====
    const predHurufTotal = hasNilaiTotal
	? PDF_predikatFromScore(nilaiAvg).huruf
	: '-';
    const setoranTotal = (usingAbsensiRange || !agg)
  ? _mergeSAfromDayRows(dayRows)
  : PDF_joinSAsegmentsNamaMerged(agg.saSegments);

const juzTotalTxt  = (usingAbsensiRange || !agg)
  ? _mergeJuzFromDayRows(dayRows)
  : PDF_joinRangeSegmentsCompact(agg.juzSegments, true);

    tableRows.push({
      _isRekap: true,
      no: '',
      nis: key,
      nama: 'REKAP',
      sem: semesterDisplayForKey(key, semesterSantri ?? (agg?.semester ?? '-')),
      jenjang: jenjangSantriLabel,
      ket: keteranganDisplayForKey(key, keteranganLive),
      h: totH, a: totA, s: totS, i: totI,
      hadirPct: `${hadirPctTotal}%`,
      setoran: setoranTotal,
      juz: juzTotalTxt,
      totJuz: totJuz.toFixed(2),
	  murRange: fmtMurRange(murJuzTotal, murCountTotal),
      persen: statusJuzTotal.label,
      nilai: hasNilaiTotal ? nilaiAvg.toFixed(1) : '-',
	  pred: predHurufTotal
    });

    // === PDF render ===
    const { jsPDF } = window.jspdf || {};
    if (!jsPDF) { alert('jsPDF belum dimuat. Tambahkan <script> jsPDF.'); return; }
    const doc = new jsPDF({ orientation: 'l', unit: 'mm', format: 'a3' });

    const theme = {
      cardBorder: [229,231,235],
      headerText: [15,23,42],
      tableHeadFill: [30,136,229],
      zebraFill: [248,250,252],
      border: [229,231,235],
      text: [31,41,55],
      statusFill: { tuntas: [220,252,231], khatam: [237,233,254] },
      rekapFill: [255, 249, 196]
    };

    const pageW  = doc.internal.pageSize.getWidth();
    const pageH  = doc.internal.pageSize.getHeight();
    const margin = { left: 12, right: 12, top: 12, bottom: 12 };
    const headerGap = 30, fontBody = 8.5, fontHead = fontBody + 1;
    const lineFactor = 1.18, baseLH = fontBody * 0.3528 * lineFactor;
    const fontBodySmall = Math.max(6.5, fontBody - 0.8);
    const cellPadX = 1.6, cellPadY = 1.2;
    const headerRowH = Math.max(9, fontHead * 0.3528 * lineFactor + 2*cellPadY);

    function drawHeaderBarS(){
      doc.setDrawColor(...theme.cardBorder);
      doc.roundedRect(margin.left-3, margin.top-6, pageW - margin.left - margin.right + 6, 22, 3, 3);
      doc.setTextColor(...theme.headerText);
      doc.setFont('helvetica','bold'); doc.setFontSize(14);
      doc.text('Rincian Per Santri ‚Äî Absensi & Setoran', margin.left, margin.top);
      doc.setFont('helvetica','normal'); doc.setFontSize(10);
      doc.text(kelasLine, margin.left, margin.top + 6);
      doc.text(`Santri: ${key} ‚Äî ${namaSantri}`, margin.left, margin.top + 12);
      const rightX = pageW - margin.right - 78;
      doc.text(`Semester: ${semesterDisplayForKey(key, tableRows.find(r=>!r._isRekap)?.sem ?? '-')}`, rightX, margin.top + 6);
      doc.text(`Periode Tahfiz: ${fmtD_M_YYYY(effStart)} s.d. ${fmtD_M_YYYY(effEnd)}`, rightX, margin.top + 12);
      doc.setTextColor(...theme.text);
    }
    function drawFooterS(pageNo, totalPages, printedAt){
      const y = pageH - 6;
      doc.setDrawColor(...theme.border); doc.setLineWidth(0.2);
      doc.line(margin.left-2, y-3, pageW-margin.right+2, y-3);
      doc.setFontSize(8);
      doc.text(`Dicetak: ${printedAt}`, margin.left, y);
      doc.text(`Halaman ${pageNo} / ${totalPages}`, pageW - margin.right - 30, y);
    }

    const cols = [
      { key:'no',       title:'No.',  w:11, minW:11, maxW:12, align:'center' },
      { key:'nis',      title:'NIS',  w:26, minW:20, maxW:36, align:'left'   },
      { key:'nama',     title:'Nama', w:46, minW:36, maxW:80, align:'left'   },
      { key:'sem',      title:'SM',   w:12, minW:12, maxW:12, align:'center' },
      { key:'jenjang',  title:'KLS',  w:14, minW:14, maxW:14, align:'center' },
      { key:'h',        title:'H',    w:8,  minW:6,  maxW:10, align:'center' },
      { key:'a',        title:'A',    w:8,  minW:6,  maxW:10, align:'center' },
      { key:'s',        title:'S',    w:8,  minW:6,  maxW:10, align:'center' },
      { key:'i',        title:'I',    w:8,  minW:6,  maxW:10, align:'center' },
      { key:'hadirPct', title:'Hadir %', w:16, minW:16, maxW:18, align:'center' },
      { key:'ket',      title:'SP',   w:12, minW:12, maxW:12, align:'center' },
      { key:'setoran',  title:'Setoran',  w:48, minW:32, maxW:120, align:'left'  },
      { key:'juz',      title:'Juz',      w:18, minW:18, maxW:18, align:'left'   },
      { key:'totJuz',   title:'Total Juz',    w:14, minW:14, maxW:22, align:'right'  },
	  { key:'murRange',  title:'Murajaah', w:20, minW:18, maxW:26, align:'right' },
      { key:'persen',   title:'THMS',     w:17, minW:17, maxW:18, align:'center' },
      { key:'nilai',    title:'Nilai',    w:14, minW:14, maxW:20, align:'right'  },
      { key:'pred',     title:'Predikat', w:18, minW:18, maxW:18, align:'center' },
    ];
    const contentW = pageW - margin.left - margin.right;
    fitColumnsFlex(doc, cols, tableRows, fontBody, contentW, cellPadX);

    // header & body
    drawHeaderBarS();
    let x0 = margin.left;
    let y  = margin.top + 30;

    drawTableHeader(doc, cols, x0, y, headerRowH, fontHead, theme, cellPadX);
    y += headerRowH;

    let rowIndex = 0;
    doc.setLineWidth(0.2);

    for (const row of tableRows) {
      const wraps = cols.map(col => doc.splitTextToSize(String(row[col.key] ?? ''), Math.max(1, col.w - 2*cellPadX)));

      // kolom NIS menampilkan NIS + tanggal (baris kecil)
      const nisIdx = cols.findIndex(c => c.key === 'nis');
      if (nisIdx >= 0) {
        const lines = [String(row.nis || '-')];
        if (row.tanggal && !row._isRekap) lines.push(fmtD_M_YYYY(row.tanggal));
        wraps[nisIdx] = lines;
      }

      const lineHSmall = fontBodySmall * 0.3528 * 1.18;
      const rowTextHeights = wraps.map((lines, i) => {
        if (cols[i].key === 'nis' && lines.length === 2) {
          return baseLH + lineHSmall;
        }
        return lines.length * baseLH;
      });
      const rowH = Math.max(baseLH + 2*cellPadY, Math.max(...rowTextHeights) + 2*cellPadY);

      // page break
      if (y + rowH > pageH - margin.bottom) {
        doc.addPage('a3', 'landscape');
        drawHeaderBarS();
        y = margin.top + 30;
        drawTableHeader(doc, cols, x0, y, headerRowH, fontHead, theme, cellPadX);
        y += headerRowH;
        rowIndex = 0;
      }

      // zebra + highlight rekap
      if (row._isRekap) {
        doc.setFillColor(...theme.rekapFill);
        doc.rect(x0, y, sumWidth(cols), rowH, 'F');
      } else if (rowIndex % 2 === 1) {
        doc.setFillColor(...theme.zebraFill);
        doc.rect(x0, y, sumWidth(cols), rowH, 'F');
      }

      // cells
      let x = x0;
      doc.setFont('helvetica','normal');
      doc.setFontSize(fontBody);
      doc.setTextColor(...theme.text);
      doc.setDrawColor(...theme.border);

      for (let ci=0; ci<cols.length; ci++){
        const col = cols[ci];
        const lines = wraps[ci];

        // highlight THMS
        if (!row._isRekap && col.key === 'persen') {
          const val = String(row[col.key] || '').toUpperCase();
          if (val === 'TUNTAS' || val === 'KHATAM') {
            const fill = (val === 'TUNTAS') ? theme.statusFill.tuntas : theme.statusFill.khatam;
            doc.setFillColor(...fill);
            doc.rect(x, y, col.w, rowH, 'F');
          }
        }

        // SP coloring
        let spTextColor = null;
        if (col.key === 'ket') {
          spTextColor = PDF_spPaintCell(doc, x, y, col.w, rowH, row.ket);
          if (spTextColor) doc.setTextColor(...spTextColor);
        }

        // text
        let yy = y + (rowH - (lines.length * baseLH))/2 + baseLH*0.82;
        let tx, opt = {};
        if (col.align === 'right') { tx = x + col.w - cellPadX; opt = { align:'right' }; }
        else if (col.align === 'center') { tx = x + col.w/2; opt = { align:'center' }; }
        else { tx = x + cellPadX; }
        for (let li=0; li<lines.length; li++){
          doc.text(String(lines[li]), tx, yy, opt);
          yy += baseLH;
        }

        doc.rect(x, y, col.w, rowH);
        if (spTextColor) doc.setTextColor(...theme.text);
        x += col.w;
      }

      y += rowH;
      rowIndex++;
    }

    // Tanda tangan + footer
    function fmtDDMMYYYY(iso){
      const m = String(iso||'').match(/^(\d{4})-(\d{2})-(\d{2})$/);
      return m ? `${m[3]}-${m[2]}-${m[1]}` : iso;
    }
    const printedAt = new Date();
    const printedISO = printedAt.toISOString().slice(0,10);
    const ttdDate = fmtDDMMYYYY(effEnd) || fmtDDMMYYYY(printedISO) || printedAt.toLocaleDateString('id-ID');

    const spaceTop = 10, neededH = 36;
    if (y + spaceTop + neededH > pageH - margin.bottom){
      doc.addPage('a3', 'landscape');
      drawHeaderBarS();
      y = margin.top + 30;
    }
    y += spaceTop;

    const totalW = sumWidth(cols);
    const colGap = 8;
    const colW   = (totalW - colGap) / 2;
    const leftX  = margin.left;
    const rightX = margin.left + colW + colGap;

    doc.setFont('helvetica','normal'); doc.setFontSize(11);
    doc.text(`Kota Bima, ${ttdDate}`, margin.left + totalW, y, { align:'right' });

    const headY = y + 8;
    doc.text('Mengetahui,', leftX, headY);
    doc.text('Pengampu Halaqoh,', rightX, headY);

    const lineY = headY + 24;
    doc.setDrawColor(...theme.border);
    doc.line(leftX,  lineY, leftX  + colW - 10, lineY);
    doc.line(rightX, lineY, rightX + colW - 10, lineY);

    const totalPages = doc.internal.getNumberOfPages();
    for (let p = 1; p <= totalPages; p++) { doc.setPage(p); drawFooterS(p, totalPages, printedAt.toLocaleString()); }

    const fileName = `Rekap_perSantri_${key}_${effStart}_sd_${effEnd}.pdf`;
    doc.save(fileName);

    const santriModal = document.getElementById('santriModalOverlay');
    if (santriModal) santriModal.style.display = 'none';

  } catch (err) {
    console.error(err);
    alert('Gagal mengunduh PDF per santri: ' + (err.message || err));
    throw err;
  } finally {
    const triggerBtn = document.getElementById('okSantriSelect') || pdfSantriBtn;
    setBtnLoading(triggerBtn, false);
  }
}
window._pdfSantriDownload = pdfSantriDownload;
// ============================
// B. DOWNLOAD PDF
// ============================	







// ============================
// hitungTotalAllJuzFromTable (REVISI TENANG: tanpa warning, FIX %)
// ============================

// --- util kecil ---
const normKey = (v) => String(v ?? "").trim();

const parseNum = (v) => {
  if (typeof v === "number") return Number.isFinite(v) ? v : 0;
  let s = String(v ?? "").trim();
  if (!s) return 0;
  s = s.replace(/[^0-9.,-]/g, "");
  const comma = s.lastIndexOf(","), dot = s.lastIndexOf(".");
  if (comma > -1 && dot > -1) { if (comma > dot) { s = s.replace(/\./g, "").replace(",", "."); } else { s = s.replace(/,/g, ""); } }
  else if (comma > -1) { s = s.replace(/\./g, "").replace(",", "."); }
  else { s = s.replace(/,/g, ""); }
  const n = parseFloat(s);
  return Number.isFinite(n) ? n : 0;
};

function parseSemester(v, def = 1) {
  if (v == null) return def;
  if (typeof v === 'number') { const n = Math.round(v); return (n>=1 && n<=6) ? n : def; }
  const m = String(v).trim().match(/([1-6])/);
  return m ? Number(m[1]) : def;
}

function readTotalJuz(rec){
  return parseNum((rec && (rec.totalJuz ?? rec.tilawahTotalJuz ?? rec.juzTotal ?? rec.total ?? 0)) || 0);
}

function getNamaFromCell(cell) {
  if (!cell) return "";
  const first = cell.childNodes && cell.childNodes[0];
  const txt = (first && first.textContent) ? first.textContent : cell.textContent;
  return String(txt).trim();
}

function getTotalJuzFromRow(row) {
  const td = row?.querySelector?.(".total-juz");
  return td ? parseNum(td.textContent) : 0;
}

function getRowKey(row){
  return normKey(row?.dataset?.key || row?.dataset?.nis || row?.dataset?.id);
}

// ============================
// SEMESTER MAP (cache per-kelas, byKey & byName)
// ============================
window.__semCacheByClass ||= {};    // { [kelas]: { byKey:{}, byName:{} } }
window.semesterMap       ||= {};    // alias aktif utk kelas sekarang (byKey)
window.semesterNameMap   ||= {};    // alias aktif utk kelas sekarang (byName)

async function ensureSemesterMap(kelas) {
  if (window.__semCacheByClass[kelas]) {
    window.semesterMap     = window.__semCacheByClass[kelas].byKey;
    window.semesterNameMap = window.__semCacheByClass[kelas].byName;
    return;
  }
  try {
    const res = await fetch(`/api/getSantri?kelas=${encodeURIComponent(kelas)}&t=${Date.now()}`);
    const santri = await res.json();
    const byKey  = {};
    const byName = {};
    (santri || []).forEach(s => {
      const sem = parseSemester(s?.semester, 1);
      const nis = normKey(s?.nis);
      const id  = normKey(s?.id);
      const nm  = normKey(s?.nama).toLowerCase();
      if (nis) byKey[nis] = sem;
      if (id)  byKey[id]  = sem;
      if (nm)  byName[nm] = sem;
    });
    window.__semCacheByClass[kelas] = { byKey, byName };
    window.semesterMap     = byKey;
    window.semesterNameMap = byName;
  } catch {
    window.__semCacheByClass[kelas] = { byKey:{}, byName:{} };
    window.semesterMap     = {};
    window.semesterNameMap = {};
  }
}

function getSemesterForKey(key, row, fallbackFromArchive) {
  // 1) map byKey (nis/id)
  if (window.semesterMap && window.semesterMap[key] != null) {
    return parseSemester(window.semesterMap[key], 1);
  }
  // 2) dataset.semester
  const ds = row?.dataset || {};
  if (ds.semester != null && ds.semester !== '') return parseSemester(ds.semester, 1);
  // 3) select/teks .semester
  const sel = row?.querySelector?.('.semester');
  if (sel) {
    const v = (sel.value ?? '').toString().trim(); if (v) return parseSemester(v, 1);
    const t = (sel.textContent ?? '').toString().trim(); if (t) return parseSemester(t, 1);
  }
  // 4) nama ‚Üí map byName
  const nama = (row?.children?.[1]?.textContent ?? '').toString().trim().toLowerCase();
  if (nama && window.semesterNameMap && window.semesterNameMap[nama] != null) {
    return parseSemester(window.semesterNameMap[nama], 1);
  }
  // 5) arsip
  if (fallbackFromArchive != null && fallbackFromArchive !== '') return parseSemester(fallbackFromArchive, 1);
  // 6) default
  return 1;
}

// ============================
// HITUNG MANUAL (via overlay)
// ============================
async function hitungTotalAllJuzFromTable() {
  const kelas  = kelasSelect.value;
  const dari   = document.getElementById("rangeDari")?.value;
  const sampai = document.getElementById("rangeSampai")?.value;
  if (!dari)   { alert("Mohon pilih tanggal Dari.");   return; }
  if (!sampai) { alert("Mohon pilih tanggal Sampai."); return; }

  overlay.style.display = "flex";
  try {
    await ensureSemesterMap(kelas);

    const res = await fetch(
      `/api/getAbsensiRange?kelas=${encodeURIComponent(kelas)}&start=${encodeURIComponent(dari)}&end=${encodeURIComponent(sampai)}&t=${Date.now()}`
    );
    if (!res.ok) throw new Error("Gagal ambil data absensi.");
    const payload = await res.json();
    const allData = Array.isArray(payload) ? payload : (payload?.list || []);

    const rows = [...santriTableBody.querySelectorAll("tr")];

    // nama ‚Üí key baris
    const nameToKey = new Map();
    rows.forEach(row => {
      const key = getRowKey(row);
      const nm  = getNamaFromCell(row.children?.[1]);
      if (key && nm) nameToKey.set(nm.toLowerCase(), key);
    });

    // rekap berdasarkan key
    const rekap = Object.create(null);
    (allData || []).forEach(item => {
      let id  = normKey(item?.id);
      let nis = normKey(item?.nis);
      let key = normKey(nis || id);
      if (!key) {
        const nm = normKey(item?.nama).toLowerCase();
        if (nm && nameToKey.has(nm)) key = nameToKey.get(nm);
      }
      if (!key) return;
      if (!rekap[key]) rekap[key] = { totalJuz: 0, semester: item?.semester ?? null, id, nis, nama: item?.nama ?? "" };
      rekap[key].totalJuz += readTotalJuz(item);
    });

    const batasSemester = {1: 1, 2: 1, 3: 2, 4: 2, 5: 3, 6: 3, 7: 4, 8: 4, 9: 5, 10: 5, 11: 6, 12: 6};
    const defaultTarget = 30;

    const dataToSave = [];
    rows.forEach(row => {
      const key  = getRowKey(row);
      const cell = row.querySelector(".total-all-juz");
      if (!cell) return;

      let totalJuzNum = rekap[key] ? parseNum(rekap[key].totalJuz) : 0;
      let archSem = rekap[key]?.semester ?? null;

      if (!totalJuzNum) {
        const fallbackRowVal = getTotalJuzFromRow(row);
        if (fallbackRowVal) totalJuzNum = fallbackRowVal;
      }

      if (totalJuzNum) {
        const semester = getSemesterForKey(key, row, archSem);
        const batas    = (batasSemester[semester] ?? defaultTarget);
        const totalJuzStr = totalJuzNum.toFixed(2);

        let label, warna;
        if (totalJuzNum >= 30) { label = "KHATAM"; warna = "green"; }
        else {
          let prosentase = Math.floor((totalJuzNum / batas) * 100);
          if (prosentase > 100) prosentase = 100;
          if (prosentase >= 100) { label = "TUNTAS"; warna = "green"; }
          else { label = `${prosentase}%`; warna = "red"; }
        }

        cell.innerHTML = `${totalJuzStr}&nbsp;juz <span style="color:${warna}; font-size:12px;">${label}</span>`;

        dataToSave.push({
          key,
          id: rekap[key]?.id || "",
          nis: rekap[key]?.nis || "",
          totalJuz: Number(totalJuzStr),
          semester: semester || null,
          isKhatam: totalJuzNum >= 30
        });
      } else {
        cell.innerHTML = `0.00&nbsp;juz <span style="color:red; font-size:10px">0%</span>`;
      }
    });

    const saveRes = await fetch('/api/aksesAutoUpdateAllJuz', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ fromDate: dari, toDate: sampai, kelas, data: dataToSave }),
    });
    if (!saveRes.ok) throw new Error(await saveRes.text().catch(()=>"(no body)"));

    alert("üü¢ Total All Juz berhasil dihitung dan disimpan.");
  } catch (err) {
    console.error(err);
    alert("‚ùå Terjadi kesalahan: " + err.message);
  } finally {
    overlay.style.display = "none";
  }
}

// ============================
// Buka overlay (range helper)
// ============================
function bukaOverlayTotalAllJuz() {
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, "0");
  const dd = String(today.getDate()).padStart(2, "0");
  const todayStr = `${yyyy}-${mm}-${dd}`;

  const rangeDari = document.getElementById("rangeDari");
  const rangeSampai = document.getElementById("rangeSampai");

  if (rangeDari) {
    rangeDari.max = todayStr;
    if (!rangeDari.value || rangeDari.value > todayStr) rangeDari.value = todayStr;
  }
  if (rangeSampai) {
    rangeSampai.removeAttribute("max");
    rangeSampai.disabled = false;
    if (!rangeSampai.value) rangeSampai.value = todayStr;
  }

  document.getElementById("juzOverlay").style.display = "flex";
}

document.getElementById("btnHitungTotalJuz")?.addEventListener("click", hitungTotalAllJuzFromTable);

// ============================
// HITUNG OTOMATIS (setelah render)
// ============================
async function hitungTotalAllJuzOtomatis() {
  const kelas = kelasSelect.value;

  const rows = santriTableBody.querySelectorAll("tr");
  if (rows.length === 0) { setTimeout(hitungTotalAllJuzOtomatis, 200); return; }

  const rangeDari = document.getElementById("rangeDari");
  const rangeSampai = document.getElementById("rangeSampai");
  try {
    const res = await fetch(`/api/getAutoUpdateAllJuz?t=${Date.now()}`);
    const allData = await res.json();
    const kelasData = (allData || []).find(item => item.kelas === kelas);
    if (kelasData) {
      if (rangeDari)   rangeDari.value   = kelasData.fromDate || "";
      if (rangeSampai) rangeSampai.value = kelasData.toDate   || "";
    }
  } catch {}

  const dari = rangeDari?.value;
  const sampai = rangeSampai?.value;
  if (!dari || !sampai) return;

  try {
    await ensureSemesterMap(kelas);

    const resAbs = await fetch(
      `/api/getAbsensiRange?kelas=${encodeURIComponent(kelas)}&start=${encodeURIComponent(dari)}&end=${encodeURIComponent(sampai)}&t=${Date.now()}`
    );
    if (!resAbs.ok) throw new Error("Gagal ambil data absensi.");
    const payload = await resAbs.json();
    const allData = Array.isArray(payload) ? payload : (payload?.list || []);

    const rowsArr = [...santriTableBody.querySelectorAll("tr")];
    const nameToKey = new Map();
    rowsArr.forEach(row => {
      const key = getRowKey(row);
      const nm  = getNamaFromCell(row.children?.[1]);
      if (key && nm) nameToKey.set(nm.toLowerCase(), key);
    });

    const rekap = Object.create(null);
    (allData || []).forEach(item => {
      let id  = normKey(item?.id);
      let nis = normKey(item?.nis);
      let key = normKey(nis || id);
      if (!key) {
        const nm = normKey(item?.nama).toLowerCase();
        if (nm && nameToKey.has(nm)) key = nameToKey.get(nm);
      }
      if (!key) return;
      if (!rekap[key]) rekap[key] = { totalJuz: 0, semester: item?.semester ?? null };
      rekap[key].totalJuz += readTotalJuz(item);
    });

    const batasSemester = {1: 1, 2: 1, 3: 2, 4: 2, 5: 3, 6: 3, 7: 4, 8: 4, 9: 5, 10: 5, 11: 6, 12: 6};
    const defaultTarget = 30;

    rowsArr.forEach(row => {
      const key  = getRowKey(row);
      const cell = row.querySelector(".total-all-juz");
      if (!cell) return;

      let totalJuzNum = rekap[key] ? parseNum(rekap[key].totalJuz) : 0;
      if (!totalJuzNum) totalJuzNum = getTotalJuzFromRow(row);

      if (totalJuzNum) {
        const semester = getSemesterForKey(key, row, rekap[key]?.semester);
        const target   = (batasSemester[semester] ?? defaultTarget);
        const totalJuzStr = totalJuzNum.toFixed(2);

        let label, warna;
        if (totalJuzNum >= 30) { label = "KHATAM";  warna = "purple"; }
        else {
          let prosentase = Math.floor((totalJuzNum / target) * 100);
          if (prosentase > 100) prosentase = 100;
          if (prosentase >= 100) { label = "TUNTAS"; warna = "green"; }
          else { label = `${prosentase}%`; warna = "red"; }
        }

        cell.innerHTML = `${totalJuzStr}&nbsp;juz <span style="color:${warna}; font-size:14px">${label}</span>`;
      } else {
        cell.innerHTML = `0.00&nbsp;juz <span style="color:red; font-size:16px">0%</span>`;
      }
    });
  } catch (err) {
    console.error("Gagal ambil data absensi:", err);
  }
}

// Jalankan saat pertama kali halaman selesai dimuat
window.addEventListener("DOMContentLoaded", hitungTotalAllJuzOtomatis);

// Pastikan otomatis jalan lagi setelah tabel diperbarui
function afterTableRendered() { setTimeout(hitungTotalAllJuzOtomatis, 50); }

// Integrasi ke loadSantriData atau fungsi render tabel (guard bila belum terdefinisi)
const originalLoadSantriData = window.loadSantriData;
window.loadSantriData = async function (...args) {
  if (typeof originalLoadSantriData === "function") {
    await originalLoadSantriData.apply(this, args);
  }
  afterTableRendered();
};

// Kalau ganti tanggal atau kelas, otomatis muat ulang tabel & hitung
tanggalInput?.addEventListener("change", () => loadSantriData());
kelasSelect?.addEventListener("change", () => loadSantriData());
</script>



<script>
// ============================
// D. MURAJAAH 3 SESI
// ============================	
// ---------- Murajaah (3 sesi, Juz Range + Nilai per sesi) ----------
(function(){
  const MAP_URL='https://raw.githubusercontent.com/dickymiswardi/tadabbur/main/ayah_page_map.json';
  const LAST_PAGE=604;
  const SKIP=(p)=> (p===21 || (p>=602 && p<=604));
  const $=(s,r=document)=>r.querySelector(s);
  const $$=(s,r=document)=>[...r.querySelectorAll(s)];
  const makeOpts=(n)=>Array.from({length:n},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join('');
  const parseNum=(v)=>{ if(typeof v==='number')return Number.isFinite(v)?v:0; const s=String(v??'').replace(/[^0-9.,-]/g,'').replace(',', '.'); const n=parseFloat(s); return Number.isFinite(n)?n:0; };

  // Predikat
  const PREDIKATS = [
    { max: 59,  text: 'ROSIB',         huruf: 'D'  },
    { max: 69,  text: 'MAQBUL',        huruf: 'C'  },
    { max: 79,  text: 'JAYYID',        huruf: 'B'  },
    { max: 89,  text: 'JAYYID JIDDAN', huruf: 'A'  },
    { max: 100, text:'MUMTAZ',         huruf: 'A+' },
  ];
  function getPredikat(score){
  const s = Math.max(0, Math.min(100, Number(score)||0));
  if (s === 0) return null;              // 0 = tidak ada predikat
  return PREDIKATS.find(p=>s<=p.max) || PREDIKATS[PREDIKATS.length-1];
}


 // --- META JUZ: surah/ayat & page (akurasi dari mapping kamu) ---
const JUZ_META = {
  1:{ sFrom:1,  aFrom:1,   sTo:2,  aTo:141, pFrom:1,   pTo:20  },
  2:{ sFrom:2,  aFrom:142, sTo:2,  aTo:252, pFrom:22,  pTo:41  },
  3:{ sFrom:2,  aFrom:253, sTo:3,  aTo:92,  pFrom:42,  pTo:62  },
  4:{ sFrom:3,  aFrom:93,  sTo:4,  aTo:23,  pFrom:62,  pTo:81  },
  5:{ sFrom:4,  aFrom:24,  sTo:4,  aTo:147, pFrom:82,  pTo:101 },
  6:{ sFrom:4,  aFrom:148, sTo:5,  aTo:81,  pFrom:102, pTo:121 },
  7:{ sFrom:5,  aFrom:82,  sTo:6,  aTo:110, pFrom:121, pTo:141 },
  8:{ sFrom:6,  aFrom:111, sTo:7,  aTo:87,  pFrom:142, pTo:161 },
  9:{ sFrom:7,  aFrom:88,  sTo:8,  aTo:40,  pFrom:162, pTo:181 },
 10:{ sFrom:8,  aFrom:41,  sTo:9,  aTo:92,  pFrom:182, pTo:201 },
 11:{ sFrom:9,  aFrom:93,  sTo:11, aTo:5,   pFrom:201, pTo:221 },
 12:{ sFrom:11, aFrom:6,   sTo:12, aTo:52,  pFrom:222, pTo:241 },
 13:{ sFrom:12, aFrom:53,  sTo:14, aTo:52,  pFrom:242, pTo:261 },
 14:{ sFrom:15, aFrom:1,   sTo:16, aTo:128, pFrom:262, pTo:281 },
 15:{ sFrom:17, aFrom:1,   sTo:18, aTo:74,  pFrom:282, pTo:301 },
 16:{ sFrom:18, aFrom:75,  sTo:20, aTo:135, pFrom:302, pTo:321 },
 17:{ sFrom:21, aFrom:1,   sTo:22, aTo:78,  pFrom:322, pTo:341 },
 18:{ sFrom:23, aFrom:1,   sTo:25, aTo:20,  pFrom:342, pTo:361 },
 19:{ sFrom:25, aFrom:21,  sTo:27, aTo:55,  pFrom:362, pTo:381 },
 20:{ sFrom:27, aFrom:56,  sTo:29, aTo:45,  pFrom:382, pTo:401 },
 21:{ sFrom:29, aFrom:46,  sTo:33, aTo:30,  pFrom:402, pTo:421 },
 22:{ sFrom:33, aFrom:31,  sTo:36, aTo:27,  pFrom:422, pTo:441 },
 23:{ sFrom:36, aFrom:28,  sTo:39, aTo:31,  pFrom:442, pTo:461 },
 24:{ sFrom:39, aFrom:32,  sTo:41, aTo:46,  pFrom:462, pTo:481 },
 25:{ sFrom:41, aFrom:47,  sTo:45, aTo:37,  pFrom:482, pTo:502 },
 26:{ sFrom:46, aFrom:1,   sTo:51, aTo:30,  pFrom:502, pTo:521 },
 27:{ sFrom:51, aFrom:31,  sTo:57, aTo:29,  pFrom:522, pTo:541 },
 28:{ sFrom:58, aFrom:1,   sTo:66, aTo:12,  pFrom:542, pTo:561 },
 29:{ sFrom:67, aFrom:1,   sTo:77, aTo:50,  pFrom:562, pTo:581 },
 30:{ sFrom:78, aFrom:1,   sTo:114,aTo:6,   pFrom:582, pTo:601 }, // UI tetap tulis 582‚Äì604
};

// Range Juz by number
function getJuzRange(j){
  j = +j;
  return (j>=1 && j<=30) ? { ...JUZ_META[j] } : null;
}

// Cari juz untuk (surah, ayat) berdasarkan META
function juzOfAyah(s,a){
  const gt = (x1,y1,x2,y2)=> (x1>x2) || (x1===x2 && y1>y2);
  const ge = (x1,y1,x2,y2)=> (x1>x2) || (x1===x2 && y1>=y2);
  for (let j=1;j<=30;j++){
    const m = JUZ_META[j];
    if (ge(s,a,m.sFrom,m.aFrom) && !gt(s,a,m.sTo,m.aTo)) return j;
  }
  return 30;
}

  // ---------- Data Mushaf ----------
  let ayahPageMap={}, pageAyahCount={}, surahMaxAyah={}, dataReady=false, currentRowEl=null;

  async function ensureMap(){
    if (dataReady) return;
    try{
      const res=await fetch(MAP_URL);
      ayahPageMap=await res.json();
    }catch(e){
      console.error('Gagal memuat MAP_URL', e);
      ayahPageMap={};
    }
    pageAyahCount={}; surahMaxAyah={};
    for (const [key,page] of Object.entries(ayahPageMap)){
      if(!page) continue;
      pageAyahCount[page]=(pageAyahCount[page]||0)+1;
      const [sStr,aStr]=key.split(':'); const s=+sStr,a=+aStr;
      if(s&&a && (!surahMaxAyah[s]||a>surahMaxAyah[s])) surahMaxAyah[s]=a;
    }
    for(let s=1;s<=114;s++) if(!surahMaxAyah[s]) surahMaxAyah[s]=(s===1?7:(s===9?129:286));
    dataReady=true;
    window.dataReady = true;
  }

  // ====== WIPE TOKEN (tombstone) ======
  const LS_WIPE = 'murWipe:v1';
  function _wipeDB(){ try{ return JSON.parse(localStorage.getItem(LS_WIPE)||'{}'); }catch{ return {}; } }
  function _wipeDBSet(x){ try{ localStorage.setItem(LS_WIPE, JSON.stringify(x)); }catch{} }
  function _kelasNow(){
    return String(
      window.kelasSelect?.value ||
      $('#kelasSelect')?.value || $('#kelas')?.value ||
      document.querySelector('select[name="kelas"]')?.value ||
      $('#santri-table')?.dataset?.kelas ||
      document.body?.dataset?.kelas || ''
    ).trim();
  }
  function _tanggalOfRow(tr){
    const byRow = String(tr?.dataset?.tanggal||'').trim();
    if (byRow) return byRow;
    return String(
      window.tanggalInput?.value ||
      $('#tanggalInput')?.value || $('#tanggal')?.value || $('#date')?.value ||
      document.querySelector('input[name="tanggal"]')?.value ||
      document.querySelector('input[name="date"]')?.value || ''
    ).trim();
  }
  function _rowKey(tr){
    const nis = String(tr?.dataset?.nis||'').trim();
    const id  = String(tr?.children?.[0]?.textContent||'').trim();
    const name = (tr?.children?.[1]?.childNodes?.[0]?.textContent || tr?.children?.[1]?.textContent || '').trim().toLowerCase();
    return nis || id || name || 'unknown';
  }
  function _wipeKey(tr, idx){ return `${_kelasNow()}|${_tanggalOfRow(tr)}|${_rowKey(tr)}|${idx}`; }
  function wipeHas(tr, idx){ const db=_wipeDB(); return !!db[_wipeKey(tr,idx)]; }
  function wipeAdd(tr, idx){ const db=_wipeDB(); db[_wipeKey(tr,idx)]=1; _wipeDBSet(db); }
  function wipeClear(tr, idx){ const db=_wipeDB(); const k=_wipeKey(tr,idx); if (k in db){ delete db[k]; _wipeDBSet(db); } }

  function computeTotalJuz(sF,aF,sT,aT){
    let tot=0;
    for(let s=+sF;s<=+sT;s++){
      const startA=(s===+sF)?+aF:1, endA=(s===+sT)?+aT:surahMaxAyah[s];
      for(let a=startA;a<=endA;a++){
        const p=ayahPageMap[`${s}:${a}`]; if(!p||SKIP(p)) continue;
        const per=pageAyahCount[p]||1; tot+=0.05/per;
      }
    }
    return tot;
  }
  function ayahRangeToPages(sF,aF,sT,aT){
    let minP=Infinity,maxP=-Infinity,hit=false;
    for(let s=+sF;s<=+sT;s++){
      const aStart=(s===+sF)?+aF:1, aEnd=(s===+sT)?+aT:surahMaxAyah[s];
      for(let a=aStart;a<=aEnd;a++){
        const p=ayahPageMap[`${s}:${a}`]; if(!p||SKIP(p)) continue;
        hit=true; if(p<minP)minP=p; if(p>maxP)maxP=p;
      }
    }
    return hit?{pFrom:minP,pTo:maxP}:null;
  }
  function pagesToAyahRange(pFrom,pTo){
    const first=[],last=[];
    for(const [k,p] of Object.entries(ayahPageMap)){ if(p===+pFrom)first.push(k); if(p===+pTo)last.push(k); }
    if(!first.length||!last.length) return null;
    const [sF,aF]=first.map(k=>k.split(':').map(Number)).sort((a,b)=>a[0]-b[0]||a[1]-b[1])[0];
    const [sT,aT]=last .map(k=>k.split(':').map(Number)).sort((a,b)=>a[0]-b[0]||a[1]-b[1]).slice(-1)[0];
    return { sFrom:sF, aFrom:aF, sTo:sT, aTo:aT };
  }

  // ---------- UI Fills ----------
  function fillSurahSelect(sel){
    const N=["Al-Fatihah","Al-Baqarah","Ali 'Imran","An-Nisa'","Al-Ma'idah","Al-An'am","Al-A'raf","Al-Anfal","At-Taubah","Yunus","Hud","Yusuf","Ar-Ra'd","Ibrahim","Al-Hijr","An-Nahl","Al-Isra'","Al-Kahf","Maryam","Ta Ha","Al-Anbiya'","Al-Hajj","Al-Mu'minun","An-Nur","Al-Furqan","Ash-Shu'ara'","An-Naml","Al-Qasas","Al-'Ankabut","Ar-Rum","Luqman","As-Sajdah","Al-Ahzab","Saba'","Fatir","Ya-Sin","As-Saffat","Sad","Az-Zumar","Ghafir","Fussilat","Ash-Shura","Az-Zukhruf","Ad-Dukhan","Al-Jathiyah","Al-Ahqaf","Muhammad","Al-Fath","Al-Hujurat","Qaf","Adz-Dzariyat","At-Tur","An-Najm","Al-Qamar","Ar-Rahman","Al-Waqi'ah","Al-Hadid","Al-Mujadilah","Al-Hashr","Al-Mumtahanah","As-Saff","Al-Jumu'ah","Al-Munafiqun","At-Taghabun","At-Talaq","At-Tahrim","Al-Mulk","Al-Qalam","Al-Haqqah","Al-Ma'arij","Nuh","Al-Jinn","Al-Muzzammil","Al-Muddaththir","Al-Qiyamah","Al-Insan","Al-Mursalat","An-Naba'","An-Nazi'at","'Abasa","At-Takwir","Al-Infitar","Al-Mutaffifin","Al-Inshiqaq","Al-Buruj","At-Tariq","Al-A'la","Al-Ghashiyah","Al-Fajr","Al-Balad","Ash-Shams","Al-Layl","Ad-Duha","Ash-Sharh","At-Tin","Al-'Alaq","Al-Qadr","Al-Bayyinah","Az-Zalzalah","Al-'Adiyat","Al-Qari'ah","At-Takathur","Al-'Asr","Al-Humazah","Al-Fil","Quraysh","Al-Ma'un","Al-Kawthar","Al-Kafirun","An-Nasr","Al-Masad","Al-Ikhlas","Al-Falaq","An-Nas"];
    const el = (typeof sel==='string')?$(sel):sel;
    if(!el) return;
    el.innerHTML = '<option value=""></option>' +
      Array.from({length:114},(_,i)=>`<option value="${i+1}">${i+1} ‚Äî ${N[i]}</option>`).join('');
    el.value = '';
  }

  function fillAyahForSurah(sel, surahId, {keep=false, preset=null}={}){
    const el=(typeof sel==='string')?$(sel):sel; if(!el) return;
    if(!surahId){
      el.innerHTML = '<option value=""></option>';
      el.value = '';
      return;
    }
    const max = Math.max(1, +surahMaxAyah[+surahId] || 1);
    const prev = keep ? +el.value : null;
    el.innerHTML = '<option value=""></option>' + makeOpts(max);
    if (preset != null)      el.value = String(Math.min(+preset, max));
    else if (keep && prev)   el.value = String(Math.min(prev, max));
    else                     el.value = '';
  }

  function fillPageSelects(idFrom, idTo){
    const f = (typeof idFrom==='string')?$(idFrom):idFrom;
    const t = (typeof idTo  ==='string')?$(idTo)  :idTo;
    if(!f || !t) return;
    const opts = '<option value=""></option>' + makeOpts(LAST_PAGE);
    f.innerHTML = opts; t.innerHTML = opts;
    f.value = ''; t.value = '';
  }

  function fillJuzSelect(id){
    const el = (typeof id === 'string') ? $(id) : id;
    if (!el) return;
    let opts = '<option value=""></option>';
    for (let i = 1; i <= 30; i++) opts += `<option value="${i}">Juz ${i}</option>`;
    el.innerHTML = opts;
    el.value = '';
  }

  const murState = {1:{},2:{},3:{}};

  function setPredikatUI(idx){
  const inp = $(`#mur${idx}-score`);
  applyPredikatBadgeStyle(idx, ''); // netral
  applyPredikatBadgeStyle(idx, ''); // netral (0 tidak punya predikat)
  if (!inp) return;
  const raw = String(inp.value ?? '');

  // Kosong ‚Üí hapus predikat & score dari UI+state+dataset
  if (raw.trim() === '') {
    $(`#mur${idx}-predikatBadge`).textContent = '‚Äì';
    murState[idx].score  = null;
    murState[idx].pText  = '';
    murState[idx].pHuruf = '';
    if (currentRowEl){
      const cell = currentRowEl.querySelector('.murajaah-cell');
      if (cell){
        delete cell.dataset[`score${idx}`];
        delete cell.dataset[`ptext${idx}`];
        delete cell.dataset[`phuruf${idx}`];
      }
    }
    return;
  }

  const sc = Math.max(0, Math.min(100, parseInt(raw, 10) || 0));

  // Khusus skor 0 ‚Üí tidak ada predikat
  if (sc === 0){
    $(`#mur${idx}-predikatBadge`).textContent = '‚Äì';
    murState[idx].score  = 0;
    murState[idx].pText  = '';
    murState[idx].pHuruf = '';
    if (currentRowEl){
      const cell = currentRowEl.querySelector('.murajaah-cell');
      if (cell){
        cell.dataset[`score${idx}`] = '0';
        delete cell.dataset[`ptext${idx}`];
        delete cell.dataset[`phuruf${idx}`];
      }
    }
    return;
  }

  // > 0 ‚Üí pakai predikat normal (ROSIB 1‚Äì59, dst.)
  const p = getPredikat(sc);
  $(`#mur${idx}-predikatBadge`).textContent = `${p.text} (${p.huruf})`;
  applyPredikatBadgeStyle(idx, p.huruf);
  murState[idx].score  = sc;
  murState[idx].pText  = p.text;
  murState[idx].pHuruf = p.huruf;

  if (currentRowEl){
    const cell = currentRowEl.querySelector('.murajaah-cell');
    if (cell){
      cell.dataset[`score${idx}`] = String(sc);
      cell.dataset[`ptext${idx}`] = p.text;
      cell.dataset[`phuruf${idx}`]= p.huruf;
    }
  }
}


  // === Reset satu sesi ke PRISTINE (lokal) ===
  function resetSession(idx){
    $(`#mur${idx}-juzFrom`).value = '';
    $(`#mur${idx}-juzTo`).value   = '';
    $(`#mur${idx}-pageFrom`).value = '';
    $(`#mur${idx}-pageTo`).value   = '';

    $(`#mur${idx}-surahFrom`).value = '';
    fillAyahForSurah($(`#mur${idx}-ayahFrom`), '', {});
    $(`#mur${idx}-surahTo`).value   = '';
    fillAyahForSurah($(`#mur${idx}-ayahTo`),   '', {});

    $(`#mur${idx}-score`).value = '';
    $(`#mur${idx}-predikatBadge`).textContent = '‚Äì';

    $(`#mur${idx}-pagesHint`).textContent = '';
    $(`#mur${idx}-totalJuz`).textContent  = '0.00';

    murState[idx] = {
      touched:false, sF:null,aF:null,sT:null,aT:null,
      pFrom:'',pTo:'', jFrom:null,jTo:null,
      total:0, score:null, pText:'', pHuruf:''
    };

    if (currentRowEl){
      const cell = currentRowEl.querySelector('.murajaah-cell');
      if (cell){
        delete cell.dataset[`sf${idx}`];
        delete cell.dataset[`af${idx}`];
        delete cell.dataset[`st${idx}`];
        delete cell.dataset[`at${idx}`];
        delete cell.dataset[`pf${idx}`];
        delete cell.dataset[`pt${idx}`];
        delete cell.dataset[`jfrom${idx}`];
        delete cell.dataset[`jto${idx}`];
        delete cell.dataset[`score${idx}`];
        delete cell.dataset[`ptext${idx}`];
        delete cell.dataset[`phuruf${idx}`];
        cell.dataset[`juz${idx}`] = '0.00';
      }
    }

    $('#mur-t1').textContent=(murState[1]?.total||0).toFixed(2);
    $('#mur-t2').textContent=(murState[2]?.total||0).toFixed(2);
    $('#mur-t3').textContent=(murState[3]?.total||0).toFixed(2);
    const grand=(murState[1]?.total||0)+(murState[2]?.total||0)+(murState[3]?.total||0);
    $('#mur-totalJuzAll').textContent=grand.toFixed(2);
    if (currentRowEl){
      const cell=currentRowEl.querySelector('.murajaah-cell');
      if (cell){
        cell.dataset.murtotal = grand.toFixed(2);
        const valEl=cell.querySelector('.mur-val');
        if (valEl) valEl.textContent = `${grand.toFixed(2)} juz`;
      }
    }
  }

  // === Render sesi ===
  function renderSession(idx){
    const sFv = $(`#mur${idx}-surahFrom`).value;
    const aFv = $(`#mur${idx}-ayahFrom`).value;
    const sTv = $(`#mur${idx}-surahTo`).value;
    const aTv = $(`#mur${idx}-ayahTo`).value;

    const pageFromEl = $(`#mur${idx}-pageFrom`);
    const pageToEl   = $(`#mur${idx}-pageTo`);
    const juzFromVal = $(`#mur${idx}-juzFrom`).value;
    const juzToVal   = $(`#mur${idx}-juzTo`).value;

    const cell = currentRowEl?.querySelector('.murajaah-cell');
    const hasDataset = !!(cell?.dataset?.[`pf${idx}`] || cell?.dataset?.[`pt${idx}`]
                       || cell?.dataset?.[`sf${idx}`] || cell?.dataset?.[`st${idx}`]);

    const isPristine = (!sFv || !aFv || !sTv || !aTv) &&
                       !hasDataset &&
                       !juzFromVal && !juzToVal &&
                       !pageFromEl.value && !pageToEl.value &&
                       !murState[idx]?.touched;

    if (isPristine){
      $(`#mur${idx}-pagesHint`).textContent='';
      $(`#mur${idx}-totalJuz`).textContent='0.00';
      setPredikatUI(idx);
      murState[idx]={...murState[idx], sF:null,aF:null,sT:null,aT:null,pFrom:'',pTo:'',jFrom:null,jTo:null,total:0};
    } else {
      if (sFv && aFv && sTv && aTv){
        const sF=+sFv, aF=+aFv, sT=+sTv, aT=+aTv;
        const pages=ayahRangeToPages(sF,aF,sT,aT);
        if(pages){
          if ((pageFromEl.value==='' && pageToEl.value==='') || hasDataset || juzFromVal || juzToVal){
            pageFromEl.value=String(pages.pFrom);
            pageToEl.value  =String(pages.pTo);
          }
          $(`#mur${idx}-pagesHint`).textContent=`Halaman: ${pages.pFrom}‚Äî${pages.pTo}`;
        } else {
          $(`#mur${idx}-pagesHint`).textContent='';
        }

        const jF=juzOfAyah(sF,aF), jT=juzOfAyah(sT,aT);
        const total=computeTotalJuz(sF,aF,sT,aT);
        $(`#mur${idx}-totalJuz`).textContent=total.toFixed(2);

        if (jF===30 && jT===30){
          $(`#mur${idx}-pagesHint`).textContent = 'Halaman: 582‚Äî604';
          if (!$(`#mur${idx}-pageFrom`).value) $(`#mur${idx}-pageFrom`).value = '582';
          $(`#mur${idx}-pageTo`).value = '604';
        }

        {
  const jfEl = $(`#mur${idx}-juzFrom`);
  const jtEl = $(`#mur${idx}-juzTo`);
  if (jfEl) jfEl.value = String(jF);
  if (jtEl) jtEl.value = String(jT);
}

        setPredikatUI(idx);

        murState[idx]={...murState[idx], sF,aF,sT,aT,
          pFrom:pageFromEl.value||'', pTo:pageToEl.value||'',
          jFrom:jF, jTo:jT, total};
      } else {
        $(`#mur${idx}-pagesHint`).textContent='';
        $(`#mur${idx}-totalJuz`).textContent='0.00';
        setPredikatUI(idx);
        murState[idx]={...murState[idx], total:0};
      }
    }

    // rekap & sinkron dataset
    $('#mur-t1').textContent=(murState[1]?.total||0).toFixed(2);
    $('#mur-t2').textContent=(murState[2]?.total||0).toFixed(2);
    $('#mur-t3').textContent=(murState[3]?.total||0).toFixed(2);
    const grand=(murState[1]?.total||0)+(murState[2]?.total||0)+(murState[3]?.total||0);
    $('#mur-totalJuzAll').textContent=grand.toFixed(2);

    if(currentRowEl){
      const cell=currentRowEl.querySelector('.murajaah-cell'); if(cell){
        cell.dataset.murtotal=String(grand.toFixed(2));
        [1,2,3].forEach(i=>{
          const st=murState[i]||{};
          cell.dataset[`sf${i}`]=st.sF||''; cell.dataset[`af${i}`]=st.aF||'';
          cell.dataset[`st${i}`]=st.sT||''; cell.dataset[`at${i}`]=st.aT||'';
          cell.dataset[`pf${i}`]=st.pFrom||''; cell.dataset[`pt${i}`]=st.pTo||'';
          cell.dataset[`jfrom${i}`]=st.jFrom||''; cell.dataset[`jto${i}`] = st.jTo || '';
          cell.dataset[`juz${i}`]=(st.total||0).toFixed(2);
          if(st.score!=null){ cell.dataset[`score${i}`]=String(st.score); cell.dataset[`ptext${i}`]=st.pText||''; cell.dataset[`phuruf${i}`]=st.pHuruf||''; }
        });
        const valEl=cell.querySelector('.mur-val'); if(valEl) valEl.textContent = grand.toFixed(2)+' juz';
      }
    }

    // --- jika user sudah mengisi data sesi -> hapus wipe-token supaya server boleh isi ulang
    try{
      const hasData = !!(murState[idx]?.sF && murState[idx]?.aF && murState[idx]?.sT && murState[idx]?.aT);
      if (hasData && currentRowEl) {
        wipeClear(currentRowEl, idx);
        const cell = currentRowEl.querySelector('.murajaah-cell');
        if (cell) delete cell.dataset[`wipe${idx}`];
      }
    }catch(_){}
  }

  function applyJuzRange(idx){
    const jf = +($(`#mur${idx}-juzFrom`).value)||0;
    let jt = +($(`#mur${idx}-juzTo`).value)||jf;
    if (!jf) return;
    if (jt<jf){ jt=jf; $(`#mur${idx}-juzTo`).value=String(jf); }

    const rF = getJuzRange(jf), rT = getJuzRange(jt);
    if (!rF || !rT) return;

    $(`#mur${idx}-surahFrom`).value = String(rF.sFrom);
    fillAyahForSurah($(`#mur${idx}-ayahFrom`), rF.sFrom, { preset:rF.aFrom });

    $(`#mur${idx}-surahTo`).value   = String(rT.sTo);
    fillAyahForSurah($(`#mur${idx}-ayahTo`),   rT.sTo,   { preset:rT.aTo });

    const pfEl = $(`#mur${idx}-pageFrom`);
    const ptEl = $(`#mur${idx}-pageTo`);
    if (jf===30 && jt===30){
      if (pfEl) pfEl.value = '582';
      if (ptEl) ptEl.value = '604';
      $(`#mur${idx}-pagesHint`).textContent = 'Halaman: 582‚Äî604';
    } else {
      if (pfEl) pfEl.value = String(rF.pFrom);
      if (ptEl) ptEl.value = String(rT.pTo);
      $(`#mur${idx}-pagesHint`).textContent = `Halaman: ${rF.pFrom}‚Äî${rT.pTo}`;
    }

    renderSession(idx);
  }

  function onPagesChange(idx){
    const pFv=$(`#mur${idx}-pageFrom`).value;
    const pTv=$(`#mur${idx}-pageTo`).value;
    if (!pFv || !pTv){ renderSession(idx); return; }

    let pF=+pFv, pT=+pTv;
    if(pT<pF){ pT=pF; $(`#mur${idx}-pageTo`).value=String(pF); }

    const r=pagesToAyahRange(pF,pT);
    if(r){
      $(`#mur${idx}-surahFrom`).value=String(r.sFrom); fillAyahForSurah($(`#mur${idx}-ayahFrom`), r.sFrom,{preset:r.aFrom});
      $(`#mur${idx}-surahTo`).value  =String(r.sTo);   fillAyahForSurah($(`#mur${idx}-ayahTo`),   r.sTo,  {preset:r.aTo});
    }
    renderSession(idx);
  }

  function onSurahChange(idx,which){
    const sFv=$(`#mur${idx}-surahFrom`).value;
    const sTv=$(`#mur${idx}-surahTo`).value;

    if(which==='from') fillAyahForSurah($(`#mur${idx}-ayahFrom`), sFv||'', {keep:true});
    else               fillAyahForSurah($(`#mur${idx}-ayahTo`),   sTv||'', {keep:true});

    const aFv=$(`#mur${idx}-ayahFrom`).value;
    const aTv=$(`#mur${idx}-ayahTo`).value;

    if (sFv && sTv && aFv && aTv){
      const sF=+sFv, sT=+sTv, aF=+aFv, aT=+aTv;
      if(sT<sF || (sT===sF && aT<aF)){
        $(`#mur${idx}-surahTo`).value=String(sF);
        fillAyahForSurah($(`#mur${idx}-ayahTo`), sF, {keep:true});
        if((+$(`#mur${idx}-ayahTo`).value||0) < (+aF||0))
          $(`#mur${idx}-ayahTo`).value=String(aF);
      }
    }
    murState[idx].touched = true;
    renderSession(idx);
  }

  function onAyahChange(idx){
    const sFv=$(`#mur${idx}-surahFrom`).value, aFv=$(`#mur${idx}-ayahFrom`).value;
    const sTv=$(`#mur${idx}-surahTo`).value,   aTv=$(`#mur${idx}-ayahTo`).value;

    if (sFv && aFv && sTv && aTv){
      const sF=+sFv, aF=+aFv, sT=+sTv, aT=+aTv;
      if(sT<sF || (sT===sF && aT<aF)){
        $(`#mur${idx}-surahTo`).value=String(sF);
        fillAyahForSurah($(`#mur${idx}-ayahTo`), sF,{keep:true});
        if((+$(`#mur${idx}-ayahTo`).value||0) < (+aF||0))
          $(`#mur${idx}-ayahTo`).value=String(aF);
      }
    }
    murState[idx].touched = true;
    renderSession(idx);
  }

	// --- Helper: set header Nama / NIS di murModal ---
function setMurHeader(nama, nis){
  const namaEl = document.getElementById('murNama');
  const nisEl  = document.getElementById('murNis');
  if (namaEl) namaEl.textContent = nama || '(Nama tidak ditemukan)';
  if (nisEl)  nisEl.textContent  = nis ? ' ‚Ä¢ NIS ' + nis : '';

  // simpan ke dataset & hidden input (jika ada)
  const modal = document.getElementById('murModal');
  if (modal){
    modal.dataset.nama = nama || '';
    modal.dataset.nis  = nis  || '';
    const inNama = modal.querySelector('input[name="mur_nama"]');
    const inNis  = modal.querySelector('input[name="mur_nis"]');
    if (inNama) inNama.value = nama || '';
    if (inNis)  inNis.value  = nis  || '';
  }
}

function getRowNamaNis(row){
  if (!row) return { nama:'', nis:'' };
  const nis = String(row.dataset?.nis || '').trim();
  // kolom [1] biasanya nama (innerText atau node text pertama)
  const nama = ((row.children?.[1]?.childNodes?.[0]?.textContent) ||
                (row.children?.[1]?.textContent) || '').trim();
  return { nama, nis };
}

	function applyPredikatBadgeStyle(idx, huruf){
  const el = document.getElementById(`mur${idx}-predikatBadge`);
  if (!el) return;

  // reset dulu
  el.style.background = '';
  el.style.color = '';
  el.style.border = '';
  el.style.borderRadius = '8px';
  el.style.padding = '2px 6px';
  el.style.display = 'inline-block';

  const h = (huruf||'').toUpperCase().trim();
  // mapping warna
  const MAP = {
    'A+': { bg:'#dcfce7', fg:'#166534', br:'#86efac' }, // hijau muda
    'A' : { bg:'#eafaf0', fg:'#166534', br:'#a7f3d0' }, // hijau muda (lebih pucat)
    'B' : { bg:'#dbeafe', fg:'#1e3a8a', br:'#93c5fd' }, // biru muda
    'C' : { bg:'#ffedd5', fg:'#9a3412', br:'#fdba74' }, // oranye muda
    'D' : { bg:'#ffe4e6', fg:'#9f1239', br:'#fecdd3' }, // merah muda
  };

  const s = MAP[h];
  if (!s){ // tidak ada predikat ‚Üí netral
    el.style.background = '';
    el.style.color = '';
    el.style.border = '1px solid transparent';
    return;
  }
  el.style.background = s.bg;
  el.style.color = s.fg;
  el.style.border = `1px solid ${s.br}`;
}

  // ---------- Helper: resolve kelas & tanggal ----------
  function resolveKelas(){
    const byWin = (window.kelasSelect && window.kelasSelect.value) ? window.kelasSelect.value : "";
    const byId  = $('#kelasSelect')?.value || $('#kelas')?.value || '';
    const byName= (document.querySelector('select[name="kelas"]')?.value
                || document.querySelector('input[name="kelas"]')?.value
                || '');
    const byData= $('#santri-table')?.dataset?.kelas
               || document.body?.dataset?.kelas
               || '';
    if (String(byWin).trim())  return String(byWin).trim();
    if (String(byId).trim())   return String(byId).trim();
    if (String(byName).trim()) return String(byName).trim();
    if (String(byData).trim()) return String(byData).trim();
    const row = $('#santri-table tbody tr');
    return String(row?.dataset?.kelas || '').trim();
  }
  function resolveTanggalGlobal(){
    const byWin = (window.tanggalInput && window.tanggalInput.value) ? window.tanggalInput.value : '';
    const byId  = $('#tanggalInput')?.value
               || $('#tanggal')?.value
               || $('#date')?.value
               || '';
    const byName= (document.querySelector('input[name="tanggal"]')?.value
                || document.querySelector('input[name="date"]')?.value
                || '');
    if (String(byWin).trim())  return String(byWin).trim();
    if (String(byId).trim())   return String(byId).trim();
    if (String(byName).trim()) return String(byName).trim();
    return '';
  }

  // === Modal ===
  async function openModalForRow(row){
    currentRowEl = row;
    $('#murModal').style.display = 'flex';

	  // Isi header Nama/NIS segera saat modal dibuka
try{
  const { nama, nis } = getRowNamaNis(row);
  setMurHeader(nama, nis);
}catch(_){}

    if (!dataReady){
      await ensureMap();
      [1,2,3].forEach(bindSession);
    }

    try { if (typeof window.murajaah?.refreshServer === 'function') {
      await window.murajaah.refreshServer();
    }} catch(_){}

    const cell = row.querySelector('.murajaah-cell');

    function resetOne(i){
      $(`#mur${i}-juzFrom`).value = '';
      $(`#mur${i}-juzTo`).value   = '';
      $(`#mur${i}-pageFrom`).value = '';
      $(`#mur${i}-pageTo`).value   = '';
      $(`#mur${i}-surahFrom`).value = '';
      fillAyahForSurah($(`#mur${i}-ayahFrom`), '', {});
      $(`#mur${i}-surahTo`).value   = '';
      fillAyahForSurah($(`#mur${i}-ayahTo`),   '', {});
      $(`#mur${i}-score`).value = '';
      $(`#mur${i}-predikatBadge`).textContent = '‚Äì';
      $(`#mur${i}-pagesHint`).textContent = '';
      $(`#mur${i}-totalJuz`).textContent = '0.00';
      murState[i] = {
        touched:false, sF:null,aF:null,sT:null,aT:null,
        pFrom:'', pTo:'', jFrom:null, jTo:null,
        total:0, score:null, pText:'', pHuruf:''
      };
    }

    function pickNonEmpty(...vals){ for(const v of vals){ if(v!==undefined && v!==null && String(v)!=='') return v; } return undefined; }
    function getDS(ds, i, perKey, legacyKey){
      const v = ds[perKey];
      if (v !== undefined && String(v) !== '') return v;
      if (i === 1){ const L = ds[legacyKey]; if (L !== undefined && String(L) !== '') return L; }
      return undefined;
    }

    async function fetchRowRecord(){
      const kelas = (typeof resolveKelas==='function' ? resolveKelas() : '') ||
                    String(row.closest('table')?.dataset?.kelas || document.body?.dataset?.kelas || '');
      const tanggal = String(row.dataset?.tanggal || '') ||
                      (typeof resolveTanggalGlobal==='function' ? resolveTanggalGlobal() : '');
      if (!kelas || !tanggal) return null;
      try{
        const res = await fetch(`/api/getAbsensi?kelas=${encodeURIComponent(kelas)}&tanggal=${encodeURIComponent(tanggal)}&t=${Date.now()}`);
        if (!res.ok) return null;
        const arr = await res.json().catch(()=>[]) || [];
        const id  = String(row.dataset?.id  || row.children?.[0]?.textContent || '').trim();
        const nis = String(row.dataset?.nis || '').trim();
        const nm  = (row.children?.[1]?.childNodes?.[0]?.textContent || row.children?.[1]?.textContent || '').trim().toLowerCase();
        return arr.find(r=>{
          const rid  = String(r?.id||'').trim();
          const rnis = String(r?.nis||'').trim();
          const rnm  = String(r?.nama||'').trim().toLowerCase();
          return (nis && rnis===nis) || (id && rid===id) || (nm && rnm===nm);
        }) || null;
      }catch{ return null; }
    }

    const ds = cell?.dataset || {};
    const rec = await fetchRowRecord();

    const fromRec = (i, kind)=>{
      if (!rec) return undefined;
      if (kind==='from')   return pickNonEmpty(rec[`murFrom${i}`],   rec.murSessions?.[i-1]?.from,   i===1?rec.murFrom:undefined);
      if (kind==='to')     return pickNonEmpty(rec[`murTo${i}`],     rec.murSessions?.[i-1]?.to,     i===1?rec.murTo:undefined);
      if (kind==='pages')  return pickNonEmpty(rec[`murPages${i}`],  rec.murSessions?.[i-1]?.pages,  i===1?rec.murPages:undefined);
      if (kind==='juz')    return pickNonEmpty(rec[`juzmur${i}`],    rec[`juzSesi${i}`],             rec.murSessions?.[i-1]?.juz);
      if (kind==='jFrom')  return pickNonEmpty(rec[`jFrom${i}`],     rec.murSessions?.[i-1]?.jFrom);
      if (kind==='jTo')    return pickNonEmpty(rec[`jTo${i}`],       rec.murSessions?.[i-1]?.jTo);
      if (kind==='score')  return pickNonEmpty(rec[`murScore${i}`],  rec.murSessions?.[i-1]?.score);
      if (kind==='pText')  return pickNonEmpty(rec[`murPredText${i}`],  rec.murSessions?.[i-1]?.predikatText);
      if (kind==='pHuruf') return pickNonEmpty(rec[`murPredHuruf${i}`], rec.murSessions?.[i-1]?.predikatHuruf);
    };
    const splitSA = (s)=>{ if(!s) return []; const a=String(s).split(':'); return [Number(a[0])||null, Number(a[1])||null]; };
    const applyPages = (i, str)=>{ if(!str) return; const [pf,pt]=String(str).split('-'); $(`#mur${i}-pageFrom`).value=pf||''; $(`#mur${i}-pageTo`).value=pt||''; };

    const loadOne = (i) => {
      // Jika sesi di-wipe: kosongkan total & jangan prefill apapun
      if (wipeHas(row, i)){
        $(`#mur${i}-juzFrom`).value = '';
        $(`#mur${i}-juzTo`).value   = '';
        $(`#mur${i}-pageFrom`).value = '';
        $(`#mur${i}-pageTo`).value   = '';
        $(`#mur${i}-surahFrom`).value = '';
        fillAyahForSurah($(`#mur${i}-ayahFrom`), '', {});
        $(`#mur${i}-surahTo`).value   = '';
        fillAyahForSurah($(`#mur${i}-ayahTo`),   '', {});
        $(`#mur${i}-score`).value = '';
        $(`#mur${i}-predikatBadge`).textContent = '‚Äì';
        $(`#mur${i}-pagesHint`).textContent = '';
        $(`#mur${i}-totalJuz`).textContent = '0.00';
        murState[i] = { touched:false, sF:null,aF:null,sT:null,aT:null, pFrom:'',pTo:'', jFrom:null,jTo:null, total:0, score:null, pText:'', pHuruf:'' };
        return;
      }

      const fromStr  = pickNonEmpty(
        (()=>{
          const sf=getDS(ds,i,`sf${i}`,'sf'), af=getDS(ds,i,`af${i}`,'af');
          return (sf||af) ? `${sf||''}:${af||''}` : undefined;
        })(),
        fromRec(i,'from')
      );
      const toStr    = pickNonEmpty(
        (()=>{
          const st=getDS(ds,i,`st${i}`,'st'), at=getDS(ds,i,`at${i}`,'at');
          return (st||at) ? `${st||''}:${at||''}` : undefined;
        })(),
        fromRec(i,'to')
      );
      const pagesStr = pickNonEmpty(
        (()=>{
          const pf=getDS(ds,i,`pf${i}`,'pf'), pt=getDS(ds,i,`pt${i}`,'pt');
          return (pf||pt) ? `${pf||''}-${pt||''}` : undefined;
        })(),
        fromRec(i,'pages')
      );

      const hasAny = !!(fromStr || toStr || pagesStr || ds[`juz${i}`] || fromRec(i,'juz'));

      if (hasAny){
        let [sF,aF] = splitSA(fromStr);
        let [sT,aT] = splitSA(toStr);

        if (sF!=null){ $(`#mur${i}-surahFrom`).value = String(sF); fillAyahForSurah($(`#mur${i}-ayahFrom`), sF, { preset: aF??undefined }); }
        if (sT!=null){ $(`#mur${i}-surahTo`).value   = String(sT); fillAyahForSurah($(`#mur${i}-ayahTo`),   sT, { preset: aT??undefined }); }

        if (pagesStr) applyPages(i, pagesStr);

        const jf = pickNonEmpty(ds[`jfrom${i}`], fromRec(i,'jFrom'));
        const jt = pickNonEmpty(ds[`jto${i}`],   fromRec(i,'jTo'));
        $(`#mur${i}-juzFrom`).value = jf!==undefined ? String(jf) : '';
        $(`#mur${i}-juzTo`).value   = jt!==undefined ? String(jt) : '';

        // Prefill nilai dari dataset ATAU record server (kalau ada)
// Prefill nilai dari dataset ATAU record server (kalau ada, > 0)
const scFromDs  = ds[`score${i}`];
const scFromRec = fromRec(i, 'score');

// normalisasi ke number
const scCand = (scFromDs !== undefined && scFromDs !== '') ? Number(scFromDs)
             : (scFromRec !== undefined && scFromRec !== '') ? Number(scFromRec)
             : NaN;

// HANYA prefill jika angka valid DAN > 0
if (Number.isFinite(scCand) && scCand > 0) {
  const s = Math.max(0, Math.min(100, Math.floor(scCand)));
  const p = getPredikat(s);
  const inp = $(`#mur${i}-score`);
  if (inp) inp.value = String(s);
  $(`#mur${i}-predikatBadge`).textContent = `${p.text} (${p.huruf})`;

  murState[i].score  = s;
  murState[i].pText  = p.text;
  murState[i].pHuruf = p.huruf;

  if (currentRowEl){
    const c = currentRowEl.querySelector('.murajaah-cell');
    if (c){
      c.dataset[`score${i}`]  = String(s);
      c.dataset[`ptext${i}`]  = p.text;
      c.dataset[`phuruf${i}`] = p.huruf;
    }
  }
} else {
  const inp = $(`#mur${i}-score`);
  if (inp) inp.value = '';
  $(`#mur${i}-predikatBadge`).textContent = '‚Äì';
  murState[i].score  = null;
  murState[i].pText  = '';
  murState[i].pHuruf = '';
}


        renderSession(i);

        const juzVal = pickNonEmpty(ds[`juz${i}`], fromRec(i,'juz'));
        if (juzVal !== undefined){
          const v = Number(juzVal)||0;
          $(`#mur${i}-totalJuz`).textContent = v.toFixed(2);
          murState[i].total = v;
        }
      }
    };

    [1,2,3].forEach(resetOne);
    [1,2,3].forEach(loadOne);

    ensureResetButtons();
  }

  function fillAllBases(idx){
    fillJuzSelect(`#mur${idx}-juzFrom`);
    fillJuzSelect(`#mur${idx}-juzTo`);
    fillPageSelects(`#mur${idx}-pageFrom`, `#mur${idx}-pageTo`);
    fillSurahSelect(`#mur${idx}-surahFrom`);
    fillSurahSelect(`#mur${idx}-surahTo`);
    fillAyahForSurah($(`#mur${idx}-ayahFrom`), '', {});
    fillAyahForSurah($(`#mur${idx}-ayahTo`),   '', {});

    $(`#mur${idx}-juzFrom`) ?.addEventListener('change', ()=>applyJuzRange(idx));
    $(`#mur${idx}-juzTo`)   ?.addEventListener('change', ()=>applyJuzRange(idx));
    $(`#mur${idx}-pageFrom`)?.addEventListener('change', ()=>onPagesChange(idx));
    $(`#mur${idx}-pageTo`)  ?.addEventListener('change', ()=>onPagesChange(idx));

    $(`#mur${idx}-surahFrom`)?.addEventListener('change', ()=>{ murState[idx].touched = true; onSurahChange(idx,'from'); });
    $(`#mur${idx}-surahTo`)  ?.addEventListener('change', ()=>{ murState[idx].touched = true; onSurahChange(idx,'to');   });
    $(`#mur${idx}-ayahFrom`) ?.addEventListener('change', ()=>{ murState[idx].touched = true; onAyahChange(idx);         });
    $(`#mur${idx}-ayahTo`)   ?.addEventListener('change', ()=>{ murState[idx].touched = true; onAyahChange(idx);         });

    $(`#mur${idx}-score`)    ?.addEventListener('input',  ()=>{ setPredikatUI(idx); renderSession(idx); });
  }
  function bindSession(idx){ fillAllBases(idx); }

  function ensureMurColumn(){
    const table=$('#santri-table'); if(!table) return;
    const theadRow=table.tHead?.rows?.[0];
    if(theadRow && !theadRow.querySelector('th.mur-header')){
      const th=document.createElement('th'); th.className='mur-header'; th.textContent='Murajaah'; theadRow.appendChild(th);
    }
    const rows=table.tBodies?.[0]?.rows||[];
    [...rows].forEach(tr=>{
      if(tr.querySelector('.murajaah-cell')) return;
      const td=document.createElement('td'); td.className='murajaah-cell';
      td.dataset.murtotal = ""; td.dataset.murlabel = "";
      td.innerHTML = `
        <div class="mur-val" style="font-weight:600;min-height:1em">‚Äî</div>
        <div class="mur-label" style="font-size:11px; color:#6b7280;"></div>
        <button type="button" class="btn-mur" style="margin-top:6px; padding:4px 8px;">Input</button>`;
      tr.appendChild(td);
      td.querySelector('.btn-mur').addEventListener('click',()=>openModalForRow(tr));
    });
  }

  // ---------- Refresh dari server (muat juga skor/predikat jika ada) ----------
  async function refreshMurFromServer(){
    const $ = (s,r=document)=>r.querySelector(s);
    const table = $('#santri-table');
    const kelas = (function(){
      return String(
        window.kelasSelect?.value ||
        $('#kelasSelect')?.value || $('#kelas')?.value ||
        document.querySelector('select[name="kelas"]')?.value ||
        table?.dataset?.kelas || document.body?.dataset?.kelas || ''
      ).trim();
    })();
    if(!kelas || !table) return;

    const rows = [...(table.tBodies?.[0]?.rows||[])];
    const tglSet = new Set(rows.map(r=>String(r.dataset?.tanggal||'').trim()).filter(Boolean));
    if(!tglSet.size){
      const g = String(
        window.tanggalInput?.value ||
        $('#tanggalInput')?.value || $('#tanggal')?.value || $('#date')?.value ||
        document.querySelector('input[name="tanggal"]')?.value ||
        document.querySelector('input[name="date"]')?.value || ''
      ).trim();
      if(g) tglSet.add(g);
    }
    if(!tglSet.size) return;

    const setSA=(cell,src,dsS,dsA)=>{ if(!src){cell.dataset[dsS]='';cell.dataset[dsA]='';return;}
      const [s,a]=String(src).split(':'); cell.dataset[dsS]=s||''; cell.dataset[dsA]=a||''; };
    const setPages=(cell,src,pfKey,ptKey)=>{ if(!src){cell.dataset[pfKey]='';cell.dataset[ptKey]='';return;}
      const [pf,pt]=String(src).split('-'); cell.dataset[pfKey]=pf||''; cell.dataset[ptKey]=pt||''; };
    const num=(v)=>{ if(typeof v==='number') return Number.isFinite(v)?v:0;
      const n=parseFloat(String(v??'').replace(/[^0-9.,-]/g,'').replace(',', '.')); return Number.isFinite(n)?n:0; };

    for (const tgl of tglSet){
      let list=[];
      try{
        const res=await fetch(`/api/getAbsensi?kelas=${encodeURIComponent(kelas)}&tanggal=${encodeURIComponent(tgl)}`);
        if(!res.ok) continue;
        list=await res.json().catch(()=>[])||[];
      }catch{continue;}

      const byId=new Map(), byNis=new Map();
      for(const r of list){
        const id = String(r?.id??'').trim();
        const nis= String(r?.nis??'').trim();
        if(id)  byId.set(id, r);
        if(nis) byNis.set(nis,r);
      }

      	rows.forEach(tr=>{
		// ‚¨á‚¨á‚¨á Tambahan: batasi ke baris dengan tanggal yang sesuai
		const rowTgl = String(tr.dataset?.tanggal || '').trim();
		if (rowTgl && rowTgl !== tgl) return;
        const cell=tr.querySelector('.murajaah-cell'); if(!cell) return;
        const nis = String(tr.dataset?.nis||'').trim();
        const id  = String(tr.children?.[0]?.textContent||'').trim();
        const rec = (nis && byNis.get(nis)) || (id && byId.get(id)) || null;

        const total = num(rec?.juzmurajaah ?? rec?.totalJuz ?? 0);
        const valEl = cell.querySelector('.mur-val');
        if(valEl) valEl.textContent = `${total.toFixed(2)} juz`;
        cell.dataset.murtotal = total.toFixed(2);

        const legacyFrom = rec?.murFrom || '';
        const legacyTo   = rec?.murTo   || '';
        const legacyPg   = rec?.murPages|| '';
        setSA(cell, legacyFrom, 'sf', 'af');
        setSA(cell, legacyTo,   'st', 'at');
        setPages(cell, legacyPg, 'pf', 'pt');

        const takeNonEmpty = (...xs) => { for (const x of xs){ if(x!==undefined && x!==null && String(x)!=='') return x; } return ''; };
        function getSessionFrom(rec, i){
          const arr = Array.isArray(rec?.murSessions) ? rec.murSessions : null;
          const ses = arr && arr[i-1] ? arr[i-1] : null;
          const fromStr  = takeNonEmpty(rec?.[`murFrom${i}`],  ses?.from,  rec?.murFrom);
          const toStr    = takeNonEmpty(rec?.[`murTo${i}`],    ses?.to,    rec?.murTo);
          const pagesStr = takeNonEmpty(rec?.[`murPages${i}`], ses?.pages, rec?.murPages);
          const juzVal   = takeNonEmpty(rec?.[`juzmur${i}`], rec?.[`juzSesi${i}`], ses?.juz);
          const jFrom    = (rec?.[`jFrom${i}`] ?? ses?.jFrom);
          const jTo      = (rec?.[`jTo${i}`]   ?? ses?.jTo);
          const score    = (rec?.[`murScore${i}`]     ?? ses?.score);
          const pText    = (rec?.[`murPredText${i}`]  ?? ses?.predikatText);
          const pHuruf   = (rec?.[`murPredHuruf${i}`] ?? ses?.predikatHuruf);
          return { fromStr, toStr, pagesStr, juzVal, jFrom, jTo, score, pText, pHuruf };
        }

        for (let i = 1; i <= 3; i++) {
          // Jika ada wipe untuk sesi ini: kosongkan & skip data server
          if (wipeHas(tr, i)){
            ['sf','af','st','at','pf','pt','jfrom','jto','score','ptext','phuruf'].forEach(k=>{
              const key = `${k}${i}`; if (key in cell.dataset) delete cell.dataset[key];
            });
            cell.dataset[`juz${i}`] = '0.00';
            cell.dataset[`wipe${i}`] = '1';
            continue;
          }

          const ses = getSessionFrom(rec, i);
          setSA(cell, ses.fromStr, `sf${i}`, `af${i}`);
          setSA(cell, ses.toStr,   `st${i}`, `at${i}`);
          setPages(cell, ses.pagesStr, `pf${i}`, `pt${i}`);
          if (ses.jFrom != null && ses.jFrom !== '') cell.dataset[`jfrom${i}`] = String(ses.jFrom); else delete cell.dataset[`jfrom${i}`];
          if (ses.jTo   != null && ses.jTo   !== '') cell.dataset[`jto${i}`]   = String(ses.jTo);   else delete cell.dataset[`jto${i}`];
          cell.dataset[`juz${i}`] = num(ses.juzVal || 0).toFixed(2);

const sNum = Number(ses.score);
if (Number.isFinite(sNum) && sNum > 0) {
  cell.dataset[`score${i}`] = String(Math.floor(sNum));
} else {
  delete cell.dataset[`score${i}`];
}
          if (ses.pText  != null) cell.dataset[`ptext${i}`] = String(ses.pText); else delete cell.dataset[`ptext${i}`];
          if (ses.pHuruf != null) cell.dataset[`phuruf${i}`]= String(ses.pHuruf); else delete cell.dataset[`phuruf${i}`];
        }
      });
    }
  }

  function bindModalShell(){
    $('#mur-close')?.addEventListener('click',()=>{$('#murModal').style.display='none';});
    $('#mur-preview')?.addEventListener('click', ()=>{
      const lines=[1,2,3].map(i=>{
        const st=murState[i]||{};
        if(!st.sF) return `<li>Sesi ${i}: -</li>`;
        const pv = (st.pText && st.pHuruf!=null) ? ` ‚Ä¢ Nilai ${st.score} ‚Üí <b>${st.pText} (${st.pHuruf})</b>` : '';
        return `<li><b>Sesi ${i}</b>: Surah ${st.sF}:${st.aF} ‚Üí ${st.sT}:${st.aT} ‚Ä¢ Juz ${st.jFrom} ‚Üí ${st.jTo} ‚Ä¢ <b>${(st.total||0).toFixed(2)} juz</b>${pv}</li>`;
      }).join('');
      const grand=((murState[1]?.total||0)+(murState[2]?.total||0)+(murState[3]?.total||0)).toFixed(2);
      $('#murPreviewBody').innerHTML = `<ul style="margin:0 0 10px 18px">${lines}</ul><div><b>Total 3 sesi:</b> ${grand} juz</div>`;
      $('#murPreviewOverlay').style.display='flex';
    });
    $('#mur-save')?.addEventListener('click', async()=>{
  try{
    // Sinkronkan skor dulu, supaya dataset pasti terisi
    [1,2,3].forEach(i => setPredikatUI(i));
    // Render (rekap total & dataset range)
    [1,2,3].forEach(renderSession);

    if (typeof window.simpanDataMutabaah === 'function'){
      await window.simpanDataMutabaah($('#mur-save'));
      await refreshMurFromServer();
      $('#mur-save-status').textContent='üü¢ Tersimpan';
      setTimeout(()=>$('#mur-save-status').textContent='',1500);
    }
  }catch(e){ console.error(e); $('#mur-save-status').textContent='‚ùå Gagal simpan'; }
});
  }

  function afterTableRendered(){ ensureMurColumn(); refreshMurFromServer(); }

  // ============ RESET: kosong total (0.00) + lindungi dari data server ============
  async function serverSafeReset(idx){
    try{ if (!window.dataReady) await ensureMap(); }catch(_){}
    const sel = q => document.querySelector(q);

    // Kosongkan UI
    sel(`#mur${idx}-juzFrom`)   && (sel(`#mur${idx}-juzFrom`).value   = '');
    sel(`#mur${idx}-juzTo`)     && (sel(`#mur${idx}-juzTo`).value     = '');
    sel(`#mur${idx}-pageFrom`)  && (sel(`#mur${idx}-pageFrom`).value  = '');
    sel(`#mur${idx}-pageTo`)    && (sel(`#mur${idx}-pageTo`).value    = '');
    sel(`#mur${idx}-surahFrom`) && (sel(`#mur${idx}-surahFrom`).value = '');
    sel(`#mur${idx}-surahTo`)   && (sel(`#mur${idx}-surahTo`).value   = '');
    if (sel(`#mur${idx}-ayahFrom`)) sel(`#mur${idx}-ayahFrom`).innerHTML = '<option value=""></option>';
    if (sel(`#mur${idx}-ayahTo`))   sel(`#mur${idx}-ayahTo`).innerHTML   = '<option value=""></option>';
    if (sel(`#mur${idx}-score`))           sel(`#mur${idx}-score`).value = '';
    if (sel(`#mur${idx}-predikatBadge`))   sel(`#mur${idx}-predikatBadge`).textContent = '‚Äì';
    if (sel(`#mur${idx}-pagesHint`))       sel(`#mur${idx}-pagesHint`).textContent = '';
    if (sel(`#mur${idx}-totalJuz`))        sel(`#mur${idx}-totalJuz`).textContent = '0.00';

    // Reset state
    murState[idx] = {
      touched:false, sF:null,aF:null,sT:null,aT:null,
      pFrom:'', pTo:'', jFrom:null, jTo:null,
      total:0, score:null, pText:'', pHuruf:''
    };

    // Bersihkan dataset sel + set wipe marker
    if (window.currentRowEl){
      const cell = window.currentRowEl.querySelector('.murajaah-cell');
      if (cell){
        ['sf','af','st','at','pf','pt','jfrom','jto','score','ptext','phuruf','juz'].forEach(k=>{
          const key = `${k}${idx}`; if (key in cell.dataset) delete cell.dataset[key];
        });
        wipeAdd(window.currentRowEl, idx);
        cell.dataset[`wipe${idx}`] = '1';
      }
    }

	  // --- setelah kosongkan UI & state, isi skor=0 dan sinkronkan UI+dataset
const scoreEl = document.querySelector(`#mur${idx}-score`);
if (scoreEl) {
  scoreEl.value = '0';
  // trigger listener 'input' yang sudah ada ‚Üí setPredikatUI(idx) + render
  scoreEl.dispatchEvent(new Event('input', { bubbles: true }));
}

// agar tersimpan juga ke dataset kalau modal terbuka
if (window.currentRowEl){
  const cell = window.currentRowEl.querySelector('.murajaah-cell');
  if (cell){
    cell.dataset[`score${idx}`] = '0';
    // opsional: langsung set label predikat sesuai 0 (ROSIB)
    delete cell.dataset[`ptext${idx}`];
	delete cell.dataset[`phuruf${idx}`];
  }
}

    // Rekap total
    [1,2,3].forEach(renderSession);
    const g = (murState[1]?.total||0)+(murState[2]?.total||0)+(murState[3]?.total||0);
    const gEl = document.querySelector('#mur-totalJuzAll');
    if (gEl) gEl.textContent = g.toFixed(2);
    if (window.currentRowEl){
      const cell = window.currentRowEl.querySelector('.murajaah-cell');
      const valEl = cell?.querySelector('.mur-val');
      if (cell) cell.dataset.murtotal = g.toFixed(2);
      if (valEl) valEl.textContent = `${g.toFixed(2)} juz`;
    }

    const statusEl = document.querySelector('#mur-save-status');
    try{
      if (typeof window.simpanDataMutabaah === 'function'){
        await window.simpanDataMutabaah(document.querySelector(`#mur${idx}-totalJuz-reset`) || null);
        if (typeof window.murajaah?.refreshServer === 'function'){
          await window.murajaah.refreshServer();
        }
        if (statusEl){ statusEl.textContent='üü¢ Reset ke kosong (0.00) & dilindungi dari server'; setTimeout(()=>statusEl.textContent='',1500); }
      } else {
        if (statusEl){ statusEl.textContent='‚ÑπÔ∏è Di-reset lokal (tanpa simpan server)'; setTimeout(()=>statusEl.textContent='',1500); }
      }
    }catch(e){
      console.error(e);
      if (statusEl){ statusEl.textContent='‚ùå Gagal simpan ke server'; setTimeout(()=>statusEl.textContent='',2000); }
    }
  }

  // === Buat tombol reset di sebelah #murX-totalJuz (1..3) ‚Üí jalankan serverSafeReset ===
  function ensureResetButtons(){
    for (let i=1;i<=3;i++){
      const totalEl = $(`#mur${i}-totalJuz`);
      if (!totalEl) continue;
      if (document.getElementById(`mur${i}-totalJuz-reset`)) continue;

      const btn = document.createElement('button');
      btn.id = `mur${i}-totalJuz-reset`;
      btn.type = 'button';
      btn.textContent = 'Reset';
      btn.style.marginLeft = '8px';
      btn.style.padding = '2px 8px';
      btn.style.fontSize = '12px';

      const sesiWrap = document.getElementById(`mur-sesi${i}`);
      if (totalEl.parentNode) totalEl.parentNode.insertBefore(btn, totalEl.nextSibling);
      else if (sesiWrap) sesiWrap.appendChild(btn);
      else totalEl.after(btn);

      btn.addEventListener('click', ()=> serverSafeReset(i));
    }
  }

  // ekspor
  window.murajaah = { afterTableRendered: ()=>{ ensureMurColumn(); refreshMurFromServer(); }, refreshServer: refreshMurFromServer };

  // init
  (async function init(){
    bindModalShell();
    if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', window.murajaah.afterTableRendered);
    else window.murajaah.afterTableRendered();
    const _origLoad=window.loadSantriData;
    window.loadSantriData=async function(...args){
      if(typeof _origLoad==='function') await _origLoad.apply(this,args);
      setTimeout(window.murajaah.afterTableRendered,0);
    };
    await ensureMap();
    [1,2,3].forEach(bindSession);

    // tombol reset sesi tersedia dari awal
    ensureResetButtons();
  })();
})();
</script>

<script>
(function(){
  // ===== util & helpers Murajaah RANGE =====
  const $  = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>[...r.querySelectorAll(s)];
  const normKey = v => String(v ?? "").trim();
  const parseNum = v => {
    if (typeof window.parseNum === "function") return window.parseNum(v);
    let s = String(v ?? "").trim();
    if (!s) return 0;
    s = s.replace(/[^0-9.,-]/g,"");
    const c = s.lastIndexOf(","), d = s.lastIndexOf(".");
    if (c>-1 && d>-1){ if (c>d){ s=s.replace(/\./g,"").replace(",","."); } else { s=s.replace(/,/g,""); } }
    else if (c>-1){ s=s.replace(/\./g,"").replace(",","."); }
    else { s=s.replace(/,/g,""); }
    const n = parseFloat(s); return Number.isFinite(n)?n:0;
  };
  const BATAS = {1: 1, 2: 1, 3: 2, 4: 2, 5: 3, 6: 3, 7: 4, 8: 4, 9: 5, 10: 5, 11: 6, 12: 6};
  const LS_KEY = k => `murRange:${k}`;

  function getSantriTable(){
    return document.getElementById('santri-table')
        || document.getElementById('santriTable')
        || document.querySelector('table[data-role="santri-table"]')
        || document.querySelector('table.santri-table')
        || null;
  }

  function kelasNow(){
    if (window.kelasSelect && window.kelasSelect.value) {
      const v = normKey(window.kelasSelect.value); try{ localStorage.setItem('lastKelas', v);}catch{}; return v;
    }
    const sel = document.querySelector(
      'select#kelasSelect, select[name="kelas"], select[name="kelasSelect"], '+
      'select.kelas-select, select.kelas, #kelas, .kelasSelect, .kelas'
    );
    if (sel && sel.value){ const v=normKey(sel.value); try{localStorage.setItem('lastKelas', v);}catch{}; return v; }
    const ref = document.querySelector('[data-kelas]'); if (ref?.dataset?.kelas){ const v=normKey(ref.dataset.kelas); try{localStorage.setItem('lastKelas', v);}catch{}; return v; }
    const qs = new URLSearchParams(location.search); const vq = qs.get('kelas') || qs.get('class') || qs.get('kls');
    if (vq){ const v=normKey(vq); try{localStorage.setItem('lastKelas', v);}catch{}; return v; }
    try{ const last = localStorage.getItem('lastKelas'); if (last) return normKey(last);}catch{}
    return '';
  }

  // ===== sisip header & kolom =====
  function ensureMurRangeColumn(){
    const table = getSantriTable(); if (!table) return;
    const thRow = table.tHead?.rows?.[0];
    if (thRow && !thRow.querySelector('#murRangeHeader')){
      const th = document.createElement('th');
      th.id = 'murRangeHeader';
      th.style.cursor = 'pointer';
      th.style.textDecoration = 'underline';
      th.textContent = 'Setting Murajaah';
      const murTh = thRow.querySelector('.mur-header');
      if (murTh && murTh.nextSibling) thRow.insertBefore(th, murTh.nextSibling);
      else thRow.appendChild(th);
      th.addEventListener('click', bukaOverlayTotalMurRange);
    }
    const rows = table.tBodies?.[0]?.rows || [];
    [...rows].forEach(tr=>{
      if (tr.querySelector('.total-mur-range')) return;
      const td = document.createElement('td');
      td.className = 'total-mur-range';
      td.innerHTML = '0.00&nbsp;juz ' +
  '<span class="mur-range-badge" style="color:#999; font-size:12px">total 0%</span> ' +
  '<small class="mur-range-count" data-link="0" data-count="0" role="button" tabindex="-1" aria-label="Tidak ada input murajaah dalam rentang" style="color:#6b7280">(0)</small> ' +
  '<button type="button" class="mur-range-list-btn" data-count="0" disabled ' +
  'style="margin-left:6px;padding:3px 8px;font-size:12px;border:1px solid #d1d5db;border-radius:6px;background:#f9fafb;color:#6b7280;cursor:not-allowed" ' +
  'title="Daftar input murajaah (rentang)">Unduh</button>';
      const murCell = tr.querySelector('.murajaah-cell');
      if (murCell && murCell.nextSibling) tr.insertBefore(td, murCell.nextSibling);
      else tr.appendChild(td);
    });
  }

  // ===== persist range (server + local) =====
  async function saveRangeServer(kelas, fromDate, toDate, count){
    const r = await fetch('/api/aksesAutoUpdateAllJuzMur', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        kelas,
        fromDate,
        toDate,
        data: [{ meta:true, count: Number(count||0) }]
      })
    });
    if (!r.ok) throw new Error('saveRangeServer: HTTP '+r.status);
  }

  // Multi-strategy penghapusan range di server (agar kompatibel berbagai backend)
  async function tryResetRangeServer(kelas){
    const attempts = [
      { url: '/api/aksesAutoUpdateAllJuzMur', method:'POST',   body:{ kelas, delete:true } },
      { url: '/api/aksesAutoUpdateAllJuzMur', method:'DELETE', body:{ kelas } },
      { url: '/api/aksesAutoUpdateAllJuzMur', method:'POST',   body:{ kelas, fromDate:'', toDate:'', data:[] } },
      { url: '/api/aksesAutoUpdateAllJuzMur', method:'POST',   body:{ kelas, fromDate:null, toDate:null, data:[{meta:true, count:0, delete:true}] } },
      { url: '/api/resetAutoUpdateAllJuzMur', method:'POST',   body:{ kelas } },
      { url: '/api/aksesAutoUpdateAllJuzMur?delete=1', method:'POST', body:{ kelas } },
    ];

    for (const att of attempts){
      try{
        const r = await fetch(att.url, {
          method: att.method,
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(att.body||{})
        });
        let j=null; try{ j = await r.clone().json(); }catch(_){}
        const okFlag = r.ok || r.status===204 || (j && (j.ok||j.success||j.removed||j.deleted));
        if (okFlag) { console.info('[murRange] reset OK via', att); return true; }
        console.warn('[murRange] reset attempt fail', att, r.status, j||await r.text());
      }catch(e){
        console.warn('[murRange] reset attempt error', att, e);
      }
    }
    return false;
  }

  function saveRangeLocal(kelas, fromDate, toDate){
    try{ localStorage.setItem(LS_KEY(kelas), JSON.stringify({ fromDate, toDate, t: Date.now() })); }catch{}
  }
  async function getRangeForKelas(kelas){
    try{
      const r = await fetch('/api/getAutoUpdateAllJuzMur?t='+Date.now());
      if (r.ok){
        const arr = await r.json();
        const it  = (arr||[]).find(x=>String(x.kelas||"")===String(kelas));
        if (it && (it.fromDate || it.toDate)) return { fromDate: it.fromDate||"", toDate: it.toDate||"" };
      }
    }catch(_){}
    try{
      const raw = localStorage.getItem(LS_KEY(kelas));
      if (raw){ const obj = JSON.parse(raw); return { fromDate: obj.fromDate||"", toDate: obj.toDate||"" }; }
    }catch(_){}
    return { fromDate:"", toDate:"" };
  }

  // ===== overlay open =====
  function bukaOverlayTotalMurRange(){
    const el = $('#murRangeOverlay'); if (!el) return;
    const today = new Date(); const yyyy = today.getFullYear();
    const mm = String(today.getMonth()+1).padStart(2,"0");
    const dd = String(today.getDate()).padStart(2,"0");
    const todayStr = `${yyyy}-${mm}-${dd}`;
    const dari = $('#murRangeDari'); const sampai = $('#murRangeSampai');
    if (dari){ dari.max = todayStr; if (!dari.value || dari.value > todayStr) dari.value = todayStr; }
    if (sampai){ sampai.removeAttribute('max'); if (!sampai.value) sampai.value = todayStr; }
    $('#murRangeStatus') && ($('#murRangeStatus').textContent = '');
    el.style.display = 'flex';
  }

  // ===== hitung dari server ‚Üí tampilkan =====
  async function hitungTotalMurRangeFromTable(){
    const kelas  = kelasNow();
    const table  = getSantriTable();
    const dari   = $('#murRangeDari')?.value;
    const sampai = $('#murRangeSampai')?.value;

    if (!kelas){ alert("Mohon pilih kelas."); return; }
    if (!table){ alert("Tabel santri belum tersedia."); return; }
    if (!dari){ alert("Mohon pilih tanggal Dari."); return; }
    if (!sampai){ alert("Mohon pilih tanggal Sampai."); return; }

    $('#murRangeStatus') && ($('#murRangeStatus').textContent = "‚è≥ Menghitung‚Ä¶");

    try{
      const res = await fetch(`/api/getAbsensiRange?kelas=${encodeURIComponent(kelas)}&start=${encodeURIComponent(dari)}&end=${encodeURIComponent(sampai)}&t=${Date.now()}`);
      if (!res.ok) throw new Error("Gagal ambil data absensi.");
      const payload = await res.json();
      const allData = Array.isArray(payload) ? payload : (payload?.list || []);

      const rows = [...(table.tBodies?.[0]?.rows || [])];

      const nameToKey = new Map();
      rows.forEach(row=>{
        const key = normKey(row.dataset?.nis || row.dataset?.id || row.dataset?.key);
        const nm  = (row.children?.[1] ? (row.children[1].childNodes?.[0]?.textContent || row.children[1].textContent) : "") || "";
        if (key && nm) nameToKey.set(nm.trim().toLowerCase(), key);
      });

      const extract3 = (item)=>{
        const v1 = parseNum(item?.juzmur1 ?? item?.juzSesi1 ?? item?.juzmurajaah1 ?? 0);
        const v2 = parseNum(item?.juzmur2 ?? item?.juzSesi2 ?? item?.juzmurajaah2 ?? 0);
        const v3 = parseNum(item?.juzmur3 ?? item?.juzSesi3 ?? item?.juzmurajaah3 ?? 0);
        if (v1||v2||v3) return [v1,v2,v3];
        const t = parseNum(item?.juzmurajaah ?? item?.totalJuz ?? 0);
        return [t,0,0];
      };

      const rekap = Object.create(null);
      (allData||[]).forEach(item=>{
        let id  = normKey(item?.id);
        let nis = normKey(item?.nis);
        let key = normKey(nis || id);
        if (!key){
          const nm = normKey(item?.nama).toLowerCase();
          if (nm && nameToKey.has(nm)) key = nameToKey.get(nm);
        }
        if (!key) return;
        const [v1,v2,v3] = extract3(item);
        if (!rekap[key]) rekap[key] = { s1:0,s2:0,s3:0, cAll:0, semester:item?.semester ?? null };
        rekap[key].s1 += v1; rekap[key].s2 += v2; rekap[key].s3 += v3;
        const sum = v1+v2+v3;
        if (sum>0) rekap[key].cAll += 1;
      });

      rows.forEach(row=>{
        const key  = normKey(row.dataset?.key || row.dataset?.nis || row.dataset?.id);
        const cell = row.querySelector('.total-mur-range');
        if (!cell) return;

        const rec = key ? rekap[key] : null;
        const s1 = rec ? Number(rec.s1||0) : 0;
        const s2 = rec ? Number(rec.s2||0) : 0;
        const s3 = rec ? Number(rec.s3||0) : 0;
        const totalNum = s1+s2+s3;

        let semester = 1;
        if (typeof window.getSemesterForKey === "function") semester = Number(window.getSemesterForKey(key,row,rec?.semester)||1);
        else if (row?.querySelector?.(".semester")?.value) semester = Number(row.querySelector(".semester").value||1);
        else if (rec?.semester) semester = Number(rec.semester||1);
        const target = BATAS[semester]||0;

        const pct = v => { if(!target) return 0; let p=Math.floor((v/target)*100); if(p<0)p=0; return p; };
        const p1=pct(s1), p2=pct(s2), p3=pct(s3);
        const pSum = p1 + p2 + p3;

        let totalLabel = `${totalNum.toFixed(2)}&nbsp;juz`;
        if (totalNum >= 99999999999999999999999999) totalLabel = `<span style="color:#7c3aed;font-weight:600">KHATAM</span> (${totalNum.toFixed(2)} juz)`;

		var count = Number(rec && rec.cAll ? rec.cAll : 0);
var btnEnabled = count > 0;
var btnStyle = btnEnabled
  ? 'margin-left:6px;padding:3px 8px;font-size:12px;border:1px solid #d1d5db;border-radius:6px;background:#eef2ff;color:#4338ca;cursor:pointer'
  : 'margin-left:6px;padding:3px 8px;font-size:12px;border:1px solid #d1d5db;border-radius:6px;background:#f9fafb;color:#6b7280;cursor:not-allowed';
		
        cell.innerHTML =
  totalLabel +
  ' <span class="mur-range-badge" style="color:#6b7280; font-size:12px">total ' + pSum + '%</span> ' +
  '<small class="mur-range-count" data-link="' + (btnEnabled ? '1' : '0') + '" data-count="' + count + '" role="button" tabindex="' + (btnEnabled ? '0' : '-1') + '" ' +
  'aria-label="' + (btnEnabled ? ('Lihat ' + count + ' input murajaah dalam rentang') : 'Tidak ada input murajaah dalam rentang') + '" ' +
  'style="color:#6b7280;' + (btnEnabled ? 'cursor:pointer;text-decoration:underline' : '') + '">(' + count + ')</small> ' +
  '<button type="button" class="mur-range-list-btn" data-count="' + count + '" ' + (btnEnabled ? '' : 'disabled') + ' ' +
  'style="' + btnStyle + '" title="Daftar input murajaah (rentang)">Unduh</button>';

        cell.dataset.murRangeTotal = totalNum.toFixed(2);
        cell.dataset.murRangePsum  = String(pSum);
        const pAvg = Math.floor((p1+p2+p3)/3);
        cell.dataset.murRangePavg  = String(pAvg);
      });

      const totalKeys = Object.keys(rekap).length;
      await saveRangeServer(kelas, dari, sampai, totalKeys);
      saveRangeLocal(kelas, dari, sampai);

      $('#murRangeStatus') && ($('#murRangeStatus').textContent = "üü¢ Disimpan. Rentang ini akan otomatis terpakai saat refresh.");
    }catch(err){
      console.error(err);
      $('#murRangeStatus') && ($('#murRangeStatus').textContent = "‚ùå " + (err?.message || err));
      alert("‚ùå Terjadi kesalahan: " + (err?.message || err));
    }
  }

  window.bukaOverlayTotalMurRange = bukaOverlayTotalMurRange;
  $('#btnHitungTotalMur')?.addEventListener('click', hitungTotalMurRangeFromTable);

  // ====== RESET/SAVE overlay ‚Üí hapus di DB & local (robust) ======
  function resetRangeLocal(kelas){
    try{ localStorage.removeItem(LS_KEY(kelas)); }catch{}
  }
  function clearRangeBadgesInTable(){
    const table = (typeof getSantriTable === 'function') ? getSantriTable() : null;
    const rows = table?.tBodies?.[0]?.rows || [];
    [...rows].forEach(tr=>{
      const td = tr.querySelector('.total-mur-range');
      if (!td) return;
      td.innerHTML = '0.00&nbsp;juz ' +
  '<span class="mur-range-badge" style="color:#999; font-size:12px">total 0%</span> ' +
  '<small class="mur-range-count" data-link="0" data-count="0" role="button" tabindex="-1" aria-label="Tidak ada input murajaah dalam rentang" style="color:#6b7280">(0)</small> ' +
  '<button type="button" class="mur-range-list-btn" data-count="0" disabled ' +
  'style="margin-left:6px;padding:3px 8px;font-size:12px;border:1px solid #d1d5db;border-radius:6px;background:#f9fafb;color:#6b7280;cursor:not-allowed" ' +
  'title="Daftar input murajaah (rentang)">Unduh</button>';
      td.dataset.murRangeTotal = "0.00";
      td.dataset.murRangePsum  = "0";
      td.dataset.murRangePavg  = "0";
    });
  }

  document.getElementById('murRangeReset')?.addEventListener('click', async ()=>{
    const kelas = (typeof kelasNow==='function'? kelasNow() : '') || '';
    const dari  = document.getElementById('murRangeDari');
    const smp   = document.getElementById('murRangeSampai');
    const st    = document.getElementById('murRangeStatus');

    if (dari) dari.value = '';
    if (smp)  smp.value  = '';
    clearRangeBadgesInTable();
    if (st) st.textContent = '‚è≥ Menghapus setelan di server‚Ä¶';

    let ok = true;
    if (kelas) ok = await tryResetRangeServer(kelas);

    if (kelas) resetRangeLocal(kelas);

    if (ok){
      if (st) st.textContent = 'üü¢ Sudah di-reset (server & lokal). Klik Save untuk memastikan tersimpan kosong.';
    } else {
      if (st) st.textContent = '‚ùå Gagal hapus di server. Lihat Console.';
      alert('‚ùå Gagal reset di server. Cek Network/Console untuk detail.');
    }
  });

  document.getElementById('murRangeSave')?.addEventListener('click', async ()=>{
    const kelas  = (typeof kelasNow==='function'? kelasNow() : '') || '';
    const dariEl = document.getElementById('murRangeDari');
    const smpEl  = document.getElementById('murRangeSampai');
    const st     = document.getElementById('murRangeStatus');

    if (!kelas){ alert('Mohon pilih kelas.'); return; }

    const fromDate = (dariEl?.value||'').trim();
    const toDate   = (smpEl?.value||'').trim();

    try{
      if (!fromDate && !toDate){
        if (st) st.textContent = '‚è≥ Menyimpan penghapusan ke server‚Ä¶';
        const ok = await tryResetRangeServer(kelas);
        if (kelas) resetRangeLocal(kelas);
        clearRangeBadgesInTable();
        if (!ok) throw new Error('reset server gagal');
        if (st) st.textContent = 'üü¢ Tersimpan: setelan dihapus (server & lokal).';
        return;
      }

      if (st) st.textContent = '‚è≥ Menyimpan setelan‚Ä¶';
      await saveRangeServer(kelas, fromDate, toDate, 0);
      try{ localStorage.setItem(LS_KEY(kelas), JSON.stringify({ fromDate, toDate, t: Date.now() })); }catch{}
      if (st) st.textContent = 'üü¢ Tersimpan.';
    }catch(e){
      console.error(e);
      if (st) st.textContent = '‚ùå Gagal menyimpan.';
      alert('‚ùå Gagal menyimpan setelan.');
    }
  });

  // ===== Scheduler & Observer =====
  let autoRanForKelas = "";
  let autoApplyLock = false;
  let recalcTimer = null;
  let runningCalc = false;
  let tbodyObserver = null;

  function debounce(fn, ms){
    return function(...args){
      clearTimeout(recalcTimer);
      recalcTimer = setTimeout(()=>fn.apply(this,args), ms);
    };
  }

  async function scheduleRecalcMurRange(){
    const kelas = kelasNow();
    if (!kelas) return;
    const dari = $('#murRangeDari')?.value;
    const sampai = $('#murRangeSampai')?.value;
    if (!dari || !sampai) return;

    if (runningCalc) return;
    runningCalc = true;
    try { await hitungTotalMurRangeFromTable(); }
    finally { runningCalc = false; }
  }
  const scheduleRecalcMurRangeDebounced = debounce(scheduleRecalcMurRange, 100);

  function watchTableBody(){
    const table = getSantriTable();
    const tbody = table?.tBodies?.[0];
    if (!tbody) return;
    if (tbodyObserver) { try{tbodyObserver.disconnect();}catch{} }
    tbodyObserver = new MutationObserver((mut)=>{
      if (mut.some(m=>m.type==='childList')) {
        scheduleRecalcMurRangeDebounced();
      }
    });
    tbodyObserver.observe(tbody, { childList:true, subtree:false });
  }

  function waitForRows(timeoutMs=7000){
    return new Promise(resolve=>{
      const table = getSantriTable();
      const tbody = table?.tBodies?.[0];
      if (!tbody){ return resolve(false); }
      if (tbody.rows.length){ return resolve(true); }
      const obs = new MutationObserver(()=>{
        if (tbody.rows.length){
          obs.disconnect(); resolve(true);
        }
      });
      obs.observe(tbody, {childList:true, subtree:false});
      setTimeout(()=>{ try{obs.disconnect();}catch{} resolve(tbody.rows.length>0); }, timeoutMs);
    });
  }

  async function autoApplyMurRangeIfAvailable(){
    if (autoApplyLock) return;
    autoApplyLock = true;
    try{
      const kelas = kelasNow();
      const table = getSantriTable();
      if (!kelas || !table){ setTimeout(()=>{ autoApplyLock=false; autoApplyMurRangeIfAvailable(); }, 150); return; }
      if (autoRanForKelas === kelas){ autoApplyLock=false; return; }

      ensureMurRangeColumn();

      const ok = await waitForRows(7000);
      if (!ok){ autoApplyLock=false; return; }

      watchTableBody();

      const { fromDate, toDate } = await getRangeForKelas(kelas);
      if (fromDate && toDate){
        if ($('#murRangeDari'))   $('#murRangeDari').value   = fromDate;
        if ($('#murRangeSampai')) $('#murRangeSampai').value = toDate;

        requestAnimationFrame(()=> setTimeout(async ()=>{
          try{
            await hitungTotalMurRangeFromTable();
            autoRanForKelas = kelas;
          } finally {
            autoApplyLock = false;
          }
        }, 0));
        return;
      }
    } catch(e){
      console.warn('autoApplyMurRangeIfAvailable:', e);
    }
    autoApplyLock = false;
  }

  function afterTableRenderedMurRange(){
    ensureMurRangeColumn();
    autoApplyMurRangeIfAvailable();
  }

  const _origLoad = window.loadSantriData;
  window.loadSantriData = async function(...args){
    const kelasBefore = kelasNow();
    await (_origLoad?.apply ? _origLoad.apply(this, args) : Promise.resolve());
    setTimeout(afterTableRenderedMurRange, 30);
    const kelasAfter = kelasNow();
    if (kelasBefore !== kelasAfter){ autoRanForKelas = ""; }
  };

  ['#kelasSelect','#kelas','select[name="kelas"]','.kelas','.kelasSelect','.kelas-select'].forEach(sel=>{
    const el = document.querySelector(sel);
    if (el) el.addEventListener('change', ()=>{
      autoRanForKelas = "";
      setTimeout(()=>{ autoApplyMurRangeIfAvailable(); }, 200);
    });
  });

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', afterTableRenderedMurRange);
  } else {
    afterTableRenderedMurRange();
  }

  window.hitungTotalMurRangeFromTable = hitungTotalMurRangeFromTable;
  window.getRangeForKelas = window.getRangeForKelas || getRangeForKelas;
  window.kelasNow        = window.kelasNow        || kelasNow;
  window.getSantriTable  = window.getSantriTable  || getSantriTable;
})();
</script>

<script>
(function(){
  function fmtID(iso){ if(!iso) return ''; var a=String(iso).split('-'); return a.length===3? (a[2]+'/'+a[1]+'/'+a[0]) : iso; }
  function num(v){ var n=parseFloat(String(v==null?'':v).replace(/[^0-9.,-]/g,'').replace(',', '.')); return isFinite(n)?n:0; }
  // === Tambahan: update total keseluruhan di bawah tabel modal ===
function updateMrlSum(list){
  var sum = (list||[]).reduce(function(acc, it){
    return acc + num(it.total);
  }, 0);
  var box = document.getElementById('mrl-sum');
  if (!box) return;
  if (!list || !list.length){
    box.style.display = 'none';
  } else {
    box.textContent = 'Total keseluruhan: ' + sum.toFixed(2) + ' juz';
    box.style.display = '';
  }
}

	
  function _kelasNow(){
    if (window.kelasNow) return window.kelasNow();
    var sel = document.querySelector('select#kelasSelect, select[name="kelas"], #kelas, .kelas, .kelas-select, .kelasSelect');
    if (sel && sel.value) return String(sel.value).trim();
    var ref = document.querySelector('[data-kelas]');
    if (ref && ref.dataset && ref.dataset.kelas) return String(ref.dataset.kelas).trim();
    try{ var last=localStorage.getItem('lastKelas'); if (last) return String(last).trim(); }catch(e){}
    return '';
  }
  function _getSantriTable(){
    if (window.getSantriTable) return window.getSantriTable();
    return document.getElementById('santri-table')
        || document.getElementById('santriTable')
        || document.querySelector('table[data-role="santri-table"]')
        || document.querySelector('table.santri-table')
        || null;
  }
  async function _getRangeForKelas(kelas){
    if (window.getRangeForKelas){
      try{ var r = await window.getRangeForKelas(kelas); if (r && (r.fromDate || r.toDate)) return r; }catch(e){}
    }
    var dariEl = document.getElementById('murRangeDari');
    var smpEl  = document.getElementById('murRangeSampai');
    return { fromDate: (dariEl && dariEl.value ? dariEl.value : ''), toDate: (smpEl && smpEl.value ? smpEl.value : '') };
  }

  // Peta warna untuk predikat huruf
function predStyle(p){
  var t = (p==null?'':String(p)).toUpperCase().trim();
  if (t === 'A+') return { bg:'#dcfce7', fg:'#166534', br:'#86efac' }; // hijau muda
  if (t === 'A')  return { bg:'#eafaf0', fg:'#166534', br:'#a7f3d0' }; // hijau lebih pucat
  if (t === 'B')  return { bg:'#dbeafe', fg:'#1e3a8a', br:'#93c5fd' }; // biru muda
  if (t === 'C')  return { bg:'#ffedd5', fg:'#9a3412', br:'#fdba74' }; // oranye muda
  if (t === 'D')  return { bg:'#ffe4e6', fg:'#9f1239', br:'#fecdd3' }; // merah muda
  return null;
}

// Fallback: konversi skor ‚Üí huruf (kalau pHuruf kosong)
function hurufFromScore(sc){
  var s = Math.max(0, Math.min(100, Math.floor(Number(sc)||0)));
  if (s === 0) return '';          // 0 = tidak ada predikat
  if (s <= 59) return 'D';
  if (s <= 69) return 'C';
  if (s <= 79) return 'B';
  if (s <= 89) return 'A';
  return 'A+';
}

  function sesLine(s){
    if (!s) return '-';
    var hasRange = (s.from && s.from.length) || (s.to && s.to.length);
    var range = hasRange ? ((s.from||'') + ' \u2192 ' + (s.to||'')) : (s.pages||'');
    var juz   = (s.juz!=null && s.juz!=='') ? (' \u2022 ' + num(s.juz).toFixed(2) + ' juz') : '';
    var score = (s.score!=null && s.score!=='') ? (' \u2022 Nilai ' + Math.floor(Number(s.score)||0)) : '';
    var huruf = (s.pHuruf ? (' ('+s.pHuruf+')') : '');
    var txt = '';
    if (range && range.length) txt += range;
    if (juz) txt += juz;
    if (score) txt += score;
    if (huruf) txt += huruf;
    return txt || '-';
  }

  function extractSessions(rec){
  function s(i){
    return {
      from:  (rec['murFrom'+i]  != null ? rec['murFrom'+i]  : (rec.murSessions && rec.murSessions[i-1] ? rec.murSessions[i-1].from  : (i===1?rec.murFrom:undefined))) || '',
      to:    (rec['murTo'+i]    != null ? rec['murTo'+i]    : (rec.murSessions && rec.murSessions[i-1] ? rec.murSessions[i-1].to    : (i===1?rec.murTo:undefined)))   || '',
      pages: (rec['murPages'+i] != null ? rec['murPages'+i] : (rec.murSessions && rec.murSessions[i-1] ? rec.murSessions[i-1].pages : (i===1?rec.murPages:undefined)))|| '',
      juz:   (rec['juzmur'+i]   != null ? rec['juzmur'+i]   : (rec['juzSesi'+i] != null ? rec['juzSesi'+i] : (rec.murSessions && rec.murSessions[i-1] ? rec.murSessions[i-1].juz : undefined))),
      score: (rec['murScore'+i] != null ? rec['murScore'+i] : (rec.murSessions && rec.murSessions[i-1] ? rec.murSessions[i-1].score : undefined)),
      pHuruf:(rec['murPredHuruf'+i] != null ? rec['murPredHuruf'+i] : (rec.murSessions && rec.murSessions[i-1] ? rec.murSessions[i-1].predikatHuruf : '')),
      jFrom: (rec['jFrom'+i] != null ? rec['jFrom'+i] : (rec.murSessions && rec.murSessions[i-1] ? rec.murSessions[i-1].jFrom : undefined)),
      jTo:   (rec['jTo'+i]   != null ? rec['jTo'+i]   : (rec.murSessions && rec.murSessions[i-1] ? rec.murSessions[i-1].jTo   : undefined))
    };
  }
  var s1=s(1), s2=s(2), s3=s(3);
  var total = num(rec.juzmurajaah!=null ? rec.juzmurajaah : (rec.totalJuz!=null ? rec.totalJuz : (num(s1.juz)+num(s2.juz)+num(s3.juz))));
  return { s1:s1, s2:s2, s3:s3, total: total };
}

	// === JUZ META & helper posisi juz (biarkan seperti sebelumnya) ===
var JUZ_META = {
  1:{ sFrom:1,aFrom:1,sTo:2,aTo:141 },  2:{ sFrom:2,aFrom:142,sTo:2,aTo:252 },
  3:{ sFrom:2,aFrom:253,sTo:3,aTo:92 }, 4:{ sFrom:3,aFrom:93,sTo:4,aTo:23 },
  5:{ sFrom:4,aFrom:24,sTo:4,aTo:147 }, 6:{ sFrom:4,aFrom:148,sTo:5,aTo:81 },
  7:{ sFrom:5,aFrom:82,sTo:6,aTo:110 }, 8:{ sFrom:6,aFrom:111,sTo:7,aTo:87 },
  9:{ sFrom:7,aFrom:88,sTo:8,aTo:40 }, 10:{ sFrom:8,aFrom:41,sTo:9,aTo:92 },
 11:{ sFrom:9,aFrom:93,sTo:11,aTo:5 }, 12:{ sFrom:11,aFrom:6,sTo:12,aTo:52 },
 13:{ sFrom:12,aFrom:53,sTo:14,aTo:52 },14:{ sFrom:15,aFrom:1,sTo:16,aTo:128 },
 15:{ sFrom:17,aFrom:1,sTo:18,aTo:74 },16:{ sFrom:18,aFrom:75,sTo:20,aTo:135 },
 17:{ sFrom:21,aFrom:1,sTo:22,aTo:78 },18:{ sFrom:23,aFrom:1,sTo:25,aTo:20 },
 19:{ sFrom:25,aFrom:21,sTo:27,aTo:55 },20:{ sFrom:27,aFrom:56,sTo:29,aTo:45 },
 21:{ sFrom:29,aFrom:46,sTo:33,aTo:30 },22:{ sFrom:33,aFrom:31,sTo:36,aTo:27 },
 23:{ sFrom:36,aFrom:28,sTo:39,aTo:31 },24:{ sFrom:39,aFrom:32,sTo:41,aTo:46 },
 25:{ sFrom:41,aFrom:47,sTo:45,aTo:37 },26:{ sFrom:46,aFrom:1,sTo:51,aTo:30 },
 27:{ sFrom:51,aFrom:31,sTo:57,aTo:29 },28:{ sFrom:58,aFrom:1,sTo:66,aTo:12 },
 29:{ sFrom:67,aFrom:1,sTo:77,aTo:50 },30:{ sFrom:78,aFrom:1,sTo:114,aTo:6 }
};
function juzOfAyah(s,a){
  function gt(x1,y1,x2,y2){ return (x1>x2) || (x1===x2 && y1>y2); }
  function ge(x1,y1,x2,y2){ return (x1>x2) || (x1===x2 && y1>=y2); }
  for (var j=1;j<=30;j++){
    var m=JUZ_META[j];
    if (ge(s,a,m.sFrom,m.aFrom) && !gt(s,a,m.sTo,m.aTo)) return j;
  }
  return 30;
}
function parseSA(sa){
  if(!sa) return null;
  var parts=String(sa).split(':'); if(parts.length<2) return null;
  var s=parseInt(parts[0],10), a=parseInt(parts[1],10);
  if(!isFinite(s)||!isFinite(a)) return null;
  return {s:s,a:a};
}

// Atur output jika tidak ada range SA. Pilih '' (kosong) atau '0'
var MRL_EMPTY_OUTPUT = ''; // ubah ke '0' jika ingin angka 0

function renderSessionHTML(s){
  if (!s) return MRL_EMPTY_OUTPUT;

  // validasi harus ada "surah:ayat" ‚Üí "surah:ayat"
  var reSA = /^\s*\d+\s*:\s*\d+\s*$/;
  var hasFrom = !!(s.from && reSA.test(String(s.from)));
  var hasTo   = !!(s.to   && reSA.test(String(s.to)));
  if (!(hasFrom && hasTo)){
    // Tidak ada keterangan SA lengkap ‚Üí kosong/0
    return MRL_EMPTY_OUTPUT;
  }

  // === lanjut sama seperti sebelumnya (range + Juz X‚ÄìY + Nilai + badge warna) ===
  var range = (s.from||'') + ' \u2192 ' + (s.to||'');

  // hitung/ambil jFrom-jTo
  var jFrom = (s.jFrom!=null && s.jFrom!=='') ? Number(s.jFrom) : null;
  var jTo   = (s.jTo  !=null && s.jTo  !=='') ? Number(s.jTo)   : null;
  if (jFrom==null || jTo==null){
    var pf = parseSA(s.from), pt = parseSA(s.to);
    if (pf) jFrom = juzOfAyah(pf.s, pf.a);
    if (pt) jTo   = juzOfAyah(pt.s, pt.a);
  }
  var juzTxt = '';
  if (jFrom && jTo) juzTxt = (jFrom===jTo) ? ('Juz ' + jFrom) : ('Juz ' + jFrom + '\u2013' + jTo);
  else if (jFrom)   juzTxt = 'Juz ' + jFrom;

  // nilai + huruf (fallback huruf dari score)
  var huruf = (s.pHuruf && String(s.pHuruf).trim()) ? String(s.pHuruf).toUpperCase() : '';
  if (!huruf && s.score!=null && s.score!==''){ huruf = hurufFromScore(s.score); }
  var scoreTxt = '';
  if (s.score!=null && s.score!==''){
    scoreTxt = 'Nilai ' + Math.floor(Number(s.score)||0) + (huruf ? (' ('+huruf+')') : '');
  } else if (huruf){
    scoreTxt = huruf;
  }

  var parts = [];
  if (range) parts.push(range);
  if (juzTxt) parts.push(juzTxt);
  if (scoreTxt) parts.push(scoreTxt);
  var inner = parts.join(' \u2022 ');

  var st = predStyle(huruf);
  if (!st) return inner;
  return '<div style="display:inline-block;border-radius:8px;padding:6px 8px;border:1px solid '+st.br+';background:'+st.bg+';color:'+st.fg+'">'+ inner +'</div>';
}

  async function openMurRangeListForRow(tr){
    var box = document.getElementById('murRangeListModal');
    if (!box){ alert('Modal murRangeListModal belum ditambahkan (Langkah 1).'); return; }

    var kelas = _kelasNow();
    if (!kelas){ alert('Mohon pilih kelas.'); return; }

    var rng = await _getRangeForKelas(kelas);
    var fromDate = rng && rng.fromDate ? rng.fromDate : '';
    var toDate   = rng && rng.toDate   ? rng.toDate   : '';
    if (!fromDate || !toDate){ alert('Rentang tanggal belum disetel. Klik header "Setting Murajaah" untuk mengatur.'); return; }

    var res = await fetch('/api/getAbsensiRange?kelas=' + encodeURIComponent(kelas) + '&start=' + encodeURIComponent(fromDate) + '&end=' + encodeURIComponent(toDate) + '&t=' + Date.now());
    if (!res.ok){ alert('Gagal mengambil data rentang.'); return; }
    var payload = await res.json();
    var all = Array.isArray(payload) ? payload : (payload && payload.list ? payload.list : []);

    var namaRow = tr && tr.children && tr.children[1] ? (tr.children[1].childNodes && tr.children[1].childNodes[0] ? tr.children[1].childNodes[0].textContent : tr.children[1].textContent) : '';
    namaRow = (namaRow || '').trim();
    var nisRow  = tr && tr.dataset && tr.dataset.nis ? String(tr.dataset.nis).trim() : '';
    var keyRow  = tr && tr.dataset ? (String(tr.dataset.key || tr.dataset.nis || tr.dataset.id || '').trim().toLowerCase()) : '';

    var table = _getSantriTable();
    var rows  = table && table.tBodies && table.tBodies[0] ? Array.prototype.slice.call(table.tBodies[0].rows) : [];
    var nameToKey = new Map();
    for (var r=0;r<rows.length;r++){
      var rr = rows[r];
      var k = rr && rr.dataset ? String(rr.dataset.nis || rr.dataset.id || rr.dataset.key || '').trim().toLowerCase() : '';
      var nm= rr && rr.children && rr.children[1] ? (rr.children[1].childNodes && rr.children[1].childNodes[0] ? rr.children[1].childNodes[0].textContent : rr.children[1].textContent) : '';
      nm = (nm || '').trim().toLowerCase();
      if (k && nm) nameToKey.set(nm, k);
    }
    var myKey = keyRow || nameToKey.get(namaRow.toLowerCase()) || '';

    var mine = all.filter(function(rec){
      var rkey = String((rec && (rec.nis!=null ? rec.nis : rec.id)) || '').trim().toLowerCase();
      if (myKey && rkey) return rkey === myKey;
      var rnm = String(rec && rec.nama ? rec.nama : '').trim().toLowerCase();
      return (namaRow && rnm && rnm === namaRow.toLowerCase());
    });

    var normalized = mine.map(function(rec){
      var ss = extractSessions(rec);
      return { tanggal: (rec && (rec.tanggal || rec.date) ? (rec.tanggal || rec.date) : ''), total:ss.total, s1:ss.s1, s2:ss.s2, s3:ss.s3 };
    }).sort(function(a,b){ return String(a.tanggal||'').localeCompare(String(b.tanggal||'')); });

    document.getElementById('mrl-title').textContent = 'Daftar Murajaah (Rentang)';
    document.getElementById('mrl-sub').textContent =
      (namaRow ? ('Nama: ' + namaRow + ' ‚Ä¢ ') : '') +
      (nisRow ? ('NIS: ' + nisRow + ' ‚Ä¢ ') : '') +
      ('Rentang: ' + fmtID(fromDate) + ' s.d. ' + fmtID(toDate) + ' ‚Ä¢ Total hari: ' + normalized.length);

    var tb = document.getElementById('mrl-tbody');
    var empty = document.getElementById('mrl-empty');
    tb.innerHTML = '';
    if (!normalized.length){
      empty.style.display='block';
    } else {
      empty.style.display='none';
      for (var i=0;i<normalized.length;i++){
        var it = normalized[i];
        var trEl = document.createElement('tr');
        if (i%2===1) trEl.style.background = '#fafafa';
        trEl.innerHTML =
  '<td style="padding:8px 10px;border-bottom:1px solid #eee;vertical-align:top">'+ fmtID(it.tanggal||'') +'</td>' +
  '<td style="padding:8px 10px;border-bottom:1px solid #eee;vertical-align:top"><b>'+ num(it.total).toFixed(2) +' juz</b></td>' +
  '<td style="padding:8px 10px;border-bottom:1px solid #eee;white-space:pre-wrap;vertical-align:top">'+ renderSessionHTML(it.s1) +'</td>' +
'<td style="padding:8px 10px;border-bottom:1px solid #eee;white-space:pre-wrap;vertical-align:top">'+ renderSessionHTML(it.s2) +'</td>' +
'<td style="padding:8px 10px;border-bottom:1px solid #eee;white-space:pre-wrap;vertical-align:top">'+ renderSessionHTML(it.s3) +'</td>'
        tb.appendChild(trEl);
      }
    }
	updateMrlSum(normalized);

    var search = document.getElementById('mrl-search');
    search.value = '';
    search.oninput = function(){
      var q = (search.value || '').trim().toLowerCase();
      var filtered = normalized.filter(function(it){
        var hay = [
          it.tanggal, it.total,
          it.s1 && it.s1.from, it.s1 && it.s1.to, it.s1 && it.s1.pages, it.s1 && it.s1.score, it.s1 && it.s1.pHuruf,
          it.s2 && it.s2.from, it.s2 && it.s2.to, it.s2 && it.s2.pages, it.s2 && it.s2.score, it.s2 && it.s2.pHuruf,
          it.s3 && it.s3.from, it.s3 && it.s3.to, it.s3 && it.s3.pages, it.s3 && it.s3.score, it.s3 && it.s3.pHuruf
        ].join(' ').toLowerCase();
        return hay.indexOf(q) !== -1;
      });
      tb.innerHTML='';
      if (!filtered.length){ empty.style.display='block'; return; }
      empty.style.display='none';
      for (var j=0;j<filtered.length;j++){
        var it2 = filtered[j];
        var trEl2 = document.createElement('tr');
        if (j%2===1) trEl2.style.background = '#fafafa';
        trEl2.innerHTML =
  '<td style="padding:8px 10px;border-bottom:1px solid #eee;vertical-align:top">'+ fmtID(it2.tanggal||'') +'</td>' +
  '<td style="padding:8px 10px;border-bottom:1px solid #eee;vertical-align:top"><b>'+ num(it2.total).toFixed(2) +' juz</b></td>' +
  '<td style="padding:8px 10px;border-bottom:1px solid #eee;white-space:pre-wrap;vertical-align:top">'+ renderSessionHTML(it2.s1) +'</td>' +
'<td style="padding:8px 10px;border-bottom:1px solid #eee;white-space:pre-wrap;vertical-align:top">'+ renderSessionHTML(it2.s2) +'</td>' +
'<td style="padding:8px 10px;border-bottom:1px solid #eee;white-space:pre-wrap;vertical-align:top">'+ renderSessionHTML(it2.s3) +'</td>'
        tb.appendChild(trEl2);
      }
	updateMrlSum(filtered);
    };

    box.style.display = 'flex';
  }

  // Klik tombol "Lihat"
  document.addEventListener('click', function(ev){
    var btn = ev.target && ev.target.closest ? ev.target.closest('.mur-range-list-btn') : null;
    if (!btn) return;
    if (btn.hasAttribute('disabled')) return;
    var tr = btn.closest('tr'); if (!tr) return;
    openMurRangeListForRow(tr);
  });

  // Tutup modal
  document.addEventListener('click', function(e){
    var box = document.getElementById('murRangeListModal');
    if (!box) return;
    if (e.target && typeof e.target.hasAttribute === 'function' && e.target.hasAttribute('data-close-mur-range-list')){
      box.style.display = 'none';
    }
  });
  document.addEventListener('keydown', function(e){
    var box = document.getElementById('murRangeListModal');
    if (box && e.key === 'Escape' && box.style.display !== 'none'){
      box.style.display = 'none';
    }
  });
})();

// ============================
// D. MURAJAAH 3 SESI
// ============================	
</script>

<script>
  // ====== KONFIG (opsional dari window.*) ======
  const JENJANG_MAX = Number(window.JENJANG_MAX ?? 14);             // 34 default; 0 = tanpa batas atas
  const JENJANG_SAFETY_CAP = Number(window.JENJANG_SAFETY_CAP ?? 1000); // darurat bila tanpa batas

  // ====== Helper jenjang dinamis ======
  function parseJenjang(v) {
    const m = /^A(\d+)$/.exec(String(v || "").trim());
    return m ? Number(m[1]) : null;
  }

  // kosong = valid; selain itu harus "A<number>" minimal A1, dan <= JENJANG_MAX (kecuali 0)
  function isValidJenjang(v, max = JENJANG_MAX) {
    if (!v) return true;
    const n = parseJenjang(v);
    if (!Number.isFinite(n) || n < 1) return false;
    if (!max || max === 0) return true; // tanpa batas atas
    return n <= max;
  }

  // Tambahkan A1..A{limit} yang belum ada (tidak merusak label existing)
  function extendJenjangOptions(selectEl, max = JENJANG_MAX) {
    if (!selectEl) return;
    const existing = new Set([...selectEl.options].map(o => String(o.value || "").trim()));
    const frag = document.createDocumentFragment();

    const limit = (!max || max === 0) ? JENJANG_SAFETY_CAP : max;
    for (let i = 1; i <= limit; i++) {
      const val = `A${i}`;
      if (!existing.has(val)) {
        const opt = document.createElement("option");
        opt.value = val;
        opt.textContent = val; // label default untuk opsi baru
        frag.appendChild(opt);
      }
    }
    if (frag.childNodes.length) selectEl.appendChild(frag);
  }

  // ===== Tambah Santri =====
  function bukaModalSantri() {
    document.getElementById("modalSantri").style.display = "block";
    // Pastikan opsi jenjang ter-extend setiap buka modal (aman dipanggil berulang)
    const jenSel = document.getElementById("inputJenjang");
    if (jenSel) extendJenjangOptions(jenSel, JENJANG_MAX);
  }

  const semSel = document.getElementById("inputSemester");
  if (semSel) extendSemesterOptions(semSel);

  // Disesuaikan dengan pemanggilanmu: tutupModal('modalSantri')
  function tutupModal(id) {
    const modal = document.getElementById(id || "modalSantri");
    if (modal) modal.style.display = "none";
    // reset form
    document.getElementById("inputNama").value = "";
    document.getElementById("inputNis").value = "";
    document.getElementById("inputSemester").value = "1";
    const jenSel = document.getElementById("inputJenjang");
    if (jenSel) jenSel.value = ""; // reset ke opsi kosong
    document.getElementById("loadingTambahSantri").style.display = "none";
    const btn = document.getElementById("btnSimpanSantri");
    if (btn) { btn.disabled = false; btn.textContent = "Simpan"; btn.style.opacity = ""; btn.style.cursor = ""; }
  }

  // Extend opsi saat halaman siap (kalau modal dibuka pertama kali)
  document.addEventListener("DOMContentLoaded", () => {
    const jenSel = document.getElementById("inputJenjang");
    if (jenSel) extendJenjangOptions(jenSel, JENJANG_MAX);
  });

  async function simpanSantriBaru() {
    const nama     = document.getElementById("inputNama").value.trim();
    const nis      = document.getElementById("inputNis").value.trim();
    const semester = document.getElementById("inputSemester").value;
    const jenjang  = (document.getElementById("inputJenjang")?.value || "").trim();
    const kelas    = document.getElementById("kelas").value; // dropdown kelas utama

    // Validasi dasar
    if (!nama) { alert("Nama tidak boleh kosong."); return; }
    if (!nis)  { alert("NIS tidak boleh kosong.");  return; }
    if (!isValidSemester(semester)) {
  alert(`Semester harus 1-${SEMESTER_MAX}.`);
  return;
}
    if (!isValidJenjang(jenjang)) {
      alert(`Jenjang harus A1 - A${JENJANG_MAX || "‚àû"} (atau kosong).`);
      return;
    }

    const loadingEl = document.getElementById("loadingTambahSantri");
    const btn = document.getElementById("btnSimpanSantri");
    loadingEl.style.display = "block";
    if (btn) { btn.disabled = true; btn.textContent = "Menyimpan‚Ä¶"; btn.style.opacity = "0.6"; btn.style.cursor = "not-allowed"; }

    try {
      const res = await fetch("/api/tambahSantri", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nama, nis, semester, jenjang, kelas })
      });

      const data = await res.json().catch(() => ({}));
      loadingEl.style.display = "none";

      if (res.ok && (data?.success ?? true)) {
        alert("Santri berhasil ditambahkan!");
        tutupModal("modalSantri");
        location.reload(); // refresh map master (semester/jenjang)
      } else {
        alert("Gagal menambahkan: " + (data?.error || res.statusText));
        if (btn) { btn.disabled = false; btn.textContent = "Simpan"; btn.style.opacity = ""; btn.style.cursor = ""; }
      }
    } catch (err) {
      loadingEl.style.display = "none";
      alert("Terjadi kesalahan: " + err.message);
      if (btn) { btn.disabled = false; btn.textContent = "Simpan"; btn.style.opacity = ""; btn.style.cursor = ""; }
    }
  }
</script>


<script>
const btnHapusSantri = document.getElementById("btnHapusSantri");
const modalHapusSantri = document.getElementById("modalHapusSantri");
const listSantriHapus = document.getElementById("listSantriHapus");
const btnHapusTerpilih = document.getElementById("btnHapusTerpilih");
const btnTutupModal = document.getElementById("btnTutupModal");

// Tombol untuk menutup modal
btnTutupModal.addEventListener("click", () => {
  modalHapusSantri.style.display = "none";
});

// Tombol untuk membuka modal dan load santri
btnHapusSantri.addEventListener("click", async () => {
  modalHapusSantri.style.display = "flex";
  listSantriHapus.innerHTML = "<li>Loading...</li>";

  const kelas = kelasSelect.value; // Ambil kelas dari select
  try {
    const res = await fetch(`/api/ambilSantri?kelas=${kelas}`);
    const santriData = await res.json();

    if (!Array.isArray(santriData)) {
      console.error("Santri data bukan array:", santriData);
      listSantriHapus.innerHTML = "<li>Gagal load data</li>";
      return;
    }

    listSantriHapus.innerHTML = "";
    if (santriData.length === 0) {
      listSantriHapus.innerHTML = "<li>Tidak ada santri di kelas ini</li>";
      return;
    }

    santriData.forEach(s => {
      const li = document.createElement("li");
      li.style.marginBottom = "5px";
      li.innerHTML = `<label>
        <input type="checkbox" value="${s.id || s.nis}"> ${s.nama} (${s.id || s.nis})
      </label>`;
      listSantriHapus.appendChild(li);
    });
  } catch (err) {
    console.error(err);
    listSantriHapus.innerHTML = "<li>Gagal load data</li>";
  }
});

// Tombol hapus terpilih
btnHapusTerpilih.addEventListener("click", async () => {
  const checked = listSantriHapus.querySelectorAll("input:checked");
  if (checked.length === 0) return alert("Pilih santri terlebih dahulu");

  const kelas = kelasSelect.value;
  for (let c of checked) {
    const identifier = c.value;
    try {
      const res = await fetch(`/api/hapusSantri`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ kelas, identifier })
      });
      const result = await res.json();
      console.log("Hasil hapus:", result);
    } catch (err) {
      console.error("Gagal hapus:", err);
    }
  }

  modalHapusSantri.style.display = "none";

  // Refresh tabel utama
  if (typeof loadSantriData === "function") {
    loadSantriData();
  }
});
</script>


<script>
(() => {
  const elBtnOpen   = document.getElementById('btnPindahKelas');
  const elModal     = document.getElementById('modalPindahKelas');
  const elClose     = document.getElementById('closePindah');
  const elSantriSel = document.getElementById('selectSantriPindah');
  const elKelasWrap = document.getElementById('listKelasTujuan');
  const elDo        = document.getElementById('doPindah');
  const elStatus    = document.getElementById('statusPindah');

  const normKelas = (k) => (k?.startsWith('kelas_') ? k : `kelas_${k}`);

  async function ensureAbsensiAda(kelas, tanggal) {
    try {
      const url = `/api/getAbsensi?kelas=${encodeURIComponent(kelas)}&tanggal=${encodeURIComponent(tanggal)}&t=${Date.now()}`;
      const r = await fetch(url);
      return (r.status === 200 || r.status === 404);
    } catch { return false; }
  }

  let elStart = document.getElementById('startDateMove');
function ensureStartDateInput() {
  if (!elStart) {
    const holder = document.createElement('div');

    // blok tanggal yang tidak melebar & punya jarak ke tombol
    holder.style.display = 'inline-flex';
    holder.style.flexDirection = 'column'; // label di atas input
    holder.style.flex = '0 0 auto';        // JANGAN width:100%
    holder.style.margin = '0 12px 0 0';    // jarak ke tombol

    holder.innerHTML = `
      <label style="margin-bottom:4px;"><b>Mulai dari tanggal (opsional):</b></label>
      <input type="date" id="startDateMove" style="width:260px;max-width:100%;">
    `;

    const row = elDo.parentElement; // div flex yang berisi tombol & status
    // pastikan properti baris sudah di-set (kalau belum diubah di HTML)
    row.style.gap = '12px';
    row.style.alignItems = 'flex-end';
    row.style.flexWrap = 'wrap';

    row.insertBefore(holder, elDo);
    elStart = holder.querySelector('#startDateMove');
  }
}

  elBtnOpen.addEventListener('click', openModal);
  elClose.addEventListener('click', () => elModal.style.display = 'none');

  async function openModal() {
    elModal.style.display = 'flex';
    elStatus.textContent = '';
    elDo.disabled = false;
    ensureStartDateInput();

    const kelasAsal = normKelas(kelasSelect.value);

    // 1) load santri
    try {
      const r = await fetch(`/api/ambilSantri?kelas=${encodeURIComponent(kelasAsal)}&t=${Date.now()}`);
      const data = await r.json();
      elSantriSel.innerHTML = (Array.isArray(data) ? data : []).map(s => {
        const id   = s.id   ?? '';
        const nis  = s.nis  ?? '';
        const nama = s.nama ?? '';
        return `<option value="${String(nis || id || '')}"
                        data-id="${String(id)}"
                        data-nis="${String(nis)}"
                        data-nama="${String(nama)}">
          ${nama} (${nis || id || '-'})
        </option>`;
      }).join('');
    } catch {
      elSantriSel.innerHTML = '';
    }

    // 2) load kelas tujuan
    try {
      const rK = await fetch(`/api/ambilKelas?t=${Date.now()}`);
      const kelasList = await rK.json();

      // [PERUBAHAN] ganti isi wrapper menjadi <select size=8> agar scroll otomatis
      elKelasWrap.innerHTML = '<select id="selectKelasTujuan" size="8" style="width:100%;margin:6px 0;"></select>';
      const selTujuan = document.getElementById('selectKelasTujuan');

      const opts = (Array.isArray(kelasList) ? kelasList : [])
        .map(normKelas)
        .filter(k => k !== kelasAsal)
        .map(k => `<option value="${k}">${k}</option>`)
        .join('');
      selTujuan.innerHTML = opts || '<option disabled>(tidak ada kelas tujuan)</option>';
    } catch {
      elKelasWrap.innerHTML = '<em>Gagal memuat daftar kelas.</em>';
    }
  }

  async function postJSON(url, payload) {
    const res = await fetch(url, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    let out = {};
    try { out = await res.json(); } catch {}
    return { res, out };
  }

  elDo.addEventListener('click', async () => {
    const kelasAsal   = normKelas(kelasSelect.value);

    // [PERUBAHAN] ambil pilihan dari <select id="selectKelasTujuan">
    const selTujuanEl = document.getElementById('selectKelasTujuan');
    const kelasTujuan = normKelas(selTujuanEl?.value || '');

    const selected    = Array.from(elSantriSel.selectedOptions);

    if (!selected.length) { alert('Pilih minimal satu santri.'); return; }
    if (!kelasTujuan)     { alert('Pilih kelas tujuan.'); return; }

    const ids   = [...new Set(selected.map(o => (o.dataset.id  || '').trim()).filter(Boolean))];
    const nises = [...new Set(selected.map(o => (o.dataset.nis || '').trim()).filter(Boolean))];
    const names = [...new Set(selected.map(o => (o.dataset.nama || '').trim().toLowerCase()).filter(Boolean))];
    const identifiers = Array.from(new Set([...ids, ...nises, ...names])); // untuk roster

    const startDate = (elStart?.value || '').trim();

    elDo.disabled = true;
    elStatus.style.color = '#333';
    elStatus.textContent = startDate ? `Memproses mulai ${startDate}‚Ä¶` : 'Memproses semua tanggal‚Ä¶';

    try {
      // 1) Pindah ROSTER
      const { res: r1, out: o1 } = await postJSON('/api/pindahRosterKelas', {
        kelasAsal, kelasTujuan, identifiers
      });
      if (!r1.ok || !o1.success) {
        elStatus.style.color = 'red';
        elStatus.textContent = (o1.error || `HTTP ${r1.status}`) + (o1.detail ? `: ${o1.detail}` : '');
        elDo.disabled = false;
        return;
      }
      const idMap = Array.isArray(o1.idMap) ? o1.idMap : [];
      const payloadCommon = { kelasAsal, kelasTujuan, ids, nises, idMap };

      // 2) Pindah ABSENSI
      let r2, o2 = {};
      if (startDate) {
        r2 = await fetch('/api/pindahKelasMulaiTanggal', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ ...payloadCommon, startDate })
        });
        if (r2.status === 404) {
          r2 = await fetch('/api/pindahKelasSemuaTanggal', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payloadCommon)
          });
        }
      } else {
        r2 = await fetch('/api/pindahKelasSemuaTanggal', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payloadCommon)
        });
      }
      try { o2 = await r2.json(); } catch {}
      if (!r2.ok || !o2.success) {
        elStatus.style.color = 'red';
        elStatus.textContent = (o2.error || `HTTP ${r2.status}`) + (o2.detail ? `: ${o2.detail}` : '');
        elDo.disabled = false;
        return;
      }

      elStatus.style.color = 'green';
      elStatus.textContent = `Selesai. Roster & absensi (${o2.totalMoved ?? 'n/a'} entri) dipindahkan${startDate ? ' sejak ' + startDate : ''}.`;

      if (window.tanggalFilterAkhir) {
        tanggalFilterAkhir.value = "";
        try { localStorage.removeItem("tanggalFilterAkhirTerakhir"); } catch(_){}
      }
      kelasSelect.value = kelasTujuan;
      try { localStorage.setItem("kelasTerakhir", kelasTujuan); } catch(_){}
      const today = new Date().toLocaleDateString('sv-SE');
      const tanggalAktif = (tanggalInput?.value || today);
      await ensureAbsensiAda(kelasTujuan, tanggalAktif);

      if (typeof loadSantriData === 'function') await loadSantriData();
      setTimeout(() => { elModal.style.display = 'none'; }, 800);

    } catch (e) {
      console.error(e);
      elStatus.style.color = 'red';
      elStatus.textContent = 'Kesalahan jaringan/servis.';
      elDo.disabled = false;
    }
  });
})();
</script>
  

  <script>
  function tutupModal(id) {
    const modal = document.getElementById(id);
    if (modal) {
      modal.style.display = "none";
    }
  }

    function tutupModal(id) {
  if (!id) return; // jika tidak ada ID, keluar saja
  const modal = document.getElementById(id);
  if (modal) {
    modal.style.display = "none";
  }
}
</script>

	  <script>
document.getElementById("login-form").addEventListener("submit", (e) => {
  e.preventDefault();
  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;
  console.log("Login:", username, password);
  // proses login
});
</script>



<script>
// 1. Fungsi untuk memberi warna hanya huruf predikat
function bgHuruf(huruf, predikatText = "") {
  const warna = { A: "green", A: "green", B: "blue", C: "orange", D: "red" };
  // huruf diberi background, predikatText normal
  return `${predikatText} <span style="background-color:${warna[huruf]}; color:white; padding:0 4px; border-radius:3px;">${huruf}</span>`;
}

// 2. Data dari server / dataSantri
let dataSantri = []; // nanti diisi fetch atau data.push

// 3. Fungsi render tabel
function renderTabelPredikat() {
  dataSantri.forEach(data => {
    const cell = document.querySelector(`#row-${data.id} .nilai-ringkas`);
    if (!cell) return;
    cell.innerHTML = `<strong>${data.buttonCell.nilai.toFixed(1)}</strong> - ${bgHuruf(data.buttonCell.predikatHuruf, data.buttonCell.predikatText)}`;
  });
}
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const eye = document.getElementById("toggle-password");
  const input = document.getElementById("password");
  if (eye && input) {
    eye.addEventListener("click", () => {
      input.type = (input.type === "password") ? "text" : "password";
    });
  }
});
</script>

		
		
<script>
// ================================
// Soft-lock dropdown JENJANG/SEMESTER/KETERANGAN (warna normal)
// ================================
(function () {
  let nisObserver = null;

  function getTbody() {
    return document.querySelector("#tabelSantri tbody")
        || document.querySelector("table#data-santri tbody")
        || document.querySelector("tbody");
  }

  function getTargets(scope=document) {
    // HANYA 3 ini; tidak termasuk .absensi
    return Array.from(scope.querySelectorAll(
      "select.jenjang, select.semester, select.keterangan"
    ));
  }

  // ---- soft-lock: blok interaksi tanpa set disabled (warna tetap normal)
  function attachBlockers(sel){
    if (sel._nisBlockerAttached) return;

    // keluarkan dari tab order, tapi simpan nilai lama
    if (sel.dataset._tab_bak === undefined)
      sel.dataset._tab_bak = sel.getAttribute("tabindex") || "";
    sel.setAttribute("tabindex","-1");
    sel.setAttribute("aria-disabled","true"); // aksesibel; tidak mengubah warna

    const block = (e)=>{ e.preventDefault(); e.stopImmediatePropagation(); return false; };
    const events = ["mousedown","click","input","change","keydown","wheel","touchstart","pointerdown","contextmenu"];
    events.forEach(ev => sel.addEventListener(ev, block, true));

    sel._nisBlocker = { block, events };
    sel._nisBlockerAttached = true;
  }

  function detachBlockers(sel){
    if (!sel._nisBlockerAttached) return;
    const { block, events } = sel._nisBlocker || {};
    if (block) events.forEach(ev => sel.removeEventListener(ev, block, true));
    sel._nisBlocker = null;
    sel._nisBlockerAttached = false;

    // pulihkan tab order
    if (sel.dataset._tab_bak !== undefined){
      const v = sel.dataset._tab_bak;
      delete sel.dataset._tab_bak;
      if (v) sel.setAttribute("tabindex", v); else sel.removeAttribute("tabindex");
    }
    sel.removeAttribute("aria-disabled");
  }

  function applySoftLock(disabled){
    const tbody = getTbody();
    const list = tbody ? getTargets(tbody) : getTargets(document);
    list.forEach(sel => disabled ? attachBlockers(sel) : detachBlockers(sel));
  }

  // Fungsi publik: panggil true/false
  window.setNISDropdownDisabled = function(disabled){
    // hentikan observer lama
    if (nisObserver) { nisObserver.disconnect(); nisObserver = null; }

    applySoftLock(!!disabled);

    // kunci ulang bila tabel dirender ulang
    if (disabled) {
      const tbody = getTbody();
      if (!tbody) return;
      nisObserver = new MutationObserver(() => applySoftLock(true));
      nisObserver.observe(tbody, { childList: true, subtree: true });
    }
  };
})();
</script>


<script>
// ========================================
// Soft-lock tombol Recording (warna normal)
// ========================================
(function () {
  function getTargets() {
    const list = new Set();
    const byId1 = document.getElementById("record-start");  // id yang kamu sebut
    const byId2 = document.getElementById("recordButton");  // id lama di kode kamu
    if (byId1) list.add(byId1);
    if (byId2) list.add(byId2);
    document.querySelectorAll("button.rec-btn").forEach(b => list.add(b)); // jaga-jaga
    return Array.from(list);
  }

  function attachBlockers(btn){
    if (!btn || btn._nisBlockerAttached) return;

    // backup dan keluarkan dari tab order
    if (btn.dataset._tab_bak === undefined)
      btn.dataset._tab_bak = btn.getAttribute("tabindex") || "";
    btn.setAttribute("tabindex","-1");
    btn.setAttribute("aria-disabled","true"); // tidak ubah warna

    // kalau ada onclick inline, backup dan lepas
    if (btn.dataset._onclick_bak === undefined)
      btn.dataset._onclick_bak = btn.getAttribute("onclick") || "";
    if (btn.dataset._onclick_bak) btn.removeAttribute("onclick");

    const block = (e)=>{ e.preventDefault(); e.stopImmediatePropagation(); return false; };
    const events = ["click","mousedown","keydown","keyup","keypress","touchstart","pointerdown","contextmenu"];
    events.forEach(ev => btn.addEventListener(ev, block, true));

    btn._nisBlocker = { block, events };
    btn._nisBlockerAttached = true;
  }

  function detachBlockers(btn){
    if (!btn || !btn._nisBlockerAttached) return;
    const { block, events } = btn._nisBlocker || {};
    if (block) events.forEach(ev => btn.removeEventListener(ev, block, true));
    btn._nisBlocker = null;
    btn._nisBlockerAttached = false;

    // pulihkan tabindex & aria
    if (btn.dataset._tab_bak !== undefined){
      const v = btn.dataset._tab_bak;
      delete btn.dataset._tab_bak;
      if (v) btn.setAttribute("tabindex", v); else btn.removeAttribute("tabindex");
    }
    btn.removeAttribute("aria-disabled");

    // pulihkan onclick inline jika ada
    if (btn.dataset._onclick_bak !== undefined){
      if (btn.dataset._onclick_bak) btn.setAttribute("onclick", btn.dataset._onclick_bak);
      else btn.removeAttribute("onclick");
      delete btn.dataset._onclick_bak;
    }
  }

  function applyRecordSoftLock(disabled){
    getTargets().forEach(btn => disabled ? attachBlockers(btn) : detachBlockers(btn));
  }

  // expose
  window.setNISRecordDisabled = applyRecordSoftLock;
})();
</script>


<script>
// ===========================================
// Soft-lock + SAMARKAN tombol rekap
//   -> kecuali: download-pdf-santri & okSantriSelect (tetap aktif)
// ===========================================
(function () {
  let rekapObserver = null;

  // üü¢ ID yang DIIZINKAN klik walau mode NIS
  const ALLOW = new Set(["download-pdf-santri", "okSantriSelect", "cancelSantriSelect"]);

  function getRekapButtons() {
    const ids = [
      "download-pdf-rekap",
      "download-xls-rekap",
      "download-pdf-santri",   // dikecualikan
      "download-pdf-allkelas",
      "okSantriSelect",        // dikecualikan (tombol OK modal)
    ];
    const set = new Set();
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el) set.add(el);
    });
    // jaring tambahan via class umum
    document.querySelectorAll("button.rekap-btn").forEach(b => set.add(b));
    return Array.from(set);
  }

  function attachBlockers(btn){
    if (!btn || btn._nisBlockerAttached) return;

    if (btn.dataset._tab_bak === undefined)
      btn.dataset._tab_bak = btn.getAttribute("tabindex") || "";
    btn.setAttribute("tabindex","-1");
    btn.setAttribute("aria-disabled","true");

    if (btn.dataset._onclick_bak === undefined)
      btn.dataset._onclick_bak = btn.getAttribute("onclick") || "";
    if (btn.dataset._onclick_bak) btn.removeAttribute("onclick");

    const block = (e)=>{ e.preventDefault(); e.stopImmediatePropagation(); return false; };
    const events = ["click","mousedown","keydown","keyup","keypress","touchstart","pointerdown","contextmenu"];
    events.forEach(ev => btn.addEventListener(ev, block, true));

    btn.classList.add("nis-masked");

    btn._nisBlocker = { block, events };
    btn._nisBlockerAttached = true;
  }

  function detachBlockers(btn){
    if (!btn) return;

    if (btn._nisBlockerAttached) {
      const { block, events } = btn._nisBlocker || {};
      if (block) events.forEach(ev => btn.removeEventListener(ev, block, true));
      btn._nisBlocker = null;
      btn._nisBlockerAttached = false;
    }

    if (btn.dataset._tab_bak !== undefined){
      const v = btn.dataset._tab_bak;
      delete btn.dataset._tab_bak;
      if (v) btn.setAttribute("tabindex", v); else btn.removeAttribute("tabindex");
    }
    btn.removeAttribute("aria-disabled");

    if (btn.dataset._onclick_bak !== undefined){
      if (btn.dataset._onclick_bak) btn.setAttribute("onclick", btn.dataset._onclick_bak);
      else btn.removeAttribute("onclick");
      delete btn.dataset._onclick_bak;
    }

    btn.classList.remove("nis-masked");
  }

  function applyRekapSoftLock(disabled){
    getRekapButtons().forEach(btn => {
      if (ALLOW.has(btn.id)) {
        // pengecualian: pastikan selalu aktif
        detachBlockers(btn);
        return;
      }
      disabled ? attachBlockers(btn) : detachBlockers(btn);
    });
  }

  // Drop-in replacement
  window.setNISRekapDisabled = function(disabled){
    if (rekapObserver) { rekapObserver.disconnect(); rekapObserver = null; }
    applyRekapSoftLock(!!disabled);
    if (disabled){
      rekapObserver = new MutationObserver(() => applyRekapSoftLock(true));
      rekapObserver.observe(document.body, { childList:true, subtree:true });
    }
  };

  // üü¢ Bersihkan jika "OK" sudah terlanjur tersamarkan saat skrip ini dimuat
  (function unmaskAllowedNow(){
    ALLOW.forEach(id => {
      const b = document.getElementById(id);
      if (b) detachBlockers(b);
    });
  })();
})();
</script>

<style>
/* gaya samaran untuk tombol yang dikunci */
.nis-masked {
  opacity: .5;
  filter: grayscale(70%);
  cursor: not-allowed !important;
}
</style>

<script>
/* =========================================================
   PDF Individual ‚Äî dropdown patuh ke login:
   - user NIS  => hanya 1 opsi (nis sendiri) dari roster kelas aktif
   - non-NIS   => gunakan fungsi lama (semua santri), atau fallback roster
   - Klik "PDF Individual" hanya membuka modal + populate; unduh saat klik OK
   ========================================================= */
(function(){
  const modal      = document.getElementById('santriModalOverlay');
  const openBtn    = document.getElementById('download-pdf-santri');
  const selectEl   = document.getElementById('pdf-santri-select');
  const okBtn      = document.getElementById('okSantriSelect');

  // Simpan fungsi lama (apapun yang ada) agar bisa fallback utk non-NIS
  if (!window.__OLD_populateSantriSelect) {
    window.__OLD_populateSantriSelect =
      (typeof window.populateSantriSelect === 'function' && window.populateSantriSelect) ||
      (typeof window._populateSantriSelect === 'function' && window._populateSantriSelect) ||
      null;
  }

  // Helper ambil elemen kelas
  function kelasSelectEl(){
    return (typeof kelasSelect !== 'undefined' && kelasSelect) ? kelasSelect : document.getElementById('kelasSelect');
  }

  // Fallback roster jika fungsi lama tidak ada
  async function fetchRosterAll(){
    const kelasEl = kelasSelectEl();
    const kelas   = kelasEl?.value || '';
    const url = `/api/getSantri?kelas=${encodeURIComponent(kelas)}&t=${Date.now()}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('Gagal memuat roster santri.');
    const arr = await res.json().catch(()=>[]) || [];
    return (arr||[])
      .map(s => ({ key: (s.nis||s.id||'').toString(), nama: s.nama||'-', nis: s.nis||'', id: s.id||'' }))
      .filter(x => x.key)
      .sort((a,b)=> (a.nama||'').localeCompare(b.nama||'','id'));
  }

  // Inti: populate dropdown yang menghormati login user (meniru dashboard)
  async function populateSantriSelectRespectLogin(){
    if (!selectEl) return;

    const kelasEl = kelasSelectEl();
    const kelas   = kelasEl?.value || '';

    // --- Ambil user login seperti dashboard ---
    let user = null;
    try {
      const username = localStorage.getItem('username'); // dashboard juga pakai ini
      const users = await fetch(`/api/getUsers?t=${Date.now()}`).then(r=>r.json());
      user = Array.isArray(users) ? users.find(u => u && u.username === username) : null;
    } catch (e) {
      console.warn('getUsers gagal:', e);
    }

    // === Jika user NIS -> tampilkan 1 opsi (nis pertama) ===
    if (user && Array.isArray(user.nis) && user.nis.length) {
      // Hormati pembatasan kelas seperti dashboard: jika kelas aktif tidak termasuk akses user, kosongkan
      if (user.kelas && Array.isArray(user.kelas) && user.kelas.length && kelas && !user.kelas.includes(kelas)) {
        selectEl.innerHTML = `<option value="">‚Äî Tidak ada akses ke kelas ini ‚Äî</option>`;
        window.__SANTRI_SCOPE_LOCKED__ = true;
        return;
      }

      const nis = String(user.nis[0] ?? '').trim();
      if (!nis) {
        selectEl.innerHTML = `<option value="">‚Äî NIS tidak ditemukan ‚Äî</option>`;
        window.__SANTRI_SCOPE_LOCKED__ = true;
        return;
      }

      // Ambil nama dari roster kelas aktif (seperti dashboard menggunakan getSantri)
      let nama = '-';
      try {
        const roster = await fetch(`/api/getSantri?kelas=${encodeURIComponent(kelas)}&t=${Date.now()}`)
                         .then(r=>r.json()).catch(()=>[]) || [];
        const hit = roster.find(s => String(s.nis).trim() === nis || String(s.id).trim() === nis);
        if (hit?.nama) nama = hit.nama;
      } catch(_e){ /* abaikan, nama tetap '-' */ }

      const safeNama = (nama || '-').replace(/"/g,'&quot;');
      selectEl.innerHTML =
        `<option value="">‚Äî Pilih santri ‚Äî</option>
         <option value="${nis}" data-nama="${safeNama}">${nis} ‚Äî ${safeNama}</option>`;
      selectEl.value = nis;

      // Kunci agar panggilan lain tidak menimpa dropdown
      window.__SANTRI_SCOPE_LOCKED__ = true;
      return;
    }

    // === Bukan user NIS -> pakai cara lama (semua santri) ===
    window.__SANTRI_SCOPE_LOCKED__ = false;
    if (typeof window.__OLD_populateSantriSelect === 'function') {
      await window.__OLD_populateSantriSelect();
      return;
    }

    // Fallback terakhir: roster penuh
    try {
      const roster = await fetchRosterAll();
      selectEl.innerHTML = [
        `<option value="">‚Äî Pilih santri ‚Äî</option>`,
        ...roster.map(x => `<option value="${x.key}" data-nama="${(x.nama||'-').replace(/"/g,'&quot;')}">${x.nis ? x.nis : x.id} ‚Äî ${x.nama||'-'}</option>`)
      ].join('');
    } catch (e) {
      console.error(e);
      selectEl.innerHTML = `<option value="">‚Äî Gagal memuat daftar santri ‚Äî</option>`;
    }
  }

  // Paksa semua pemanggilan populate mengarah ke versi ini
  window.populateSantriSelect  = populateSantriSelectRespectLogin;
  window._populateSantriSelect = populateSantriSelectRespectLogin;

  // Pastikan tombol PDF Individual TIDAK auto-unduh, hanya buka modal + populate
  if (openBtn) {
    const cloned = openBtn.cloneNode(true);           // buang listener lama kalau ada
    openBtn.parentNode.replaceChild(cloned, openBtn);
    cloned.addEventListener('click', async ()=>{
      if (modal) modal.style.display = 'flex';
      await populateSantriSelectRespectLogin();
    });
    // simpan referensi global (kalau diperlukan kode lain)
    window.pdfSantriBtn = cloned;
  } else if (!window.pdfSantriBtn) {
    window.pdfSantriBtn = document.getElementById('download-pdf-santri');
  }

  // Klik OK => jalankan unduh (fungsi pdfSantriDownload sudah ada sebelumnya)
  okBtn?.addEventListener('click', ()=>{
    const fn = window._pdfSantriDownload || window.pdfSantriDownload;
    if (typeof fn === 'function') fn();
    else {
      console.error('pdfSantriDownload tidak ditemukan.');
      alert('Gagal: fungsi PDF per santri tidak ditemukan.');
    }
  });

  // Guard setBtnLoading global bila belum ada (tidak mengganggu jika sudah ada)
  if (typeof window.setBtnLoading !== 'function') {
    window.setBtnLoading = function(btn, loading, loadingText='Mengerjakan‚Ä¶'){
      if (!btn) return;
      if (loading) {
        btn.dataset._oldText = btn.textContent;
        btn.textContent = loadingText;
        btn.disabled = true;
      } else {
        if (btn.dataset._oldText) btn.textContent = btn.dataset._oldText;
        btn.disabled = false;
        delete btn.dataset._oldText;
      }
    };
  }
})();
</script>



<!-- ===== Modal Editor Parsial ‚Äî Single Block (Revisi Otomatis-Deteksi) ===== -->
<style>
  #editBtnIndex{
    position:fixed;right:16px;bottom:16px;z-index:9999;padding:10px 14px;border:0;border-radius:10px;
    background:#111831;color:#E6ECFF;box-shadow:0 6px 18px rgba(0,0,0,.25);cursor:pointer
  }
  #overlayEdit{display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.45);backdrop-filter:saturate(120%) blur(2px)}
  #overlayEdit, #overlayEdit * , #overlayEdit *::before, #overlayEdit *::after{box-sizing:border-box}
  #overlayEdit .panel{
    position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
    width:min(1080px,96vw);max-width:calc(100vw - 24px);
    height:min(86vh,760px);max-height:calc(100vh - 24px);
    background:#0b1020;color:#e6ecff;border:1px solid #2a3157;border-radius:20px;
    display:flex;flex-direction:column;overflow:hidden
  }
  #overlayEdit header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:#1a2344;border-bottom:1px solid #2a3157}
  #overlayEdit header h3{margin:0;font-size:16px;font-weight:600}
  #overlayEdit .body{flex:1 1 auto;display:grid;gap:12px;align-items:stretch;grid-template-columns:1fr;padding:12px;min-width:0;min-height:0;overflow:hidden}
  #overlayEdit .editor{display:flex;flex-direction:column;gap:10px;min-width:0;min-height:0}
  #overlayEdit .editor textarea{
    flex:1 1 auto;min-width:0;min-height:0;width:100%;max-width:100%;height:100%;
    resize:none;overflow:auto;background:#0f152d;color:#e6ecff;border:1px solid #2a3157;border-radius:12px;
    padding:12px;font:13px ui-monospace,Consolas,Menlo,monospace;white-space:pre
  }
  #overlayEdit footer{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 12px;border-top:1px solid #2a3157;background:#0f152d}
  #stagedBadge{font-size:12px;color:#c6ffde;background:#16321c;border:1px solid #1f5b33;padding:6px 10px;border-radius:999px}
  .btn-danger{border-color:#6b1f2d;background:#3a1a24;color:#ffd0d4}
  .btn-ok{border-color:#1f5b33;background:#16321c;color:#c6ffde}

  /* Tombol inline (opsional) menyesuaikan tombol "HTML" kamu */
  #editBtnIndex{
    position: static !important;
    right: auto !important;
    bottom: auto !important;
    z-index: auto !important;
    box-shadow: none !important;
    border-radius: 6px;
    background: #1e88e5 !important;
    color: #fff !important;
    border: 1px solid #ccc !important;
    padding: 10px 14px !important;
    cursor: pointer;
  }
  #editBtnIndex:hover{ background:#1565c0 !important; }
</style>

<div id="overlayEdit" role="dialog" aria-modal="true" aria-labelledby="editorTitle">
  <div class="panel">
    <header>
      <h3 id="editorTitle">Editor Parsial (Auto-Deteksi Bagian)</h3>
      <small id="foundInfo" style="opacity:.8"></small>
    </header>
    <div class="body">
      <section class="editor">
        <textarea id="editBox" spellcheck="false" placeholder="Memuat‚Ä¶"></textarea>
      </section>
    </div>
    <footer>
      <span id="stagedBadge">0 blok</span>
      <div style="display:flex;gap:8px">
        <button id="btnSaveAll" class="btn-ok" title="Ctrl/Cmd+S">Save</button>
        <button id="btnReload">Reload</button>
        <button id="btnCloseModal" class="btn-danger" title="Esc">Close</button>
      </div>
      <span id="lockInfo" style="display:none"></span>
    </footer>
  </div>
</div>

<script>
(()=>{
  // ===== KONFIG REPO =====
  const API    = '/api/gitFile';
  const OWNER  = 'tahfizpis';
  const REPO   = 'web';
  const BRANCH = 'main';
  const PATH   = 'index.html';

  // ===== STATE =====
  let fullText = '', lastSha = null;
  const STAGED = {};       // key -> view string yg DIEDIT (diambil dari single block)
  const FOUND  = {};       // key -> seg ditemukan
  const $ = s => document.querySelector(s);

  // ===== UI =====
  const btnOpen    = $('#editBtnIndex');
  const modal      = $('#overlayEdit');
  const btnClose   = $('#btnCloseModal');
  const btnSaveAll = $('#btnSaveAll');
  const btnReload  = $('#btnReload');
  const box        = $('#editBox');
  const badge      = $('#stagedBadge');
  const foundInfo  = $('#foundInfo');

  // ===== Admin Gate =====
  async function ensureAdmin(){
    if (sessionStorage.getItem('isAdmin') === '1') return true;
    const pass = prompt('Masukkan password admin:'); if (pass == null) return false;
    try{
      const r = await fetch('/api/cek-admin', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ password: pass })
      });
      const ct = r.headers.get('content-type') || '';
      let ok=false, msg='';
      if (ct.includes('application/json')){
        const js = await r.json();
        msg = String(js.message || js.msg || js.status || '').trim();
        const lower = msg.toLowerCase();
        ok = r.ok && (js.ok===true || js.authorized===true || js.status==='ok' ||
             lower.includes('authorized') || lower.includes('success') || lower.includes('berhasil') ||
             (lower.includes('valid') && !lower.includes('invalid')) || lower==='ok');
      } else {
        const tx=(await r.text()).trim(); const lower=tx.toLowerCase();
        msg=tx; ok = r.ok && (lower==='ok' || lower.includes('authorized') || lower.includes('success') ||
             lower.includes('berhasil') || (lower.includes('valid') && !lower.includes('invalid')));
      }
      if(!ok){ alert(msg || 'Password admin salah atau tidak diizinkan.'); return false; }
      sessionStorage.setItem('isAdmin','1'); return true;
    }catch(err){ console.error(err); alert('Gagal verifikasi admin: '+err.message); return false; }
  }

  // ===== DAFTAR ITEM (urut tampil di editor) =====
  const ITEMS = [
    {key:'LOGIN_H1',      label:'1) Judul Login (H1 di #login-card)',                      required:true},
    {key:'DASHBOARD_H1',  label:'2) Judul Dashboard (H1 di #dashboard-card)',              required:true},
    {key:'TABLE_HEADERS', label:'3) Header Tabel #santri-table (satu baris per <th>)',     required:true},

    {key:'JENJANG_MAX',     label:'4) JENJANG_MAX (di loadSantriData)',                    required:false},
    {key:'JENJANG_MAX_CFG', label:'5) JENJANG_MAX (Konfig Global <script>)',               required:false},

    {key:'MODAL_SANTRI_JENJANG', label:'6) Modal Tambah Santri ‚Äî Jenjang (id="inputJenjang")', required:true},

    {key:'JENJANG_OPTS',  label:'7) <select class="jenjang"> (VALUE => LABEL)',            required:false},
    {key:'SEMESTER_OPTS', label:'8) <select class="semester"> (VALUE => LABEL)',           required:false},
    {key:'KET_OPTS',      label:'9) <select class="keterangan"> (VALUE => LABEL)',         required:false},

    {key:'KELAS_BUNDLE',  label:'10) Kelas: semuaKelas + namaKelasCustom',                 required:false},
    {key:'KELOMPOK_FB',   label:'11) Fallback ‚ÄúKelompok Ust. ‚Ä¶‚Äù (untuk PDF)',              required:false},

    {key:'THMS_GLOBAL',   label:'12) THMS Global: const BATAS = {...}',                    required:false},
    {key:'THMS_PDF',      label:'13) THMS di PDF_percentCapaian()',                        required:false},
    {key:'THMS_FROM_T',   label:'14) THMS di hitungTotalAllJuzFromTable()',                required:false},
    {key:'THMS_AUTO',     label:'15) THMS di hitungTotalAllJuzOtomatis()',                 required:false},

    {key:'PDF_REKAP_LOK',  label:'16) PDF Rekap ‚Äî Nama Lokasi',                            required:false},
    {key:'PDF_ALL_LOK',    label:'17) PDF All Kelas ‚Äî Nama Lokasi',                        required:false},
    {key:'PDF_SANTRI_LOK', label:'18) PDF Per Santri ‚Äî Nama Lokasi',                       required:false},

    {key:'PDF_REKAP_TTD',  label:'19) PDF Rekap ‚Äî Label TTD (2 baris)',                    required:false},
    {key:'PDF_ALL_TTD',    label:'20) PDF All Kelas ‚Äî Label TTD (2 baris)',                required:false},
    {key:'PDF_SANTRI_TTD', label:'21) PDF Per Santri ‚Äî Label TTD (2 baris)',               required:false},

    {key:'THMS_JUZLIST_JUZOVERLAY', label:'22) THMS ‚Äî Juz List di #juzOverlay (isi <li>‚Ä¶)</li>', required:false},
    {key:'THMS_JUZLIST_MURRANGE',   label:'23) THMS ‚Äî Juz List di #murRangeOverlay (isi <li>‚Ä¶)</li>', required:false},

    // Banyak instalasi terbaru belum punya ABS_FLEX ‚Äî jangan wajibkan
    {key:'ABS_PER_STATUS',     label:'24) ABS Flex ‚Äî perStatus (1..6)',                    required:false},
    {key:'ABS_DEFAULT_TARGET', label:'25) ABS Flex ‚Äî defaultTarget (1..6)',                required:false},
    {key:'ABS_MAX_TARGET',     label:'26) ABS Flex ‚Äî maxTarget (1..6)',                    required:false},
    {key:'ABS_SESI_ALL',       label:'27) ABS Flex ‚Äî sesiAll (array ["Subuh","Pagi",...])',required:false},
  ];
  const ITEM = Object.fromEntries(ITEMS.map(i=>[i.key,i]));

  // ===== OPEN/CLOSE =====
  btnOpen?.addEventListener('click', async () => {
    if (!await ensureAdmin()) return;
    await ensureLoaded(true);
    // Pre-scan segmen agar hanya tampilkan yang ditemukan
    preScanSegments();
    box.value = buildMasterBlock();
    modal.style.display = 'block';
    parseMasterIntoStaged();
    updateBadge();
    updateFoundInfo();
  });
  btnClose?.addEventListener('click', () => { modal.style.display = 'none'; });

  btnReload?.addEventListener('click', async () => {
    if (!confirm('Muat ulang dari file dan BUANG perubahan di editor?')) return;
    await ensureLoaded(true);
    preScanSegments();
    box.value = buildMasterBlock();
    parseMasterIntoStaged();
    updateBadge();
    updateFoundInfo();
  });

  // Shortcuts
  document.addEventListener('keydown', (e)=>{
    if (modal.style.display !== 'block') return;
    if (e.key === 'Escape'){ e.preventDefault(); btnClose.click(); }
    if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); btnSaveAll.click(); }
  });

  btnSaveAll?.addEventListener('click', onSaveAll);

  async function onSaveAll(){
    parseMasterIntoStaged();
    if (Object.keys(STAGED).length===0) return alert('Tidak ada blok terdeteksi.');
    const patch = buildPatchTasks(); if (patch.error) return alert(patch.error);

    let updated = fullText;
    for (const t of patch.tasks.sort((a,b)=>b.start-a.start)){
      updated = updated.slice(0,t.start) + t.content + updated.slice(t.end);
    }

    btnSaveAll.disabled = true; btnSaveAll.textContent = 'Menyimpan‚Ä¶';
    try{
      const r = await fetch(API,{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          action:'put', owner:OWNER, repo:REPO, branch:BRANCH, path:PATH,
          content: updated, message:`bulk edit (single-block) di ${PATH}`, sha:lastSha
        })
      });
      if (!r.ok) throw new Error(await r.text());
      const js = await r.json();
      fullText = updated; lastSha = js.commit || js.sha || lastSha;
      alert('Perubahan tersimpan.');
      // rebuild view dari file terbaru
      preScanSegments();
      box.value = buildMasterBlock();
      parseMasterIntoStaged(); updateBadge(); updateFoundInfo();
    }catch(err){
      console.error(err); alert('Gagal menyimpan: '+err.message);
    }finally{
      btnSaveAll.disabled = false; btnSaveAll.textContent = 'Save';
    }
  }

  // ===== FETCH file =====
  async function ensureLoaded(force=false){
    if (fullText && !force) return;
    const r = await fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({action:'get',owner:OWNER,repo:REPO,branch:BRANCH,path:PATH})});
    if (!r.ok){ alert('Gagal GET index.html'); throw new Error(await r.text()); }
    const js = await r.json();
    fullText = js.content||''; lastSha = js.sha||null;
  }

  // ====== MARKER UTILS (single-block) ======
  const openMark = k => `/*[[${k}]]*/`;
  const closeMark= k => `/*[[/${k}]]*/`;

  function buildMasterBlock(){
    const lines = [];
    lines.push('// === Petunjuk Singkat ===');
    lines.push('// - Setiap bagian dibatasi marker: /*[[KEY]]*/ ... /*[[/KEY]]*/');
    lines.push('// - Jangan hapus marker. Ubah isi di tengahnya.');
    lines.push('// - Hanya bagian yang TERDETEKSI akan ditampilkan di sini.');
    lines.push('');

    const showItems = ITEMS.filter(it => !!FOUND[it.key]);
    for (const it of showItems){
      const view = buildView(it.key) ?? '';
      lines.push(`// === ${it.label} ===`);
      lines.push(openMark(it.key));
      lines.push(view);
      lines.push(closeMark(it.key));
      lines.push('');
    }

    const missing = ITEMS.filter(it => !FOUND[it.key]).map(it => it.label);
    if (missing.length){
      lines.push('// === Bagian tidak ditemukan (hanya catatan, tidak bisa diedit) ===');
      for (const label of missing){
        lines.push(`// - ${label}`);
      }
      lines.push('');
    }
    return lines.join('\n');
  }

  function parseMasterIntoStaged(){
    for (const k of Object.keys(STAGED)) delete STAGED[k];
    const text = box.value || '';
    for (const it of ITEMS){
      if (!FOUND[it.key]) continue; // hanya yang ada
      const re = new RegExp(
        escapeReg(openMark(it.key)) + '([\\s\\S]*?)' + escapeReg(closeMark(it.key)),
        'i'
      );
      const m = re.exec(text);
      if (m) STAGED[it.key] = trimKeepNewlineEdges(m[1]);
    }
  }

  function updateBadge(){
    const n = Object.keys(STAGED).length;
    badge.textContent = `${n} blok`;
  }
  function updateFoundInfo(){
    const found = Object.keys(FOUND).filter(k=>FOUND[k]).length;
    const total = ITEMS.length;
    foundInfo.textContent = `Found ${found}/${total}`;
  }

  function trimKeepNewlineEdges(s){
    return String(s).replace(/^\n+/, '').replace(/\n+$/, '');
  }
  function escapeReg(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }

  // ===== Segment finders =====
  // Cari h1 PERSIS DI DALAM container <div id="..."> ... </div> (lebih aman)
  function h1InsideDiv(divId){
    const t = fullText;
    const reDiv = new RegExp(`<div[^>]*id=["']${divId}["'][^>]*>([\\s\\S]*?)<\\/div>`, 'i');
    const mDiv = reDiv.exec(t); if (!mDiv) return null;
    const base = mDiv.index;
    const inner = mDiv[1]||'';
    const mH1 = /<h1[^>]*>([\s\S]*?)<\/h1>/i.exec(inner);
    if (!mH1) return null;
    const h1Inner = mH1[1]||'';
    const start = base + mDiv[0].indexOf(h1Inner);
    const end   = start + h1Inner.length;
    return {start, end, text: h1Inner};
  }
  function byRegex(re){
    re.lastIndex=0; const t=fullText; const m=re.exec(t); if (!m) return null;
    const inner=m[1]??''; const innerStart=m.index + m[0].indexOf(inner); const innerEnd=innerStart+inner.length;
    return {start:innerStart, end:innerEnd, text:inner};
  }
  function findTheadThCells(){
    const seg = byRegex(/<table[^>]*id=["']santri-table["'][^>]*>[\s\S]{0,6000}?<thead>([\s\S]*?)<\/thead>/i);
    if (!seg) return null;
    const html = seg.text; const base = seg.start;
    const re = /<th\b[^>]*>([\s\S]*?)<\/th>/gi;
    const cells=[]; let m;
    while((m=re.exec(html))){
      const inner = m[1]||'';
      const innerStart = base + m.index + m[0].indexOf(inner);
      const innerEnd   = innerStart + inner.length;
      cells.push({start:innerStart,end:innerEnd,text:inner});
    }
    return cells.length ? {cells, count:cells.length} : null;
  }
  function findOptionsInSelect(cls){
    const seg = byRegex(new RegExp(`<select[^>]*class=["']${cls}["'][^>]*>([\\s\\S]*?)<\\/select>`,'i'));
    if (!seg) return null;
    const html = seg.text, base = seg.start;
    const re = /<option\b[^>]*value=["']([^"']*)["'][^>]*>([\s\S]*?)<\/option>/gi;
    const items=[]; let m;
    while((m=re.exec(html))){
      const value = m[1]; const label = (m[2]||'').trim();
      const whole = m[0];
      const wholeStart = base + m.index;
      const wholeEnd   = wholeStart + whole.length;
      const labelStart = base + m.index + whole.indexOf(label);
      const labelEnd   = labelStart + label.length;
      items.push({value, label, wholeStart, wholeEnd, labelStart, labelEnd});
    }
    return {items, innerStart: seg.start, innerEnd: seg.end, innerText: seg.text};
  }
  function findOptionsInSelectById(id){
    const seg = byRegex(new RegExp(`<select[^>]*id=["']${id}["'][^>]*>([\\s\\S]*?)<\\/select>`,'i'));
    if (!seg) return null;
    const html = seg.text, base = seg.start;
    const re = /<option\b[^>]*value=["']([^"']*)["'][^>]*>([\s\S]*?)<\/option>/gi;
    const items=[]; let m;
    while((m=re.exec(html))){
      const value = m[1];
      const label = (m[2]||'').trim();
      const whole = m[0];
      const wholeStart = base + m.index;
      const wholeEnd   = wholeStart + whole.length;
      const labelStart = base + m.index + whole.indexOf(label);
      const labelEnd   = labelStart + label.length;
      items.push({value, label, wholeStart, wholeEnd, labelStart, labelEnd});
    }
    return {items, innerStart: seg.start, innerEnd: seg.end, innerText: seg.text};
  }
  function findUlJuzInnerIn(containerId){
    const t = fullText;
    const reContainer = new RegExp(`<div[^>]*id=["']${containerId}["'][^>]*>([\\s\\S]*?)<\\/div>`,'i');
    const m = reContainer.exec(t); if (!m) return null;
    const base = m.index; const inner = m[1]||'';
    const mUl = /<ul[^>]*class=["']juz-list["'][^>]*>([\s\S]*?)<\/ul>/i.exec(inner);
    if (!mUl) return null;
    const ulInner = mUl[1]||'';
    const start = base + m[0].indexOf(ulInner);
    const end   = start + ulInner.length;
    return {start, end, text: ulInner};
  }
  function findJenjangMax(){
    return byRegex(/function\s+loadSantriData\s*\([^)]*\)\s*{[\s\S]{0,8000}?const\s+JENJANG_MAX\s*=\s*Number\(\s*window\.JENJANG_MAX\s*\?\?\s*(\d+)\s*\)/i);
  }
  function findJenjangMaxConfig(){
    return byRegex(/\/\/\s*=+\s*KONFIG[^\n]*\n[\s\S]{0,2000}?const\s+JENJANG_MAX\s*=\s*Number\(\s*window\.JENJANG_MAX\s*\?\?\s*(\d+)\s*\)/i);
  }
  function findPdfLok(funcName){
    const re = new RegExp(
      `function\\s+${funcName}\\s*\\([^)]*\\)\\s*{[\\s\\S]{0,120000}?doc\\.text\\(\\s*\\\`([^\\\`]*?),\\s*\\$\\{ttdDate\\}\\\`\\s*,\\s*margin\\.left\\s*\\+\\s*totalW\\s*,\\s*y\\s*,\\s*\\{[^}]*align\\s*:\\s*'right'[^}]*\\}[^)]*\\)`,
      'i'
    );
    return byRegex(re);
  }
  function findPdfTtd(funcName){
    const re = new RegExp(
      `function\\s+${funcName}\\s*\\([^)]*\\)\\s*{[\\s\\S]{0,120000}?doc\\.text\\(\\s*['"]([^'"]*)['"]\\s*,\\s*leftX\\s*,\\s*headY\\s*\\)\\s*;\\s*doc\\.text\\(\\s*['"]([^'"]*)['"]\\s*,\\s*rightX\\s*,\\s*headY\\s*\\)`,
      'i'
    );
    const t = fullText; const m = re.exec(t);
    if (!m) return null;
    const whole = m[0];
    const wholeStart = m.index;
    const offset1 = whole.indexOf(m[1]);
    const offset2 = whole.lastIndexOf(m[2]);
    return {
      left:  { start: wholeStart + offset1, end: wholeStart + offset1 + m[1].length,  text: m[1] },
      right: { start: wholeStart + offset2, end: wholeStart + offset2 + m[2].length,  text: m[2] }
    };
  }

  // === ABSENSI FLEX finders (opsional) ===
  function findAbsFlexPerStatus(){
    return byRegex(/window\.ABS_FLEX_CFG\s*=\s*window\.ABS_FLEX_CFG\s*\|\|\s*{[\s\S]{0,8000}?perStatus\s*:\s*Number\(\s*window\.ABS_FLEX_PER_STATUS\s*\?\?\s*(\d+)\s*\)/i);
  }
  function findAbsFlexDefaultTarget(){
    return byRegex(/window\.ABS_FLEX_CFG[\s\S]{0,8000}?defaultTarget\s*:\s*(\d+)/i);
  }
  function findAbsFlexMaxTarget(){
    return byRegex(/window\.ABS_FLEX_CFG[\s\S]{0,8000}?maxTarget\s*:\s*(\d+)/i);
  }
  function findAbsFlexSesiAll(){
    return byRegex(/function\s+defaultLabel\s*\([^)]*\)\s*{[\s\S]{0,4000}?const\s+sesiAll\s*=\s*(\[[\s\S]*?\])\s*;/i);
  }

  // ===== Build View =====
  function buildView(key){
    const seg = getSegment(key); if (!seg) return '';
    if (key==='LOGIN_H1' || key==='DASHBOARD_H1') return seg.text.trim();

    if (key==='TABLE_HEADERS'){
      const {cells} = seg; return cells.map(c=>c.text.trim()).join('\n');
    }
    if (key==='JENJANG_OPTS' || key==='SEMESTER_OPTS' || key==='KET_OPTS'){
      return seg.items.map(it=>`${it.value} => ${decodeEntities((it.label||'').trim())}`).join('\n');
    }
    if (key==='KELAS_BUNDLE'){
      const arrNums = (seg.arr.text.match(/"kelas_(\d+)"/g)||[]).map(s=>s.replace(/[^0-9]/g,''));
      const objPairs = [];
      (seg.obj.text.match(/kelas_(\d+)\s*:\s*"([^"]*)"/g)||[]).forEach(s=>{
        const m = s.match(/kelas_(\d+)\s*:\s*"([^"]*)"/); if (m) objPairs.push([m[1], m[2]]);
      });
      return [
        '/* === semuaKelas (ISIKAN ANGKA, koma-berpisah) === */',
        arrNums.join(','),
        '',
        '/* === namaKelasCustom (format: ANGKA = Nama) === */',
        ...objPairs.map(([num, nama])=>`${num} = ${nama}`)
      ].join('\n');
    }
    if (key==='KELOMPOK_FB'){
      const lines=[]; (seg.text.match(/kelas_(\d+)\s*:\s*"([^"]*)"/g)||[]).forEach(s=>{
        const m=s.match(/kelas_(\d+)\s*:\s*"([^"]*)"/); if (m) lines.push(`${m[1]} = ${m[2]}`);
      }); return lines.join('\n');
    }
    if (key==='THMS_GLOBAL' || key==='THMS_PDF' || key==='THMS_FROM_T' || key==='THMS_AUTO'){
      const pairs = parseObjectPairs(seg.text);
      const ks = Object.keys(pairs).map(Number).sort((a,b)=>a-b);
      return ks.map(k => `${k}=${pairs[k]}`).join('\n');
    }
    if (key==='JENJANG_MAX' || key==='JENJANG_MAX_CFG') return String(seg.text).trim();

    if (key==='PDF_REKAP_LOK' || key==='PDF_ALL_LOK' || key==='PDF_SANTRI_LOK'){
      return String(seg.text).trim();
    }
    if (key==='PDF_REKAP_TTD' || key==='PDF_ALL_TTD' || key==='PDF_SANTRI_TTD'){
      return `${seg.left.text}\n${seg.right.text}`;
    }
    if (key==='MODAL_SANTRI_JENJANG'){
      return seg.items.map(it=>`${it.value} => ${decodeEntities(it.label)}`).join('\n');
    }
    if (key==='THMS_JUZLIST_JUZOVERLAY' || key==='THMS_JUZLIST_MURRANGE'){
      return seg.text.trim();
    }

    // ABS FLEX views
    if (key==='ABS_PER_STATUS' || key==='ABS_DEFAULT_TARGET' || key==='ABS_MAX_TARGET'){
      return String(seg.text).trim();
    }
    if (key==='ABS_SESI_ALL'){
      return String(seg.text).trim(); // array literal
    }

    return (seg.text||'').trim();
  }

  function getSegment(key){
    switch(key){
      case 'LOGIN_H1':      return h1InsideDiv('login-card');
      case 'DASHBOARD_H1':  return h1InsideDiv('dashboard-card');
      case 'KELAS_BUNDLE': {
        const arr = byRegex(/function\s+aturDropdownKelas\s*\([^)]*\)\s*{[\s\S]{0,8000}?const\s+semuaKelas\s*=\s*\[([\s\S]*?)\];/i);
        const obj = byRegex(/const\s+namaKelasCustom\s*=\s*{([\s\S]*?)}\s*;/i);
        if (!arr || !obj) return null; return {bundle:true, arr, obj};
      }
      case 'KELOMPOK_FB':  return byRegex(/custom\s*=\s*window\.namaKelasCustom\s*\|\|\s*window\.NAMA_KELAS_CUSTOM\s*\|\|\s*{([\s\S]*?)}\s*;/i);
      case 'TABLE_HEADERS':return findTheadThCells();
      case 'JENJANG_OPTS': return findOptionsInSelect('jenjang');

      case 'JENJANG_MAX':     return findJenjangMax();
      case 'JENJANG_MAX_CFG': return findJenjangMaxConfig();

      case 'SEMESTER_OPTS': return findOptionsInSelect('semester');
      case 'KET_OPTS':      return findOptionsInSelect('keterangan');
      case 'THMS_GLOBAL':   return byRegex(/const\s+BATAS\s*=\s*{([\s\S]*?)}\s*;/i);
      case 'THMS_PDF':      return byRegex(/function\s+PDF_percentCapaian\s*\([^)]*\)\s*{[\s\S]{0,4000}?const\s+batasSemester\s*=\s*{([\s\S]*?)}\s*;/i);
      case 'THMS_FROM_T':   return byRegex(/function\s+hitungTotalAllJuzFromTable\s*\([^)]*\)\s*{[\s\S]{0,12000}?const\s+batasSemester\s*=\s*{([\s\S]*?)}\s*;/i);
      case 'THMS_AUTO':     return byRegex(/function\s+hitungTotalAllJuzOtomatis\s*\([^)]*\)\s*{[\s\S]{0,12000}?const\s+batasSemester\s*=\s*{([\s\S]*?)}\s*;/i);

      case 'PDF_REKAP_LOK':  return findPdfLok('pdfRekapDownload');
      case 'PDF_ALL_LOK':    return findPdfLok('pdfAllKelasDownload');
      case 'PDF_SANTRI_LOK': return findPdfLok('pdfSantriDownload');

      case 'PDF_REKAP_TTD':  return findPdfTtd('pdfRekapDownload');
      case 'PDF_ALL_TTD':    return findPdfTtd('pdfAllKelasDownload');
      case 'PDF_SANTRI_TTD': return findPdfTtd('pdfSantriDownload');

      case 'MODAL_SANTRI_JENJANG':     return findOptionsInSelectById('inputJenjang');
      case 'THMS_JUZLIST_JUZOVERLAY':  return findUlJuzInnerIn('juzOverlay');
      case 'THMS_JUZLIST_MURRANGE':    return findUlJuzInnerIn('murRangeOverlay');

      // ABS FLEX (opsional)
      case 'ABS_PER_STATUS':     return findAbsFlexPerStatus();
      case 'ABS_DEFAULT_TARGET': return findAbsFlexDefaultTarget();
      case 'ABS_MAX_TARGET':     return findAbsFlexMaxTarget();
      case 'ABS_SESI_ALL':       return findAbsFlexSesiAll();
    }
    return null;
  }

  function preScanSegments(){
    for (const it of ITEMS){
      FOUND[it.key] = !!getSegment(it.key);
    }
  }

  // ===== Build patch =====
  function buildPatchTasks(){
    const tasks = [];

    for (const key of Object.keys(STAGED)){
      if (!FOUND[key]) continue; // skip yang tidak ada
      const rules = ITEM[key] || {};
      const view  = STAGED[key];
      const seg   = getSegment(key);
      if (!seg) continue;

      // 1 & 2: H1
      if (key==='LOGIN_H1' || key==='DASHBOARD_H1'){
        const val = (view||'').trim();
        if (rules.required && !val) return {error:`${rules.label||key}: tidak boleh kosong.`};
        tasks.push({start:seg.start, end:seg.end, content:escapeHtml(val)});
        continue;
      }

      // 3: <th> header
      if (key==='TABLE_HEADERS'){
        const lines = (view||'').split('\n'); const {cells}=seg;
        if (lines.length!==cells.length) return {error:`${rules.label||key}: jumlah baris (${lines.length}) harus = jumlah <th> (${cells.length}).`};
        for (let i=0;i<cells.length;i++){
          const txt=(lines[i]??'').trim();
          if (!txt) return {error:`${rules.label||key}: header ke-${i+1} tidak boleh kosong.`};
          tasks.push({start:cells[i].start, end:cells[i].end, content:escapeHtml(txt)});
        }
        continue;
      }

      // <select> options by class
      if (key==='JENJANG_OPTS' || key==='SEMESTER_OPTS' || key==='KET_OPTS'){
        const selCls = (key==='JENJANG_OPTS' ? 'jenjang' : key==='SEMESTER_OPTS' ? 'semester' : 'keterangan');
        const segSel = getSegment(key);

        const lines=(view||'').split('\n').map(s=>s.trim()).filter(Boolean);
        const pairs=[];
        for (const line of lines){
          const mm=line.match(/^([^=]*)=>(.*)$/);
          if (!mm) return {error:`${rules.label||key}: format baris invalid: "${line}". Contoh: A15 => 2A`};
          const value=(mm[1]||'').trim();
          const label=(mm[2]||'').trim();
          if (selCls!=='keterangan' && value==='') return {error:`${rules.label||key}: VALUE tidak boleh kosong.`};
          pairs.push({value,label});
        }
        function optLine(cls, value, label){
          const v = value.replace(/"/g,'&quot;');
          const lbl = escapeHtml(label);
          if (cls==='jenjang')  return `    <option value="${v}" \${jenNow === '${v}' ? 'selected' : ''}>${lbl}</option>`;
          if (cls==='semester') return `    <option value="${v}" \${String(semNow) === '${v}' ? 'selected' : ''}>${lbl}</option>`;
          if (v==='') return `    <option value="" \${!ketNow ? 'selected' : ''}></option>`;
          return `    <option value="${v}" \${ketNow === '${v}' ? 'selected' : ''}>${lbl}</option>`;
        }
        const inner=(pairs.length?pairs.map(p=>optLine(selCls,p.value,p.label)).join('\n'):'');
        const newInner=(inner?'\n'+inner+'\n  ':'');
        tasks.push({ start: segSel.innerStart, end: segSel.innerEnd, content: newInner });
        continue;
      }

      // 10: KELAS_BUNDLE
      if (key==='KELAS_BUNDLE'){
        const mArr = view.match(/\/\*\s*===\s*semuaKelas.*?\*\/\s*([\s\S]*?)\n\s*\/\*/i);
        const mObj = view.match(/\/\*\s*===\s*namaKelasCustom.*?\*\/\s*([\s\S]*)$/i);
        if(!mArr || !mObj) return {error:`${rules.label||key}: format tidak valid. Jangan hapus marker komentar di dalam blok.`};

        const nums=mArr[1].replace(/\s+/g,'').split(',').filter(Boolean);
        const badNum=nums.find(n=>!/^\d+$/.test(n)); if (badNum) return {error:`${rules.label||key}: angka kelas tidak valid: ${badNum}`};

        const arrContent=nums.map((n,i)=>(i%6===0?'\n    ':'')+`"kelas_${n}"`).join(',')+(nums.length?'\n  ':'');
        const newArrInner=arrContent.trim()?('  '+arrContent.trim()+'\n'):'';

        const objPairs=mObj[1].split('\n').map(s=>s.trim()).filter(Boolean).map(line=>{
          const mm=line.match(/^(\d+)\s*=\s*(.*)$/); return mm?[mm[1],mm[2]]:null;
        }).filter(Boolean);
        const newObjInner=objPairs.map(([n,nama])=>`  kelas_${n}: "${nama}"`).join(',\n');

        const segBundle = getSegment('KELAS_BUNDLE');
        tasks.push({start:segBundle.arr.start, end:segBundle.arr.end, content:newArrInner.replace(/\s+$/,'')});
        tasks.push({start:segBundle.obj.start, end:segBundle.obj.end, content:newObjInner});
        continue;
      }

      // 11: Fallback Kelompok
      if (key==='KELOMPOK_FB'){
        const lines=(view||'').split('\n').map(s=>s.trim()).filter(Boolean);
        const entries=[];
        for (const line of lines){
          const m=line.match(/^(\d+)\s*=\s*(.*)$/);
          if(!m) return {error:`${rules.label||key}: baris tidak valid: "${line}" (pakai format: ANGKA = Nama)`};
          entries.push({num:m[1], name:m[2]});
        }
        const content=entries.map(e=>`  kelas_${e.num}: "${e.name}"`).join(',\n');
        const segFB = getSegment('KELOMPOK_FB');
        tasks.push({start:segFB.start, end:segFB.end, content});
        continue;
      }

      // 12‚Äì15: THMS maps
      if (key==='THMS_GLOBAL' || key==='THMS_PDF' || key==='THMS_FROM_T' || key==='THMS_AUTO'){
        const map=parseLinesKeyVal(view); const ks=Object.keys(map);
        if(ks.length===0) return {error:`${rules.label||key}: isi minimal satu pasangan k:v (mis. 1: 5)`};
        const content=Object.keys(map).sort((a,b)=>Number(a)-Number(b)).map(k=>`${k}: ${map[k]}`).join(', ');
        const segTH = getSegment(key);
        tasks.push({start:segTH.start, end:segTH.end, content});
        continue;
      }

      // 4: JENJANG_MAX >0
      if (key==='JENJANG_MAX'){
        const trimmed=String(view||'').trim();
        if (!trimmed) return {error:`${rules.label||key}: tidak boleh kosong.`};
        const num=Number(trimmed);
        if(!Number.isInteger(num) || num<=0) return {error:`${rules.label||key}: harus bilangan bulat > 0.`};
        tasks.push({start:seg.start, end:seg.end, content:String(num)});
        continue;
      }
      // 5: JENJANG_MAX_CFG ‚â•0
      if (key==='JENJANG_MAX_CFG'){
        const trimmed=String(view||'').trim();
        if (trimmed==='') return {error:`${rules.label||key}: tidak boleh kosong.`};
        const num=Number(trimmed);
        if(!Number.isInteger(num) || num<0) return {error:`${rules.label||key}: harus bilangan bulat ‚â• 0 (0 = tanpa batas).`};
        tasks.push({start:seg.start, end:seg.end, content:String(num)});
        continue;
      }

      // 16‚Äì18: Lokasi PDF
      if (key==='PDF_REKAP_LOK' || key==='PDF_ALL_LOK' || key==='PDF_SANTRI_LOK'){
        const val=(view||'').trim(); if(!val) return {error:`${rules.label||key}: tidak boleh kosong.`};
        tasks.push({start:seg.start, end:seg.end, content:escapeHtml(val)});
        continue;
      }

      // 19‚Äì21: TTD
      if (key==='PDF_REKAP_TTD' || key==='PDF_ALL_TTD' || key==='PDF_SANTRI_TTD'){
        const lines=String(view||'').split('\n');
        const left=(lines[0]||'').trim(); const right=(lines[1]||'').trim();
        if(!left || !right) return {error:`${rules.label||key}: isi 2 baris: baris-1 label kiri, baris-2 label kanan.`};
        tasks.push({start:seg.left.start, end:seg.left.end, content:escapeHtml(left)});
        tasks.push({start:seg.right.start, end:seg.right.end, content:escapeHtml(right)});
        continue;
      }

      // 6: Modal Tambah Santri ‚Äî Jenjang
      if (key==='MODAL_SANTRI_JENJANG'){
        const lines=(view||'').split('\n').map(s=>s.trim());
        const pairs=[];
        for (const line of lines){
          if (!line) continue;
          const mm=line.match(/^([^=]*)=>(.*)$/);
          if(!mm) return {error:`${rules.label||key}: format baris invalid: "${line}". Contoh: A1 => ILA`};
          pairs.push({value:(mm[1]||'').trim(), label:(mm[2]||'').trim()});
        }
        function optLine(value,label){
          const v=String(value).replace(/"/g,'&quot;'); const lbl=escapeHtml(label);
          if (v==='') return `  <option value=""></option>`;
          return `  <option value="${v}">${lbl}</option>`;
        }
        const inner=pairs.map(p=>optLine(p.value,p.label)).join('\n');
        const newInner=(inner?'\n'+inner+'\n  ':'');
        tasks.push({start:seg.innerStart, end:seg.innerEnd, content:newInner});
        continue;
      }

      // 22‚Äì23: UL THMS
      if (key==='THMS_JUZLIST_JUZOVERLAY' || key==='THMS_JUZLIST_MURRANGE'){
        const html=String(view||'').trim();
        tasks.push({start:seg.start, end:seg.end, content:html});
        continue;
      }

      // ABS FLEX (angka 1..6)
      if (key==='ABS_PER_STATUS' || key==='ABS_DEFAULT_TARGET' || key==='ABS_MAX_TARGET'){
        const trimmed = String(view||'').trim();
        const num = Number(trimmed);
        if (!Number.isInteger(num) || num<1 || num>6) return {error:`${rules.label||key}: masukkan bilangan bulat 1..6.`};
        tasks.push({start:seg.start, end:seg.end, content:String(num)});
        continue;
      }
      // ABS FLEX sesiAll (array literal)
      if (key==='ABS_SESI_ALL'){
        const txt = String(view||'').trim();
        if (!/^\[\s*[\s\S]*\]\s*$/.test(txt)) return {error:`${rules.label||key}: isi harus array literal, contoh: ["Subuh","Pagi","Siang","Sore","Malam","Tahajjud"]`};
        tasks.push({start:seg.start, end:seg.end, content:txt});
        continue;
      }
    }

    return {tasks};
  }

  // ===== Helpers =====
  function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function decodeEntities(s){ return s.replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&amp;/g,'&').replace(/&quot;/g,'"').replace(/&#39;/g,"'"); }
  function parseObjectPairs(inner){
    const out={}; (inner.match(/(\d+)\s*:\s*(\d+)/g)||[]).forEach(x=>{ const m=x.match(/(\d+)\s*:\s*(\d+)/); if(m) out[m[1]]=Number(m[2]); });
    return out;
  }
  function parseLinesKeyVal(view){
    const out={}; String(view||'').split('\n').forEach(line=>{
      const m=line.trim().match(/^(\d+)\s*[:=]\s*(\d+)\s*$/); if (m) out[m[1]]=Number(m[2]);
    }); return out;
  }
})();
</script>
<!-- ===== /Modal Editor Parsial ‚Äî Single Block (Revisi Otomatis-Deteksi) ===== -->





<!-- ===== MODE FILTER NIS (card layout mobile + ayat ditumpuk, TANPA scroll di wrapper) ===== -->
<style>
  /* Kolom NIS interaktif */
  #santri-table td.col-nis {
    color: #1E88E5;
    cursor: pointer;
    text-decoration: underline;
    user-select: none;
    white-space: nowrap;
  }
  #santri-table td.col-nis.show-all {
    font-weight: 600;
    text-decoration: none;
  }

  /* Sembunyikan kolom saat mode ringkas (filtered) */
  #santri-table.filtered-compact th.hidden-col,
  #santri-table.filtered-compact td.hidden-col {
    display: none !important;
  }

  /* ===== Wrapper mobile TANPA scroll internal ===== */
  @media (max-width: 768px) {
    .santri-scrollwrap.scroll-on {
      /* tidak ada batas tinggi & tidak ada scroll internal */
      max-height: none;
      overflow-y: visible;

      /* kosmetik tetap boleh */
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 10px;
      overflow-x: hidden; /* cegah geser kiri-kanan */
      background: #fff;
      display: block;
      box-sizing: border-box;
    }
    .santri-scrollwrap.scroll-on > table {
      width: 100%;
      margin: 0;
      table-layout: auto;
    }
  }

  /* Bar kontrol filter */
  .nis-filter-bar {
    display: none;
    margin: 8px 0 6px;
    padding: 8px 12px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    background: #f9fafb;
    font-size: 14px;
    line-height: 1.4;
  }
  .nis-filter-bar.show { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
  .nis-filter-bar .label { opacity: .8; }
  .nis-filter-bar .btn-clear {
    padding: 6px 10px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    background: #1E88E5;
    color: #fff;
    cursor: pointer;
  }

  /* ===== CARD LAYOUT MOBILE (saat filtered) ===== */
  @media (max-width: 768px) {
    #santri-table.filtered-compact.card-mobile { border-collapse: separate; border-spacing: 0; }
    #santri-table.filtered-compact.card-mobile thead { display: none !important; }

    #santri-table.filtered-compact.card-mobile tbody {
      padding: 2px 0;
      display: block;
    }

    /* Kartu center presisi */
    #santri-table.filtered-compact.card-mobile tbody tr {
      display: block;
      box-sizing: border-box;
      width: min(680px, 100% - 24px);
      margin: 10px auto;      /* center kiri-kanan */
      padding: 12px;
      border: 1px solid #eee;
      border-radius: 10px;
      background: #fff;
      box-shadow: 0 1px 6px rgba(0,0,0,.03);
    }

    /* KV row (label: nilai) */
    #santri-table.filtered-compact.card-mobile tbody td:not(.hidden-col) {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 0;
      white-space: normal;
      border-bottom: 1px solid #f2f2f2;
    }
    #santri-table.filtered-compact.card-mobile tbody tr td:not(.hidden-col):last-of-type {
      border-bottom: 0;
      padding-bottom: 0;
    }
    #santri-table.filtered-compact.card-mobile tbody td:not(.hidden-col)::before {
      content: attr(data-label) ":";
      flex: 0 0 44%;
      font-weight: 600;
      opacity: .85;
    }
    #santri-table.filtered-compact.card-mobile tbody td:not(.hidden-col) > * { max-width: 100%; }

    /* Tumpuk AYAT di bawah SURAH */
    #santri-table.filtered-compact.card-mobile tbody td[data-label="Setor Dari"],
    #santri-table.filtered-compact.card-mobile tbody td[data-label="Setor Sampai"]{
      display: block;
      padding: 10px 0;
    }
    #santri-table.filtered-compact.card-mobile tbody td[data-label="Setor Dari"]::before,
    #santri-table.filtered-compact.card-mobile tbody td[data-label="Setor Sampai"]::before{
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      opacity: .85;
      content: attr(data-label) ":";
    }
    #santri-table.filtered-compact.card-mobile tbody td[data-label="Setor Dari"] select,
    #santri-table.filtered-compact.card-mobile tbody td[data-label="Setor Sampai"] select{
      display: block;
      width: 100%;
      min-height: 42px;
    }
    #santri-table.filtered-compact.card-mobile tbody td[data-label="Setor Dari"] select.ayat-dari,
    #santri-table.filtered-compact.card-mobile tbody td[data-label="Setor Sampai"] select.ayat-sampai{
      margin-top: 8px;
    }
  }

  /* offset kalau ada header sticky (opsional) */
  .santri-scrollwrap { scroll-margin-top: 64px; }
</style>

<script>
(function(){
  const STORAGE_KEY = 'nisFilterState.v2'; // {mode:'filtered'|'all', nis?:string}
  let bodyObserver = null;
  let headObserver = null;

  function getTable(){ return document.getElementById('santri-table'); }
  function getTBody(tbl){ return tbl && tbl.tBodies ? tbl.tBodies[0] : null; }

  function ensureWrapper(){
    const tbl = getTable();
    if (!tbl) return null;
    let wrap = tbl.closest('.santri-scrollwrap');
    if (wrap) return wrap;
    wrap = document.createElement('div');
    wrap.className = 'santri-scrollwrap';
    wrap.setAttribute('role','region');
    wrap.setAttribute('aria-label','Daftar santri');
    tbl.parentNode.insertBefore(wrap, tbl);
    wrap.appendChild(tbl);
    return wrap;
  }

  function ensureFilterBar(){
    const wrap = ensureWrapper();
    if (!wrap) return null;
    let bar = wrap.previousElementSibling;
    if (!bar || !bar.classList.contains('nis-filter-bar')){
      bar = document.createElement('div');
      bar.className = 'nis-filter-bar';
      bar.innerHTML = `
        <span class="label">NIS:</span>
        <strong class="nis"></strong>
        <button type="button" class="btn-clear">Tampilkan Semua Santri</button>
      `;
      wrap.parentNode.insertBefore(bar, wrap);
    }
    return bar;
  }

  function saveState(s){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }catch{} }
  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return null;
      const s = JSON.parse(raw);
      if (s && (s.mode==='filtered' || s.mode==='all')) return s;
    }catch{}
    return null;
  }

  // Mode ringkas: kolom yang ditampilkan
  function computeCompactColumns(){
    const tbl = getTable();
    const thead = tbl ? tbl.tHead : null;
    if (!thead) return { keepIdx: new Set(), hideIdx: new Set() };

    const wantedLabels = new Set([
      'nama','presensi','setor dari','setor sampai','nilai',
      'murajaah','setting murajaah','setting thms'
    ]);

    const ths = Array.from(thead.rows[0].cells);
    const keepIdx = new Set();

    ths.forEach((th, idx) => {
      const label = th.textContent.trim().toLowerCase();
      const isWantedByLabel   = wantedLabels.has(label);
      const isSettingMurById  = th.id === 'murRangeHeader';
      const isMurajaahByClass = th.classList.contains('mur-header');
      const isTHMSById        = th.id === 'totalAllJuzHeader';
      if (isWantedByLabel || isSettingMurById || isMurajaahByClass || isTHMSById){
        keepIdx.add(idx);
      }
    });

    const hideIdx = new Set();
    ths.forEach((_, idx) => { if (!keepIdx.has(idx)) hideIdx.add(idx); });
    return { keepIdx, hideIdx };
  }

  function setCardLabels(){
    const tbl = getTable();
    if (!tbl || !tbl.tHead) return;
    const headers = Array.from(tbl.tHead.rows[0].cells).map(th => th.textContent.trim());
    const tb = getTBody(tbl); if (!tb) return;

    Array.from(tb.rows).forEach(tr => {
      const tds = Array.from(tr.cells);
      tds.forEach((td, idx) => {
        if (!td.classList.contains('hidden-col')) td.setAttribute('data-label', headers[idx] || '');
      });
    });
  }

  function updateMobileCardMode(){
    const tbl = getTable(); if (!tbl) return;
    const isCompact = !!tbl.dataset.nisFilter;
    const isMobile = window.innerWidth <= 768;
    if (isCompact && isMobile){ tbl.classList.add('card-mobile'); setCardLabels(); }
    else { tbl.classList.remove('card-mobile'); }
  }

  function setColumnVisibility(compactOn){
    const tbl = getTable(); if (!tbl || !tbl.tHead) return;
    const { hideIdx } = computeCompactColumns();
    const ths = Array.from(tbl.tHead.rows[0].cells);
    const tb = getTBody(tbl); const rows = tb ? Array.from(tb.rows) : [];

    ths.forEach((th, idx)=>{ if (hideIdx.has(idx)) th.classList.toggle('hidden-col', !!compactOn); else th.classList.remove('hidden-col'); });
    rows.forEach(tr=>{
      const tds = Array.from(tr.cells);
      tds.forEach((td, idx)=>{ if (hideIdx.has(idx)) td.classList.toggle('hidden-col', !!compactOn); else td.classList.remove('hidden-col'); });
    });

    tbl.classList.toggle('filtered-compact', !!compactOn);
    updateMobileCardMode();
  }

  function resetNISFilter(tbl){
    if (!tbl) tbl = getTable();
    const tbody = getTBody(tbl); if (!tbody) return;

    [...tbody.rows].forEach(tr=>{
      tr.style.display = '';
      const cell = tr.querySelector('td.col-nis');
      if (cell){
        if (cell.dataset.originalNis){ cell.textContent = cell.dataset.originalNis; delete cell.dataset.originalNis; }
        cell.classList.remove('show-all');
      }
    });
    delete tbl.dataset.nisFilter;
    saveState({ mode: 'all' });

    const wrap = ensureWrapper(); if (wrap) wrap.classList.add('scroll-on'); /* kelas tetap dipakai utk styling, tapi tanpa scroll */
    setColumnVisibility(false);

    const bar = ensureFilterBar(); if (bar){ bar.classList.remove('show'); bar.querySelector('.nis').textContent = ''; }
  }

  function applyNISFilter(tbl, nisText){
    if (!tbl) return false;
    const tbody = getTBody(tbl); if (!tbody) return false;

    let found = false;
    tbl.dataset.nisFilter = nisText;

    [...tbody.rows].forEach(tr=>{
      const cell = tr.querySelector('td.col-nis');
      const val  = cell ? String(cell.dataset.originalNis || cell.textContent).trim() : '';
      const match = (val === nisText);
      tr.style.display = match ? '' : 'none';
      if (match && cell){
        if (!cell.dataset.originalNis) cell.dataset.originalNis = val;
        cell.textContent = 'Tampilkan Semua Santri';
        cell.classList.add('show-all');
        found = true;
      }
    });

    if (found){
      saveState({ mode: 'filtered', nis: nisText });

      const wrap = ensureWrapper();
      if (wrap){
        wrap.classList.add('scroll-on');      /* tetap pakai styling, namun tanpa overflow */
        wrap.scrollTop = 0;
      }
      setColumnVisibility(true);

      const bar = ensureFilterBar();
      if (bar){ bar.classList.add('show'); bar.querySelector('.nis').textContent = nisText; }
    } else {
      resetNISFilter(tbl);
    }
    return found;
  }

  function applyStateIfAny(){
    const tbl = getTable(); const tbody = getTBody(tbl);
    if (!tbl || !tbody) return;
    const state = loadState(); if (!state) return;
    if (!tbody.rows.length) return;

    if (state.mode === 'filtered' && state.nis){ applyNISFilter(tbl, state.nis); }
    else { resetNISFilter(tbl); }
  }

  function ensureBodyObserver(){
    const tbl = getTable(); const tbody = getTBody(tbl);
    if (!tbl || !tbody) return;

    if (bodyObserver) bodyObserver.disconnect();
    bodyObserver = new MutationObserver(() => { applyStateIfAny(); });
    bodyObserver.observe(tbody, { childList:true });
  }

  function ensureHeadObserver(){
    const tbl = getTable(); const thead = tbl && tbl.tHead;
    if (!tbl || !thead) return;

    if (headObserver) headObserver.disconnect();
    headObserver = new MutationObserver(() => {
      if (tbl.dataset.nisFilter){ setColumnVisibility(true); setCardLabels(); }
    });
    headObserver.observe(thead, { childList:true, subtree:true });
  }

  document.addEventListener('click', (e)=>{
    const btnClear = e.target && e.target.closest && e.target.closest('.nis-filter-bar .btn-clear');
    if (btnClear){ resetNISFilter(getTable()); return; }

    const cell = e.target && e.target.closest && e.target.closest('#santri-table td.col-nis');
    if (!cell) return;
    const tbl = getTable(); if (!tbl) return;

    const isFiltered = !!tbl.dataset.nisFilter;
    if (isFiltered && cell.classList.contains('show-all')){ resetNISFilter(tbl); return; }

    const nisText = String(cell.dataset.originalNis || cell.textContent).trim();
    if (!nisText) return;
    applyNISFilter(tbl, nisText);
  });

  window.addEventListener('resize', () => updateMobileCardMode());

  if (document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', init); }
  else { init(); }

  function init(){
    ensureWrapper();
    ensureFilterBar();
    ensureBodyObserver();
    ensureHeadObserver();
    applyStateIfAny();

    // guard bila tbody render belakangan
    let tries = 0;
    const i = setInterval(()=>{
      tries++;
      const tbl = getTable(), tbody = getTBody(tbl);
      if (tbl && tbody && tbody.rows.length){
        ensureWrapper(); ensureFilterBar(); ensureBodyObserver(); ensureHeadObserver(); applyStateIfAny();
        clearInterval(i);
      }
      if (tries > 20) clearInterval(i);
    }, 100);
  }

  window.resetNISFilter = resetNISFilter;
})();
</script>


<script>
/* === [GRAFIK PROSENTASE THMS ‚Äî PER HALAQOH + CACHING PER TANGGAL (PERMANEN) + REFRESH + PDF] === */
(function grafikTHMS_boot(){
  // ---- util: tunggu DOM siap
  function onReady(fn){
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', fn, { once:true });
    } else fn();
  }
  // ---- util: tunggu sampai .pdf-rekap-controls benar2 ada (untuk halaman dinamis/SPA)
  function whenControlsExist(fn){
    const el = document.querySelector('.pdf-rekap-controls');
    if (el) return fn();
    const mo = new MutationObserver(()=>{
      const ok = document.querySelector('.pdf-rekap-controls');
      if (ok) { mo.disconnect(); fn(); }
    });
    mo.observe(document.documentElement, { childList:true, subtree:true });
    setTimeout(()=>mo.disconnect(), 10000); // fail-safe
  }

  onReady(()=> whenControlsExist(initGrafikTHMS));

  function initGrafikTHMS(){
    const wrap = document.querySelector('.pdf-rekap-controls');
    if (!wrap) return console.warn('[THMS] .pdf-rekap-controls tidak ditemukan');
    if (document.getElementById('btn-graph-thms')) return; // cegah duplikat

    // ===== Tombol pemicu (Overlay)
    const btn = document.createElement('button');
    btn.id = 'btn-graph-thms';
    btn.className = 'rekap-btn';
    btn.style.background = '#16a34a';
    btn.textContent = 'Live Grafik';
    wrap.appendChild(btn);

    // ===== Tombol PDF
    const btnPdf = document.createElement('button');
    btnPdf.id = 'btn-graph-thms-pdf';
    btnPdf.className = 'rekap-btn';
    btnPdf.style.background = '#0ea5e9';
    btnPdf.textContent = 'PDF Grafik';
    wrap.appendChild(btnPdf);

    // ===== Style overlay (center)
    if (!document.getElementById('thms-ov-style')) {
      const s = document.createElement('style');
      s.id = 'thms-ov-style';
      s.textContent = `
        .thms-ov{position:fixed; inset:0; z-index:9999; display:none; background:rgba(0,0,0,.5); align-items:center; justify-content:center; padding:16px}
        .thms-ov[style*="display: block"]{ display:flex !important; }
        .thms-sheet{position:relative; width:min(980px,94vw); max-height:90vh; overflow:auto; background:#fff; border-radius:16px; box-shadow:0 20px 50px rgba(0,0,0,.25); padding:14px}
        .thms-handle{width:56px;height:5px;background:#e5e7eb;border-radius:999px;margin:2px auto 8px}
        .thms-header{display:flex;align-items:center;justify-content:space-between;gap:10px}
        .thms-title{font-weight:800;font-size:18px;color:#111827}
        .thms-sub{color:#4b5563;font-size:13px;margin-top:2px}
        .thms-actions{display:flex;gap:8px;align-items:center}
        .thms-btn{border:none;border-radius:10px;padding:.5rem .8rem;cursor:pointer;font-weight:700}
        .thms-close{background:#ef4444;color:#fff}
        .thms-refresh{background:#2563eb;color:#fff}
        .thms-cards{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
        @media (min-width:640px){ .thms-cards{grid-template-columns:repeat(5,1fr)} }
        .thms-card{background:#f9fafb;border:1px solid #e5e7eb;border-radius:12px;padding:10px}
        .thms-card .t{font-size:12px;color:#6b7280}
        .thms-card .v{font-weight:800;font-size:18px;color:#111827}
        .thms-chart{margin-top:10px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:10px}
        .thms-list{margin-top:12px;display:flex;flex-direction:column;gap:8px}
        .thms-item{border:1px solid #e5e7eb;border-radius:10px;padding:8px;background:#fff}
        .thms-item .row{display:flex;justify-content:space-between;align-items:center;gap:8px}
        .thms-item .name{font-weight:700;color:#111827}
        .thms-item .pct{font-variant-numeric:tabular-nums;font-weight:800}
        .thms-progress{height:8px;background:#f3f4f6;border-radius:999px;overflow:hidden;margin-top:6px}
        .thms-progress > span{display:block;height:100%;background:#3b82f6}
        .thms-cache-flag{font-size:11px;color:#059669;font-weight:700;margin-left:6px}
        .thms-hide{position:absolute;left:-99999px;top:-99999px;width:960px;height:280px;pointer-events:none;opacity:0}
      `;
      document.head.appendChild(s);
    }

    // ===== Overlay DOM (Tanpa tab Jenjang) + tombol Refresh
    function ensureOverlay(){
      if (document.getElementById('thmsOverlay')) return;
      const el = document.createElement('div');
      el.id = 'thmsOverlay';
      el.className = 'thms-ov';
      el.innerHTML = `
        <div class="thms-sheet" role="dialog" aria-modal="true" aria-labelledby="thmsTitleMain">
          <div class="thms-handle"></div>
          <div class="thms-header">
            <div>
              <div class="thms-title">
                <span id="thmsTitleMain">Live Grafik</span>
                <span id="thmsTitleMode">‚Äî Per Halaqoh (Ustadz)</span>
                <span id="thmsCacheFlag" class="thms-cache-flag" style="display:none">(cache)</span>
              </div>
              <div id="thmsSub" class="thms-sub"></div>
            </div>
            <div class="thms-actions">
              <button id="thmsRefresh" class="thms-btn thms-refresh" title="Perbarui data untuk tanggal ini">Perbaharui</button>
              <button id="thmsClose" class="thms-btn thms-close">Tutup</button>
            </div>
          </div>

          <div class="thms-cards">
            <div class="thms-card"><div id="thmsCardKelompokTitle" class="t">Total Halaqoh</div><div id="thmsCardKelompok" class="v">-</div></div>
            <div class="thms-card"><div class="t">Total Santri</div><div id="thmsCardSantri" class="v">-</div></div>
            <div class="thms-card"><div class="t">Rata-rata Global</div><div id="thmsCardAvg" class="v">-</div></div>
            <div class="thms-card"><div class="t">Tuntas</div><div id="thmsCardTuntas" class="v">-</div></div>
            <div class="thms-card"><div class="t">Belum Tuntas</div><div id="thmsCardBelum" class="v">-</div></div>
            <div class="thms-card"><div class="t">Khatam</div><div id="thmsCardKhatam" class="v">-</div></div>
          </div>

          <div class="thms-chart"><canvas id="thmsChart" height="160"></canvas></div>
          <div id="thmsList" class="thms-list"></div>
        </div>
      `;
      document.body.appendChild(el);

      const close = ()=> el.style.display='none';
      document.addEventListener('keydown', (e)=>{
        if (el.style.display==='block' && (e.key==='Escape' || e.key==='Esc')) {
          e.stopPropagation(); e.preventDefault();
        }
      }, true);
      el.querySelector('#thmsClose').addEventListener('click', close);
    }

    async function ensureChartJS(){
      if (window.Chart) return;
      await new Promise((res, rej)=>{
        const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js';
        s.onload=res; s.onerror=()=>rej(new Error('Gagal memuat Chart.js'));
        document.head.appendChild(s);
      });
    }
    async function ensureJsPDF(){
      if (window.jspdf?.jsPDF) return;
      await new Promise((res, rej)=>{
        const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';
        s.onload=res; s.onerror=()=>rej(new Error('Gagal memuat jsPDF'));
        document.head.appendChild(s);
      });
    }

    // ====== Caching helpers ‚Äî PERMANEN per rentang tanggal (tidak pakai TTL)
    const CACHE_NS = 'THMS_GRAPH_V6KEY';
    function fingerprintKeys(keys){ return keys.slice().map(String).sort().join('|'); }
    function makeBaseKey(start, end, kelasKeys){ return `${CACHE_NS}|${start}|${end}|${fingerprintKeys(kelasKeys)}`; }
    function cacheLoad(baseKey, mode){
      try{
        const raw = localStorage.getItem(`${baseKey}|${mode}`);
        if (!raw) return null;
        const obj = JSON.parse(raw);
        return (obj && obj.payload) ? obj.payload : null;
      }catch(e){ return null; }
    }
    function cacheSave(baseKey, mode, payload){
      try{ localStorage.setItem(`${baseKey}|${mode}`, JSON.stringify({ t: Date.now(), payload })); }catch(e){}
    }

    // ===== Helper daftar kelas (aman)
    function getAllKelasKeysSafe(){
      if (typeof _getAllKelasKeys === 'function') {
        const k = _getAllKelasKeys();
        if (Array.isArray(k) && k.length) return k;
      }
      if (Array.isArray(window.ALL_KELAS_KEYS) && window.ALL_KELAS_KEYS.length){
        return [...new Set(window.ALL_KELAS_KEYS.map(String))];
      }
      const el = (typeof kelasSelect !== 'undefined' && kelasSelect)
               ? kelasSelect
               : (document.getElementById('kelasSelect') || document.getElementById('kelas'));
      let keys = [];
      if (el?.options?.length) keys = [...el.options].map(o=>o.value).filter(Boolean);
      const custom = window.namaKelasCustom || window.NAMA_KELAS_CUSTOM;
      if (!keys.length && custom && typeof custom==='object') keys = Object.keys(custom);
      if (!keys.length && el?.value) keys = [el.value];
      keys = [...new Set(keys.map(String))].sort((a,b)=>{
        const na = +(String(a).match(/(\d+)/)?.[1]||1e9);
        const nb = +(String(b).match(/(\d+)/)?.[1]||1e9);
        return na-nb || String(a).localeCompare(String(b),'id');
      });
      if (keys.length) window.ALL_KELAS_KEYS = keys;
      return keys;
    }

    // ===== Label kelas (ustadz)
    function getKelasLabel(k){
      const el = (typeof kelasSelect !== 'undefined' && kelasSelect)
               ? kelasSelect
               : (document.getElementById('kelasSelect') || document.getElementById('kelas'));
      const opt = el ? [...el.options].find(o=>o.value===k) : null;
      if (opt && opt.textContent) return opt.textContent.trim();
      const custom = window.namaKelasCustom || window.NAMA_KELAS_CUSTOM || {};
      if (custom[k]) return String(custom[k]);
      if (typeof _kelasKelompokLineFor === 'function') {
        return _kelasKelompokLineFor(k)?.line?.replace(/^Halaqoh:\s*/,'') || k;
      }
      return k;
    }

    // ===== Roster & whitelist
    async function getRosterForClass(kelasKey){
      const r = await fetch(`/api/getSantri?kelas=${encodeURIComponent(kelasKey)}&t=${Date.now()}`).catch(()=>null);
      const roster = await r?.json().catch(()=>[]);
      return Array.isArray(roster) ? roster : [];
    }
    function makeAllowSet(roster){
      // Set kunci untuk FILTER (boleh gandakan id+nis)
      if (typeof buildRosterWhitelist === 'function') return buildRosterWhitelist(roster);
      const allow = new Set();
      for (const s of (roster||[])) {
        const nis = (s?.nis===0 || s?.nis) ? String(s.nis).trim() : "";
        const id  = (s?.id===0  || s?.id)  ? String(s.id).trim()  : "";
        if (nis) allow.add(nis);
        if (id)  allow.add(id);
      }
      return allow;
    }
    // >>> BARU: hitung SANTRI UNIK (pakai id; kalau kosong, fallback nis)
    function countUniqueRoster(roster){
      const uniq = new Set();
      for (const s of (roster||[])){
        const hasId  = (s?.id===0  || s?.id);
        const hasNis = (s?.nis===0 || s?.nis);
        if (hasId)  uniq.add('id:'  + String(s.id).trim());
        else if (hasNis) uniq.add('nis:' + String(s.nis).trim());
        // kalau dua-duanya kosong, skip
      }
      return uniq.size;
    }

    // ===== Fallback: agregat D1 + roster (TERFILTER whitelist)
    async function fetchAggOnlyRows(kelasKey, startDate, endDate){
      const url = `/api/getAbsensiRange?kelas=${encodeURIComponent(kelasKey)}&start=${encodeURIComponent(startDate)}&end=${encodeURIComponent(endDate)}&aggregate=1&t=${Date.now()}`;
      const r1  = await fetch(url).catch(()=>null);
      const j1  = await r1?.json().catch(()=>null);
      if (!j1 || !j1.aggregate || !Array.isArray(j1.list)) return [];

      const roster = await getRosterForClass(kelasKey);
      const allow  = makeAllowSet(roster);
      const byNis = new Map(), byId = new Map();
      for (const s of roster){
        const nis = (s?.nis===0 || s?.nis) ? String(s.nis).trim() : "";
        const id  = (s?.id===0  || s?.id)  ? String(s.id).trim()  : "";
        if (nis) byNis.set(nis, s);
        if (id)  byId.set(id, s);
      }

      const out = [];
      for (const it of j1.list){
        const key = String(it?.key||'').trim();
        if (!key || !allow.has(key)) continue;
        const totalJuz = Number(it?.totalJuz || it?.total_juz_num || 0);
        const s = byNis.get(key) || byId.get(key) || {};
        out.push({
          totalJuz,
          semester: (s?.semester!=null) ? Number(s.semester) : null,
          jenjang : s?.jenjang ?? null
        });
      }
      return out;
    }

    // ===== Ambil rows per kelas (universal + fallback) ‚Äî TERFILTER whitelist
    async function getRowsForClass(kelasKey, startDate, endDate){
      const roster = await getRosterForClass(kelasKey);
      const allow  = makeAllowSet(roster);

      if (typeof collectRekapDataForClass === 'function') {
        const data = await collectRekapDataForClass(kelasKey, startDate, endDate).catch(()=>null);
        if (data?.rows?.length) {
          return data.rows
            .filter(r => {
              const key = (r?.nis && String(r.nis).trim())
                       || (r?.id  && String(r.id).trim())
                       || '';
              return key && allow.has(key);
            })
            .map(r => ({
              totalJuz: Number(r.totalJuz||0),
              semester: r.semester,
              jenjang : r.jenjang
            }));
        }
      }
      return await fetchAggOnlyRows(kelasKey, startDate, endDate).catch(()=>[]);
    }

    // Quick helper: percent
    function getPercent(r){
      if (typeof PDF_totalAllJuzStatus==='function'){
        return PDF_totalAllJuzStatus(Number(r.totalJuz||0), r.semester)?.percent || 0;
      }
      if (typeof PDF_percentCapaian==='function'){
        return PDF_percentCapaian(Number(r.totalJuz||0), r.semester) || 0;
      }
      return 0;
    }

    // ======= Komputasi: Per Halaqoh (kelas) ‚Äî FIX hitung santri unik (bukan jumlah key)
    async function computeByKelas(startDate, endDate, kelasKeys){
      const rows = [];
      for (const k of kelasKeys){
        // Ambil paralel: data capaian + roster
        const [rowsKelas, roster] = await Promise.all([
          getRowsForClass(k, startDate, endDate).catch(()=>[]),
          getRosterForClass(k).catch(()=>[])
        ]);

        const rosterCount = countUniqueRoster(roster); // <<< INI FIX UTAMA
        let sum=0, kh=0, tn=0, present=0;

        for (const r of rowsKelas){
          const pct = getPercent(r);
          const isKhatam = Number(r.totalJuz||0) >= 30;
          const isTuntas = !isKhatam && pct >= 100;
          sum += pct;
          present++;
          if (isKhatam) kh++; else if (isTuntas) tn++;
        }

        const denom = rosterCount || present; // fallback jika roster kosong
        const belum = Math.max(0, (rosterCount || 0) - tn - kh); // <<< BARU: santri belum tuntas per halaqoh

        rows.push({
          label       : getKelasLabel(k),
          avg         : denom ? (sum / denom) : 0,
          khatam      : kh,
          tuntas      : tn,
          belumTuntas : belum,
          count       : rosterCount,  // "Total Santri" = santri unik
          present     : present       // info tambahan (aktif)
        });
      }
      rows.sort((a,b)=> a.label.localeCompare(b.label, 'id'));
      return { rows, startDate, endDate, mode: 'kelas' };
    }

    // ======= Chart ctx guard
    function getChartCtx(){
      const c = document.getElementById('thmsChart');
      const ctx = c && c.getContext && c.getContext('2d');
      if (!ctx) throw new Error('Canvas context tidak tersedia');
      return ctx;
    }

    // ======= Render (hanya mode Kelas)
    let _chart = null;
    function renderView(payload, fromCache=false){
      const { rows, startDate, endDate } = payload;
      const ov = document.getElementById('thmsOverlay');
      ov.style.display = 'block';

      document.getElementById('thmsTitleMode').textContent = '‚Äî Per Halaqoh (Ustadz)';
      const fmt = (window.fmtD_M_YYYY || (x=>x));
      document.getElementById('thmsSub').textContent = `Periode Tahfiz: ${fmt(startDate)} s.d. ${fmt(endDate)}`;
      document.getElementById('thmsCacheFlag').style.display = fromCache ? '' : 'none';

      document.getElementById('thmsCardKelompokTitle').textContent = 'Total Halaqoh';

      const totalGroupsShown = rows.length;
      const totalSantri = rows.reduce((s,r)=>s+r.count,0);
      const totalKhatam = rows.reduce((s,r)=>s+r.khatam,0);
      const totalTuntas = rows.reduce((s,r)=>s+r.tuntas,0);
      const totalBelumTuntas = rows.reduce(
        (s,r)=> s + (r.belumTuntas ?? Math.max(0,(r.count||0)-(r.tuntas||0)-(r.khatam||0))),
        0
      );
      const avgGlobal   = rows.length ? Math.round(rows.reduce((s,r)=>s+r.avg,0)/rows.length) : 0;

      document.getElementById('thmsCardKelompok').textContent = totalGroupsShown;
      document.getElementById('thmsCardSantri').textContent   = totalSantri;
      document.getElementById('thmsCardAvg').textContent      = `${avgGlobal}%`;
      document.getElementById('thmsCardTuntas').textContent   = totalTuntas;
      document.getElementById('thmsCardBelum').textContent    = totalBelumTuntas;
      document.getElementById('thmsCardKhatam').textContent   = totalKhatam;

      const labels = rows.map(r=>r.label);
      const data   = rows.map(r=>Math.round(r.avg));
      const ctx    = getChartCtx();
      if (_chart) { _chart.destroy(); _chart=null; }
      _chart = new Chart(ctx, {
        type:'bar',
        data:{ labels, datasets:[{ label:'Rata-rata THMS (%)', data }] },
        options:{
          responsive:true, maintainAspectRatio:false,
          scales:{ y:{ beginAtZero:true, max:100, ticks:{ stepSize:10 } } },
          plugins:{
            legend:{ display:false },
            tooltip:{ callbacks:{ footer:(items)=>{
              const i = items[0].dataIndex, r = rows[i];
              const belum = r.belumTuntas ?? Math.max(0,(r.count||0)-(r.tuntas||0)-(r.khatam||0));
              return `Santri: ${r.count} (aktif: ${r.present}) | Tuntas: ${r.tuntas} | Belum: ${belum} | Khatam: ${r.khatam}`;
            }}}
          }
        }
      });

      const list = document.getElementById('thmsList');
      list.innerHTML = '';
      rows.forEach(r=>{
        const pct = Math.round(r.avg);
        const belum = r.belumTuntas ?? Math.max(0,(r.count||0)-(r.tuntas||0)-(r.khatam||0));
        const item = document.createElement('div');
        item.className = 'thms-item';
        item.innerHTML = `
          <div class="row">
            <div class="name">${r.label}</div>
            <div class="pct">${pct}%</div>
          </div>
          <div class="thms-progress"><span style="width:${Math.min(100, Math.max(0, pct))}%"></span></div>
          <div class="thms-sub" style="margin-top:4px">
            Santri: ${r.count} ¬∑ Aktif: ${r.present} ¬∑ Tuntas: ${r.tuntas} ¬∑ Belum Tuntas: ${belum} ¬∑ Khatam: ${r.khatam}
          </div>
        `;
        list.appendChild(item);
      });
    }

    // ======= State untuk refresh
    let _lastStart = null, _lastEnd = null, _lastKelasKeys = null;

    // ======= Compute helper (pakai cache atau paksa fresh)
    function makeBaseFromInputs(){
      const startDate = _lastStart ?? document.querySelector('#pdf-start-date')?.value;
      const endDate   = _lastEnd   ?? document.querySelector('#pdf-end-date')?.value;
      if (!startDate || !endDate) throw new Error('Mohon pilih tanggal mulai & akhir.');
      const kelasKeys = _lastKelasKeys ?? getAllKelasKeysSafe();
      if (!kelasKeys.length) throw new Error('Tidak menemukan daftar kelas.');
      const baseKey = makeBaseKey(startDate, endDate, kelasKeys);
      return { baseKey, startDate, endDate, kelasKeys };
    }

    async function computeMaybeCached({ forceFresh = false } = {}){
      const { baseKey, startDate, endDate, kelasKeys } = makeBaseFromInputs();
      let payload = !forceFresh ? cacheLoad(baseKey, 'kelas') : null;
      if (!payload){
        payload = await computeByKelas(startDate, endDate, kelasKeys);
        cacheSave(baseKey, 'kelas', payload);
      }
      _lastStart = startDate; _lastEnd = endDate; _lastKelasKeys = kelasKeys;
      return { payload, fromCache: !forceFresh && !!cacheLoad(baseKey, 'kelas') };
    }

    // ======= Click handler Overlay
    async function openOverlay(){
      btn.disabled = true; btn.textContent = 'Memuat grafik‚Ä¶';
      try{
        ensureOverlay(); await ensureChartJS();
        const { payload, fromCache } = await computeMaybeCached({ forceFresh:false });
        renderView(payload, fromCache);

        // Bind tombol Refresh (sekali saja)
        const refBtn = document.getElementById('thmsRefresh');
        if (!refBtn.dataset.bound){
          refBtn.dataset.bound = '1';
          refBtn.addEventListener('click', async ()=>{
            const prev = refBtn.textContent;
            refBtn.disabled = true; refBtn.textContent = 'Menyegarkan‚Ä¶';
            try{
              const { payload } = await computeMaybeCached({ forceFresh:true });
              renderView(payload, false);
              document.getElementById('thmsCacheFlag').style.display = 'none';
            } catch(e){
              console.error(e);
              alert('Gagal menyegarkan data: ' + (e.message||e));
            } finally {
              refBtn.disabled = false; refBtn.textContent = prev;
            }
          });
        }
      } catch(e){
        console.error(e);
        alert('Gagal menampilkan grafik: ' + (e.message||e));
      } finally {
        btn.disabled = false; btn.textContent = 'Live Grafik';
      }
    }

    // ======= PDF: render chart offscreen + generate PDF
    function makeHiddenCanvas(){
      const c = document.createElement('canvas');
      c.width = 1200; c.height = 360; // resolusi bagus untuk PDF
      c.className = 'thms-hide';
      document.body.appendChild(c);
      return c;
    }
    function destroyCanvas(c){ try{ c.remove(); }catch(_){} }

    async function buildChartImage(rows){
      await ensureChartJS();
      const labels = rows.map(r=>r.label);
      const data   = rows.map(r=>Math.round(r.avg));
      const c = makeHiddenCanvas();
      const ctx = c.getContext('2d');
      const chart = new Chart(ctx, {
        type:'bar',
        data:{ labels, datasets:[{ label:'Rata-rata THMS (%)', data }] },
        options:{
          animation:false, responsive:false, maintainAspectRatio:false,
          scales:{ y:{ beginAtZero:true, max:100, ticks:{ stepSize:10 } } },
          plugins:{ legend:{ display:false } }
        }
      });
      // pastikan sudah render
      await new Promise(r=>requestAnimationFrame(()=>r()));
      const img = chart.toBase64Image('image/png', 1.0);
      chart.destroy();
      destroyCanvas(c);
      return img;
    }

    async function downloadPdf(){
      // tombol state
      const prev = btnPdf.textContent;
      btnPdf.disabled = true; btnPdf.textContent = 'Menyusun PDF‚Ä¶';
      try{
        await ensureJsPDF();
        const { jsPDF } = window.jspdf;
        const { payload, fromCache } = await computeMaybeCached({ forceFresh:false });
        const { rows, startDate, endDate } = payload;

        // kartu ringkas
        const totalGroupsShown = rows.length;
        const totalSantri = rows.reduce((s,r)=>s+r.count,0);
        const totalKhatam = rows.reduce((s,r)=>s+r.khatam,0);
        const totalTuntas = rows.reduce((s,r)=>s+r.tuntas,0);
        const totalBelumTuntas = rows.reduce(
          (s,r)=> s + (r.belumTuntas ?? Math.max(0,(r.count||0)-(r.tuntas||0)-(r.khatam||0))),
          0
        );
        const avgGlobal   = rows.length ? Math.round(rows.reduce((s,r)=>s+r.avg,0)/rows.length) : 0;

        const chartImg = await buildChartImage(rows);

        // PDF A4 portrait
        const doc = new jsPDF({ unit:'pt', format:'a4', compress:true });
        const pageW = doc.internal.pageSize.getWidth();
        const margin = 36;

        // Header
        doc.setFont('helvetica','bold'); doc.setFontSize(14);
        doc.text('Live Grafik THMS ‚Äî Per Halaqoh (Ustadz)', margin, 40);
        doc.setFont('helvetica','normal'); doc.setFontSize(11);
        const fmt = (window.fmtD_M_YYYY || (x=>x));
        doc.text(`Periode Tahfiz: ${fmt(startDate)} s.d. ${fmt(endDate)}${fromCache?'  (cache)':''}`, margin, 58);

        // Kartu ringkas (grid 6 kolom)
        const yCardsTop = 78, hCard = 48, gap = 10, cols = 6;
        const colW = (pageW - margin*2 - gap*(cols-1)) / cols;
        const cards = [
          ['Total Halaqoh', String(totalGroupsShown)],
          ['Total Santri', String(totalSantri)],
          ['Rata-rata Global', `${avgGlobal}%`],
          ['Tuntas', String(totalTuntas)],
          ['Belum Tuntas', String(totalBelumTuntas)],
          ['Khatam', String(totalKhatam)],
        ];
        doc.setDrawColor(230); doc.setLineWidth(0.8);
        cards.forEach((c, i)=>{
          const x = margin + i*(colW+gap);
          doc.setFillColor(249,250,251); // f9fafb
          doc.roundedRect(x, yCardsTop, colW, hCard, 6, 6, 'FD');
          doc.setFontSize(9); doc.setTextColor(107,114,128); // slate-500
          doc.text(c[0], x+10, yCardsTop+18);
          doc.setTextColor(17,24,39); doc.setFont('helvetica','bold'); doc.setFontSize(14);
          doc.text(c[1], x+10, yCardsTop+38);
          doc.setFont('helvetica','normal'); doc.setTextColor(0,0,0);
        });

        // Chart image
        const chartY = yCardsTop + hCard + 18;
        const chartW = pageW - margin*2;
        const chartH = 220;
        doc.addImage(chartImg, 'PNG', margin, chartY, chartW, chartH);

        // Tabel ringkas (nama, % , Santri, Tuntas, Belum, Khatam)
        let y = chartY + chartH + 22;
        const lineH = 16;
        function headerRow(){
          doc.setFont('helvetica','bold'); doc.setFontSize(10);
          doc.text('Halaqoh', margin, y);
          doc.text('%',       margin+260, y, { align:'right' });
          doc.text('Santri',  margin+320, y, { align:'right' });
          doc.text('Tuntas',  margin+380, y, { align:'right' });
          doc.text('Belum',   margin+460, y, { align:'right' });
          doc.text('Khatam',  margin+540, y, { align:'right' });
          doc.setFont('helvetica','normal'); doc.setFontSize(10);
          y += 6; doc.setDrawColor(230); doc.line(margin, y, pageW - margin, y); y += 10;
        }
        headerRow();
        for (const r of rows){
          if (y > doc.internal.pageSize.getHeight() - 48){
            doc.addPage(); y = margin; headerRow();
          }
          const pct = Math.round(r.avg);
          const belum = r.belumTuntas ?? Math.max(0,(r.count||0)-(r.tuntas||0)-(r.khatam||0));
          doc.text(String(r.label), margin, y);
          doc.text(`${pct}%`,        margin+260, y, { align:'right' });
          doc.text(String(r.count),  margin+320, y, { align:'right' });
          doc.text(String(r.tuntas), margin+380, y, { align:'right' });
          doc.text(String(belum),    margin+460, y, { align:'right' });
          doc.text(String(r.khatam), margin+540, y, { align:'right' });
          y += lineH;
        }

        // Footer kecil
        doc.setFontSize(8); doc.setTextColor(120);
        doc.text('Generated by Rapor Tahfiz ‚Äî PDF Grafik THMS', margin, doc.internal.pageSize.getHeight()-20);

        // Filename
        const safe = (s)=>String(s||'').replace(/[^\w\-]+/g,'_');
        const fname = `GrafikProsentase_THMS_${safe(startDate)}_sd_${safe(endDate)}.pdf`;
        doc.save(fname);
      } catch(e){
        console.error(e);
        alert('Gagal membuat PDF: ' + (e.message||e));
      } finally {
        btnPdf.disabled = false; btnPdf.textContent = prev;
      }
    }

    // ====== Bind tombol
    btn.addEventListener('click', openOverlay);
    btnPdf.addEventListener('click', downloadPdf);
  }
})();
</script>



<!-- ===== SIMPAN RENTANG TANGGAL DOWNLOAD PDF DLL ===== -->
<script>
(function(){
  const startEl = document.getElementById('pdf-start-date');
  const endEl   = document.getElementById('pdf-end-date');
  if (!startEl || !endEl) return;

  // ====== KUNCI PENYIMPANAN ======
  // Per kelas (default): simpan tanggal per nilai #kelasSelect
  const kelasEl = document.getElementById('kelasSelect');
  const keyFor = () => `raportahfiz.rekapRange.${kelasEl?.value || 'ALL'}`;

  // ====== UTIL ======
  const isISO = v => /^\d{4}-\d{2}-\d{2}$/.test(v);
  const pad2  = n => String(n).padStart(2,'0');
  function monthToDateDefault(){
    const d = new Date();
    const yyyy = d.getFullYear(), mm = pad2(d.getMonth()+1), dd = pad2(d.getDate());
    return { start: `${yyyy}-${mm}-01`, end: `${yyyy}-${mm}-${dd}` };
  }

  function load(){
    let obj = {};
    try { obj = JSON.parse(localStorage.getItem(keyFor()) || '{}'); } catch(e){}
    const { start, end } = obj || {};
    const def = monthToDateDefault();
    startEl.value = isISO(start) ? start : (startEl.value || def.start);
    endEl.value   = isISO(end)   ? end   : (endEl.value   || def.end);

    // beri tahu komponen lain yang tergantung tanggal (opsional)
    try { window._populateSantriSelect?.(); } catch(e){}
  }

  function save(){
    const data = {
      start: startEl.value || null,
      end:   endEl.value   || null,
      t: Date.now()
    };
    localStorage.setItem(keyFor(), JSON.stringify(data));
  }

  startEl.addEventListener('change', save);
  endEl.addEventListener('change', save);
  kelasEl?.addEventListener('change', load);

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', load);
  } else {
    load();
  }

  // (opsional) reset
  window.clearSavedRekapRange = function(){
    localStorage.removeItem(keyFor());
    load();
  };
})();
</script>

<!-- Modal: Daftar Input Murajaah (Rentang) -->
<div id="murRangeListModal" style="display:none;position:fixed;inset:0;z-index:9999;align-items:center;justify-content:center">
  <div data-close-mur-range-list style="position:absolute;inset:0;background:rgba(0,0,0,.5)"></div>
  <div style="position:relative;background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.2);width:min(100%,1000px);max-height:80vh;display:flex;flex-direction:column">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #eee">
      <div>
        <div id="mrl-title" style="font-weight:700">Daftar Murajaah (Rentang)</div>
        <div id="mrl-sub" style="font-size:12px;color:#6b7280"></div>
      </div>
      <div style="display:flex;gap:8px">
  <button id="mrl-download"
    style="border:1px solid #d1d5db;border-radius:8px;padding:6px 10px;font-size:12px;background:#eef2ff;color:#1e40af">
    Unduh PDF
  </button>
  <button data-close-mur-range-list
    style="border:1px solid #e5e7eb;border-radius:8px;padding:6px 10px;font-size:12px">
    Tutup
  </button>
</div>
    </div>
    <div style="padding:10px 16px">
  <input
    id="mrl-search"
    placeholder="Cari tanggal/surah/catatan‚Ä¶"
    style="box-sizing:border-box; width:100%; max-width:100%; display:block; border:1px solid #e5e7eb; border-radius:8px; padding:8px 10px; font-size:14px"
  >
</div>
    <div style="padding:0 16px 12px;overflow:auto">
      <table style="width:100%;border-collapse:separate;border-spacing:0;border:1px solid #e5e7eb;border-radius:10px;overflow:hidden">
        <thead style="background:#fafafa">
          <tr>
            <th style="text-align:left;padding:8px 10px;border-bottom:1px solid #eee">Tanggal</th>
            <th style="text-align:left;padding:8px 10px;border-bottom:1px solid #eee">Total</th>
            <th style="text-align:left;padding:8px 10px;border-bottom:1px solid #eee">Sesi 1</th>
            <th style="text-align:left;padding:8px 10px;border-bottom:1px solid #eee">Sesi 2</th>
            <th style="text-align:left;padding:8px 10px;border-bottom:1px solid #eee">Sesi 3</th>
          </tr>
        </thead>
        <tbody id="mrl-tbody"></tbody>
      </table>
      <div id="mrl-empty" style="text-align:center;color:#6b7280;font-size:13px;padding:16px;display:none">
        Belum ada input murajaah pada rentang ini.
      </div>
		<!-- ‚¨á‚¨á Tambahan: total keseluruhan -->
      <div id="mrl-sum"
           style="margin:10px 16px 16px;border-top:1px solid #e5e7eb;padding-top:10px;
                  font-weight:600;color:#111827;display:none">
        Total keseluruhan: 0.00 juz
      </div>
      <!-- ‚¨Ü‚¨Ü Tambahan -->
    </div>
  </div>
</div>

<script>
// === Murajaah Range ‚Üí Download PDF LANGSUNG (jsPDF) ===
// A3 landscape ‚Ä¢ kolom dinamis ‚Ä¢ badge berwarna ‚Ä¢ "Surah X s.d Y"
// Baris kosong disembunyikan ‚Ä¢ Badge/teks dipusatkan vertikal
// + RINGKASAN: Total Juz (di bagian bawah)

(function(){
  // ---------- Utils DOM ----------
  const $ = s => document.querySelector(s);
  const text = el => (el ? String(el.innerText || el.textContent || '').trim() : '');

  // ---------- Warna badge predikat ----------
  function predStyle(letter){
    const t = (letter||'').toUpperCase().trim();
    if (t==='A+') return { bg:[220,252,231], br:[134,239,172], fg:[22,101,52]  };
    if (t==='A')  return { bg:[234,250,240], br:[167,243,208], fg:[22,101,52]  };
    if (t==='B')  return { bg:[219,234,254], br:[147,197,253], fg:[30,58,138]  };
    if (t==='C')  return { bg:[255,237,213], br:[253,186,116], fg:[154,52,18]  };
    if (t==='D')  return { bg:[255,228,230], br:[254,205,211], fg:[159,18,57]  };
    return null;
  }
  function extractHuruf(sessionText){
    const m = (sessionText||'').match(/\((A\+|A|B|C|D)\)/i);
    return m ? m[1].toUpperCase() : '';
  }

  // ---------- Deteksi kolom dari THEAD modal ----------
  function detectColumns(){
    const thead = $('#mrl-tbody')?.parentNode?.querySelector('thead');
    if (!thead) return null;
    const ths = [...thead.querySelectorAll('th')].map(th => text(th));
    const cols = [];
    ths.forEach((label, idx) => {
      const L = label.toLowerCase();
      if (L.includes('tanggal')) cols.push({type:'tgl', label:'Tanggal', idx});
      else if (L.includes('total')) cols.push({type:'total', label:'Total', idx});
      else if (L.includes('sesi')) cols.push({type:'sesi', label:label, idx}); // Sesi 1/2/3
    });
    return cols;
  }

  // ---------- Row kosong? (semua kolom Sesi kosong) ----------
  function isRowEmpty(tr, sesiIdx){
    const c = tr.children; if (!c) return true;
    return sesiIdx.every(i => !text(c[i]));
  }

  // ---------- Normalisasi teks sesi: "a:b ‚Üí c:d" ‚Üí "Surah a:b s.d c:d" ----------
  const ARROW_RE = /(\d+\s*:\s*\d+)\s*[\u2192\-‚Äì‚Äî>]\s*(\d+\s*:\s*\d+)/;
  const normalizeSessionText = s => s ? s.replace(ARROW_RE, (_,a,b)=>`Surah ${a} s.d ${b}`) : s;

  // ---------- Kumpulkan data baris dari tbody (mengikuti kolom terdeteksi) ----------
  function collectRows(cols){
    const tbody = $('#mrl-tbody'); if (!tbody) return [];
    const sesiIdx = cols.filter(c=>c.type==='sesi').map(c=>c.idx);
    const out = [];
    tbody.querySelectorAll('tr').forEach(tr=>{
      if (isRowEmpty(tr, sesiIdx)) return;
      const row = cols.map(c=>{
        const td = tr.children[c.idx];
        let v = text(td);
        if (c.type==='sesi') v = normalizeSessionText(v);
        return v;
      });
      out.push(row);
    });
    return out;
  }

  // ---------- parser angka "1.00 juz" ‚Üí 1.00 ----------
  function parseJuz(s){
    if (!s) return 0;
    let v = String(s).toLowerCase().replace(/juz/g,'').trim();
    v = v.replace(/[^\d,.\-]/g,'');
    // normalisasi koma/desimal
    const c=v.lastIndexOf(','), d=v.lastIndexOf('.');
    if (c>-1 && d>-1){ if (c>d){ v=v.replace(/\./g,'').replace(',', '.'); } else { v=v.replace(/,/g,''); } }
    else if (c>-1){ v=v.replace(/\./g,'').replace(',', '.'); }
    else { v=v.replace(/,/g,''); }
    const n = parseFloat(v);
    return Number.isFinite(n) ? n : 0;
  }

  // ---------- Layout PDF (A3 landscape) ----------
  const M = { L:12, T:12, R:12, B:10 };
  const PAGE_W = 420, PAGE_H = 297;                   // A3 landscape (mm)
  const USABLE_W = PAGE_W - M.L - M.R;                // 396mm
  const HEADER_FILL = [33,150,243], HEADER_TXT=[255,255,255];
  const GRID=[224,224,224], ZEBRA=[248,250,252];

  // Lebar kolom dinamis: Tanggal & Total fixed-min, sisa untuk Sesi (dibagi rata)
  function computeColWidths(cols){
    const nSesi = cols.filter(c=>c.type==='sesi').length;
    const hasTgl = cols.some(c=>c.type==='tgl');
    const hasTot = cols.some(c=>c.type==='total');

    const tglMin = hasTgl ? 40 : 0;
    const totMin = hasTot ? 32 : 0;
    const fixed = tglMin + totMin;

    const rem = Math.max(USABLE_W - fixed, 60 * nSesi); // jaga minimal
    const sesiW = nSesi ? rem / nSesi : 0;

    const mapW = {};
    cols.forEach(c=>{
      if (c.type==='tgl')   mapW[c.idx] = tglMin;
      else if (c.type==='total') mapW[c.idx] = totMin;
      else mapW[c.idx] = sesiW;
    });
    return cols.map(c=>mapW[c.idx]);
  }

  function tryJsPDFDownload(rows, cols, colW, title, sub){
    const jsPDF = window.jspdf ? window.jspdf.jsPDF : (window.jsPDF || null);
    if (!jsPDF) return false;

    const doc = new jsPDF({ unit:'mm', format:'a3', orientation:'landscape' });
    const headers = cols.map(c=>c.label);
    const totalIdx = cols.findIndex(c=>c.type==='total');

    // ==== hitung total juz (hanya baris tercetak) ====
    let totalJuz = 0;
    if (totalIdx >= 0){
      for (let i=0;i<rows.length;i++){
        totalJuz += parseJuz(rows[i][totalIdx]);
      }
    }
    totalJuz = Math.max(0, totalJuz);
    const hariCount = rows.length;

    function drawHeader(y){
      doc.setFont('helvetica','bold'); doc.setFontSize(15); doc.setTextColor(0);
      doc.text(title || 'Daftar Murajaah (Rentang)', M.L, y); y += 7;

      if (sub){
        doc.setFont('helvetica','normal'); doc.setFontSize(11);
        const lines = doc.splitTextToSize(sub, USABLE_W);
        lines.forEach(line => { doc.text(line, M.L, y); y += 5; });
        y += 2;
      }

      // header tabel
      let x = M.L, thH = 9;
      doc.setFillColor(...HEADER_FILL);
      doc.setDrawColor(...GRID);
      doc.rect(M.L, y, USABLE_W, thH, 'F');

      doc.setFont('helvetica','bold'); doc.setFontSize(11); doc.setTextColor(...HEADER_TXT);
      headers.forEach((h,i)=>{ doc.text(h, x+2, y+5.8); if(i>0) doc.line(x, y, x, y+thH); x += colW[i]; });
      doc.line(M.L, y+thH, M.L+USABLE_W, y+thH);
      doc.setTextColor(0);
      return y + thH + 2;
    }

    function drawFooter(page){
      doc.setFont('helvetica','normal'); doc.setFontSize(9); doc.setTextColor(110);
      doc.text(`Generated ${new Date().toLocaleString()} ‚Ä¢ Page ${page}`, M.L, PAGE_H - 6);
      doc.setTextColor(0);
    }

    // kotak ringkasan di bawah
    function drawSummary(y){
      const label = `Ringkasan: Total Juz = ${totalJuz.toFixed(2)} juz ‚Ä¢ Jumlah hari = ${hariCount}`;
      const boxH = 11;
      if (y + boxH > PAGE_H - M.B){ // pindah halaman jika tak muat
        drawFooter(page);
        doc.addPage('a3','landscape');
        page++;
        y = M.T; // tidak perlu header tabel lagi untuk ringkasan
      }
      // garis pemisah
      doc.setDrawColor(...GRID);
      doc.line(M.L, y, M.L + USABLE_W, y);
      y += 3;

      // kotak
      doc.setFillColor(245, 245, 245);
      doc.setDrawColor(200, 200, 200);
      if (doc.roundedRect){
        doc.roundedRect(M.L, y, USABLE_W, boxH, 2.5, 2.5, 'FD');
      } else {
        doc.rect(M.L, y, USABLE_W, boxH, 'FD');
      }
      doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.setTextColor(34,34,34);
      doc.text(label, M.L + 4, y + 7);
      return y + boxH;
    }

    let page = 1;
    let y = drawHeader(M.T);
    doc.setDrawColor(...GRID); doc.setLineWidth(0.2);

    for (let r=0; r<rows.length; r++){
      // wrap per kolom
      const wrapped = rows[r].map((cell, i)=>{
        const innerW = Math.max(colW[i] - 8, 20);
        return doc.splitTextToSize(cell || '', innerW);
      });

      // tinggi baris
      let linesMax = 1; wrapped.forEach(w => linesMax = Math.max(linesMax, w.length));
      const lineH = 5;
      const rowH  = Math.max(10, linesMax * lineH + 6);

      // page break
      if (y + rowH > PAGE_H - M.B - 20){ // sisakan ruang untuk ringkasan/footnote
        drawFooter(page);
        doc.addPage('a3','landscape');
        page++; y = drawHeader(M.T);
      }

      // zebra row
      if (r % 2 === 1){ doc.setFillColor(...ZEBRA); doc.rect(M.L, y, USABLE_W, rowH, 'F'); }

      // === ISI: pusatkan badge & teks secara VERTIKAL ===
      doc.setFont('helvetica','normal'); doc.setFontSize(10);
      let x = M.L;

      for (let c=0; c<cols.length; c++){
        const col   = cols[c];
        const lines = wrapped[c];
        const textBlockH = Math.max(1, lines.length) * lineH;

        if (col.type === 'sesi'){
          const sesText = rows[r][c] || '';
          const huruf   = extractHuruf(sesText);
          const st      = predStyle(huruf);

          // dimensi badge
          const padX = 2.2, padY = 2.0;
          const badgeW = Math.max(colW[c] - 3.0, 18);
          const badgeH = Math.max(8, textBlockH + padY*2);

          // posisi badge tengah sel
          const badgeY = y + (rowH - badgeH)/2;

          if (st){
            doc.setFillColor(...st.bg);
            doc.setDrawColor(...st.br);
            if (doc.roundedRect){
              doc.roundedRect(x+1.2, badgeY, badgeW-2.4, badgeH, 2.5, 2.5, 'FD');
            } else {
              doc.rect(x+1.2, badgeY, badgeW-2.4, badgeH, 'FD');
            }
            doc.setTextColor(...st.fg);
          } else {
            doc.setTextColor(0);
          }

          // teks di dalam badge ‚Üí dipusatkan vertikal
          const textY = badgeY + (badgeH - textBlockH)/2 + 4; // +4 = baseline tweak
          for (let li=0; li<lines.length; li++){
            doc.text(lines[li], x + padX + 1.5, textY + li*lineH);
          }
          doc.setTextColor(0);

        } else {
          // kolom Tanggal / Total ‚Üí pusat vertikal di dalam cell
          const baseY = y + (rowH - textBlockH)/2 + 4;
          lines.forEach((ln,i)=> doc.text(ln, x+1.8, baseY + i*lineH));
        }

        // grid vertikal
        doc.setDrawColor(...GRID);
        doc.line(x, y, x, y + rowH);
        x += colW[c];
      }

      // grid kanan & bawah
      doc.line(M.L + USABLE_W, y, M.L + USABLE_W, y + rowH);
      doc.line(M.L, y + rowH, M.L + USABLE_W, y + rowH);

      y += rowH;
    }

    // ---- Ringkasan di bawah tabel ----
    y += 6;
    y = drawSummary(y);

    drawFooter(page);
    doc.save('murajaah-range-a3.pdf'); // langsung download
    return true;
  }

  function handleDownload(){
    const title = $('#mrl-title') ? $('#mrl-title').textContent.trim() : 'Daftar Murajaah (Rentang)';
    const sub   = $('#mrl-sub')   ? $('#mrl-sub').textContent.trim()   : '';

    const cols  = detectColumns();
    if (!cols || !cols.length){ alert('Tabel modal tidak ditemukan.'); return; }

    const rows  = collectRows(cols);
    if (!rows.length){ alert('Tidak ada data untuk diunduh.'); return; }

    const colW  = computeColWidths(cols);

    let ok = false;
    try { ok = tryJsPDFDownload(rows, cols, colW, title, sub); } catch(e) { ok = false; }
    if (!ok) alert('jsPDF belum tersedia. Tambahkan <script jsPDF> di <head>.');
  }

  // Tombol di header modal: <button id="mrl-download">Unduh PDF</button>
  document.addEventListener('click', e=>{
    if (e.target && e.target.id === 'mrl-download') handleDownload();
  });
})();
</script>


<!-- ===================== PRESENSI ALL (TH Trigger) ===================== --> 
<style>
  /* overlay & modal ringkas */
  #presensiAllOverlay{
    position:fixed;inset:0;background:rgba(0,0,0,.5);
    display:none;z-index:9999;
    align-items:center;justify-content:center;
    padding:16px
  }
  #presensiAllOverlay.show{display:flex}
  .pa-card{
    background:#fff;max-width:980px;width:100%;max-height:90vh;
    border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.22);
    display:flex;flex-direction:column;overflow:hidden;
    position:relative; /* untuk loader di dalam modal */
  }
  .pa-hd{
    display:flex;align-items:center;justify-content:space-between;
    padding:12px 16px;border-bottom:1px solid #eee
  }
  .pa-bd{padding:12px 16px;overflow:auto}
  .pa-ft{
    display:flex;justify-content:flex-end;gap:10px;
    padding:12px 16px;border-top:1px solid #eee;background:#fff
  }
  .pa-btn{
    border-radius:10px;border:1px solid #e5e7eb;background:#1E88E5;
    padding:8px 14px;cursor:pointer
  }
  .pa-btn.primary{
    background:#1E88E5;color:#fff;border-color:#1E88E5
  }
  .pa-date{
    display:flex;gap:12px;flex-wrap:wrap;margin-bottom:10px
  }
  .pa-pill{
    background:#f3f4f6;border:1px solid #e5e7eb;border-radius:999px;
    padding:6px 10px;min-width:110px;text-align:center
  }
  .pa-bulk{
    display:flex;align-items:center;gap:12px;flex-wrap:wrap;
    background:#fafafa;border:1px solid #eee;border-radius:10px;
    padding:8px 10px;margin-bottom:10px
  }
  .pa-list-head,.pa-row{
    display:grid;
    grid-template-columns:120px 1fr repeat(4,88px);
    align-items:center
  }
  .pa-list{
    border:1px solid #eee;border-radius:12px;overflow:hidden
  }
  .pa-list-head{
    background:#f8fafc;border-bottom:1px solid #eee;
    font-weight:600;font-size:13px
  }
  .pa-col{
    padding:8px 10px;border-right:1px solid #f0f0f0
  }
  .pa-col:last-child{border-right:none}
  .pa-rows{max-height:52vh;overflow:auto}
  .pa-row{border-bottom:1px solid #f3f4f6}
  .pa-row:last-child{border-bottom:none}

  /* ---------- MOBILE (<=720px): sticky kolom NIS kiri, header ikut geser ---------- */
  @media(max-width:720px){
    #presensiAllOverlay{ --pa-nama-w: 180px; }

    .pa-list-head,
    .pa-row{
      grid-template-columns:82px var(--pa-nama-w, 180px) repeat(4,64px);
    }

    .pa-col{
      padding:8px;
      line-height:1.25;
    }

    .pa-col.nama{
      width:var(--pa-nama-w, 180px);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .pa-row{align-items:center;}

    /* scroll horizontal: header & body bergerak bersama */
    .pa-list{
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }

    .pa-rows{
      max-height:none;
      overflow:visible;
    }

    /* sticky kolom pertama (NIS) */
    .pa-list-head .pa-col:first-child,
    #paRows .pa-row .pa-col:first-child{
      position:sticky;
      left:0;
      z-index:3;
    }
    .pa-list-head .pa-col:first-child{
      background:#f8fafc;
      z-index:4;
    }
    #paRows .pa-row .pa-col:first-child{
      background:#fff;
      box-shadow:2px 0 4px rgba(0,0,0,0.03);
    }
  }

  /* th Presensi: tampilan seperti link nyata */
  th.pa-presensi-th{
    cursor:pointer;
    position:relative;
  }
  th.pa-presensi-th .pa-presensi-link{
    color:#FFFFFF;
    text-decoration:underline;
    text-underline-offset:3px;
  }
  th.pa-presensi-th::after{
    content:"";
    position:absolute;
    inset:auto 8px 6px auto;
    width:7px;height:7px;
    border-right:2px solid #1E88E5;
    border-bottom:2px solid #1E88E5;
    transform:rotate(45deg)
  }

  /* Loader overlay di dalam modal */
  .pa-loading{
    position:absolute;
    inset:0;
    background:rgba(255,255,255,0.8);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:50;
  }
  .pa-loading.show{display:flex;}
  .pa-loading img{
    width:40px;
    height:40px;
    object-fit:contain;
  }
</style>

<!-- Modal dibuat sekali -->
<div id="presensiAllOverlay" aria-hidden="true">
  <div class="pa-card" role="dialog" aria-modal="true" aria-labelledby="pa-title">
    <div class="pa-hd">
      <h3 id="pa-title" style="margin:0;font-size:18px;">Presensi All</h3>
    </div>
    <div class="pa-bd">
      <div class="pa-date">
        <div>
          <label style="font-size:12px;color:#666;display:block;margin-bottom:4px">Hari</label>
          <div id="paHari" class="pa-pill">-</div>
        </div>
        <div>
          <label style="font-size:12px;color:#666;display:block;margin-bottom:4px" for="paTanggal">Tanggal</label>
          <input id="paTanggal" type="date">
        </div>
      </div>

      <div class="pa-bulk">
        <strong style="font-size:12px;color:#555">Semua</strong>
        <label><input type="checkbox" id="paAllHadir"> Hadir</label>
        <label><input type="checkbox" id="paAllIzin"> Izin</label>
        <label><input type="checkbox" id="paAllSakit"> Sakit</label>
        <label><input type="checkbox" id="paAllAlpha"> Alpha</label>
      </div>

      <div class="pa-list">
        <div class="pa-list-head">
          <div class="pa-col">NIS</div>
          <div class="pa-col nama">Nama</div>
          <div class="pa-col" style="text-align:center">Hadir</div>
          <div class="pa-col" style="text-align:center">Izin</div>
          <div class="pa-col" style="text-align:center">Sakit</div>
          <div class="pa-col" style="text-align:center">Alpha</div>
        </div>
        <div id="paRows" class="pa-rows"></div>
      </div>
    </div>
    <div class="pa-ft">
      <button class="pa-btn" id="paBtnClose">Tutup</button>
      <button class="pa-btn primary" id="paBtnSave">Save</button>
    </div>

    <!-- Loader di dalam modal -->
    <div id="paLoading" class="pa-loading" aria-hidden="true">
      <img src="https://raw.githubusercontent.com/digitalmtq/web/main/gear.gif">
    </div>
  </div>
</div>

<script>
(function(){
  const SS_KEY_OPEN = 'PA_OPEN_AFTER_RELOAD';
  const SS_KEY_DATE = 'PA_SELECTED_DATE';

  let tableObserver = null;

  // ===== util tanggal/hari =====
  function getTodayStr(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const dd= String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  }

  function hariIndo(d){
    const map = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
    return map[d.getDay()];
  }

  function setHariFromInput(){
    const el = document.getElementById('paTanggal');
    const hari = document.getElementById('paHari');
    const v = el.value;
    if(!v){ hari.textContent='-'; return; }

    const today = getTodayStr();
    if (v > today){
      el.value = today;
    }

    const parts = el.value.split('-').map(Number);
    if (parts.length === 3){
      const [y,m,dd] = parts;
      hari.textContent = hariIndo(new Date(y, m-1, dd));
    } else {
      hari.textContent = '-';
    }
  }

  // ===== loader helper =====
  function showLoading(){
    const el = document.getElementById('paLoading');
    if (!el) return;
    el.classList.add('show');
    el.setAttribute('aria-hidden','false');
  }
  function hideLoading(){
    const el = document.getElementById('paLoading');
    if (!el) return;
    el.classList.remove('show');
    el.setAttribute('aria-hidden','true');
  }

  // ===== sinkron tanggal ke dashboard =====
  function syncDashboardDate(dateStr){
    try{
      const target =
        (window.tanggalInput && window.tanggalInput.tagName ? window.tanggalInput : null) ||
        document.getElementById('tanggalInput') ||
        document.getElementById('tanggal') ||
        document.getElementById('date');

      const overlayOpen = document
        .getElementById('presensiAllOverlay')
        ?.classList.contains('show');

      if (target){
        if (overlayOpen) showLoading();

        if (target.value !== dateStr){
          target.value = dateStr;
          target.setAttribute('value', dateStr);
        }
        target.dispatchEvent(new Event('input', {bubbles:true}));
        target.dispatchEvent(new Event('change', {bubbles:true}));
        // AJAX handler akan update #santri-table,
        // MutationObserver -> renderRows() -> hideLoading()
      } else {
        // Fallback reload penuh + auto-open sekali
        try{
          sessionStorage.setItem(SS_KEY_DATE, dateStr);
          sessionStorage.setItem(SS_KEY_OPEN, '1');
        }catch(e){}
        if (overlayOpen) showLoading();
        window.location.reload();
      }
    }catch(e){
      // Kalau error, fallback reload penuh + auto-open sekali
      try{
        sessionStorage.setItem(SS_KEY_DATE, dateStr);
        sessionStorage.setItem(SS_KEY_OPEN, '1');
      }catch(_e){}
      showLoading();
      window.location.reload();
    }
  }

  // ===== deteksi kolom NIS/Nama dari THEAD =====
  function headerMapForTable(table){
    const map = { nis:0, nama:1, presensi:-1 };
    if(!table) return map;
    const ths = table.querySelectorAll('thead th');
    if (!ths.length) return map;
    for (let i=0;i<ths.length;i++){
      const tRaw = (ths[i].textContent||'').trim().toLowerCase();
      const t = tRaw.replace(/\s+/g,' ');
      if (t === 'nis') map.nis = i;
      if (t === 'nama') map.nama = i;
      if (t === 'presensi' || t === 'all presensi') {
        map.presensi = i;
        ths[i].classList.add('pa-presensi-th');
      }
    }
    return map;
  }

  // ===== ambil rows santri dari #santri-table =====
  function getSantriRows(){
    const table = document.getElementById('santri-table');
    const tbody = table?.querySelector('tbody');
    if (!table || !tbody) return { table:null, map:null, rows:[] };
    const map = headerMapForTable(table);
    const rows = [...tbody.querySelectorAll('tr')];
    return { table, map, rows };
  }

  // ===== observer: jika #santri-table berubah, update isi modal jika sedang terbuka =====
  function ensureTableObserver(){
    const { table } = getSantriRows();
    const tbody = table?.querySelector('tbody');
    if (!tbody) return;

    if (tableObserver) tableObserver.disconnect();

    tableObserver = new MutationObserver(function(){
      const overlay = document.getElementById('presensiAllOverlay');
      if (overlay && overlay.classList.contains('show')){
        renderRows();       // sync isi modal dengan data baru
        hideLoading();      // matikan loader setelah data masuk
      }
    });

    tableObserver.observe(tbody, { childList:true, subtree:true });
  }

  // ===== baca status dominan saat ini (untuk pra-centang) =====
  function currentDominantFromRow(row){
    const cell = row.querySelector('.abs-flex-cell');
    const items = Array.isArray(cell?._absensiItems) ? cell._absensiItems : [];
    if (typeof window.__absmini_dominantStatus === 'function'){
      return window.__absmini_dominantStatus(items);
    }
    const cnt = {hadir:0,izin:0,sakit:0,alpha:0};
    items.forEach(it=>{
      if (!it.checked) return;
      const base = String(it.key||'').toLowerCase().replace(/\d+$/,'');
      if (base in cnt) cnt[base]++;
    });
    return ['hadir','izin','sakit','alpha'].reduce((a,b)=>cnt[b]>cnt[a]?b:a,'hadir');
  }

  // ===== MOBILE: set lebar kolom Nama mengikuti nama terpanjang =====
  function setFixedNamaWidthMobile(){
    if (!window.matchMedia('(max-width: 720px)').matches) return;
    const overlay = document.getElementById('presensiAllOverlay');
    const names = [...document.querySelectorAll('#paRows .pa-col.nama')];
    if (!names.length){
      overlay?.style?.setProperty('--pa-nama-w', '180px');
      return;
    }

    const sample = names[0];
    const cs = window.getComputedStyle(sample);
    const font = `${cs.fontStyle} ${cs.fontVariant} ${cs.fontWeight} ${cs.fontSize} ${cs.fontFamily}`;

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    ctx.font = font;

    let maxPx = 0;
    names.forEach(el => {
      const text = el.textContent.trim();
      const w = ctx.measureText(text).width;
      if (w > maxPx) maxPx = w;
    });

    const padding = 24;
    let target = Math.ceil(maxPx + padding);
    const maxVW = Math.floor(window.innerWidth * 0.55);
    const minPx = 140;
    target = Math.max(minPx, Math.min(target, maxVW));

    overlay?.style?.setProperty('--pa-nama-w', `${target}px`);
  }

  // ===== auto-sync bulk checkbox dari isi rows =====
  function syncBulkFromRows(){
    const rows = document.querySelectorAll('#paRows .pa-row');
    const cbHadir = document.getElementById('paAllHadir');
    const cbIzin  = document.getElementById('paAllIzin');
    const cbSakit = document.getElementById('paAllSakit');
    const cbAlpha = document.getElementById('paAllAlpha');

    [cbHadir, cbIzin, cbSakit, cbAlpha].forEach(cb => { if (cb) cb.checked = false; });

    if (!rows.length) return;

    let allHadir = true;
    let allIzin  = true;
    let allSakit = true;
    let allAlpha = true;

    rows.forEach(row => {
      const h = row.querySelector('.st-hadir')?.checked || false;
      const i = row.querySelector('.st-izin')?.checked  || false;
      const s = row.querySelector('.st-sakit')?.checked || false;
      const a = row.querySelector('.st-alpha')?.checked || false;

      if (!h) allHadir = false;
      if (!i) allIzin  = false;
      if (!s) allSakit = false;
      if (!a) allAlpha = false;
    });

    const candidates = [];
    if (allHadir) candidates.push(cbHadir);
    if (allIzin)  candidates.push(cbIzin);
    if (allSakit) candidates.push(cbSakit);
    if (allAlpha) candidates.push(cbAlpha);

    if (candidates.length === 1 && candidates[0]){
      candidates[0].checked = true;
    }
  }

  // ===== render daftar di modal =====
  function renderRows(){
    const wrap = document.getElementById('paRows');
    wrap.innerHTML = '';
    const { rows, map } = getSantriRows();
    rows.forEach(tr=>{
      const tds = tr.querySelectorAll('td');
      const nis  = (tds[map.nis]?.textContent || '').trim();
      const nama = (tds[map.nama]?.textContent || '').trim();

      const r = document.createElement('div');
      r.className = 'pa-row';
      r.dataset.nis = nis;

      const dom = currentDominantFromRow(tr);
      r.innerHTML = `
        <div class="pa-col">${nis}</div>
        <div class="pa-col nama" title="${nama}">${nama}</div>
        <div class="pa-col" style="text-align:center"><input type="checkbox" class="st st-hadir"></div>
        <div class="pa-col" style="text-align:center"><input type="checkbox" class="st st-izin"></div>
        <div class="pa-col" style="text-align:center"><input type="checkbox" class="st st-sakit"></div>
        <div class="pa-col" style="text-align:center"><input type="checkbox" class="st st-alpha"></div>
      `;

      r.querySelectorAll('.st').forEach(chk=>{
        chk.addEventListener('change', (e)=>{
          if (e.target.checked){
            r.querySelectorAll('.st').forEach(o=>{ if(o!==e.target) o.checked=false; });
          }
        });
      });

      if (dom) {
        const box = r.querySelector(`.st-${dom}`);
        if (box) box.checked = true;
      }

      wrap.appendChild(r);
    });

    document
      .querySelector('#presensiAllOverlay .pa-list-head .pa-col:nth-child(2)')
      ?.classList.add('nama');

    setFixedNamaWidthMobile();
    syncBulkFromRows();
  }

  // ===== BULK (mutually exclusive + clear saat uncheck) =====
  function setupBulk(){
    const bulkIds = ['paAllHadir','paAllIzin','paAllSakit','paAllAlpha'];
    const map = {
      paAllHadir: '.st-hadir',
      paAllIzin:  '.st-izin',
      paAllSakit: '.st-sakit',
      paAllAlpha: '.st-alpha'
    };

    bulkIds.forEach(id=>{
      const el = document.getElementById(id);
      if (!el) return;

      el.addEventListener('change', (e)=>{
        const checked = e.target.checked;

        if (checked){
          bulkIds.forEach(o=>{
            if (o !== id){
              const x = document.getElementById(o);
              if (x) x.checked = false;
            }
          });
          document.querySelectorAll('#paRows .st').forEach(c=>{ c.checked = false; });
          document.querySelectorAll('#paRows '+map[id]).forEach(c=>{ c.checked = true; });
        } else {
          document.querySelectorAll('#paRows .st').forEach(c=>{ c.checked = false; });
        }
      });
    });
  }

  // ===== terapkan hasil ke tabel (ABSENSI FLEX) =====
  function applyToTable(){
    const { rows } = getSantriRows();
    const chosen = new Map();

    // Baca pilihan dari modal
    document.querySelectorAll('#paRows .pa-row').forEach(r=>{
      const nis = r.dataset.nis;
      const status =
        r.querySelector('.st-hadir')?.checked ? 'hadir' :
        r.querySelector('.st-izin')?.checked  ? 'izin'  :
        r.querySelector('.st-sakit')?.checked ? 'sakit' :
        r.querySelector('.st-alpha')?.checked ? 'alpha' : '';
      chosen.set(nis, status); // boleh kosong (artinya clear)
    });

    const per = Number(window.ABS_FLEX_CFG?.perStatus ?? 2);
    const allStatuses = Array.isArray(window.ABS_FLEX_CFG?.statuses)
      ? window.ABS_FLEX_CFG.statuses
      : ['hadir','izin','sakit','alpha'];

    function makeItemsFor(status, target){
      const t = Math.max(
        1,
        Math.min(6,
          Number(target) || Number(window.ABS_FLEX_CFG?.defaultTarget || 1)
        )
      );
      const items=[];
      for (const st of allStatuses){
        for (let i=1;i<=per;i++){
          const key = `${st}${i}`;
          items.push({ key, checked: (st===status && i<=t) });
        }
      }
      return items;
    }

    function makeEmptyItems(target){
      const t = Math.max(
        1,
        Math.min(6,
          Number(target) || Number(window.ABS_FLEX_CFG?.defaultTarget || 1)
        )
      );
      const items=[];
      for (const st of allStatuses){
        for (let i=1;i<=per;i++){
          const key = `${st}${i}`;
          items.push({ key, checked:false });
        }
      }
      return { items, target:t };
    }

    function compute(items, target){
      if (typeof window.__absflex_computePercent === 'function'){
        const rec = window.__absflex_computePercent(items, target);
        return {
          percent: Math.round(rec.percent),
          checked: rec.checked,
          target: rec.target
        };
      }
      const tgt = Math.max(1, Math.min(6, Number(target)||1));
      const on = (items||[]).reduce((a,it)=>a+(it.checked?1:0),0);
      return {
        percent: Math.round(Math.min(on,tgt)/tgt*100),
        checked:on,
        target:tgt
      };
    }

    function updateMini(cell){
      const mini = cell.querySelector('.abs-mini');
      const pct  = Number(cell._absensiPercent||0);
      const chk  = Number(cell._absensiChecked||0);
      const tgt  = Number(cell._absensiTarget||0);
      if (mini){
        mini.textContent = `${pct}% (${chk}/${tgt})`;
        mini.setAttribute('data-progress', String(pct));
        mini.classList.toggle('is-complete', pct>=100);

        const st = (typeof window.__absmini_dominantStatus === 'function')
          ? window.__absmini_dominantStatus(cell._absensiItems)
          : null;

        mini.classList.remove('is-hadir','is-izin','is-sakit','is-alpha');
        if (st) mini.classList.add(`is-${st}`);
      }
    }

    // Terapkan ke setiap row di dashboard
    rows.forEach(tr=>{
      const nis = (tr.dataset?.nis || tr.querySelector('td')?.textContent || '').trim();
      if (!nis) return;

      const chosenStatus = chosen.get(nis); // bisa 'hadir'/'izin'/... atau '' (clear) atau undefined
      const cell = tr.querySelector('.abs-flex-cell');
      if (!cell) return;

      const currentTarget = Number(cell._absensiTarget || window.ABS_FLEX_CFG?.defaultTarget || 1);

      if (!chosenStatus){ 
        // CLEAR: tidak ada yang dicentang di modal -> matikan semua checkbox di flex
        const empty = makeEmptyItems(currentTarget);
        cell._absensiItems   = empty.items;
        const rec = compute(cell._absensiItems, empty.target);
        cell._absensiTarget  = rec.target;
        cell._absensiChecked = rec.checked;
        cell._absensiPercent = rec.percent;
        updateMini(cell);
      } else {
        // SET ke status tunggal
        cell._absensiItems = makeItemsFor(chosenStatus, currentTarget);
        const rec = compute(cell._absensiItems, currentTarget);
        cell._absensiTarget  = rec.target;
        cell._absensiChecked = rec.checked;
        cell._absensiPercent = rec.percent;
        updateMini(cell);
      }
    });

    // Event keluar (opsional, tidak diubah)
    const tanggal = document.getElementById('paTanggal').value;
    const hari = document.getElementById('paHari').textContent;
    const itemsOut = [];
    document.querySelectorAll('#paRows .pa-row').forEach(r=>{
      const nis = r.dataset.nis;
      const nama = r.children[1]?.textContent?.trim() || '';
      const st =
        r.querySelector('.st-hadir')?.checked ? 'HADIR' :
        r.querySelector('.st-izin')?.checked  ? 'IZIN'  :
        r.querySelector('.st-sakit')?.checked ? 'SAKIT' :
        r.querySelector('.st-alpha')?.checked ? 'ALPHA' : '';
      itemsOut.push({ nis, nama, status: st });
    });
    document.dispatchEvent(new CustomEvent('presensiAllSaved', {
      detail: { tanggal, hari, items: itemsOut }
    }));
  }

  // ===== open/close modal =====
  function openModal(initialDate){
    const inTanggal = document.getElementById('paTanggal');
    const todayStr = getTodayStr();
    inTanggal.setAttribute('max', todayStr);

    const global =
      (window.tanggalInput && window.tanggalInput.value ? window.tanggalInput.value : '') ||
      document.querySelector('#tanggalInput')?.value ||
      document.querySelector('#tanggal')?.value ||
      document.querySelector('#date')?.value ||
      '';

    let useDate = todayStr;
    if (initialDate && initialDate <= todayStr){
      useDate = initialDate;
    } else if (global && global <= todayStr){
      useDate = global;
    }

    inTanggal.value = useDate;
    setHariFromInput();

    renderRows();
    document.getElementById('presensiAllOverlay').classList.add('show');
    document.getElementById('presensiAllOverlay').setAttribute('aria-hidden','false');

    setFixedNamaWidthMobile();
    hideLoading();
  }

  function closeModal(){
    document.getElementById('presensiAllOverlay').classList.remove('show');
    document.getElementById('presensiAllOverlay').setAttribute('aria-hidden','true');
    ['paAllHadir','paAllIzin','paAllSakit','paAllAlpha'].forEach(id=>{
      const el=document.getElementById(id);
      if(el) el.checked=false;
    });
    document.getElementById('paRows').innerHTML = '';
    hideLoading();
  }

  // ===== pasang pada <th>Presensi> (support lama "All Presensi") =====
  function hookPresensiTH(){
    const table = document.getElementById('santri-table');
    if (!table) return;
    const ths = [...table.querySelectorAll('thead th')];

    const th = ths.find(t => {
      const txt = (t.textContent||'').trim().toLowerCase().replace(/\s+/g,' ');
      return txt === 'presensi' || txt === 'all presensi';
    });
    if (!th) return;

    if (!th.querySelector('.pa-presensi-link')) {
      const label = (th.textContent || '').trim() || 'Presensi';
      th.innerHTML =
        '<a href="javascript:void(0)" class="pa-presensi-link">'+label+'</a>';
    }

    th.classList.add('pa-presensi-th');
    th.addEventListener('click', function(){ openModal(); });
  }

  // ===== init =====
  document.getElementById('paBtnClose').addEventListener('click', closeModal);

  document.getElementById('paBtnSave')?.addEventListener('click', async function(){
    const btn = this;
    try{
      applyToTable();
      if (typeof window.simpanDataMutabaah === 'function') {
        await window.simpanDataMutabaah(btn);
      } else if (typeof simpanDataMutabaah === 'function') {
        await simpanDataMutabaah(btn);
      } else {
        console.warn('simpanDataMutabaah() tidak ditemukan di global scope.');
        alert('Fungsi simpanDataMutabaah tidak ditemukan. Data di tabel sudah di-update, tapi tidak terkirim ke server.');
      }
    } catch(err){
      console.error('Gagal menyimpan Presensi All:', err);
      alert('Terjadi error saat menyimpan presensi. Silakan cek console atau coba lagi.');
    }
  });

  document.getElementById('paTanggal').addEventListener('change', function(){
    const today = getTodayStr();
    if (this.value > today) {
      this.value = today;
    }
    setHariFromInput();

    const selected = this.value;
    if (selected){
      syncDashboardDate(selected);
    }
  });

  setupBulk();
  hookPresensiTH();
  ensureTableObserver();

  let __paResizeT = null;
  window.addEventListener('resize', ()=>{
    if (__paResizeT) cancelAnimationFrame(__paResizeT);
    __paResizeT = requestAnimationFrame(setFixedNamaWidthMobile);
  });

  // Auto-open modal setelah reload jika (dan hanya jika) sebelumnya memang diset saat fallback reload
  try{
    const shouldOpen = sessionStorage.getItem(SS_KEY_OPEN) === '1';
    const savedDate = sessionStorage.getItem(SS_KEY_DATE);
    if (shouldOpen){
      sessionStorage.removeItem(SS_KEY_OPEN);
      openModal(savedDate || undefined);
    }
  }catch(e){}
})();
</script>
		
</body>
</html>
